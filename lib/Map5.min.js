!function(){window.GeoBeans={}}();
window.requestNextAnimationFrame=function(){var e=void 0,n=void 0,i=0,t=navigator.userAgent,o=0,a=this;return window.webkitRequestAnimationFrame&&(n=function(e){void 0===e&&(e=+new Date),a.callback(e)},e=window.webkitRequestAnimationFrame,window.webkitRequestAnimationFrame=function(i,t){a.callback=i,e(n,t)}),window.mozRequestAnimationFrame&&(o=t.indexOf("rv:"),t.indexOf("Gecko")!=-1&&(i=t.substr(o+3,3),"2.0"===i&&(window.mozRequestAnimationFrame=void 0))),window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,n){var i,t;window.setTimeout(function(){i=+new Date,e(i),t=+new Date,a.timeout=1e3/60-(t-i)},a.timeout)}}(),window.cancelNextRequestAnimationFrame=window.cancelRequestAnimationFrame||window.webkitCancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||clearTimeout;
GeoBeans.Class=function(){var t=arguments.length,n=arguments[0],e=arguments[t-1],o="function"==typeof e.initialize?e.initialize:function(){n.prototype.initialize.apply(this,arguments)};if(t>1){var i=[o,n].concat(Array.prototype.slice.call(arguments).slice(1,t-1),e);GeoBeans.inherit.apply(null,i)}else o.prototype=e;return o},GeoBeans.inherit=function(t,n){var e=function(){};e.prototype=n.prototype,t.prototype=new e;var o,i,r;for(o=2,i=arguments.length;o<i;o++)r=arguments[o],"function"==typeof r&&(r=r.prototype),GeoBeans.Util.extend(t.prototype,r)},GeoBeans.Util=GeoBeans.Util||{},GeoBeans.Util.extend=function(t,n){if(t=t||{},n){for(var e in n){var o=n[e];void 0!==o&&(t[e]=o)}var i="function"==typeof window.Event&&n instanceof window.Event;!i&&n.hasOwnProperty&&n.hasOwnProperty("toString")&&(t.toString=n.toString)}return t};
GeoBeans.Color=GeoBeans.Class({r:null,g:null,b:null,a:null,initialize:function(){this.r=parseInt(255*Math.random()),this.g=parseInt(255*Math.random()),this.b=parseInt(255*Math.random()),this.a=Math.random()},set:function(t,s,n,i){this.r=t,this.g=s,this.b=n,this.a=i},setByHex:function(t,s){if(null!=t){t=t.replace("#","");var n=parseInt(t.substring(0,2),16),i=parseInt(t.substring(2,4),16),r=parseInt(t.substring(4,6),16);this.r=n,this.g=i,this.b=r}null!=s&&(this.a=parseFloat(s))},setByRgb:function(t,s){if(null!=t){var n=t.indexOf("("),i=t.indexOf(")"),r=t.slice(n+1,i),e=r.slice(0,r.indexOf(",")),a=r.slice(r.lastIndexOf(",")+1,r.length),h=r.slice(r.indexOf(",")+1,r.lastIndexOf(","));this.r=parseInt(e),this.g=parseInt(h),this.b=parseInt(a)}null!=s&&(this.a=parseFloat(s))},getRgb:function(){return"rgb("+this.r+","+this.g+","+this.b+")"},getRgba:function(){return"rgba("+this.r+","+this.g+","+this.b+","+this.a+")"},getOpacity:function(){return this.a},setOpacity:function(t){this.a=t},zero_fill_hex:function(t,s){for(var n=t.toString(16);n.length<s;)n="0"+n;return n},getHex:function(){var t=this.getRgb();if("#"==t.charAt(0))return t;var s=t.split(/\D+/),n=65536*Number(s[1])+256*Number(s[2])+Number(s[3]);return"#"+this.zero_fill_hex(n,6)},clone:function(){var t=new GeoBeans.Color;return t.r=this.r,t.g=this.g,t.b=this.b,t.a=this.a,t},setByHsl:function(t,s,n,i){var r,e,a;if(0==s)r=e=a=n;else{var h=function(t,s,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?t+6*(s-t)*n:n<.5?s:n<2/3?t+(s-t)*(2/3-n)*6:t},l=n<.5?n*(1+s):n+s-n*s,u=2*n-l;r=h(u,l,t+1/3),e=h(u,l,t),a=h(u,l,t-1/3)}this.r=Math.round(255*r),this.g=Math.round(255*e),this.b=Math.round(255*a),null!=i&&(this.a=parseFloat(i))},getHsl:function(){var t,s,n=this.r/255,i=this.g/255,r=this.b/255,e=Math.max(n,i,r),a=Math.min(n,i,r),h=(e+a)/2;if(e==a)t=s=0;else{var l=e-a;switch(s=h>.5?l/(2-e-a):l/(e+a),e){case n:t=(i-r)/l+(i<r?6:0);break;case i:t=(r-n)/l+2;break;case r:t=(n-i)/l+4}t/=6}return{h:t,s:s,l:h}}});
GeoBeans.ColorRamp=GeoBeans.Class({beginColor:null,endColor:null,number:null,initialize:function(e,n,o){this.beginColor=e,this.endColor=n,this.number=o},getValues:function(){for(var e,n,o,t,r,i=this.beginColor.slice(1,this.beginColor.length),l=this.endColor.slice(1,this.endColor.length),s=parseInt("0x"+i,16),a=(16711680&s)>>16,h=(65280&s)>>8,u=(255&s)>>0,C=parseInt("0x"+l,16),p=(16711680&C)>>16,b=(65280&C)>>8,g=(255&C)>>0,m=[],c=0;c<=this.number;c++)e=this.interpolateColor(a,p,c,this.number),n=this.interpolateColor(h,b,c,this.number),o=this.interpolateColor(u,g,c,this.number),t=new GeoBeans.Color,t.set(parseInt(e),parseInt(n),parseInt(o),1),r=t.getHex(),m.push(r);return m},interpolateColor:function(e,n,o,t){return e<n?(n-e)*(o/t)+e:(e-n)*(1-o/t)+n}});
GeoBeans.ColorRangeMap=GeoBeans.Class({beginColor:null,endColor:null,min:null,max:null,beginColorHSV:null,endColorHSV:null,initialize:function(o,r,e,i){this.beginColor=o,this.endColor=r,this.min=e,this.max=i;var n=this.beginColor.slice(1,this.beginColor.length),t=this.endColor.slice(1,this.endColor.length),s=parseInt("0x"+n,16),l=(16711680&s)>>16,a=(65280&s)>>8,h=(255&s)>>0;this.beginColorHSV=this.rgb_2_hsv(l,a,h);var g=parseInt("0x"+t,16),C=(16711680&g)>>16,u=(65280&g)>>8,b=(255&g)>>0;this.endColorHSV=this.rgb_2_hsv(C,u,b)},getValue:function(o){var r=this.getColorValue(this.beginColorHSV.h,this.endColorHSV.h,o),e=this.getColorValue(this.beginColorHSV.s,this.endColorHSV.s,o),i=this.getColorValue(this.beginColorHSV.v,this.endColorHSV.v,o),n=this.hsv_2_rgb(r,e,i);return color=new GeoBeans.Color,color.set(parseInt(n.r),parseInt(n.g),parseInt(n.b),1),color},getColorValue:function(o,r,e){var i=null;return i=e<this.min?0:e>this.max?this.max-this.min:e-this.min,o<r?(r-o)*(i/(this.max-this.min))+o:(o-r)*(1-i/(this.max-this.min))+r},rgb_2_hsv:function(o,r,e){var i,n,t,s=Math.min(o,r,e),l=Math.max(o,r,e);t=l;var a=l-s;return 0==l?(n=0,i=-1,{h:i,s:n,v:t}):(n=a/l,i=o==l?(r-e)/a:r==l?2+(e-o)/a:4+(o-r)/a,i*=60,i<0&&(i+=360),{h:i,s:n,v:parseFloat(t/255)})},hsv_2_rgb:function(o,r,e){var i,n,t;if(0==r)return i=n=t=e,{r:255*i,g:255*n,b:255*t};o/=60;var s=Math.floor(o),l=o-s,a=e*(1-r),h=e*(1-r*l),g=e*(1-r*(1-l));switch(s){case 0:i=e,n=g,t=a;break;case 1:i=h,n=e,t=a;break;case 2:i=a,n=e,t=g;break;case 3:i=a,n=h,t=e;break;case 4:i=g,n=a,t=e;break;default:i=e,n=a,t=h}return{r:255*i,g:255*n,b:255*t}}});
GeoBeans.Cookie=GeoBeans.Class({initialize:function(){},setCookie:function(e,o,i){var n=new Date;n.setTime(n.getTime()+864e5);var t=e+"="+escape(o)+";expires="+n.toGMTString();null!=i&&(t+=";path="+i),document.cookie=t},getCookie:function(e){var o=document.cookie.match(new RegExp("(^| )"+e+"=([^;]*)(;|$)"));return null!=o?unescape(o[2]):null},delCookie:function(e,o){var i=new Date;i.setTime(i.getTime()-1);var n=this.getCookie(e);if(null!=n){var t=e+"="+n+";expires="+i.toGMTString();null!=o&&(t+=";path="+o),document.cookie=t}}});
GeoBeans.Envelope=GeoBeans.Class({xmin:null,xmax:null,ymin:null,ymax:null,initialize:function(i,t,n,m){this.xmin=i,this.ymin=t,this.xmax=n,this.ymax=m},getWidth:function(){return this.xmax-this.xmin},getHeight:function(){return this.ymax-this.ymin},getCenter:function(){var i=(this.xmin+this.xmax)/2,t=(this.ymin+this.ymax)/2,n=new GeoBeans.Geometry.Point(i,t);return n},offset:function(i,t){this.xmin+=i,this.xmax+=i,this.ymin+=t,this.ymax+=t},union:function(i){this.xmin=this.xmin<i.xmin?this.xmin:i.xmin,this.xmax=this.xmax>i.xmax?this.xmax:i.xmax,this.ymin=this.ymin<i.ymin?this.ymin:i.ymin,this.ymax=this.ymax>i.ymax?this.ymax:i.ymax},contain:function(i,t){return i>this.xmin&&i<this.xmax&&t>this.ymin&&t<this.ymax},scale:function(i){var t=(this.xmin+this.xmax)/2,n=(this.ymin+this.ymax)/2,m=(this.xmax-this.xmin)*i/2,x=(this.ymax-this.ymin)*i/2;this.xmin=t-m,this.xmax=t+m,this.ymin=n-x,this.ymax=n+x},toString:function(){var i="";return i+=this.xmin+",",i+=this.ymin+",",i+=this.xmax+",",i+=this.ymax},equal:function(i){return this.xmin==i.xmin&&this.xmax==i.xmax&&this.ymin==i.ymin&&this.ymax==i.ymax},intersects:function(i){var t=this.xmin>i.xmin?this.xmin:i.xmin,n=this.xmax<i.xmax?this.xmax:i.xmax,m=this.ymin>i.ymin?this.ymin:i.ymin,x=this.ymax<i.ymax?this.ymax:i.ymax;return t<n&&m<x}});
GeoBeans.Control=GeoBeans.Class({type:null,map:null,enabled:!0,initialize:function(n){},destory:function(){},attach:function(n){this.map=n},detach:function(){this.map=map},enable:function(n){this.enabled=n}}),GeoBeans.Control.Type={SCROLL_MAP:"SrollMapControl",DRAG_MAP:"DragMapControl",TRACK:"TrackControl",TRACKBUFFER:"TrackBufferControl",TRACKTRANSACTION:"TrackTransactionControl",TRACKOVERLAY:"TrackOverlayControl",HIT_FEATURE:"FeatureHitControl",NAV:"navControl",ZOOM:"zoom"},GeoBeans.Control.Controls=GeoBeans.Class({map:null,controls:[],initialize:function(n){this.map=n,this.controls=[]},destory:function(){this.controls=null},add:function(n){if(null!=n&&"undefined"!=n){var t=this.find(n.type);t<0?(n.attach(this.map),this.controls.push(n)):(this.controls[t]=null,this.controls[t]=n)}},remove:function(n){if(null!=n&&"undefined"!=n){var t=this.find(n.type);t>=0&&(this.controls[t]=null,this.controls[t].splice(t,1))}},get:function(n){return this.controls[n]},find:function(n){for(var t=this.controls.length,o=0;o<t;o++){var l=this.controls[o];if(null!=l&&l.type==n)return o}return-1},cleanup:function(){for(var n=this.controls.length,t=0;t<n;t++)this.controls[t].destory(),this.controls[t]=null;this.controls=[]}});
GeoBeans.Event={CLICK:"click",DCLICK:"dblclick",MOUSE_DOWN:"mousedown",MOUSE_UP:"mouseup",MOUSE_MOVE:"mousemove",MOUSE_OVER:"mouseover",MOUSE_OUT:"mouseout",RESIZE:"resize",MOUSE_WHEEL:"mousewheel"},GeoBeans.Event.MouseButton={LEFT:"left",RIGHT:"right",MID:"mid"},GeoBeans.Event.MouseArgs=function(){},GeoBeans.Events=GeoBeans.Class({events:null,initialize:function(){this.events=[]},destory:function(){this.events=null},addEvent:function(e,n){this.events.push({event:e,handler:n})},getEvnet:function(e){for(var n=this.events,t=0;t<n;t++){var s=this.events[t];if(s.event==e)return s}return null}});
GeoBeans.Feature=GeoBeans.Class({featureType:null,fid:null,geometry:null,values:null,symbolizer:null,initialize:function(e,l,t,u){this.featureType=e,this.fid=l,this.geometry=t,this.values=u},destroy:function(){this.featureType=null,this.geometry=null,this.values=null}});
GeoBeans.FeatureType=GeoBeans.Class({workspace:null,name:null,title:null,keywords:null,srs:null,extent:null,fields:null,geomFieldName:null,count:null,minMaxValue:null,callback_obj:null,initialize:function(e,t){this.workspace=e,this.name=t},destory:function(){this.workspace=null,this.name=null,this.title=null,this.keywords=null,this.srs=null,this.extent=null,this.geomFieldName=null},setName:function(e){this.name=e},setTitle:function(e){this.title=e},setKeywords:function(e){this.keywords=e},setSrs:function(e){this.srs=e},setExtent:function(e){this.extent=e},getFields:function(e,t){if(null!=this.fields&&0!=this.fields.length)return this.fields;var n=this,r=this.workspace.server,s="service="+this.workspace.service+"&version="+this.workspace.version+"&request=describeFeatureType&typeName="+this.name;return null!=e&&(s+="&mapName="+e),null!=t&&(s+="&sourceName="+t),$.ajax({type:"get",url:r,data:encodeURI(s),dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,t){n.fields=n.parseFields(e)},complete:function(e,t){},error:function(){}}),this.fields},getFieldIndex:function(e){for(var t=this.getFields(),n=0,r=t.length;n<r;n++){var s=t[n];if(s.name==e)return n}return-1},parseFields:function(e){if(0!=$(e).find("ExceptionText").length){var t=$(e).find("ExceptionText").text();return t}var n=this,r=null,s=new Array;return $(e).find("xsd\\:sequence").children().each(function(){r=n.parseField(this),s.push(r)}),s},parseField:function(e){var t=$(e).attr("name"),n=($(e).attr("nillable"),$(e).attr("type")),r=this.parseFieldType(n),s=$(e).attr("length"),a=new GeoBeans.Field(t,r,this,s);if(r==GeoBeans.FieldType.GEOMETRY){var i=this.parseGeometryType(n);a.setGeomType(i),this.geomFieldName=t}return a},parseFieldType:function(e){return"gml"==e.substr(0,3)?GeoBeans.FieldType.GEOMETRY:e.substring(4,e.length)},parseGeometryType:function(e){return e.substr(4,e.length-16)},getFeatures:function(e,t,n,r,s){var a=this,i=this.workspace.server,o="service="+this.workspace.service+"&version="+this.workspace.version+"&request=getFeature&typeName="+this.name;null!=e&&(o+="&mapName="+e),null!=t&&(o+="&sourceName="+t),null!=n&&(o+="&maxFeatures="+n),null!=r&&(o+="&offset="+r);var l="";if(null!=s)for(var u=0;u<s.length;++u)l+=s[u],u<s.length-1&&(l+=",");return 0!=l.length&&(o+="&fields="+l),a.fields=a.getFields(e,t),$.ajax({type:"get",url:i,data:encodeURI(encodeURI(o)),dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,t){var n=a.parseFeatures(e);a.features=n},complete:function(e,t){},error:function(){}}),this.features},getFeaturesAsync:function(e,t,n,r,s,a){var i=this,o=this.workspace.server,l="service="+this.workspace.service+"&version="+this.workspace.version+"&request=getFeature&typeName="+this.name;null!=e&&(l+="&mapName="+e),null!=t&&(l+="&sourceName="+t),null!=n&&(l+="&maxFeatures="+n),null!=r&&(l+="&offset="+r);var u="";if(null!=s)for(var c=0;c<s.length;++c)u+=s[c],c<s.length-1&&(u+=",");0!=u.length&&(l+="&fields="+u),i.fields=i.getFields(e,t),$.ajax({type:"get",url:o,data:encodeURI(encodeURI(l)),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=i.parseFeatures(e);void 0!=a&&a(n)},complete:function(e,t){},error:function(e,t,n){console.log("textStatus:"+t),console.log("error:"+n)}})},getFeatureBBoxGet:function(e,t,n,r,s){var a=this,i=this.workspace.server,o="service="+this.workspace.service+"&version="+this.workspace.version+"&request=getFeature&typeName="+this.name;if(null!=e&&(o+="&mapName="+e),null!=t&&(o+="&sourceName="+t),null!=n){var l=n.xmin,u=n.xmax,c=n.ymin,p=n.ymax,f="";f=u-l<.01?n.toString():l.toFixed(6)+","+c.toFixed(6)+","+u.toFixed(6)+","+p.toFixed(6),o+="&bbox="+f}return null!=r&&(o+="&maxFeatures="+r),null!=s&&(o+="&offset="+s),a.fields=a.getFields(e,t),$.ajax({type:"get",url:i,data:encodeURI(o),dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,t){var n=a.parseFeatures(e);a.features=n},complete:function(e,t){},error:function(){}}),a.features},getFeatureBBoxGetOutput:function(e,t,n,r,s){var a=this.workspace.server,i="service="+this.workspace.service+"&version="+this.workspace.version+"&request=getFeature&typeName="+this.name;if(null!=e&&(i+="&mapName="+e),null!=t&&(i+="&sourceName="+t),null!=n){var o=n.xmin,l=n.xmax,u=n.ymin,c=n.ymax,p=o.toFixed(2)+","+u.toFixed(2)+","+l.toFixed(2)+","+c.toFixed(2);i+="&bbox="+p}return null!=r&&(i+="&maxFeatures="+r),null!=s&&(i+="&offset="+s),i+="&outputformat=shape-zip",a+"?"+i},getFeaturesBBox:function(e,t,n){var r=t.xmin,s=t.xmax,a=t.ymin,i=t.ymax,o=(r.toFixed(2)+","+a.toFixed(2)+","+s.toFixed(2)+","+i.toFixed(2),this),l=this.workspace.server,u=this.buildGetFeatureXMLBboxFilter(t,n);$.ajax({type:"post",url:l,data:u,contentType:"text/xml",dataType:"xml",async:!0,beforeSend:function(e){},success:function(t,n){var r=o.parseFeatures(t);void 0!=e&&e(o,r)},complete:function(e,t){},error:function(){}})},parseFeatures:function(e){var t=this,n=null,r=new Array,s=new GeoBeans.Geometry.GML.Reader(GeoBeans.Geometry.GML.Version.v_2_0);return $(e).find("gml\\:featureMember").each(function(){n=t.parseFeature($(this).children()[0],s),r.push(n)}),r},parseFeature:function(e,t){for(var n=this.parseFID($(e).attr("fid")),r=(this.getFields(),new Array),s=null,a=null,i=this.fields.length,o=0;o<i;o++)if(a=this.fields[o],a.type==GeoBeans.FieldType.GEOMETRY){var l=$(e).find("world\\:"+a.name+":first").children()[0];null==l?r.push(null):(s=t.read(l),r.push(s))}else{var u=$(e).find("world\\:"+a.name+":first");r.push(null==u||0==u.length?null:u.text())}return new GeoBeans.Feature(this,n,s,r)},parseFID:function(e){var t=e.indexOf(".");return e.substring(t+1,e.length)},buildGetFeatureXMLBboxFilter:function(e,t){var n="",r=this.workspace.workspaceName,s='xmlns:wfs="http://www.opengis.net/wfs"',a="xmlns:"+r+'="'+this.workspace.xmlnsWorkspace+'"',i='xmlns:gml="http://www.opengis.net/gml"',o='xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"',l='xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.0.0/WFS-basic.xsd"',u='xmlns:ogc="http://www.opengis.net/ogc" ';n+='<wfs:GetFeature service="WFS" version="1.0.0"  '+s+" "+u+" "+a+" "+i+" "+o+" "+l+'><wfs:Query typeName="'+this.name+'"><ogc:Filter>';var c="",p="";if(null!=e&&void 0!=e&&(p+="<ogc:BBOX><gml:Box><gml:coordinates>"+e.xmin+","+e.ymin+" "+e.xmax+","+e.ymax+"</gml:coordinates></gml:Box></ogc:BBOX>"),null!=t&&void 0!=t){var f=t.field,m=t.value;c+="<ogc:PropertyIsEqualTo><ogc:PropertyName>"+f+"</ogc:PropertyName><ogc:Literal>"+m+"</ogc:Literal></ogc:PropertyIsEqualTo>"}return""!=c&&""!=p?n+="<And>"+c+p+"</And>":""!=c&&""==p?n+=c:""==c&&""!=p&&(n+=p),n+="</ogc:Filter></wfs:Query></wfs:GetFeature>"},getCount:function(e,t,n){var r=this,s=this.workspace.server,a="service="+this.workspace.service+"&version="+this.workspace.version+"&request=GetCount&typeName="+this.name;return null!=e&&(a+="&mapName="+e),null!=t&&(a+="&sourceName="+t),null!=n&&(a+="&bbox="+n.toString()),$.ajax({type:"get",url:s,data:encodeURI(a),dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,t){r.count=r.parseCount(e)},complete:function(e,t){},error:function(){}}),r.count},parseCount:function(e){if(0!=$(e).find("ExceptionText").length){var t=$(e).find("ExceptionText").text();if(""!=t)return t}var n=$(e).find("Count").text();return parseInt(n)},getFeaturesWithin:function(e,t,n){var r=this,s=this.workspace.server,a=this.buildGetFeaturesXMLWithin(e,t,n);return $.ajax({type:"post",url:s,contentType:"text/xml",dataType:"xml",data:a,async:!1,beforeSend:function(e){},success:function(e,t){var n=r.parseFeatures(e);r.features=n},complete:function(e,t){},error:function(){}}),r.features},getFeaturesWithinAsync:function(e,t,n,r,s,a){var i=this,o=this.workspace.server,l=this.buildGetFeaturesXMLWithin(e,t,n,s);$.ajax({type:"post",url:o,contentType:"text/xml",dataType:"xml",data:l,async:!0,beforeSend:function(e){},success:function(e,t){var n=i.parseFeatures(e);void 0!=r&&r(a,n)},complete:function(e,t){},error:function(){}})},buildGetFeaturesXMLWithin:function(e,t,n,r){var s="";s+='<wfs:GetFeature service="WFS" version="1.1.0" ',null!=e&&(s+='mapName="'+e+'" '),null!=t&&(s+='sourceName="'+t+'" ');var a="";if(null!=r)for(var i=0;i<r.length;++i){var o=r[i];null!=o&&(a+="<wfs:PropertyName>"+o+"</wfs:PropertyName>")}var l=new GeoBeans.Geometry.GML.Writer(GeoBeans.Geometry.GML.Version.v_2_0),u=l.write(n);return s+='xmlns:world="www.world.ac.cn" xmlns:wfs="http://www.opengis.net/wfs" xmlns:gml="http://www.opengis.net/gml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd"><wfs:Query typeName="'+this.name+'">'+a+"\t<Filter>\t\t<Within>\t\t\t<PropertyName>"+this.geomFieldName+"</PropertyName>"+u+"\t\t</Within>\t</Filter></wfs:Query></wfs:GetFeature>"},getFeaturesFilter:function(e,t,n,r,s,a,i){var o=this,l=this.workspace.server,u=this.buildGetFeatureFilterXML(e,t,n,r,s,a,i);return this.fields=this.getFields(e,t),$.ajax({type:"post",url:l,data:u,contentType:"text/xml",dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,t){var n=o.parseFeatures(e);o.features=n},complete:function(e,t){},error:function(){}}),o.features},getFeaturesFilterAsync:function(e,t,n,r,s,a,i,o){var l=this,u=this.workspace.server,c=this.buildGetFeatureFilterXML(e,t,n,r,s,a,i);this.fields=this.getFields(e,t),$.ajax({type:"post",url:u,data:c,contentType:"text/xml",dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=l.parseFeatures(e);void 0!=o&&o(n)},complete:function(e,t){},error:function(e,t,n){console.log("textStatus:"+t),console.log("error:"+n)}})},getFeaturesFilterAsync2:function(e,t,n,r,s,a,i,o,l){var u=this,c=this.workspace.server,p=this.buildGetFeatureFilterXML(e,t,n,r,s,a);this.fields=this.getFields(e,t),this.callback_obj=o;var f=$.ajax({type:"post",url:c,data:p,contentType:"text/xml",dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=u.parseFeatures(e);void 0!=l&&l(u.callback_obj,n)},complete:function(e,t){},error:function(e,t,n){}});return f},buildGetFeatureFilterXML:function(e,t,n,r,s,a,i){var o='<?xml version="1.0" encoding="UTF-8"?><wfs:GetFeature service="WFS" version="1.0.0" outputFormat="GML2" xmlns:wfs="http://www.opengis.net/wfs" xmlns:ogc="http://www.opengis.net/ogc" xmlns:gml="http://www.opengis.net/gml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd" ';null!=e&&(o+='mapName="'+e+'" '),null!=t&&(o+='sourceName="'+t+'" '),null!=r&&(o+='maxFeatures="'+r+'" '),null!=s&&(o+='offset="'+s+'" '),o+="/>";var l=$.parseXML(o),u=l.createElement("wfs:Query");if($(u).attr("typeName",this.name),null!=a)for(var c=0;c<a.length;++c){var p=l.createElement("wfs:PropertyName");$(p).text(a[c]),$(u).append(p)}var f=new GeoBeans.FilterWriter,m=f.write(l,n);if($(u).append(m),null!=i){var h=this.buildOrderbyXML(l,i);$(u).append(h)}$("wfs\\:GetFeature",l).append(u);var d=(new XMLSerializer).serializeToString(l);return d},buildOrderbyXML:function(e,t){if(null==t)return"";var n=e.createElement("ogc:OrderBy"),r=t.isAsc();r?$(n).attr("order","asc"):$(n).attr("order","desc");for(var s=t.getFieldCount(),a=null,i=null,o=0;o<s;++o)i=t.getField(o),null!=i&&(a=e.createElement("wfs:PropertyName"),$(a).text(i),$(n).append(a));return n},getFeatureFilterCount:function(e,t,n){var r=this,s=this.workspace.server,a=this.buildGetFeatureFilterCountXML(e,t,n);return $.ajax({type:"post",url:s,data:a,contentType:"text/xml",dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,t){r.count=r.parseCount(e)},complete:function(e,t){},error:function(){}}),r.count},buildGetFeatureFilterCountXML:function(e,t,n){var r='<?xml version="1.0" encoding="UTF-8"?><wfs:GetCount service="WFS" version="1.0.0" outputFormat="GML2" xmlns:world="www.world.ac.cn" xmlns:wfs="http://www.opengis.net/wfs" xmlns:ogc="http://www.opengis.net/ogc" xmlns:gml="http://www.opengis.net/gml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd" ';null!=e&&(r+='mapName="'+e+'" '),null!=t&&(r+='sourceName="'+t+'" '),r+="/>";var s=$.parseXML(r),a=s.createElement("wfs:Query");$(a).attr("typeName",this.name);var i=new GeoBeans.FilterWriter,o=i.write(s,n);$(a).append(o),$("wfs\\:GetCount",s).append(a);var l=(new XMLSerializer).serializeToString(s);return l},getFeatureFilterCountAsync:function(e,t,n,r,s){var a=this,i=this.workspace.server,o=this.buildGetFeatureFilterCountXML(e,t,n);return this.callback_obj=r,$.ajax({type:"post",url:i,data:o,contentType:"text/xml",dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.parseCount(e);null!=s&&s(a.callback_obj,n)},complete:function(e,t){},error:function(){}}),a.count},getFeatureFilterOutput:function(e,t,n,r,s){var a=this.workspace.server,i='<?xml version="1.0" encoding="UTF-8"?><a/>',o=$.parseXML(i),l=new GeoBeans.FilterWriter,u=l.write(o,n);$(u).attr("xmlns:ogc","http://www.opengis.net/ogc"),$(u).attr("xmlns:gml","http://www.opengis.net/gml");var c=(new XMLSerializer).serializeToString(u),p="service="+this.workspace.service+"&version="+this.workspace.version+"&request=getFeature&typeName="+this.name+"&outputFormat=shape-zip&filter="+c;return null!=e&&(p+="&mapName="+e),null!=t&&(p+="&sourceName="+t),a+"?"+p},getMinMaxValue:function(e,t,n,r){if(null==r){var s=this.getMinMaxValueSyn(e,t,n);return s}this.getMinMaxValueAsync(e,t,n,r)},getMinMaxValueSyn:function(e,t,n){if(null==e)return null;var r=this,s=this.workspace.server,a="service="+this.workspace.service+"&version="+this.workspace.version+"&request=GetValue&typeName="+this.name+"&field="+e+"&type=minmax";return null!=t&&(a+="&mapName="+t),null!=n&&(a+="&sourceName="+n),$.ajax({type:"get",url:s,data:encodeURI(encodeURI(a)),dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,t){var n=r.pareseMinMaxValue(e);this.minMaxValue=n},complete:function(e,t){},error:function(){}}),this.minMaxValue},getMinMaxValueAsync:function(e,t,n,r){if(null!=e){var s=this,a="service="+this.workspace.service+"&version="+this.workspace.version+"&request=GetValue&typeName="+this.name+"&field="+e+"&type=minmax";null!=t&&(a+="&mapName="+t),null!=n&&(a+="&sourceName="+n);var i=this.workspace.server;$.ajax({type:"get",url:i,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=s.pareseMinMaxValue(e);r(n)},complete:function(e,t){},error:function(){}})}},pareseMinMaxValue:function(e){var t=$(e).find("wfs\\:Min").text(),n=$(e).find("wfs\\:Max").text(),r=new Object;return r.min=t,r.max=n,r}});
GeoBeans.FieldType={DOUBLE:"double",STRING:"string",GEOMETRY:"geometry"},GeoBeans.Field=GeoBeans.Class({featureType:null,name:null,type:null,geomType:null,length:null,initialize:function(e,n,t,l){this.name=e,this.type=n,this.featureType=t,this.length=l},destroy:function(){this.name=null,this.type=null,this.featureType=null},setGeomType:function(e){this.geomType=e}});
GeoBeans.Filter=GeoBeans.Class({type:null,initialize:function(){},clone:function(){var e=new GeoBeans.Filter;return e.type=this.type,e}}),GeoBeans.Filter.Type={FilterID:"id",FilterComparsion:"comparsion",FilterLogic:"logic",FilterSpatial:"spatial"};
GeoBeans.FontManager=GeoBeans.Class({fonts:[],server:null,version:null,initialize:function(n,t){this.server=n,this.version=t},getFonts:function(){if(null!=this.fonts){if(0!=this.fonts.length)return this.fonts;var n=this,t="service=ims&version="+this.version+"&request=GetFont";return+name,$.ajax({type:"get",url:this.server,data:encodeURI(t),dataType:"xml",async:!1,beforeSend:function(n){},success:function(t,e){n.fonts=n.parseFonts(t)},complete:function(n,t){},error:function(){}}),n.fonts}},parseFonts:function(n){var t=[];return $(n).find("font").each(function(){var n=new Object,e=$(this).attr("face"),s=$(this).attr("family");n.face=e,n.family=s,t.push(n)}),t}});
GeoBeans.Geometry=GeoBeans.Class({id:null,extent:null,initialize:function(){},destory:function(){this.id=null,this.extent=null},getCentroid:function(){},hit:null}),GeoBeans.Geometry.Type={POINT:"Point",LINESTRING:"LineString",POLYGON:"Polygon",MULTIPOINT:"MultiPoint",MULTILINESTRING:"MultiLineString",MULTIPOLYGON:"MultiPolygon",CIRCLE:"Circle"},GeoBeans.Geometry.fromWKT=function(n){};
GeoBeans.InfoWindow=GeoBeans.Class({width:300,height:200,title:"Info",content:null,initialize:function(t,n){if(this.content=t,null!=n){var i=n.width;null!=i&&(this.width=i);var e=n.height;null!=e&&(this.height=e);var l=n.title;null!=l&&(this.title=l)}},getContent:function(){return this.content},getTitle:function(){return this.title}});
GeoBeans.JobManager=GeoBeans.Class({service:"ims",version:"1.0.0",server:null,initialize:function(t){this.server=t+"/mgr"},getJobStatistics:function(t,e,i,n,s){if(null==t||null==i||null==n)return void(null!=s&&s("params is valid"));var r="service="+this.service+"&version="+this.version+"&request=JobStatistics&field="+t+"&startTime="+i+"&endTime="+n;null!=e&&(r+="&client="+e);var a=this;$.ajax({type:"get",url:this.server,data:encodeURI(r),dataType:"xml",async:!0,beforeSend:function(t){},success:function(t,e){var i=a.parseStatistics(t);null!=s&&s(i)},complete:function(t,e){},error:function(){}})},parseStatistics:function(t){if(null!=t){var e=[];return $(t).find("Item").each(function(){var t=$(this).attr("key"),i=$(this).attr("count");e.push({key:t,count:i})}),e}},getJob:function(t,e,i){if(null==t||null==e)return void(null!=i&&i("params is not valid"));var n="service="+this.service+"&version="+this.version+"&request=GetJob&maxJobs="+t+"&offset="+e,s=this;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(t){},success:function(t,e){var n=s.parseJob(t);null!=i&&i(n)},complete:function(t,e){},error:function(){}})},parseJob:function(t){if(null==t)return null;var e=[];return $(t).find("Job").each(function(){var t=$(this).find("Operation").text(),i=$(this).find("Params").text(),n=$(this).find("Client").text(),s=$(this).find("Server").text(),r=$(this).find("StartTime").text(),a=$(this).find("EndTime").text(),o=$(this).find("State").text();e.push({operation:t,params:i,client:n,server:s,startTime:r,endTime:a,state:o})}),e}});
GeoBeans.Label=GeoBeans.Class({text:null,geometry:null,textSymbolizer:null,geometryType:null,initialize:function(){this.geometryType=GeoBeans.Geometry.Type.POINT},isCollision:function(e){return!0},computePosition:function(e,n){},adjustPosition:function(e,n){}});
GeoBeans.Layer=GeoBeans.Class({id:null,name:null,visible:!0,srid:"EPSG:4326",extent:null,map:null,events:null,canvas:null,renderer:null,mapPoint_lt:null,mapPoint_rb:null,transformation_brf:null,flag:null,initialize:function(n){this.name=n,this.events=new GeoBeans.Events,this.flag=GeoBeans.Layer.Flag.READY},destroy:function(){this.name=null,this.events=null},setName:function(n){this.name=n},setMap:function(n){this.map=n;var t=this.map.canvas;if(null!=t){var e=t.height,a=t.width;this.canvas=document.createElement("canvas"),this.canvas.height=e,this.canvas.width=a,this.renderer=new GeoBeans.Renderer(this.canvas)}},setVisiable:function(n){this.visible=n},getExtent:function(){return this.extent},draw:null,load:null,unregisterEvents:function(){},cleanup:function(){},setTransformation:function(n){null!=n&&null!=n.view_c&&(this.transformation_brf=new GeoBeans.Transformation,this.transformation_brf.map=n.map,this.transformation_brf.scale=n.scale,this.transformation_brf.view_c=new GeoBeans.Geometry.Point(n.view_c.x,n.view_c.y),this.transformation_brf.view_h=n.view_h,this.transformation_brf.view_w=n.view_w,this.transformation_brf.win_cx=n.win_cx,this.transformation_brf.win_cy=n.win_cy,this.transformation_brf.win_h=n.win_h,this.transformation_brf.win_w=n.win_w)},drawLayerSnap:function(){var n=this.map.transformation,t=this.map.viewer;if(null!=t){var e=new GeoBeans.Geometry.Point(t.xmin,t.ymax),a=new GeoBeans.Geometry.Point(t.xmax,t.ymin),i=this.transformation_brf.toScreenPoint(e.x,e.y),r=this.transformation_brf.toScreenPoint(a.x,a.y),s=r.x-i.x,o=r.y-i.y;this.renderer.context.drawImage(this.canvas,i.x,i.y,s,o,0,0,this.map.canvas.width,this.map.canvas.height),this.map.renderer.drawImage(this.canvas,0,0),this.setTransformation(n)}},up:function(n){if(!(this instanceof GeoBeans.Layer.DBLayer))return void(null!=n&&n("不支持此操作"));for(var t=this.map.groupLayer.getLayers(),e=0;e<t.length;++e){var a=t[e];if(a==this){var i=e-1,r=t[i];if(null==r)return void(null!=n&&n("已经是底层图层"));for(var s=e;s>i;--s)t[s]=t[s-1];return t[i]=this,void(null!=n&&n("success"))}}null!=n&&n("调整顺序失败")},down:function(n){if(!(this instanceof GeoBeans.Layer.DBLayer))return void(null!=n&&n("不支持此操作"));for(var t=this.map.groupLayer.getLayers(),e=0;e<t.length;++e){var a=t[e];if(a==this){var i=e+1,r=t[i];if(null==r)return void(null!=n&&n("已经是顶层图层"));for(var s=e;s<i;++s)t[s]=t[s+1];return t[i]=this,void(null!=n&&n("success"))}}null!=n&&n("调整顺序失败")},CLASS_NAME:"GeoBeans.Layer"}),GeoBeans.Layer.Flag={READY:"ready",LOADED:"loaded",ERROR:"error"};
GeoBeans.Map=GeoBeans.Class({TOLERANCE:20,mapDiv:null,canvas:null,events:null,controls:null,viewer:null,center:null,level:null,resolution:null,layers:null,baseLayer:null,overlayLayer:null,srid:4326,minScale:null,maxScale:null,width:null,height:null,renderer:null,bgColor:"rgba(255,255,255,1)",tolerance:5,transformation:null,dragable:!0,snap:null,groupLayer:null,mapWorkspace:null,server:null,tracker:null,queryLayer:null,queryTrackLayer:null,queryGeometry:null,infoWindow:null,totalFlag:!0,drawLocalFlag:!1,panoramaLayer:null,imageLayer:null,legendList:null,hitRippleLayers:null,animateCanvas:null,baseLayerCanvas:null,authTime:null,thumbnail:null,initialize:function(e,t,a,r,n,i){var s=document.getElementById(t);if(null==s)return null;s.innerHTML="",null!=r?this.extent=r:this.extent=new GeoBeans.Envelope((-180),(-90),180,90),null!=n&&(this.srid=n),null!=i?this.viewer=i:this.viewer=this.extent,this.server=e,this.id=t,this.name=a,this.mapWorkspace=new GeoBeans.MapWorkspace(this.server,this),this.layers=[],this.legendList=[],this.mapDiv=$("#"+t);var l=this.id+"_canvas",o="<canvas id='"+l+"' class='mapCanvas' height='"+$("#"+t).height()+"' width='"+$("#"+t).width()+"'></canvas>";$("#"+t).append(o),this.canvas=document.getElementById(l),this.width=$("#"+t).width(),this.height=$("#"+t).height(),this.center=new GeoBeans.Geometry.Point(0,0),this.transformation=new GeoBeans.Transformation(this),this.renderer=new GeoBeans.Renderer(this.canvas),this.controls=new GeoBeans.Control.Controls(this);var h=new GeoBeans.Control.DragMapControl(this);h.enable(!0),this.controls.add(h);var u=new GeoBeans.Control.SrollMapControl(this);u.enable(!0),this.controls.add(u);var y=new GeoBeans.Control.TrackControl;this.tracker=y,this.controls.add(y);var c=new GeoBeans.Control.ZoomControl;this.controls.add(c),null==this.mapNavControl&&(this.mapNavControl=new GeoBeans.Control.MapNavControl(this),this.mapNavControl.setEnable(!1)),this.overlayLayer=new GeoBeans.Layer.OverlayLayer("overlay"),this.overlayLayer.setMap(this),this.groupLayer=new GeoBeans.Layer.GroupLayer(this.server,this.name),this.groupLayer.setMap(this),this.panoramaLayer=new GeoBeans.Layer.PanoramaLayer("panorama"),this.panoramaLayer.setMap(this),this.imageLayer=new GeoBeans.Layer.ImageLayer("imageLayer"),this.imageLayer.setMap(this),this.hitRippleLayers=[],null!=this.viewer&&this.setViewer(this.viewer);var v,p=this;window.onresize=function(e){clearTimeout(v),v=setTimeout(function(){var t=p.mapDiv.height(),a=p.mapDiv.width();if(0!=t&&0!=a&&(t!=p.canvas.height||a!=p.canvas.width)){console.log("before:height["+p.canvas.height+"]"),console.log("before:width["+p.canvas.width+"]"),p.canvas.height=t,p.canvas.width=a,console.log("after:height["+p.canvas.height+"]"),console.log("after:width["+p.canvas.width+"]"),p.height=t,p.width=a;var r=p.viewer;if(null!=r){var n=r.xmin,i=r.xmax,s=r.ymin,l=r.ymax;if(!($.isNumeric(n)&&$.isNumeric(i)&&$.isNumeric(s)&&$.isNumeric(l)))return}if(null!=p.viewer){if(null!=p.baseLayer){var o=p.baseLayer.canvas;null!=o&&(o.height=t,o.width=a),p.baseLayer.scale=1;var h=p.level;p.resolution=p.baseLayer.getResolution(h),p.updateMapExtent(p.resolution);var u=p.center;p.setCenter(u)}var y=null;y="width"==e?p.scaleViewWidth(p.viewer):"height"==e?p.scaleViewHeight(p.viewer):p.scaleView(p.viewer),p.viewer=y,console.log(p.viewer.toString()),p.transformation.update();for(var c=p.getLayers(),v=0;v<c.length;++v){var d=c[v];if(null!=d){var g=d.canvas;null!=g&&(g.height=t,g.width=a);var L=d.bufferCanvas;null!=L&&(L.height=t,L.width=a);var f=d.featureLayerCanvas;null!=f&&(f.height=t,f.width=a)}}var m=p.groupLayer;null!=m&&(m.canvas.height=t,m.canvas.width=a,m.flag=GeoBeans.Layer.Flag.READY),p.draw()}}},250)};var d=window.onresize;d.apply(window,[]),this.queryLayer=new GeoBeans.Layer.FeatureLayer.QueryLayer("query"),this.queryLayer.setMap(this);var g="<div class='infoWindow' data-toggle='popover' title='Info' data-content=''></div>";$("#"+t).append(g),this.infoWindow=this.mapDiv.find(".infoWindow"),void 0!=this.infoWindow&&void 0!=this.infoWindow.popover&&this.infoWindow.popover({animation:!1,trigger:"manual",placement:"top",html:!0});var L="<div class='map5-copyright'>GeoBeans © </div>";$("#"+t).append(L);var f="<div class='map5-tooltip'></div>";this.mapDiv.append(f),this.authTime=new Date("2018-05-26 00:00:00")},destroy:function(){this.mapDiv.find(".chart-legend ").remove(),this.mapDiv.find("canvas").remove(),this.renderer.clearRect(0,0,this.canvas.width,this.canvas.height),this.setNavControl(!1),this.controls.cleanup(),this.infoWindow.popover("destroy"),this.unRegisterMapRippleHitEvent(),this.controls.cleanup(),this.canvas=null,this.animateCanvas=null,this.baseLayerCanvas=null,this.renderer=null,this.layers=null,this.transformation=null,this.controls=null,this.infoWindow=null,this.stopAnimate(),this.mapDiv=null},close:function(){this.destroy()},resize:function(e){var t=window.onresize;t.apply(window,[e])},getLayers:function(){for(var e=[],t=this.groupLayer.getLayers(),a=0;a<t.length;++a)e.push(t[a]);for(var a=0;a<this.layers.length;++a)e.push(this.layers[a]);return e},getLayer:function(e){if(null!=e){for(var t=null,a=this.groupLayer.getLayers(),r=null,n=0;n<a.length;++n)if(r=a[n],r.name==e)return r;for(var n=0;n<this.layers.length;++n){var t=this.layers[n];if(t.name==e)return t}}},addLayer:function(e,t){if(null==e)return void(null!=t&&t("layer is null"));var a=this.getLayer(e.name);if(null!=a)return void(null!=t&&t("this map has ["+e.name+"] layer"));if(null!=e)if(e instanceof GeoBeans.Layer.DBLayer)this.mapWorkspace.registerLayer(e,this.addLayer_callback,t);else if(e instanceof GeoBeans.Layer.WMTSLayer)if(e.setMap(this),null==this.baseLayer){if(this.setBaseLayer(e),null==this.level){var r=this.getLevel(this.viewer);this.setLevel(r)}}else this.layers.push(e);else this.layers.push(e),e.setMap(this),null!=t&&t("success")},addLayer_callback:function(e,t,a,r){e instanceof GeoBeans.Layer?(e instanceof GeoBeans.Layer.DBLayer&&(t.groupLayer.addLayer(e),e.setMap(t)),null!=r&&r("success"),t.draw()):null!=r&&r(e)},initBaseLayer:function(){var e=this.level;null==this.level&&(viewer=this.viewer,e=this.getLevel(viewer)),this.setLevel(e);var t=this.center;null==t&&(t=new GeoBeans.Geometry.Point(0,0),this.setCenter(t))},insertLayer:function(e,t){if(null==e)return void(null!=t&&t("layer is null"));var a=this.getLayer(e.name);return null!=a?void(null!=t&&t("this map has ["+e.name+"] layer")):e instanceof GeoBeans.Layer.DBLayer?void this.mapWorkspace.registerLayer(e,this.insertLayer_callback,t):e instanceof GeoBeans.Layer.TileLayer?null!=this.baseLayer?(this.baseLayer_change=e,void this.unRegisterBaseLayer(t)):void this.mapWorkspace.registerLayer(e,this.insertLayer_callback,t):(this.layers.unshift(e),e.setMap(this),void(null!=t&&t("success")))},insertLayer_callback:function(e,t,a,r){e instanceof GeoBeans.Layer?(e instanceof GeoBeans.Layer.DBLayer?(t.groupLayer.insertLayer(e),e.setMap(t)):e instanceof GeoBeans.Layer.TileLayer&&t.setBaseLayer(e),null!=r&&r("success",a),t.draw()):null!=r&&r(e)},removeLayer:function(e,t){if(null!=e){var a=this.getLayer(e);if(null!=a)if(a instanceof GeoBeans.Layer.DBLayer)this.mapWorkspace.unRegisterLayer(e,this.unRegisterLayer_callback,t);else for(var r=this.layers,n=0;n<r.length;++n)a.name==r[n].name&&(this.layers.splice(n,1),a.destroy(),void 0!=t&&t("success"))}},unRegisterLayer_callback:function(e,t,a,r){var n=t.getLayer(a);"success"==e?(n instanceof GeoBeans.Layer.DBLayer&&t.groupLayer.removeLayer(n),t.draw(),null!=r&&r(e)):null!=r&&r(e)},setStyle:function(e,t,a){var r=this.getLayer(e);r instanceof GeoBeans.Layer.FeatureDBLayer?this.mapWorkspace.setStyle(e,t,this.setStyle_callback,a):r instanceof GeoBeans.Layer.WFSLayer&&(r.setStyle(t),a("set "+r.name+"style "))},setStyle_callback:function(e,t,a,r,n){var i=t.getLayer(a);i instanceof GeoBeans.Layer.DBLayer&&(t.groupLayer.update(),i.update()),"success"==e?(i.setStyle(r),n(e)):n(e)},unRegisterBaseLayer:function(e){null!=this.baseLayer&&this.mapWorkspace.unRegisterLayer(this.baseLayer.name,this.unRegisterBaseLayer_callback,e)},unRegisterBaseLayer_callback:function(e,t,a,r){if("success"==e){if(t.removeBaseLayer(),null!=t.baseLayer_change)return t.insertLayer(t.baseLayer_change,r),void(t.baseLayer_change=null);null!=r&&r("success")}else null!=r&&r(e)},setViewer:function(e){null!=e&&(this.viewer=this.scaleView(e),this.transformation.update())},getViewer:function(){return this.viewer},setCenter:function(e){if(null!=this.viewer){var t=e.x-this.center.x,a=e.y-this.center.y;this.viewer.offset(t,a),this.center=e,this.transformation.update()}else this.center=e},offset:function(e,t){null!=this.viewer?(this.viewer.offset(e,t),this.center.x+=e,this.center.y+=t,this.transformation.update()):(this.center.x+=e,this.center.y+=t)},setLevel:function(e){this.level=e,null!=this.baseLayer&&(this.baseLayer.scale=1,this.resolution=this.baseLayer.getResolution(e),this.updateMapExtent(this.resolution),this.transformation.update())},formulateExtent:function(e){},setResolution:function(e){this.resolution=e},setBaseLayer:function(e){if(null!=this.baseLayer&&this.removeBaseLayer(),this.baseLayer=e,null!=this.baseLayer){var t=this.baseLayerCanvas;if(null==t){var a=this.id+"_canvas",r=this.id+"_basecanvas",n="<canvas  id='"+r+"' class='map5-base-canvas' height='"+this.canvas.height+"' width='"+this.canvas.width+"'></canvas>";this.mapDiv.find("#"+a).after(n),this.baseLayerCanvas=document.getElementById(r)}this.baseLayer.map=this,this.baseLayer.canvas=this.baseLayerCanvas,this.baseLayer.renderer=new GeoBeans.Renderer(this.baseLayerCanvas)}},removeBaseLayer:function(){null!=this.baseLayer&&(this.baseLayer.renderer.clearRect(),this.baseLayerCanvas.remove(),this.baseLayerCanvas=null,this.baseLayerSnap=null,this.baseLayer.destroy(),this.baseLayer=null)},updateMapExtent:function(e){var t=this.center.x,a=this.center.y,r=this.width,n=this.height,i=e*r/2,s=e*n/2,l=t-i,o=t+i,h=a-s,u=a+s;null!=this.viewer?(this.viewer.xmin=l,this.viewer.xmax=o,this.viewer.ymin=h,this.viewer.ymax=u):this.viewer=new GeoBeans.Envelope(l,h,o,u)},getLevel:function(e){var t=e.getCenter().x,a=e.getCenter().y,r=this.width,n=(this.height,t-e.xmin),i=(a-e.ymin,2*n/r);if(null==this.baseLayer)return null;var s=this.baseLayer.getLevel(i);return null==s?1:s},setDrawLayerSingle:function(e){e?this.totalFlag=!1:this.totalFlag=!0},setDrawFeatureLayerLocal:function(e){e?(this.drawLocalFlag=!0,this.setDrawLayerSingle(!0)):this.drawLocalFlag=!1},draw:function(){var e=new Date,t=e.getTime()-this.authTime.getTime();return t>2592e6?void alert("请联系管理员进行授权"):(this.renderer.save(),null!=this.baseLayer?(this.baseLayer.visible?(this.initBaseLayer(),this.baseLayer.preDraw(),this.baseLayer.loadingTiles(this.drawBaseLayerCallback)):this.baseLayer.renderer.clearRect(),this.drawLayersAll()):(this.drawLayersAll(),this.renderer.restore()),void this.mapNavControl.setZoomSlider(this.level))},drawBaseLayerCallback:function(e){},drawHitLayer:function(){this.renderer.clearRect(0,0,this.canvas.width,this.canvas.height),null!=this.baseLayer&&this.renderer.drawImage(this.baseLayer.canvas,0,0,this.baseLayer.canvas.width,this.baseLayer.canvas.height);for(var e=0;e<this.layers.length;++e){var t=this.layers[e],a=t.canvas;this.renderer.drawImage(a,0,0,a.width,a.height);var r=t.hitCanvas;null!=r&&this.renderer.drawImage(r,0,0,r.width,r.height)}},drawLayersAll:function(){0!=this.groupLayer.getLayers().length&&(this.totalFlag?this.groupLayer.loadTotal():this.groupLayer.load());for(var e=0;e<this.layers.length;++e){var t=this.layers[e];t.visible&&t.load()}if(this.overlayLayer.load(),this.queryLayer.load(),this.panoramaLayer.load(),this.imageLayer.load(),0==this.groupLayer.getLayers().length||this.groupLayer.flag!=GeoBeans.Layer.Flag.READY){for(var e=0;e<this.layers.length;++e)if(t.visible&&t.flag!=GeoBeans.Layer.Flag.LOADED)return;var a=this.overlayLayer.getLoadFlag();if(a==GeoBeans.Layer.Flag.LOADED&&this.queryLayer.flag==GeoBeans.Layer.Flag.LOADED){var r=this.panoramaLayer.getLoadFlag();if(r==GeoBeans.Layer.Flag.LOADED){var n=this.imageLayer.getLoadFlag();if(n==GeoBeans.Layer.Flag.LOADED){if(this.renderer.clearRect(0,0,this.canvas.width,this.canvas.height),0!=this.groupLayer.getLayers().length&&this.groupLayer.visible&&this.groupLayer.flag==GeoBeans.Layer.Flag.LOADED){var i=this.groupLayer.canvas;this.renderer.drawImage(i,0,0,i.width,i.height);for(var s=this.groupLayer.getLayers(),e=0;e<s.length;++e){var l=s[e],o=l.heatMapLayer;if(null!=o){var h=o.canvas;null!=h&&o.visible&&l.visible&&this.renderer.drawImage(h,0,0,h.width,h.height)}}}for(var e=0;e<this.layers.length;++e){var t=this.layers[e];if(!(t instanceof GeoBeans.Layer.RippleLayer))if(t.visible){var h=t.canvas;null!=h&&this.renderer.drawImage(h,0,0,h.width,h.height);var u=t.hitCanvas;null!=u&&this.renderer.drawImage(u,0,0,u.width,u.height);var y=t.bufferCanvas;null!=y&&this.renderer.drawImage(y,0,0,y.width,y.height),t instanceof GeoBeans.Layer.ChartLayer&&t.showLegend()}else t instanceof GeoBeans.Layer.ChartLayer&&t.hideLegend()}var h=this.overlayLayer.canvas;this.renderer.drawImage(h,0,0,h.width,h.height);var c=this.overlayLayer.hitCanvas;null!=c&&this.renderer.drawImage(c,0,0,c.width,c.height);var v=this.overlayLayer.editCanvas;null!=v&&this.renderer.drawImage(v,0,0,v.width,v.height);var p=this.queryLayer.canvas;null!=p&&this.renderer.drawImage(p,0,0,p.width,p.height);var d=this.panoramaLayer.canvas;null!=d&&this.renderer.drawImage(d,0,0,d.width,d.height);var g=this.imageLayer.canvas;null!=g&&this.renderer.drawImage(g,0,0,g.width,g.height);var L=this;if(null!=this.infoWindow){var f=this.mapDiv.find(".popover");if(1==f.length){var m=this.infoWindow.attr("x"),w=this.infoWindow.attr("y");if(!this.viewer.contain(m,w))return this.infoWindow.popover("hide"),void L.queryLayer.clearFeatures();var B=this.transformation.toScreenPoint(m,w);this.infoWindow.css("left",B.x+"px"),this.infoWindow.css("top",B.y+"px"),this.infoWindow.popover("hide").popover("show"),this.mapDiv.find(".popover-title").append('<button type="button" class="close">&times;</button>'),this.mapDiv.find(".popover-title .close").click(function(){$(this).parents(".popover").popover("hide")})}}}}}}},drawCache:function(){this.drawBackground(),null!=this.baseLayer&&this.baseLayer.drawCache()},drawBackground:function(){if(this.renderer.clearRect(0,0,this.canvas.width,this.canvas.height),null!=this.baseLayer&&this.baseLayer.renderer.clearRect(0,0,this.canvas.width,this.canvas.height),null!=this.backgroundColor){var e=this.backgroundColor.getRgba();this.renderer.context.fillStyle=e,this.renderer.context.fillRect(0,0,this.width,this.height)}},enableDrag:function(e){var t=this.controls.find(GeoBeans.Control.Type.DRAG_MAP);t>=0&&this.controls.get(t).enable(e)},addEventListener:function(e,t){var a=this;this.mapDiv[0].addEventListener(e,function(e){var r=e.layerX,n=e.layerY;if(null!=a.transformation){var i=a.transformation.toMapPoint(r,n),s=new GeoBeans.Event.MouseArgs;s.buttn=null,s.X=r,s.Y=n,s.mapX=i.x,s.mapY=i.y,s.level=a.level,t(s)}})},addWheelEventListener:function(e){if(null!=e){var t=this.controls.find(GeoBeans.Control.Type.SCROLL_MAP),a=this.controls.get(t);null!=a&&(a.userHandler=e)}},removeWheelEventListener:function(e){var t=this.controls.find(GeoBeans.Control.Type.SCROLL_MAP),a=this.controls.get(t);null!=a&&(a.userHandler=null)},addBeginDragEventListener:function(e){if(null!=e){var t=this.controls.find(GeoBeans.Control.Type.DRAG_MAP),a=this.controls.get(t);null!=a&&(a.beginDragHandler=e)}},addDraggingEventListener:function(e){if(null!=e){var t=this.controls.find(GeoBeans.Control.Type.DRAG_MAP),a=this.controls.get(t);null!=a&&(a.dragingHandler=e)}},addEndDragEventListener:function(e){if(null!=e){var t=this.controls.find(GeoBeans.Control.Type.DRAG_MAP),a=this.controls.get(t);null!=a&&(a.endDragHandler=e)}},removeBeginDragEventListener:function(){var e=this.controls.find(GeoBeans.Control.Type.DRAG_MAP),t=this.controls.get(e);null!=t&&(t.beginDragHandler=null)},removeDraggingEventListener:function(e){var t=this.controls.find(GeoBeans.Control.Type.DRAG_MAP),a=this.controls.get(t);null!=a&&(a.dragingHandler=null)},removeEndDragEventListener:function(e){var t=this.controls.find(GeoBeans.Control.Type.DRAG_MAP),a=this.controls.get(t);null!=a&&(a.endDragHandler=null)},scaleView:function(e){if(null==e)return null;var t=e.getWidth()/e.getHeight(),a=this.width/this.height;this.center=e.getCenter();var r=null;if(t>a){var n=e.getWidth()/2,i=n/a;r=new GeoBeans.Envelope(e.xmin,this.center.y-i,e.xmax,this.center.y+i)}else{var i=e.getHeight()/2,n=i*a;r=new GeoBeans.Envelope(this.center.x-n,e.ymin,this.center.x+n,e.ymax)}return r},scaleViewWidth:function(e){if(null==e)return null;this.center=e.getCenter();var t=this.width/this.height,a=e.getHeight()/2,r=a*t,n=new GeoBeans.Envelope(this.center.x-r,e.ymin,this.center.x+r,e.ymax);return n},scaleViewHeight:function(e){if(null==e)return null;this.center=e.getCenter();var t=this.width/this.height,a=e.getWidth()/2,r=a/t,n=new GeoBeans.Envelope(e.xmin,this.center.y-r,e.xmax,this.center.y+r);return n},screenCopy:function(){var e=this.renderer.context.getImageData(0,0,this.canvas.width,this.canvas.height);return e},saveSnap:function(){this.snap=this.renderer.context.getImageData(0,0,this.canvas.width,this.canvas.height),null!=this.baseLayerCanvas&&(this.baseLayerSnap=this.baseLayer.renderer.context.getImageData(0,0,this.baseLayerCanvas.width,this.baseLayerCanvas.height))},restoreSnap:function(){null!=this.snap&&this.renderer.context.putImageData(this.snap,0,0),null!=this.baseLayerSnap&&this.baseLayer.renderer.context.putImageData(this.baseLayerSnap,0,0)},putSnap:function(e,t){"undefined"==e&&(e=0),"undefined"==t&&(t=0),null!=this.snap&&this.renderer.context.putImageData(this.snap,e,t),null!=this.baseLayerSnap&&this.baseLayer.renderer.context.putImageData(this.baseLayerSnap,e,t)},cleanupSnap:function(){this.snap=null,this.baseLayerSnap=null},drawBaseLayerSnap:function(e){var t=(this.center.x,this.center.y,null),a=null,r=null,n=null,i=e-this.level,s=Math.pow(2,i);if(r=this.width*s,n=this.height*s,t=0-.5*((Math.pow(2,i)-1)*this.width),a=0-.5*((Math.pow(2,i)-1)*this.height),null!=this.baseLayerSnap){var l=$("<canvas>").attr("width",this.baseLayerSnap.width).attr("height",this.baseLayerSnap.height)[0];l.getContext("2d").putImageData(this.baseLayerSnap,0,0),this.baseLayer.renderer.context.drawImage(l,t,a,r,n)}if(null!=this.snap){var o=$("<canvas>").attr("width",this.snap.width).attr("height",this.snap.height)[0];o.getContext("2d").putImageData(this.snap,0,0),this.renderer.context.drawImage(o,t,a,r,n)}},drawLayersSnap:function(e){var t=(this.center.x,this.center.y,null),a=null,r=null,n=null;if(r=this.width/e,n=this.height/e,t=this.width/2-.5*r,a=this.height/2-.5*n,null!=this.snap){var i=$("<canvas>").attr("width",this.snap.width).attr("height",this.snap.height)[0];i.getContext("2d").putImageData(this.snap,0,0),this.renderer.context.drawImage(i,t,a,r,n)}},setNavControl:function(e){null==this.mapNavControl&&(this.mapNavControl=new GeoBeans.Control.MapNavControl(this)),this.mapNavControl.setEnable(e)},addOverlay:function(e){this.overlayLayer.addOverlay(e)},addOverlays:function(e){this.overlayLayer.addOverlays(e)},removeOverlay:function(e){this.overlayLayer.removeOverlay(e)},removeOverlayObj:function(e){this.overlayLayer.removeOverlayObj(e)},removeOverlays:function(e){this.overlayLayer.removeOverlays(e)},clearOverlays:function(){this.overlayLayer.clearOverlays()},getOverlays:function(){return this.overlayLayer.overlays},getOverlay:function(e){return this.overlayLayer.overlays[e]},getOverlayIndex:function(e){return this.overlayLayer.getOverlayIndex(e)},setFitView:function(e){var t=e.getExtent();this.viewer=this.scaleView(t),this.transformation.update();var a=this.getLevel(this.viewer);this.setLevel(a),this.draw()},registerOverlayEvent:function(){this.overlayLayer.registerHitEvent()},unregisterOverlayEvent:function(){this.overlayLayer.unregisterHitEvent()},registerInfoWindowEvent:function(){this.overlayLayer.registerInfoWindowEvent()},unRegisterInfoWindowEvent:function(){this.overlayLayer.unRegisterInfoWindowEvent()},drawGeometry:function(){},queryByRect:function(e,t){if(null!=e){var a=this.getLayer(e);null!=a&&a.type==GeoBeans.Layer.DBLayer.Type.Feature&&(this.queryLayer.clearFeatures(),this.queryTrackLayer=null,this.queryGeometry=null,this.tracker.trackRect(this.trackRect_callback,this,a,t))}},trackRect_callback:function(e,t,a,r){null!=e&&(t.tracker.end(),t.queryGeometry=e,t.queryTrackLayer=a,t.queryLayer.setLayer(a),a.getFeatureCount(e,r))},queryByRectPage:function(e,t){if(null!=this.queryTrackLayer&&null!=this.queryGeometry){var a=this.queryTrackLayer.getFeatureBBoxGet(this.queryGeometry,e,t);return this.queryLayer.setFeatures(a),this.drawLayersAll(),a}return null},queryByRectOutput:function(e,t){if(null!=this.queryTrackLayer&&null!=this.queryGeometry){var a=this.queryTrackLayer.getFeautureBBoxGetOutput(this.queryGeometry,e,t);return a}return null},setFeatureBlink:function(e,t){null!=e&&null!=t&&this.queryLayer.setFeatureBlink(e,t)},addHeatMap:function(e,t,a,r){var n=this.getLayer(e);null!=n&&n instanceof GeoBeans.Layer.DBLayer&&n.addHeatMap(t,a,r)},removeHeatMap:function(e){var t=this.getLayer(e);null!=t&&t.removeHeatMap()},setHeatMapVisible:function(e,t){var a=this.getLayer(e);null!=a&&a.setHeatMapVisible(t)},queryByClick:function(e,t){if(this.endQuery(),null!=e){var a=this.getLayer(e);null!=a&&a.type==GeoBeans.Layer.DBLayer.Type.Feature&&this.tracker.trackInfo(this.queryByClick_callback,a,this,t)}},queryByClick_callback:function(e,t,a,r){if(null!=e&&null!=t){var n=a.transformation.toMapPoint(e.x,e.y),i=5,s=new GeoBeans.Geometry.Point(e.x-i/2,e.y-i/2),l=new GeoBeans.Geometry.Point(e.x+i/2,e.y+i/2),o=a.transformation.toMapPoint(s.x,s.y),h=a.transformation.toMapPoint(l.x,l.y),u=new GeoBeans.Envelope(o.x,h.y,h.x,o.y),y=t.getFeatureType();if(null!=y){var c={map:a,layer:t,callback:r,point:n};if(t.geomType==GeoBeans.Geometry.Type.POLYGON||t.geomType==GeoBeans.Geometry.Type.MULTIPOLYGON)y.getFeaturesWithinAsync(a.name,null,n,a.getClickFeatures_callback,null,c);else{var v=new GeoBeans.BBoxFilter;v.extent=u;var p=y.geomFieldName;v.propName=p,y.getFeaturesFilterAsync2(a.name,null,v,null,null,null,null,c,a.getClickFeatures_callback)}}}},getClickFeatures_callback:function(e,t){if(null!=t&&null!=e){var a=e.map,r=e.callback,n=e.layer,i=e.point;if(null!=a&&null!=r&&null!=e&&null!=i){if(null==t||0==t.length)return a.infoWindow.popover("hide"),void a.queryLayer.clearFeatures();var s=t[0];null!=r&&r(n,s,i),a.queryLayer.setLayer(n),a.queryLayer.setFeatures([s]),a.drawLayersAll()}}},queryByPolygon:function(e,t){if(null!=e){var a=this.getLayer(e);null!=a&&a.type==GeoBeans.Layer.DBLayer.Type.Feature&&(this.queryLayer.clearFeatures(),this.queryTrackLayer=null,this.queryGeometry=null,this.tracker.trackPolygon(this.trackPolygon_callback,this,a,t))}},trackPolygon_callback:function(e,t,a,r){if(null!=e&&null!=t&&null!=a){t.tracker.end(),t.queryGeometry=e,t.queryTrackLayer=a,t.queryLayer.setLayer(a);var n=new GeoBeans.SpatialFilter;n.geometry=e,n.operator=GeoBeans.SpatialFilter.OperatorType.SpOprIntersects;var i=a.getFeatureType(),s=i.geomFieldName;n.propName=s,a.getFeatureFilterCountAsync(n,r)}},queryByPolygonPage:function(e,t){if(null!=this.queryTrackLayer&&null!=this.queryGeometry){var a=new GeoBeans.SpatialFilter;a.geometry=this.queryGeometry,a.operator=GeoBeans.SpatialFilter.OperatorType.SpOprIntersects;var r=this.queryTrackLayer.getFeatureType(),n=r.geomFieldName;a.propName=n;var i=this.queryTrackLayer.getFeatureFilter(a,e,t,null);return this.queryLayer.setFeatures(i),this.drawLayersAll(),i}return null},queryByPolygonOutput:function(e,t){if(null!=this.queryTrackLayer&&null!=this.queryGeometry){var a=new GeoBeans.SpatialFilter;a.geometry=this.queryGeometry,a.operator=GeoBeans.SpatialFilter.OperatorType.SpOprIntersects;var r=this.queryTrackLayer.getFeatureType(),n=r.geomFieldName;a.propName=n;var i=this.queryByFilterOutput(this.queryTrackLayer.name,a,e,t);return i}return null},queryByLine:function(e,t){if(null!=e){var a=this.getLayer(e);null!=a&&a.type==GeoBeans.Layer.DBLayer.Type.Feature&&(this.queryLayer.clearFeatures(),this.queryTrackLayer=null,this.queryGeometry=null,this.tracker.trackLine(this.trackLine_callback,this,a,t))}},trackLine_callback:function(e,t,a,r){if(null!=e&&null!=t&&null!=a){t.tracker.end(),t.queryGeometry=e,t.queryTrackLayer=a,t.queryLayer.setLayer(a);var n=new GeoBeans.SpatialFilter;n.geometry=e,n.operator=GeoBeans.SpatialFilter.OperatorType.SpOprIntersects;var i=a.getFeatureType(),s=i.geomFieldName;n.propName=s,a.getFeatureFilterCountAsync(n,r)}},queryByLinePage:function(e,t){if(null!=this.queryTrackLayer&&null!=this.queryGeometry){var a=new GeoBeans.SpatialFilter;a.geometry=this.queryGeometry,a.operator=GeoBeans.SpatialFilter.OperatorType.SpOprIntersects;var r=this.queryTrackLayer.getFeatureType(),n=r.geomFieldName;a.propName=n;var i=this.queryTrackLayer.getFeatureFilter(a,e,t,null);return this.queryLayer.setFeatures(i),this.drawLayersAll(),i}return null},queryByLineOutput:function(e,t){if(null!=this.queryTrackLayer&&null!=this.queryGeometry){var a=new GeoBeans.SpatialFilter;a.geometry=this.queryGeometry,a.operator=GeoBeans.SpatialFilter.OperatorType.SpOprIntersects;var r=this.queryTrackLayer.getFeatureType(),n=r.geomFieldName;a.propName=n;var i=this.queryByFilterOutput(this.queryTrackLayer.name,a,e,t);return i}return null},endQuery:function(){this.tracker.end(),this.queryLayer.clearFeatures(),this.infoWindow.popover("hide")},openInfoWindow:function(e,t){if(null!=e&&null!=t){var a=t.x,r=t.y,n=this.transformation.toScreenPoint(a,r),i=n.x,s=n.y;this.infoWindow.attr("x",a),this.infoWindow.attr("y",r),this.infoWindow.css("left",i+"px"),this.infoWindow.css("top",s+"px");var l=e.getTitle(),o=e.getContent();this.infoWindow.popover("hide").attr("data-content",o).attr("data-original-title",l).popover("show"),this.mapDiv.find(".popover-title").append('<button type="button" class="close">&times;</button>'),this.mapDiv.find(".popover-title .close").click(function(){$(this).parents(".popover").popover("hide")})}},closeInfoWindow:function(){null!=this.infoWindow&&this.infoWindow.popover("hide")},zoomToLayer:function(e){if(null!=e){var t=this.getLayer(e);if(null!=t){t instanceof GeoBeans.Layer.DBLayer&&t.update();var a=t.getExtent();if(null!=a){if(null!=this.baseLayer){var r=this.getLevel(a);if(null==r)return;var n=a.getCenter();this.setLevel(r),this.setCenter(n)}else this.setViewer(a);this.draw()}}}},zoomToBaseLayer:function(){if(null!=this.baseLayer){var e=this.baseLayer.extent;if(null!=e||(this.baseLayer instanceof GeoBeans.Layer.QSLayer&&(e=new GeoBeans.Envelope((-180),(-90),180,90)),null!=e)){var t=this.getLevel(e);if(null!=t){this.setLevel(t);var a=e.getCenter();null!=a&&(this.setCenter(a),this.draw())}}}},getFeatures:function(e,t,a){if(null==e)return null;var r=this.getLayer(e);if(null!=r&&r instanceof GeoBeans.Layer.DBLayer){var n=r.getFeatureBBoxGet(null,t,a);return n}return null},getFeatureFilter:function(e,t,a,r){var n=this.getLayer(e);if(null==n)return null;this.queryLayer.setLayer(n);var i=n.getFeatureFilter(t,a,r);return this.queryLayer.setFeatures(i),this.drawLayersAll(),i},getFeatureFilterCount:function(e,t){var a=this.getLayer(e);if(null==a)return null;var r=a.getFeatureFilterCount(t);return r},queryByFilterOutput:function(e,t,a,r){var n=this.getLayer(e);if(null==n)return null;var i=n.getFeatureFilterOutput(t,a,r);return i},getRangeChartStyle:function(e,t,a,r,n,i,s,l){if(null==e||null==t||null==a||null==r||null==n||null==i||null==s||null==l)return null;var o=new GeoBeans.Layer.ChartLayer("tmp",e,t,a,r,n,[i]);o.setMap(this);var h=o.chartFeatures;if(null==h||0==h.length)return null;var u=h[0].featureType,y=u.getFieldIndex(i),c=this.getRangeChartNodes(h,y,s);if(null==c||0==c.length)return null;var v=new GeoBeans.StyleManager(this.server),p=v.getColorMap(l,s),d=this.getRangeChartStyleByNodes(h,y,c,p);return null!=d&&(d.nodes=c),d},getRangeChartNodes:function(e,t,a){if(null==e||null==t||null==a)return null;for(var r=null,n=null,i=null,s=0;s<e.length;++s){if(r=e[s],null==r)return;var l=r.values,o=l[t];o=parseFloat(o),null!=o&&(n=null==n?o:o<n?o:n,i=null==i?o:o>i?o:i)}if(null==i||null==n||i==n)return null;for(var h=(i-n)/a,u=[],s=0;s<a;++s){var y=n+h*s;u.push(y)}return u.push(i),u},getRangeChartStyleByNodes:function(e,t,a,r){for(var n=new GeoBeans.Style.FeatureStyle("chart",GeoBeans.Style.FeatureStyle.GeomType.Polygon),i=[],s=0;s<a.length-1;++s){var l=a[s],o=a[s+1],h=r[s],u=new GeoBeans.Symbolizer.PolygonSymbolizer,y=new GeoBeans.Color;y.setByHex(h,1),u.fill.color=y,y=new GeoBeans.Color,y.setByHex("#cccccc",1),u.stroke.color=y;for(var c=new GeoBeans.IDFilter,v=0;v<e.length;++v){var p=e[v];if(null!=p){var d=p.values;if(null!=d){var g=d[t];if(null!=g&&g>=l&&g<=o){var L=p.gid;c.addID(L)}}}}var f=new GeoBeans.Rule;f.filter=c,f.name=s,f.symbolizer=u,i.push(f)}return n.rules=i,n},describeLayer:function(e,t){return null==e?void(null!=t&&t("layername is null")):void this.mapWorkspace.describeLayer(e,this.describeLayer_callback,t)},describeLayer_callback:function(e,t){null!=t&&t(e)},refresh:function(){},addPanorama:function(e,t,a,r){this.panoramaLayer.addMarker(e,t,a,r)},removePanorama:function(e){this.panoramaLayer.removeMarker(e)},clearPanoramas:function(){this.panoramaLayer.clearMarkers()},drawImage:function(e,t){this.imageLayer.addImage(e,t)},_addLegend:function(e){if(null!=e){var t=this._getLegendIndex(),a={index:t,layer:e};this.legendList.push(a),e.legendIndex=t}},_removeLegend:function(e){for(var t=null,a=null,r=null,n=0;n<this.legendList.length;++n)t=this.legendList[n],a=t.layer,r=t.index,e==r&&this.legendList.splice(n,1);for(var n=0;n<this.legendList.length;++n)t=this.legendList[n],a=t.layer,r=t.index,r>e&&(t.index=r-1,a.legendIndex=r-1)},_getLegendIndex:function(){return this.legendList.length},setBackground:function(e){null!=e&&(this.backgroundColor=e)},beginAnimate:function(){if(null==this.animateCanvas){var e=this.mapDiv.find(".map5-animate-canvas");if(0==e.length){var t=this.id+"_canvas",a=this.id+"_animatecanvas",r="<canvas  id='"+a+"' class='map5-animate-canvas' height='"+this.canvas.height+"' width='"+this.canvas.width+"'></canvas>";this.mapDiv.find("#"+t).after(r),this.animateCanvas=document.getElementById(a);var n=new GeoBeans.Renderer(this.animateCanvas);this.animateRenderer=n,window.map=this,window.requestNextAnimationFrame(this.rippleLayerAnimate)}}},rippleLayerAnimate:function(e){var t=this.map;t.animateRenderer.clearRect();var a=t._getRippleLayer();if(null!=a){for(var r=null,n=0;n<a.length;++n)r=a[n],null!=r&&r.visible&&r.draw(e);var i=window.requestNextAnimationFrame(t.rippleLayerAnimate);t.requestID=i}},stopAnimate:function(){window.cancelAnimationFrame(this.requestID)},_getRippleLayer:function(){for(var e=this.getLayers(),t=[],a=null,r=0;r<e.length;++r)a=e[r],null!=a&&a instanceof GeoBeans.Layer.RippleLayer&&t.push(a);return t},tooltip:function(e,t){var a=this.transformation.toScreenPoint(e.x,e.y);"left:"+a.x+"px;top:"+a.y+"px";this.mapDiv.find(".map5-tooltip").html(t);var r=a.x,n=a.y,i=this.mapDiv.find(".map5-tooltip").height(),s=this.mapDiv.find(".map5-tooltip").width(),l=s+a.x,o=i+a.y;l>=this.width&&(r=a.x-s),o>=this.height&&(n=a.y-i),this.mapDiv.find(".map5-tooltip").css("left",r+"px"),this.mapDiv.find(".map5-tooltip").css("top",n+"px"),this.mapDiv.find(".map5-tooltip").css("display","block")},closeTooltip:function(){this.mapDiv.find(".map5-tooltip").css("display","none")},registerRippleHitEvent:function(e,t){var a=this.getLayer(e);if(null!=a&&a instanceof GeoBeans.Layer.RippleLayer&&(a.setHitContent(t),$.inArray(a,this.hitRippleLayers)==-1&&this.hitRippleLayers.push(a),0!=this.hitRippleLayers.length&&null==this.hitRippleEvent)){var r=this,n=null,i=null,s=5;this.hitRippleEvent=function(e){if(null==n)n=e.layerX,i=e.layerY;else{var t=Math.abs(e.layerX-n)+Math.abs(e.layerY-i);if(t>s){n=e.layerX,i=e.layerY;for(var a=r.transformation.toMapPoint(e.layerX,e.layerY),l=null,o=null,h=r.getLayers(),u=0;u<r.hitRippleLayers.length;++u){
var y=r.hitRippleLayers[u];if(null!=y){var c=y.hit(a.x,a.y),v=h.indexOf(y);null!=l?v>o&&(l=c,o=v):(l=c,o=v)}}if(null==l)r.closeTooltip();else{var p=new GeoBeans.Geometry.Point(a.x,a.y);r.tooltip(p,l)}}}},this.mapDiv[0].addEventListener("mousemove",this.hitRippleEvent)}},unRegisterRippleHitEvent:function(e){var t=this.getLayer(e);if(null!=t&&t instanceof GeoBeans.Layer.RippleLayer){t.unregisterHitEvent();var a=this.hitRippleLayers.indexOf(t);a!=-1&&this.hitRippleLayers.splice(a,1),0==this.hitRippleLayers.length&&this.unRegisterMapRippleHitEvent()}},unRegisterMapRippleHitEvent:function(){this.mapDiv[0].removeEventListener("mousemove",this.hitRippleEvent),this.hitRippleEvent=null},zoomIn:function(){var e=this.controls.find(GeoBeans.Control.Type.ZOOM);if(!(e<0)){var t=this.controls.get(e);t.setMode("in"),t.trackRect()}},zoomOut:function(){var e=this.controls.find(GeoBeans.Control.Type.ZOOM);if(!(e<0)){var t=this.controls.get(e);t.setMode("out"),t.trackRect()}},endZoom:function(){var e=this.controls.find(GeoBeans.Control.Type.ZOOM);if(!(e<0)){var t=this.controls.get(e);t.end()}}});
GeoBeans.MapManager=GeoBeans.Class({service:"ims",version:"1.0.0",server:null,maps:null,getMap_u_id:null,getMap_u_map:null,createMap_u_id:null,createMap_u_name:null,createMap_u_extent:null,createMap_u_srid:null,removeMap_u_callback:null,initialize:function(e){this.server=e+"/mgr",this.maps=[]},getMaps:function(e){var a=this,r="service="+this.service+"&version="+this.version+"&request=describeMap";$.ajax({type:"get",url:this.server,data:encodeURI(r),dataType:"xml",async:!0,beforeSend:function(e){},success:function(r,n){a.maps=a.parseMaps(r),void 0!=e&&e(a.maps)},complete:function(e,a){},error:function(){}})},getMap:function(e,a){if(null!=e&&null!=a&&""!=a){this.getMap_u_id=e;var r=this,n="service="+this.service+"&version="+this.version+"&request=describeMap&name="+a;return $.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,a){var n=r.parseMap(e);r.getMap_u_map=n},complete:function(e,a){},error:function(){}}),r.getMap_u_map}},createMap:function(e,a,r,n,t){if(null!=a&&null!=r&&null!=n){this.createMap_u_id=e,this.createMap_u_name=a,this.createMap_u_extent=r,this.createMap_u_srid=n,this.createMap_u_callback=t;var s=r.toString(),i=this,l="service="+this.service+"&version="+this.version+"&request=CreateMap&name="+a+"&extent="+s+"&srid="+n;$.ajax({type:"get",url:this.server,data:encodeURI(l),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,a){var r=i.parseCreateMap(e);i.createMap_callback(r)},complete:function(e,a){},error:function(){}})}},removeMap:function(e){if(null!=e&&""!=e){var a=this,r="service="+this.service+"&version="+this.version+"&request=RemoveMap&name="+e;return this.removeMapResult=null,$.ajax({type:"get",url:this.server,data:encodeURI(r),dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,r){var n=a.parseRemoveMap(e);a.removeMapResult=n},complete:function(e,a){},error:function(){}}),this.removeMapResult}},parseMaps:function(e){var a=[],r=this;return $(e).find("Map").each(function(){var e=new Object,n=$(this).find("Name").text(),t=$(this).find("Srid").text(),s=$(this).find("BoundingBox"),i=r.parseBoundingBox(s),l=$(this).find("Thumbnail").attr("xlink");e.name=n,e.srid=t,e.extent=i,l.length-l.lastIndexOf(".png")==4&&(e.thumbnail=l),a.push(e)}),a},parseMap:function(e){var a=$(e).find("ExceptionText").text();if(""!=a)return console.log(a),null;var r=this,n=$(e).find("Name:first").text(),t=$(e).find("Srid:first").text(),s=$(e).find("BoundingBox:first"),i=r.parseBoundingBox(s),l=$(e).find("Viewer:first"),u=r.parseBoundingBox(l),o=$(e).find("Thumbnail").attr("xlink"),p=new GeoBeans.Map(r.server,r.getMap_u_id,n,i,t,u);return p.thumbnail=o,$(e).find("Capability>Layer").each(function(){var e=r.parseLayer(this);if(e instanceof GeoBeans.Layer.GroupLayer)for(var a=e.getLayers(),n=0;n<a.length;++n){var t=a[n];t.setMap(p),p.groupLayer.addLayer(t)}else e instanceof GeoBeans.Layer.TileLayer?p.setBaseLayer(e):p.addLayer(e)}),p},parseBoundingBox:function(e){if(null==e)return null;var a=parseFloat($(e).attr("minx")),r=parseFloat($(e).attr("miny")),n=parseFloat($(e).attr("maxx")),t=parseFloat($(e).attr("maxy"));return $.isNumeric(a)&&$.isNumeric(n)&&$.isNumeric(r)&&$.isNumeric(t)?new GeoBeans.Envelope(a,r,n,t):null},parseLayer:function(e){if(null==e)return null;var a=null,r=$(e).find("Type").first().text();return"Group"==r?a=this.parseGroupLayer(e):"quadserver"!=r.toLowerCase()&&"wmts"!=r.toLowerCase()||(a=this.parseTileLayer(e)),a},parseGroupLayer:function(e){if(null==e)return null;var a=this,r=$(e).find("Name:first").text(),n=$(e).find("BoundingBox:first"),t=this.parseBoundingBox(n),s=new GeoBeans.Layer.GroupLayer(r);return s.extent=t,$(e).find("Layer").each(function(){var e=a.parseDBLayer(this);s.addLayer(e)}),s},parseDBLayer:function(e){if(null==e)return null;var a=null,r=$(e).attr("id"),n=$(e).find("Name:first").text(),t=parseInt($(e).attr("queryable")),s=parseInt($(e).attr("visible"));s=1==s;var i=$(e).find("Type").first().text(),l=null;switch(i.toLowerCase()){case"raster":l=GeoBeans.Layer.DBLayer.Type.Raster;break;case"feature":l=GeoBeans.Layer.DBLayer.Type.Feature}var u=$(e).find("BoundingBox:first"),o=this.parseBoundingBox(u);if(l==GeoBeans.Layer.DBLayer.Type.Raster)a=new GeoBeans.Layer.RasterDBLayer(n,parseInt(r),null,null,t,s,null),a.extent=o;else if(l==GeoBeans.Layer.DBLayer.Type.Feature){var p=$(e).find("Style>Name").text(),c=$(e).find("GeometryType").text(),f=null;switch(c.toUpperCase()){case"POINT":f=GeoBeans.Geometry.Type.POINT;break;case"LINESTRING":f=GeoBeans.Geometry.Type.LINESTRING;break;case"POLYGON":f=GeoBeans.Geometry.Type.POLYGON;break;case"MULTIPOINT":f=GeoBeans.Geometry.Type.MULTIPOINT;break;case"MULTILINESTRING":f=GeoBeans.Geometry.Type.MULTILINESTRING;break;case"MULTIPOLYGON":f=GeoBeans.Geometry.Type.MULTIPOLYGON}a=new GeoBeans.Layer.FeatureDBLayer(n,parseInt(r),null,null,t,s,p),a.extent=o,a.geomType=f}return a},parseTileLayer:function(e){if(null==e)return null;var a=$(e).attr("id"),r=parseInt($(e).attr("queryable"));r=1==r;var n=parseInt($(e).attr("visible"));n=1==n;var t=$(e).find("Name:first").text(),s=($(e).find("Title:first").text(),$(e).find("Type").text()),i=$(e).find("URL").text(),l=$(e).find("BoundingBox:first"),u=this.parseBoundingBox(l),o=null;return"QuadServer"==s?(o=new GeoBeans.Layer.QSLayer(t,i),o.extent=u,o.visible=n,o.queryable=r,o.id=a):"WMTS"==s&&(o=this.getWMTSLayer(t,i),null!=o&&(o.visible=n,o.queryable=r,o.id=a)),o},getWMTSLayer:function(e,a){if(null==a&&null==e)return null;for(var r=null,n=null,t=null,s=null,i=null,l=null,u=null,o=null,p=null,c=a.split(";"),f=0;f<c.length;++f){var v=c[f],d=v.split(":"),y=d[0];switch(y){case"typeName":r=d[1];break;case"format":n=d[1];break;case"tms":t=d[1];break;case"extent":i=d[1];var m=i.split(",");s=new GeoBeans.Envelope(parseFloat(m[0]),parseFloat(m[1]),parseFloat(m[2]),parseFloat(m[3]));break;case"sourceName":l=d[1];break;case"url":u=d[1];break;case"startLevel":o=d[1],o=parseInt(o);break;case"endLevel":p=d[1],p=parseInt(p)}}if(null!=e&&null!=r&&null!=n&&null!=t&&null!=s&&null!=l&&null!=u){var x=new GeoBeans.Layer.WMTSLayer(e,u,r,s,t,n,l);return null!=o&&(x.MIN_ZOOM_LEVEL=o),null!=p&&(x.MAX_ZOOM_LEVEL=p),x}return null},parseCreateMap:function(e){var a=$(e).find("CreateMap").text();if("success"==a.toLowerCase())return"success";var r=$(e).find("ExceptionText").text();return r},createMap_callback:function(e){if(null!=this.createMap_u_callback){if("success"!=e)return void this.createMap_u_callback(null,e);var a=new GeoBeans.Map(this.server,this.createMap_u_id,this.createMap_u_name,this.createMap_u_extent,this.createMap_u_srid);this.createMap_u_callback(a,e)}},parseRemoveMap:function(e){var a=$(e).find("RemoveMap").text();if("success"==a.toLowerCase())return"success";var r=$(e).find("ExceptionText").text();return r},removeMap_callback:function(e){null!=this.removeMap_u_callback&&this.removeMap_u_callback(e)},saveMap:function(e,a){if(null==e&&null!=a)return void a("map is null");var r=this.buildSaveMapXML(e);if(null==r&&null!=a)return void a("map is null");var n=this;$.ajax({type:"post",url:this.server,data:r,contentType:"text/xml",dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var t=n.parseSaveMap(e);null!=a&&a(t)},complete:function(e,a){},error:function(){}})},buildSaveMapXML:function(e){if(null==e)return null;var a=$.parseXML('<?xml version="1.0"?><SaveMap service="ims" version="1.0.0" user="user1"/>'),r=e.name,n=a.createElement("Name");$(n).text(r),$("SaveMap",a).append(n);var t=e.srid,s=a.createElement("Srid");$(s).text(t),$("SaveMap",a).append(s);var i=e.extent;if(null!=i){var l=a.createElement("Extent");$(l).attr("xmin",i.xmin),$(l).attr("ymin",i.ymin),$(l).attr("xmax",i.xmax),$(l).attr("ymax",i.ymax),$("SaveMap",a).append(l)}var u=e.viewer;if(null!=u){var o=a.createElement("Viewer");$(o).attr("xmin",u.xmin),$(o).attr("ymin",u.ymin),$(o).attr("xmax",u.xmax),$(o).attr("ymax",u.ymax),$("SaveMap",a).append(o)}var p=a.createElement("Layers"),c=e.baseLayer;if(null!=c){var f=a.createElement("Layer"),r=c.name;null!=r&&$(f).attr("name",r);var v=c.id;null!=v&&$(f).attr("id",v);var d=c.visible;d=d?1:0,$(f).attr("visible",d),$(p).append(f)}for(var y=e.getLayers(),m=null,x=0;x<y.length;++x)if(m=y[x],null!=m&&m instanceof GeoBeans.Layer.DBLayer){var f=a.createElement("Layer"),r=m.name;null!=r&&$(f).attr("name",r);var v=m.id;null!=v&&$(f).attr("id",v);var d=m.visible;d=d?1:0,$(f).attr("visible",d),$(p).append(f)}if($("SaveMap",a).append(p),null!=a){var h=(new XMLSerializer).serializeToString(a);return h}return null},parseSaveMap:function(e){var a=$(e).find("SaveMap").text();if("success"==a.toLowerCase())return"success";var r=$(e).find("ExceptionText").text();return r},getMapByName:function(e){if(null==e)return null;if(null==this.maps)return null;for(var a=null,r=null,n=0;n<this.maps.length;++n)if(a=this.maps[n],null!=a&&(r=a.name,r==e))return a;return null},getMapByNameChar:function(e){if(null==e)return[];if(null==this.maps)return[];for(var a=null,r=null,n=[],t=0;t<this.maps.length;++t)a=this.maps[t],null!=a&&(r=a.name,0==r.indexOf(e)&&n.push(a));return n},getMapObj:function(e,a,r){var n="service="+this.service+"&version="+this.version+"&request=describeMap&name="+e,t=this;t.getMapObj_u=r,$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var n=t.parseMapObj(e);void 0!=a&&a(n,t.refreshMapObj,t.getMapObj_u)},complete:function(e,a){},error:function(){}})},parseMapObj:function(e){var a=$(e).find("ExceptionText").text();if(""!=a)return console.log(a),null;var r=this,n=$(e).find("Name:first").text(),t=$(e).find("Srid:first").text(),s=$(e).find("BoundingBox:first"),i=this.parseBoundingBox(s),l=$(e).find("Viewer:first"),u=this.parseBoundingBox(l),o=$(e).find("Thumbnail").attr("xlink"),p=[],c=null,f=null;return $(e).find("Capability>Layer").each(function(){var e=r.parseLayer(this);if(e instanceof GeoBeans.Layer.GroupLayer)for(var a=e.getLayers(),n=0;n<a.length;++n){var t=a[n];p.push(t)}else e instanceof GeoBeans.Layer.TileLayer&&(c=e)}),{name:n,srid:t,extent:i,viewer:u,groupLayer:f,layers:p,baseLayer:c,thumbnail:o}},refreshMap:function(e,a){if(null==e)return void(null!=a&&a("map is null"));this.refreshMapObj=e;this.getMapObj(e.name,this.refreshMap_callback,a)},refreshMap_callback:function(e,a,r){if(null==e)return void r("refreshMap failed");var n=e.layers;if(null==n)return void r("refreshMap failed");var t=e.baseLayer,s=a.getLayers(),i=null,l=null,u=new GeoBeans.Layer.GroupLayer(a.server,a.name);u.setMap(a);for(var o=0;o<n.length;++o){l=n[o];for(var p=0;p<s.length;++p)if(i=s[p],i.name==l.name){i.styleName=l.styleName,i.extent=l.extent,u.addLayer(i);break}u.hasLayer(l.name)||(l.setMap(a),u.addLayer(l))}a.groupLayer=u,null!=a.baseLayer&&(a.baseLayer.renderer.clearRect(),a.baseLayerCanvas.remove(),a.baseLayerCanvas=null,a.baseLayerSnap=null,a.baseLayer.destroy(),a.baseLayer=null),a.setBaseLayer(t),a.extent=e.extent,null!=r&&r("success")},zoomToGlobeMap:function(e,a){return null==e?void(null!=a&&a("map is null")):null!=e.baseLayer?(e.zoomToBaseLayer(),void a("success")):(this.refreshMapObj=e,void this.getMapObj(e.name,this.zoomToGlobeMap_callback,a))},zoomToGlobeMap_callback:function(e,a,r){if(null==e)return void r("zoom to  map failed");var n=e.layers;if(null==n)return void r("zoom to  map  failed");var t=a.getLayers(),s=null,i=null,l=new GeoBeans.Layer.GroupLayer(a.server,a.name);l.setMap(a);for(var u=0;u<n.length;++u){i=n[u];for(var o=0;o<t.length;++o)if(s=t[o],s.name==i.name){s.styleName=i.styleName,s.extent=i.extent,l.addLayer(s);break}l.hasLayer(i.name)||(i.setMap(a),l.addLayer(i))}a.groupLayer=l,a.extent=e.extent,a.setViewer(a.extent),a.draw(),r("success")}});
GeoBeans.MapWorkspace=GeoBeans.Class({server:null,service:"ims",version:"1.0.0",mapName:null,map:null,registerLayer_layer:null,registerLayer_callback_m:null,registerLayer_callback_u:null,setStyle_typeName:null,setStyle_style:null,setStyle_callback_m:null,setStyle_callback_u:null,initialize:function(e,r){this.server=e,this.map=r},registerLayer:function(e,r,a){if(null==e)return void(null!=r&&r("layer in null"));var t=e.type;this.type=t,t==GeoBeans.Layer.DBLayer.Type.Feature?this.registerFeatureDBLayer(e,r,a):t==GeoBeans.Layer.DBLayer.Type.Raster?this.registerRasterDBLayer(e,r,a):t==GeoBeans.Layer.TileLayer.Type.QS?this.registerQSLayer(e,r,a):t==GeoBeans.Layer.TileLayer.Type.WMTS&&this.registerWMTSLayer(e,r,a)},registerFeatureDBLayer:function(e,r,a){if(null!=e){var t=e.name,s=e.dbName,n=e.typeName;if(null==t||null==s||null==n)return void(null!=r&&r("params is invalid"));this.registerLayer_layer=e,this.registerLayer_callback_m=r,this.registerLayer_callback_u=a;var l=this,i=this.map.name,u="service="+this.service+"&version="+this.version+"&request=RegisterLayer&mapName="+i+"&datasource="+s+"&layerName="+t+"&tableName="+n+"&layertype=Feature";$.ajax({type:"get",url:this.server,data:encodeURI(u),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var a=l.parseRegisterLayer(e);null!=l.registerLayer_callback_m&&l.registerLayer_callback_m(a,l.map,l.registerLayer_layer,l.registerLayer_callback_u)},complete:function(e,r){},error:function(){}})}},registerRasterDBLayer:function(e,r,a){if(null==e)return void(null!=r&&r("layer in null"));var t=e.name,s=e.typeName,n=e.rasterPath,l=e.dbName;if(null==t||null==s||null==n||null==l)return void(null!=r&&r("params is invalid"));var i=this;this.registerLayer_layer=e,this.registerLayer_callback_m=r,this.registerLayer_callback_u=a;var u=this.map.name,y="service="+this.service+"&version="+this.version+"&request=RegisterLayer&mapName="+u+"&datasource="+l+"&rasterName="+s+"&rasterPath="+n+"&layerName="+t+"&layerType=Raster";$.ajax({type:"get",url:this.server,data:encodeURI(y),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var a=i.parseRegisterLayer(e);null!=i.registerLayer_callback_m&&i.registerLayer_callback_m(a,i.map,i.registerLayer_layer,i.registerLayer_callback_u)},complete:function(e,r){},error:function(){}})},registerTileLayer:function(e,r,a){if(null!=e){var t=(e.name,null);if(e.type==GeoBeans.Layer.TileLayer.Type.QS?t="QuadServer":e.type==GeoBeans.Layer.TileLayer.Type.WMTS&&(t="WMTS"),null!=t){e.url}}},registerQSLayer:function(e,r,a){if(null!=e){var t=e.name,s="QuadServer",n=e.url,l=(n.slice(0,n.lastIndexOf("?")),n.slice(n.indexOf("services=")+"services=".length,n.length));this.registerLayer_layer=e,this.registerLayer_callback_m=r,this.registerLayer_callback_u=a;var i=this,u=this.map.name,y="service="+this.service+"&version="+this.version+"&request=RegisterLayer&mapName="+u+"&layerName="+t+"&layertype="+s+"&webName="+l+"&weburl="+n;$.ajax({type:"get",url:this.server,data:encodeURI(y),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var a=i.parseRegisterLayer(e);null!=i.registerLayer_callback_m&&i.registerLayer_callback_m(a,i.map,i.registerLayer_layer,i.registerLayer_callback_u)},complete:function(e,r){},error:function(){}})}},registerWMTSLayer:function(e,r,a){if(null!=e){var t=e.name,s="WMTS",n=e.getUrl(),l=e.typeName;this.registerLayer_layer=e,this.registerLayer_callback_m=r,this.registerLayer_callback_u=a;var i=this,u=this.map.name,y="service="+this.service+"&version="+this.version+"&request=RegisterLayer&mapName="+u+"&layerName="+t+"&layertype="+s+"&webName="+l+"&weburl="+n;$.ajax({type:"get",url:this.server,data:encodeURI(y),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var a=i.parseRegisterLayer(e);null!=i.registerLayer_callback_m&&i.registerLayer_callback_m(a,i.map,i.registerLayer_layer,i.registerLayer_callback_u)},complete:function(e,r){},error:function(){}})}},unRegisterLayer:function(e,r,a){if(null!=e){this.unRegisterLayer_name=e,this.unRegisterLayer_callback_m=r,this.unRegisterLayer_callback_u=a;var t=this,s=this.map.name,n="service="+this.service+"&version="+this.version+"&request=UnRegisterLayer&mapName="+s+"&layerName="+e;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var a=t.parseUnRegisterLayer(e);null!=t.unRegisterLayer_callback_m&&t.unRegisterLayer_callback_m(a,t.map,t.unRegisterLayer_name,t.unRegisterLayer_callback_u)},complete:function(e,r){},error:function(){}})}},describeLayer:function(e,r,a){if(null==e)return void(null!=r&&r("layername is null"));var t=this,s=this.map.name;this.describeLayer_callback_u=a;var n="service="+this.service+"&version="+this.version+"&request=DescribeLayer&mapName="+s+"&layerName="+e;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,a){var s=t.parseDescribeLayer(e);null!=r&&r(s,t.describeLayer_callback_u)},complete:function(e,r){},error:function(){}})},parseDescribeLayer:function(e){var r=$(e).find("ExceptionText").text();if(""!=r)return r;var a=new Object,t=$(e).find("Name").first().text();a.name=t;var s=$(e).find("Type").first().text();if(a.type=s,"Feature"==s){var n=$(e).find("Feature").first(),l=$(n).find("Name").text(),i=$(n).find("GeometryType").text(),u=$(n).find("FeatureCount").text();a.featureName=l,a.geomType=i,a.count=u}else if("Raster"==s){var y=$(e).find("Raster").first(),c=$(y).find("Name").text(),o=$(y).find("Bands").text(),L=$(y).find("Format").text(),p=$(y).find("PixelType").text(),m=$(y).find("PixelSize").text(),f=$(y).find("Resolution_X").text(),d=$(y).find("Resolution_Y").text(),v=$(y).find("Width").text(),_=$(y).find("Height").text();a.rasterName=c,a.bands=o,a.format=L,a.pixelType=p,a.pixelSize=m,a.resolutionX=f,a.resolutionY=d,a.width=v,a.height=_}var g=$(e).find("EX_GeographicBoundingBox"),h=$(g).find("westBoundLongitude").text(),b=$(g).find("eastBoundLongitude").text(),T=$(g).find("southBoundLatitude").text(),x=$(g).find("northBoundLatitude").text(),S=new GeoBeans.Envelope(h,T,b,x);return a.extent=S,a},parseRegisterLayer:function(e){var r=$(e).find("ExceptionText").text();if(null!=r&&""!=r)return r;var a=null,t=$(e).find("ID").text(),s=$(e).find("Name:first").text(),n=null,l=$(e).find("Type").first().text(),l=this.type,i=null;switch(l.toLowerCase()){case"raster":i=GeoBeans.Layer.DBLayer.Type.Raster;break;case"feature":i=GeoBeans.Layer.DBLayer.Type.Feature;break;case"quadserver":i=GeoBeans.Layer.TileLayer.Type.QS;break;case"wmts":i=GeoBeans.Layer.TileLayer.Type.WMTS}var u=$(e).find("BoundingBox:first"),y=this.parseBoundingBox(u);if(i==GeoBeans.Layer.DBLayer.Type.Raster)a=new GeoBeans.Layer.RasterDBLayer(s,parseInt(t),null,null,n,(!0),null),a.extent=y;else if(i==GeoBeans.Layer.DBLayer.Type.Feature){var c=$(e).find("Style>Name").text(),o=$(e).find("GeometryType").text(),L=null;switch(o.toUpperCase()){case"POINT":L=GeoBeans.Geometry.Type.POINT;break;case"LINESTRING":L=GeoBeans.Geometry.Type.LINESTRING;break;case"POLYGON":L=GeoBeans.Geometry.Type.POLYGON;break;case"MULTIPOINT":L=GeoBeans.Geometry.Type.MULTIPOINT;break;case"MULTILINESTRING":L=GeoBeans.Geometry.Type.MULTILINESTRING;break;case"MULTIPOLYGON":L=GeoBeans.Geometry.Type.MULTIPOLYGON}a=new GeoBeans.Layer.FeatureDBLayer(s,parseInt(t),null,null,n,(!0),c),a.extent=y,a.geomType=L}else if(i==GeoBeans.Layer.TileLayer.Type.QS){var p=$(e).find("URL").text();a=new GeoBeans.Layer.QSLayer(s,p),a.id=parseInt(t),a.visible=!0,a.queryable=!1}else if(i==GeoBeans.Layer.TileLayer.Type.WMTS){var p=$(e).find("URL").text();a=this.getWMTSLayer(s,p),null!=a&&(a.id=parseInt(t),a.visible=!0,a.queryable=!1)}return a},getWMTSLayer:function(e,r){if(null==r&&null==e)return null;for(var a=null,t=null,s=null,n=null,l=null,i=null,u=null,y=null,c=null,o=r.split(";"),L=0;L<o.length;++L){var p=o[L],m=p.split(":"),f=m[0];switch(f){case"typeName":a=m[1];break;case"format":t=m[1];break;case"tms":s=m[1];break;case"extent":l=m[1];var d=l.split(",");n=new GeoBeans.Envelope(parseFloat(d[0]),parseFloat(d[1]),parseFloat(d[2]),parseFloat(d[3]));break;case"sourceName":i=m[1];break;case"url":u=m[1];break;case"startLevel":y=m[1];break;case"endLevel":c=m[1]}}if(null!=e&&null!=a&&null!=t&&null!=s&&null!=n&&null!=i&&null!=u){var v=new GeoBeans.Layer.WMTSLayer(e,u,a,n,s,t,i);return null!=y&&(v.MIN_ZOOM_LEVEL=y),null!=c&&(v.MAX_ZOOM_LEVEL=c),v}return null},parseBoundingBox:function(e){if(null==e)return null;var r=parseFloat($(e).attr("minx")),a=parseFloat($(e).attr("miny")),t=parseFloat($(e).attr("maxx")),s=parseFloat($(e).attr("maxy"));return new GeoBeans.Envelope(r,a,t,s)},parseUnRegisterLayer:function(e){var r=$(e).find("UnRegisterLayer").text();if("success"==r.toLowerCase())return"success";var a=$(e).find("ExceptionText").text();return a},setStyle:function(e,r,a,t){if(null!=e&&null!=r){this.setStyle_typeName=e,this.setStyle_style=r,this.setStyle_callback_m=a,this.setStyle_callback_u=t;var s=r.name,n=this,l=this.map.name,i="service="+this.service+"&version="+this.version+"&request=SetStyle&map="+l+"&layer="+e+"&style="+s;$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var a=n.parseSetStyle(e);null!=n.setStyle_callback_m&&n.setStyle_callback_m(a,n.map,n.setStyle_typeName,n.setStyle_style,n.setStyle_callback_u)},complete:function(e,r){},error:function(){}})}},parseSetStyle:function(e){var r=$(e).find("SetStyle").text();if("success"==r.toLowerCase())return"success";var a=$(e).find("ExceptionText").text();return a}});
GeoBeans.Marker=GeoBeans.Class({title:null,icon:null,mapX:null,mapY:null,offsetX:null,offsetY:null,image:null,layer:null,initialize:function(i,t,e,a){this.title=i,this.icon=t,this.mapX=e,this.mapY=a,this.offsetX=0,this.offsetY=0,this.image=new Image},destory:function(){},setLayer:function(i){this.layer=i},draw:function(){if(null==this.image?(this.image=new Image,this.image.src=this.icon):0==this.image.src.length&&(this.image.src=this.icon),this.image.complete)this.drarMaker();else{var i=this;this.image.onload=function(){i.drarMaker()}}},drarMaker:function(){var i=this.layer.map.transformation,t=i.toScreenPoint(this.mapX,this.mapY),e=this.layer.map.renderer;e.context.drawImage(this.image,t.x,t.y)}});
GeoBeans.Overlay=GeoBeans.Class({geometry:null,symbolizer:null,name:null,layer:null,loadFlag:null,visible:!0,isEdit:!1,isHit:!1,kvMap:{},htmlPath:null,initialize:function(e,i,t){this.name=e,this.geometry=i,this.symbolizer=t,this.loadFlag=GeoBeans.Overlay.Flag.READY,this.visible=!0,this.kvMap={}},setLayer:function(e){this.layer=e},draw:function(){if(this.visible){this.loadFlag=GeoBeans.Overlay.Flag.LOADED;var e=this.layer.map.transformation;this.layer.renderer.setSymbolizer(this.symbolizer),this.layer.renderer.drawOverlay(this,this.symbolizer,e)}},setVisible:function(e){this.visible=e},beginEdit:function(){var e=this.layer.getEditOverlaySymbolizer(this);this.layer.drawEditOverlay(this,e),this.isEdit=!0},endEdit:function(){this.isHit=!1,this.isEdit=!1,this.layer.editOverlay=null,this.layer.editRenderer.clearRect(),this.layer.map.drawLayersAll()},getKeyValueMap:function(){return this.kvMap},hasKey:function(e){return e in this.kvMap},getValue:function(e){return this.hasKey(e)?this.kvMap[e]:null},removeKey:function(e){this.hasKey(e)&&delete this.kvMap[e]},addKeyValue:function(e,i){this.hasKey(e)||(this.kvMap[e]=i)},removeKeys:function(){for(var e in this.kvMap)this.removeKey(e);this.kvMap={}},clone:function(){var e=new GeoBeans.Geometry;e=this.geometry;var i=new GeoBeans.Style.Symbolizer;i=this.symbolizer;var t={},a=this.name,s=new GeoBeans.Overlay(a,e,i);s.visible=this.visible,s.isEdit=this.isEdit,s.isHit=this.isHit;for(var l in this.kvMap){var r=this.kvMap[l];t[l]=r}return s.kvMap=t,s},getExtent:function(){var e=this.geometry,i=null;if(this.type==GeoBeans.Overlay.Type.MARKER){var t=e.x,a=e.y;i=new GeoBeans.Envelope(t-1,a-1,t+1,a+1)}else i=e.extent;return i}}),GeoBeans.Overlay.Type={MARKER:"Marker",PLOYLINE:"Polyline",CIRCLE:"Circle",POLYGON:"Polygon"},GeoBeans.Overlay.Flag={READY:"ready",LOADED:"loaded"};
GeoBeans.Renderer=GeoBeans.Class({canvas:null,context:null,initialize:function(e){this.canvas=e,this.context=e.getContext("2d")},draw:function(e,t,n){var o=e.geometry;null!=o&&this.drawGeometry(o,t,n)},save:function(){this.canvas.save()},restore:function(){this.canvas.restore()},getGlobalAlpha:function(){return this.context.globalAlpha},setGlobalAlpha:function(e){this.context.globalAlpha=e},drawGeometry:function(e,t,n){switch(e.type){case GeoBeans.Geometry.Type.POINT:this.drawPoint(e,t,n);break;case GeoBeans.Geometry.Type.MULTIPOINT:this.drawMultiPoint(e,t,n);break;case GeoBeans.Geometry.Type.LINESTRING:this.drawLineString(e,t,n);break;case GeoBeans.Geometry.Type.MULTILINESTRING:this.drawMultiLineString(e,t,n);break;case GeoBeans.Geometry.Type.POLYGON:this.drawPolygon(e,t,n);break;case GeoBeans.Geometry.Type.MULTIPOLYGON:this.drawMultiPolygon(e,t,n);break;case GeoBeans.Geometry.Type.CIRCLE:this.drawCircle(e,t,n)}},drawPoint:function(e,t,n){var o,i=t.size;o=n.toScreenPoint(e.x,e.y),this.context.beginPath(),this.context.arc(o.x,o.y,i,0,2*Math.PI,!1),this.context.closePath(),this.context.fill(),null!=t.stroke&&this.context.stroke()},drawLineString:function(e,t,n){if(!(e.points.length<1)){var o=null,i=null,l=this.context;l.beginPath(),o=e.points[0],i=n.toScreenPoint(o.x,o.y),l.moveTo(i.x,i.y);for(var r=1,a=e.points.length;r<a;r++)o=e.points[r],i=n.toScreenPoint(o.x,o.y),l.lineTo(i.x,i.y);l.stroke()}},drawPolygon:function(e,t,n){var o,i,l=null,r=null,a=0,s=0,c=this.context;for(c.beginPath(),a=e.rings.length,o=0;o<a;o++)for(r=e.rings[o],s=r.points.length,l=r.points[0],spt=n.toScreenPoint(l.x,l.y),c.moveTo(spt.x,spt.y),i=1;i<s;i++)l=r.points[i],spt=n.toScreenPoint(l.x,l.y),c.lineTo(spt.x,spt.y);null!=t.fill&&c.fill(),t.stroke&&c.stroke(),c.closePath()},drawMultiPoint:function(e,t,n){points=e.points;for(var o=null,i=0,l=points.length;i<l;i++)o=points[i],this.drawPoint(o,t,n)},drawMultiLineString:function(e,t,n){lines=e.lines;for(var o=null,i=0,l=lines.length;i<l;i++)o=lines[i],this.drawLineString(o,t,n)},drawMultiPolygon:function(e,t,n){polygons=e.polygons;for(var o=null,i=0,l=polygons.length;i<l;i++)o=polygons[i],this.drawPolygon(o,t,n)},drawCircle:function(e,t,n){var o=e.center,i=e.radius;if(!(i<=0)){var l=this.context;l.beginPath();var r=n.toScreenPoint(o.x,o.y),a=n.toScreenPoint(o.x+i,o.y),s=Math.sqrt((r.x-a.x)*(r.x-a.x)+(r.y-a.y)*(r.y-a.y));l.arc(r.x,r.y,s,0,2*Math.PI,!0),null!=t.fill&&l.fill(),t.stroke&&l.stroke(),l.closePath()}},drawIcons:function(e,t,n){if(0!=e.length)if(null==t.icon?(t.icon=new Image,t.icon.src=t.symbol.icon):t.icon.src!=t.symbol.icon&&(t.icon=null,t.icon=new Image,t.icon.src=t.symbol.icon),t.icon.complete)for(var o=e.length,i=0;i<o;i++){var l=e[i].geometry,r=n.toScreenPoint(l.x,l.y);this.drawIcon(t.icon,r.x,r.y,t)}else{var a=this;t.icon.onload=function(){for(var o=e.length,i=0;i<o;i++){var l=e[i].geometry,r=n.toScreenPoint(l.x,l.y);a.drawIcon(t.icon,r.x,r.y,t)}mapObj.drawLayersAll()}}},drawIcon:function(e,t,n,o){var i,l;i=o.icon_width>0?o.icon_width:e.width,l=o.icon_height>0?o.icon_height:e.height;var r=Math.ceil(t-i/2)+o.icon_offset_x,a=Math.ceil(n-l/2)+o.icon_offset_y;this.context.drawImage(e,r,a,i,l)},drawRing:function(e,t,n,o,i,l,r){var a=null;a=r.toScreenPoint(e.x,e.y);var s=new GeoBeans.Color;s.setByHex(o,l),this.context.fillStyle=s.getRgba(),this.context.beginPath(),this.context.arc(a.x,a.y,n,0,2*Math.PI,!1),this.context.closePath(),this.context.fill();var c=new GeoBeans.Color;c.setByHex(o,i),this.context.fillStyle=c.getRgba(),this.context.beginPath(),this.context.arc(a.x,a.y,t,0,2*Math.PI,!1),this.context.closePath(),this.context.fill()},drawBezierLine:function(e,t,n,o){var i=o.toScreenPoint(e.x,e.y),l=o.toScreenPoint(t.x,t.y),r=o.toScreenPoint(n.x,n.y);this.context.beginPath(),this.context.moveTo(i.x,i.y),this.context.quadraticCurveTo(r.x,r.y,l.x,l.y),this.context.stroke()},label:function(e,t,n,o){switch(e.type){case GeoBeans.Geometry.Type.POINT:this.labelPoint(e,t,n,o);break;case GeoBeans.Geometry.Type.MULTIPOINT:this.labelMultiPoint(e,t,o);break;case GeoBeans.Geometry.Type.LINESTRING:this.labelLineString(e,t,o);break;case GeoBeans.Geometry.Type.MULTILINESTRING:this.labelMultiLineString(e,t,o);break;case GeoBeans.Geometry.Type.POLYGON:this.labelPolygon(e,t,o);break;case GeoBeans.Geometry.Type.MULTIPOLYGON:this.labelMultiPolygon(e,t,o)}},labelPoint:function(e,t,n,o){var i;i=o.toScreenPoint(e.x,e.y),null!=n.fill&&this.context.fillText(t,i.x,i.y)},drawLabel:function(e){var t=e.pos,n=e.textSymbolizer;null!=n.fill&&this.context.fillText(e.text,t.x,t.y),null!=n.stroke&&this.context.strokeText(e.text,t.x,t.y)},labelLineString:function(e,t,n,o){},labelPolygon:function(e,t,n,o){},labelMultiPoint:function(e,t,n,o){},labelMultiLineString:function(e,t,n,o){},labelMultiPolygon:function(e,t,n,o){},getTextExtent:function(e,t){var n=this.context.measureText(e).width;null==t&&(t=12);var o=new GeoBeans.Envelope(0,0,n,t);return o},drawImage:function(e,t,n,o,i){try{this.context.drawImage(e,t,n,o,i)}catch(e){console.log("drawImage failed: "+e)}},drawImageParms:function(e,t,n,o,i,l,r,a,s){try{this.context.drawImage(e,t,n,o,i,l,r,a,s)}catch(e){console.log("drawImage failed: "+e)}},setSymbolizer:function(e){if(e instanceof GeoBeans.Symbolizer.PointSymbolizer)null!=e.stroke&&(null!=e.stroke.width&&(this.context.lineWidth=e.stroke.width),null!=e.stroke.color&&(this.context.strokeStyle=e.stroke.color.getRgba())),null!=e.fill&&(this.context.fillStyle=e.fill.color.getRgba());else if(e instanceof GeoBeans.Symbolizer.LineSymbolizer){var t=e.stroke;null!=t&&(this.context.strokeStyle=t.color.getRgba(),null!=t.width&&(this.context.lineWidth=t.width),null!=t.lineCap&&(this.context.lineCap=t.lineCap),null!=t.lineJoin&&(this.context.lineJoin=t.lineJoin))}else if(e instanceof GeoBeans.Symbolizer.PolygonSymbolizer){var n=e.fill;null!=n&&(this.context.fillStyle=n.color.getRgba());var t=e.stroke;null!=t&&(this.context.strokeStyle=t.color.getRgba(),null!=t.width&&(this.context.lineWidth=t.width),null!=t.lineCap&&(this.context.lineCap=t.lineCap),null!=t.lineJoin&&(this.context.lineJoin=t.lineJoin))}else if(e instanceof GeoBeans.Symbolizer.TextSymbolizer){var o=e.font;null!=o&&(this.context.font=o.style+" "+o.weight+" "+o.size+"px "+o.family);var n=e.fill;null!=n&&(this.context.fillStyle=n.color.getRgba());var t=e.stroke;null!=t&&(this.context.strokeStyle=t.color.getRgba(),null!=t.width&&(this.context.lineWidth=t.width),null!=t.lineCap&&(this.context.lineCap=t.lineCap),null!=t.lineJoin&&(this.context.lineJoin=t.lineJoin))}e.showShadow&&(this.context.shadowBlur=e.shadowBlur,this.context.shadowColor=e.shadowColor,this.context.shadowOffsetX=e.shadowOffsetX,this.context.shadowOffsetY=e.shadowOffsetY)},fillCircle:function(e,t,n,o){},strokeCircle:function(e,t,n,o){},clear:function(e,t,n,o){switch(e.type){case GeoBeans.Geometry.Type.POINT:this.clearPoint(e,t,n,o);break;case GeoBeans.Geometry.Type.MULTIPOINT:this.clearMultiPoint(e,t,n,o);break;case GeoBeans.Geometry.Type.LINESTRING:this.clearLineString(e,t,o);break;case GeoBeans.Geometry.Type.MULTILINESTRING:this.clearMultiLineString(e,t,o);break;case GeoBeans.Geometry.Type.POLYGON:this.clearPolygon(e,t,o);break;case GeoBeans.Geometry.Type.MULTIPOLYGON:this.clearMultiPolygon(e,t,o)}},clearPoint:function(e,t,n,o){var i;i=o.toScreenPoint(e.x,e.y),this.context.fillStyle=t,this.context.beginPath(),this.context.arc(i.x,i.y,n,0,2*Math.PI,!1),this.context.closePath(),this.context.fill()},clearLineString:function(e,t,n){if(!(e.points.length<1)){var o=null,i=null,l=this.context;l.strokeStyle=t,l.beginPath(),o=e.points[0],i=n.toScreenPoint(o.x,o.y),l.moveTo(i.x,i.y);for(var r=1,a=e.points.length;r<a;r++)o=e.points[r],i=n.toScreenPoint(o.x,o.y),l.lineTo(i.x,i.y);l.stroke()}},clearPolygon:function(e,t,n){var o,i,l=null,r=null,a=0,s=0,c=this.context;for(c.fillStyle=t,c.beginPath(),a=e.rings.length,o=0;o<a;o++)for(r=e.rings[o],s=r.points.length,l=r.points[0],spt=n.toScreenPoint(l.x,l.y),c.moveTo(spt.x,spt.y),i=1;i<s;i++)l=r.points[i],spt=n.toScreenPoint(l.x,l.y),c.lineTo(spt.x,spt.y);c.closePath(),c.fill()},clearMultiPoint:function(e,t,n,o){points=e.points;for(var i=null,l=0,r=points.length;l<r;l++)i=points[l],this.clearPoint(i,symbolizer,n,o)},clearMultiLineString:function(e,t,n){lines=e.lines;for(var o=null,i=0,l=lines.length;i<l;i++)o=lines[i],this.clearLineString(o,t,n)},clearMultiPolygon:function(e,t,n){polygons=e.polygons;for(var o=null,i=0,l=polygons.length;i<l;i++)o=polygons[i],this.clearPolygon(o,t,n)},save:function(){this.context.save()},restore:function(){this.context.restore()},clearRect:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)},drawOverlay:function(e,t,n){var o=!1,i=e.type;switch(i){case GeoBeans.Overlay.Type.MARKER:o=this.drawMarker(e,t,n);break;default:this.drawGeometry(e.geometry,t,n),o=!0}return o},drawMarker:function(e,t,n){var o=this,i=t.icon_url,l=e.geometry.x,r=e.geometry.y,a=n.toScreenPoint(l,r);return null==t.image&&(t.image=new Image,t.image.src=i),t.image.complete?(e.loadFlag=GeoBeans.Overlay.Flag.LOADED,this.drawIcon(t.image,a.x,a.y,t),!0):void(t.image.onload=function(){e.loadFlag=GeoBeans.Overlay.Flag.LOADED,o.drawIcon(t.image,a.x,a.y,t),e.layer.draw()})},drawTip:function(e,t,n,o){if(null==e||null==t||null==n)return null;var i=n.symbolizer;if(null==i)return null;this.setSymbolizer(i);var l=12,r=n.textSymbolizer;null!=r&&null!=r.font&&null!=r.font.size&&(l=r.font.size);var a=r.labelText;if(null==a)return null;var s=34,c=26,y=this.context.measureText(a).width;y>40&&(s=y+10);var h=e.x,x=e.y,u=t.toScreenPoint(h,x),f=6,g=5,G=new GeoBeans.Geometry.Point(u.x-f,u.y-f),P=new GeoBeans.Geometry.Point(u.x-s/2+g,u.y-f),m=new GeoBeans.Geometry.Point(u.x-s/2,u.y-f),w=new GeoBeans.Geometry.Point(u.x-s/2,u.y-f-g),p=new GeoBeans.Geometry.Point(u.x-s/2,u.y-c+g),d=new GeoBeans.Geometry.Point(u.x-s/2,u.y-c),b=new GeoBeans.Geometry.Point(u.x-s/2+g,u.y-c),T=(new GeoBeans.Geometry.Point(u.x+s/2-g,u.y-c),new GeoBeans.Geometry.Point(u.x+s/2,u.y-c)),v=(new GeoBeans.Geometry.Point(u.x+s/2,u.y-c+g),new GeoBeans.Geometry.Point(u.x+s/2,u.y-f-g),new GeoBeans.Geometry.Point(u.x+s/2,u.y-f)),S=(new GeoBeans.Geometry.Point(u.x+s/2-g,u.y-f),new GeoBeans.Geometry.Point(u.x+f,u.y-f)),B=this.context;B.beginPath(),B.moveTo(u.x,u.y),B.lineTo(G.x,G.y),B.lineTo(P.x,P.y),B.arcTo(m.x,m.y,w.x,w.y,g),B.lineTo(p.x,p.y),B.arcTo(d.x,d.y,b.x,b.y,g),B.lineTo(T.x,T.y),B.lineTo(v.x,v.y),B.lineTo(S.x,S.y),B.lineTo(u.x,u.y),null!=i.stroke&&B.stroke(),null!=i.fill&&B.fill();var r=n.textSymbolizer;null!=r&&this.setSymbolizer(r);var I=u.x-y/2,k=u.y-f-6;if(null!=r.fill&&B.fillText(a,I,k),null==o)return null;var L=o.textSymbolizer,M=o.symbolizer;null!=M&&this.setSymbolizer(M);var O=L.labelText;if(null==O)return null;O.length>=5&&(O=O.slice(0,5));var z=4,N=this.context.measureText(O).width;N+=2*z;var C=new GeoBeans.Geometry.Point(T.x+N-g,T.y),R=new GeoBeans.Geometry.Point(T.x+N,T.y),E=new GeoBeans.Geometry.Point(T.x+N,T.y+g),J=new GeoBeans.Geometry.Point(v.x+N,v.y-g),U=new GeoBeans.Geometry.Point(v.x+N,v.y),_=new GeoBeans.Geometry.Point(v.x+N-g,v.y);B.beginPath(),B.moveTo(T.x,T.y),B.lineTo(C.x,C.y),B.arcTo(R.x,R.y,E.x,E.y,g),B.lineTo(J.x,J.y),B.arcTo(U.x,U.y,_.x,_.y,g),B.lineTo(v.x,v.y),B.lineTo(T.x,T.y),null!=M.stroke&&B.stroke(),null!=M.fill&&B.fill(),null!=L&&this.setSymbolizer(L);var A=u.x+s/2+z,Y=u.y-f-6;B.fillText(O,A,Y,N);var D=new GeoBeans.Envelope(d.x,d.y,U.x,U.y);return D}});
GeoBeans.Style=GeoBeans.Class({name:null,type:null,initialize:function(e){this.name=e}}),GeoBeans.Style.Type={FeatureType:"featureType",RasterType:"rasterType"};
GeoBeans.Symbolizer=GeoBeans.Class({type:null,initialize:function(){},clone:function(){}}),GeoBeans.Symbolizer.Type={Point:"point",Line:"line",Polygon:"polygon",Text:"text",Raster:"raster"};
GeoBeans.Transformation=GeoBeans.Class({map:null,win_w:null,win_h:null,win_cx:null,win_cy:null,view_w:null,view_h:null,view_c:null,scale:null,initialize:function(i){this.map=i},toMapPoint:function(i,t){var e=(i-this.win_cx)/this.scale+this.view_c.x,n=(this.win_cy-t)/this.scale+this.view_c.y,s=new GeoBeans.Geometry.Point(e,n);return s},toScreenPoint:function(i,t){var e=this.scale*(i-this.view_c.x)+this.win_cx,n=this.win_cy-this.scale*(t-this.view_c.y),s=new GeoBeans.Geometry.Point(e,n);return s},update:function(){var i=this.map.viewer,t=this.map.width,e=this.map.height;this.win_w=parseFloat(t),this.win_h=parseFloat(e),this.win_cx=t/2,this.win_cy=e/2,this.view_w=i.getWidth(),this.view_h=i.getHeight(),this.view_c=i.getCenter();var n=this.win_w/this.view_w,s=this.win_h/this.view_h;this.scale=n<s?n:s,this.map.tolerance=this.map.TOLERANCE/this.scale}});
GeoBeans.User=GeoBeans.Class({name:null,server:null,mapManager:null,styleManager:null,dbsManager:null,tileDBManager:null,fileManager:null,rasterDBManager:null,gpsManager:null,tileDBManager:null,poiManager:null,subManager:null,serviceManager:null,jobManager:null,initialize:function(e){this.name=e,this.server="/ows/"+this.name+"/mgr";var a="/ows/"+this.name;this.mapManager=new GeoBeans.MapManager(a),this.styleManager=new GeoBeans.StyleManager(a),this.dbsManager=new GeoBeans.DBSManager(a),this.fileManager=new GeoBeans.FileManager(a),this.tileDBManager=new GeoBeans.TileDBManager(a),this.rasterDBManager=new GeoBeans.RasterDBManager(a),this.gpsManager=new GeoBeans.GPSManager(a),this.poiManager=new GeoBeans.PoiManager(this.name),this.subManager=new GeoBeans.SubManager(a),this.serviceManager=new GeoBeans.ServiceManager(a),this.jobManager=new GeoBeans.JobManager(a)},logout:function(){this.mapManager=null,this.styleManager=null,this.dbsManager=null,this.fileManager=null,this.tileDBManager=null,this.rasterDBManager=null,this.gpsManager=null},getMapManager:function(){return this.mapManager},getStyleManager:function(){return this.styleManager},getDBSManager:function(){return this.dbsManager},getFileManager:function(){return this.fileManager},getTileDBManager:function(e){return null==e?null:(this.tileDBManager.setName(e),this.tileDBManager)},getRasterDBManager:function(){return this.rasterDBManager},getGPSManager:function(){return this.gpsManager},getPoiManager:function(){return this.poiManager},getSubManager:function(){return this.subManager},getServiceManager:function(){return this.serviceManager},getJobManager:function(){return this.jobManager}});
GeoBeans.Workspace=GeoBeans.Class({name:null,initialize:function(n){this.name=n},destory:function(){this.name=null}});
GeoBeans.AQIIndexChart=GeoBeans.Class({name:null,container:null,dbName:null,tableName:null,chartFields:null,filterField:null,filterFieldValue:null,timeField:null,startTime:null,endTime:null,map:null,features:null,featureType:null,initialize:function(e,t,i,a,r,l,s,n,o,h){this.name=e,this.container=t,this.dbName=i,this.tableName=a,this.chartFields=r,this.filterField=l,this.filterFieldValue=s,this.timeField=n,this.startTime=o,this.endTime=h},setMap:function(e){this.map=e},setChartFields:function(e){this.chartFields=e},cleanup:function(){this.chart.clear()},show:function(){null!=this.container&&null!=this.dbName&&null!=this.tableName&&null!=this.chartFields&&null!=this.filterField&&null!=this.filterFieldValue&&null!=this.timeField&&null!=this.startTime&&null!=this.endTime&&null!=this.map&&this.getFeatures()},getFeatures:function(){var e=new GeoBeans.BinaryLogicFilter;e.operator=GeoBeans.LogicFilter.OperatorType.LogicOprAnd;var t=new GeoBeans.BinaryComparisionFilter;t.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var i=new GeoBeans.PropertyName;i.setName(this.filterField);var a=new GeoBeans.Literal;a.setValue(this.filterFieldValue),t.expression1=i,t.expression2=a,e.addFilter(t);var r=new GeoBeans.BinaryLogicFilter;r.operator=GeoBeans.LogicFilter.OperatorType.LogicOprAnd;var l=new GeoBeans.BinaryComparisionFilter;l.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprGreaterThanOrEqual,i=new GeoBeans.PropertyName,i.setName(this.timeField),a=new GeoBeans.Literal,a.setValue(this.startTime),l.expression1=i,l.expression2=a;var s=new GeoBeans.BinaryComparisionFilter;s.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprLessThanOrEqual,i=new GeoBeans.PropertyName,i.setName(this.timeField),a=new GeoBeans.Literal,a.setValue(this.endTime),s.expression1=i,s.expression2=a,r.addFilter(l),r.addFilter(s),e.addFilter(r);var n=new GeoBeans.WFSWorkspace("tmp",this.map.server,"1.0.0"),o=new GeoBeans.FeatureType(n,this.tableName);this.featureType=o,this.featureType.getFeaturesFilterAsync2(null,this.dbName,e,null,null,[this.timeField].concat(this.chartFields),this.timeField,this,this.getFeatures_callback)},getFeatures_callback:function(e,t){if(null!=e&&null!=t)if(e.features=t,null==e.chart){var i=e.getChartOption(),a=echarts.init(e.container);e.chart=a,a.setOption(i)}else{e.chart.clear();var i=e.getChartOption();e.chart.setOption(i)}},getChartOption:function(){if(null!=this.features&&null!=this.featureType){for(var e=[],t=[],i=0;i<this.chartFields.length;++i){var a=this.featureType.getFieldIndex(this.chartFields[i]);e.push(a),t[i]=[]}for(var r=[],l=this.featureType.getFieldIndex(this.timeField),s=null,n=null,i=0;i<this.features.length;++i)if(s=this.features[i],null!=s&&(n=s.values,null!=n)){for(var o=0;o<e.length;++o){var a=e[o],h=n[a];h=parseFloat(h),t[o].push(h)}var u=n[l];r.push(u)}for(var p=[],i=0;i<this.chartFields.length;++i){var d={name:this.chartFields[i],type:"line",smooth:!0,data:t[i]};p.push(d)}var F={toolbox:{show:!0,x:0,y:"top",feature:{dataView:{show:!0,readOnly:!0},magicType:{show:!0,type:["line","bar"]},restore:{show:!0},saveAsImage:{show:!0}}},grid:{x:"130px"},tooltip:{trigger:"axis"},legend:{data:this.chartFields,x:"184px",y:"top"},calculable:!0,xAxis:[{type:"value",boundaryGap:[0,.01]}],yAxis:[{type:"category",data:r}],series:p};return F}}});
GeoBeans.AQIStatCompChart=GeoBeans.Class({name:null,container:null,dbName:null,tableName:null,chartFields:null,stationCodeField:null,stationCodes:null,timeField:null,startTime:null,endTime:null,positionField:null,map:null,features:null,featureType:null,chart:null,initialize:function(e,t,i,l,a,s,n,r,o,h,u){this.name=e,this.container=t,this.dbName=i,this.tableName=l,this.chartFields=a,this.stationCodeField=s,this.stationCodes=n,this.timeField=r,this.startTime=o,this.endTime=h,this.positionField=u},setMap:function(e){this.map=e},cleanup:function(){null!=this.chart&&this.chart.clear()},show:function(){null!=this.container&&null!=this.dbName&&null!=this.tableName&&null!=this.chartFields&&null!=this.stationCodeField&&null!=this.stationCodes&&null!=this.timeField&&null!=this.startTime&&null!=this.endTime&&null!=this.map&&this.getFeatures()},getFeatures:function(){var e=new GeoBeans.BinaryLogicFilter;e.operator=GeoBeans.LogicFilter.OperatorType.LogicOprAnd;var t=new GeoBeans.BinaryLogicFilter;t.operator=GeoBeans.LogicFilter.OperatorType.LogicOprOr;var i=null,l=new GeoBeans.PropertyName;l.setName(this.stationCodeField);for(var a=0;a<this.stationCodes.length;++a)if(i=this.stationCodes[a],null!=i){var s=new GeoBeans.BinaryComparisionFilter;s.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var n=new GeoBeans.Literal;n.setValue(i),s.expression1=l,s.expression2=n,t.addFilter(s)}var r=new GeoBeans.BinaryLogicFilter;r.operator=GeoBeans.LogicFilter.OperatorType.LogicOprAnd;var o=new GeoBeans.BinaryComparisionFilter;o.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprGreaterThanOrEqual;var h=new GeoBeans.PropertyName;h.setName(this.timeField),literal=new GeoBeans.Literal,literal.setValue(this.startTime),o.expression1=h,o.expression2=literal;var u=new GeoBeans.BinaryComparisionFilter;u.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprLessThanOrEqual,literal=new GeoBeans.Literal,literal.setValue(this.endTime),u.expression1=h,u.expression2=literal,r.addFilter(o),r.addFilter(u),e.addFilter(t),e.addFilter(r);var d=new GeoBeans.WFSWorkspace("tmp",this.map.server,"1.0.0"),p=new GeoBeans.FeatureType(d,this.tableName);this.featureType=p,this.featureType.getFeaturesFilterAsync2(null,this.dbName,e,null,null,[this.timeField,this.stationCodeField,this.positionField].concat(this.chartFields),this.timeField,this,this.getFeatures_callback)},getFeatures_callback:function(e,t){if(null!=e&&null!=t){e.features=t;var i=e.getChartOption(),l=echarts.init(e.container);l.setOption(i),e.chart=l}},getChartOption:function(){if(null==this.features||null==this.featureType)return null;for(var e=this.getTimePointsList(),t=this.featureType.getFieldIndex(this.timeField),i=[],l=[],a=0;a<this.chartFields.length;++a){var s=this.featureType.getFieldIndex(this.chartFields[a]);i.push(s),l[a]=[]}for(var n=this.featureType.getFieldIndex(this.stationCodeField),r=null,o=null,h=null,u=null,d=null,p=null,F=null,c=[],f=[],a=0;a<this.stationCodes.length;++a)if(u=this.stationCodes[a],null!=u){c[a]=[];for(var m=0;m<this.chartFields.length;++m)null!=this.chartFields[m]&&(c[a][m]=[])}for(var a=0;a<this.features.length;++a)if(r=this.features[a],null!=r&&(o=r.values,null!=o)){h=o[n],p=o[t];for(var m=0;m<this.stationCodes.length;++m)if(u=this.stationCodes[m],null!=u&&h==u)for(var g=0;g<e.length;++g)if(d=e[g],null!=d&&d==p)for(var y=0;y<this.chartFields.length;++y)F=this.chartFields[y],null!=F&&(chartFieldValue=o[i[y]],chartFieldValue=parseFloat(chartFieldValue),c[m][y].push(chartFieldValue))}for(var f=this.getPositionNames(),v=[],C=[],T=null,B=null,G=null,a=0;a<c.length;++a)if(T=c[a],null!=T)for(var m=0;m<T.length;++m)B=T[m],null!=B&&(G={name:f[a]+"--"+this.chartFields[m],type:"line",smooth:!0,data:B},C.push(G),v.push(f[a]+"--"+this.chartFields[m]));var x={toolbox:{show:!0,x:0,y:"top",feature:{dataView:{show:!0,readOnly:!0},magicType:{show:!0,type:["line","bar"]},restore:{show:!0},saveAsImage:{show:!0}}},tooltip:{trigger:"axis"},legend:{data:v,x:"140px",y:"top"},calculable:!0,yAxis:[{type:"value",boundaryGap:[0,.01]}],xAxis:[{type:"category",data:e}],series:C};return x},getTimePointsList:function(){for(var e=[],t=null,i=null,l=null,a=this.featureType.getFieldIndex(this.timeField),s=0;s<this.features.length;++s)i=this.features[s],null!=i&&(l=i.values,null!=l&&(t=l[a],null!=t&&e.indexOf(t)==-1&&e.push(t)));return e},getPositionNames:function(){for(var e=this.featureType.getFieldIndex(this.positionField),t=[],i=this.featureType.getFieldIndex(this.stationCodeField),l=0;l<this.stationCodes.length;++l)for(var a=this.stationCodes[l],s=0;s<this.features.length;++s){var n=this.features[s];if(null!=n){var r=n.values;if(null!=r){var o=r[i];if(a==o){var h=r[e];if(null==t[l]){t.push(h);break}}}}}return t}});
GeoBeans.AQITimePointList=GeoBeans.Class({map:null,name:null,dbName:null,tableName:null,timeField:null,startTime:null,endTime:null,initialize:function(e,i,r,t,a,l){this.name=e,this.dbName=i,this.tableName=r,this.timeField=t,this.startTime=a,this.endTime=l},setMap:function(e){this.map=e},getTimeList:function(){if(null==this.map)return null;var e=new GeoBeans.BinaryLogicFilter;e.operator=GeoBeans.LogicFilter.OperatorType.LogicOprAnd;var i=new GeoBeans.BinaryComparisionFilter;i.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprGreaterThanOrEqual,prop=new GeoBeans.PropertyName,prop.setName(this.timeField),literal=new GeoBeans.Literal,literal.setValue(this.startTime),i.expression1=prop,i.expression2=literal;var r=new GeoBeans.BinaryComparisionFilter;r.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprLessThan,prop=new GeoBeans.PropertyName,prop.setName(this.timeField),literal=new GeoBeans.Literal,literal.setValue(this.endTime),r.expression1=prop,r.expression2=literal,e.addFilter(i),e.addFilter(r);var t=new GeoBeans.WFSWorkspace("tmp",this.map.server,"1.0.0"),a=new GeoBeans.FeatureType(t,this.tableName),l=new GeoBeans.OrderBy;l.addField(this.timeField),l.setOrder(GeoBeans.OrderBy.OrderType.OrderAsc);var n=a.getFeaturesFilter(null,this.dbName,e,null,null,[this.timeField],l);if(null==n)return null;for(var s=[],o=null,p=null,m=null,u=a.getFieldIndex(this.timeField),d=0;d<n.length;++d)o=n[d],null!=o&&(p=o.values,null!=p&&(m=p[u],s.push(m)));return s}});
GeoBeans.TimeLineBar=GeoBeans.Class({slider:null,wrapper:null,broadcastIntervalId:null,initialized:!1,boardcast:null,layer:null,map:null,timePoints:null,initialize:function(i){if(null!=i){this.layer=i;var t=this.layer.map;if(null!=t){this.map=t,this.map.mapDiv.find("#slider").remove();var a='<div class="slider-wrap" id="slider">\t<button class="timeline-play" id="slider_player">\t\t<img src="../images/timeline-play.png">\t</button>   <div class="timeline"></div>\t  <div class="label-div"></div></div>';this.map.mapDiv.append(a);var s=i.getTimePoints();this.timePoints=s;var e=this;if(!this.initialized){this.wrapper=this.map.mapDiv.find("#slider"),this.slider=this.wrapper.find(".timeline"),this.slider.noUiSlider({start:0,range:{min:0,max:s.length-1},step:1});for(var l=1,r=1;r<s.length-1;r++){var n=r/(s.length-1)*100,d=$('<span class="ui-slider-segment"></span>');d.attr("data-content",l+r).css("left",n+"%"),this.slider.append(d)}this.boardcast=this.wrapper.find(".timeline-play"),this.boardcast.click(function(i){var t=$(this).find("img"),a=t.attr("src");/play/.test(a)?t.attr("src",a.replace("play","pause")):t.attr("src",a.replace("pause","play")),e.broadcast()}),this.slider.on("set",function(){var i=parseInt($(this).val());e.layer.currentLayerID=i,e.layer.map.drawLayersAll()}),this.addLabels(),this.initialized=!0}}}},show:function(){this.wrapper.css("display","block")},hide:function(){this.wrapper.css("display","none")},broadcast:function(){var i=this;null!=this.broadcastIntervalId?(clearInterval(this.broadcastIntervalId),this.broadcastIntervalId=null):this.broadcastIntervalId=setInterval(function(){var t=i.slider.val();t=parseInt(t),t===i.timePoints.length-1?i.slider.val(0):i.slider.val(t+1)},this.layer.interval)},cleanup:function(){this.map.mapDiv.find("#slider").remove(),clearInterval(this.broadcastIntervalId),this.broadcastIntervalId=null,this.slider=null,this.wrapper=null,this.initialized=!1,this.boardcast=null},addLabels:function(){if(!(null==this.timePoints||this.timePoints.length<2)){var i=this.timePoints.length,t=this.timePoints[0],a=document.createElement("canvas"),s=a.getContext("2d");s.font="12px Arial, Verdana, sans-seri";var e=s.measureText(t).width,l=this.slider.width(),r=l/(i-1),n="";if(r>e){var d=e/2*-1;this.wrapper.find(".label-div").css("margin-left",d).css("width","calc(100% + "+e+"px)");for(var p=0;p<i;++p){var h=0;h=0==p?0:r-e,n+="<div class='time-label' style='padding-left:"+h+"px'>"+this.timePoints[p]+"</div>"}this.wrapper.find(".label-div").html(n)}else{for(var c=Math.ceil(e/r),p=0;p+c<i;p+=c){var h=0;h=0==p?0:c*r-e,n+="<div class='time-label' style='padding-left:"+h+"px'>"+this.timePoints[p]+"</div>"}h+=(i-1-p)*r,n+="<div class='time-label' style='padding-left:"+h+"px'>"+this.timePoints[i-1]+"</div>";var d=e/2*-1;this.wrapper.find(".label-div").css("margin-left",d).css("width","calc(100% + "+e+"px)"),this.wrapper.find(".label-div").html(n)}}}});
GeoBeans.AuthManager=GeoBeans.Class({server:null,service:"was",version:"1.0.0",initialize:function(e){this.server=e},createUser:function(e,n,t,r,s,i){if(null==e||null==n||null==t||null==r||null==s)return void(null==i&&i("params is invalid"));var o=this,a="service="+this.service+"&version="+this.version+"&request=createUser&name="+e+"&alias="+n+"&password="+t+"&email="+r+"&role="+s;$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var t=o.parseCreateUser(e);null!=i&&i(t)},complete:function(e,n){},error:function(){}})},parseCreateUser:function(e){var n=$(e).find("CreateUser").text();if("success"==n.toLowerCase())return"success";var t=$(e).find("ExceptionText").text();return t},login:function(e,n,t){if(null==e||null==n)return void(null!=t&&t("params is invalid"));var r=this,s="service="+this.service+"&version="+this.version+"&request=login&name="+e+"&password="+n;$.ajax({type:"get",url:this.server,data:encodeURI(s),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var s=r.parseLogin(e);null!=t&&t(s)},complete:function(e,n){},error:function(){}})},parseLogin:function(e){var n=$(e).find("Login").text();if("success"==n.toLowerCase())return"success";var t=$(e).find("ExceptionText").text();return t},logout:function(e,n){if(null==e)return void(null!=n&&n("name is null"));var t=this,r="service="+this.service+"&version="+this.version+"&request=logout&name="+e;$.ajax({type:"get",url:this.server,data:encodeURI(r),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var s=t.parseLogout(e);null!=n&&n(s)},complete:function(e,n){},error:function(){}})},parseLogout:function(e){var n=$(e).find("Logout").text();if("success"==n.toLowerCase())return"success";var t=$(e).find("ExceptionText").text();return t},getUser:function(e,n){if(null==e)return void(null!=n&&n("name is null"));var t=this,r="service="+this.service+"&version="+this.version+"&request=GetUser&name="+e;$.ajax({type:"get",url:this.server,data:encodeURI(r),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var s=t.parseGetUser(e);null!=n&&n(s)},complete:function(e,n){},error:function(){}})},parseGetUser:function(e){var n=$(e).find("ExceptionText").text();if(""!=n)return n;var t=null;return $(e).find("User").each(function(){var e=$(this).find("Name").text(),n=$(this).find("Alias").text(),r=$(this).find("Email").text(),s=$(this).find("Role").text();null!=e&&(t={name:e,alias:n,email:r,role:s})}),t},getUserList:function(e,n,t){var r=this,s="service="+this.service+"&version="+this.version+"&request=GetUser";null!=e&&(s+="&count="+e),null!=n&&(s+="&offset="+n),$.ajax({type:"get",url:this.server,data:encodeURI(s),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var s=r.parseGetUserList(e);null!=t&&t(s)},complete:function(e,n){},error:function(){}})},parseGetUserList:function(e){var n=[];return $(e).find("Users>User").each(function(){var e=$(this).find("Name").text(),t=$(this).find("Alias").text(),r=$(this).find("Email").text(),s=$(this).find("Role").text();if(null!=e){var i={name:e,alias:t,email:r,role:s};n.push(i)}}),n},getUserCount:function(e){var n=this,t="service="+this.service+"&version="+this.version+"&request=GetUserCount";$.ajax({type:"get",url:this.server,data:encodeURI(t),dataType:"xml",async:!0,beforeSend:function(e){},success:function(t,r){var s=n.parseGetUserCount(t);null!=e&&e(s)},complete:function(e,n){},error:function(){}})},parseGetUserCount:function(e){var n=$(e).find("UserCount").text();return n},getOnlineUser:function(e,n,t){var r=this,s="service="+this.service+"&version="+this.version+"&request=GetOnlineUser";null!=e&&(s+="&count="+e),null!=n&&(s+="&offset="+n),$.ajax({type:"get",url:this.server,data:encodeURI(s),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var s=r.parseGetOnlineUserList(e);null!=t&&t(s)},complete:function(e,n){},error:function(){}})},parseGetOnlineUserList:function(e){var n=[];return $(e).find("Users>User").each(function(){var e=$(this).find("Name").text();n.push(e)}),n},removeUser:function(e,n){if(null==e&&null!=n)return void n("name is null");var t=this,r="service="+this.service+"&version="+this.version+"&request=RemoveUser&name="+e;$.ajax({type:"get",url:this.server,data:encodeURI(r),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var s=t.parseRemoveUser(e);null!=n&&n(s)},complete:function(e,n){},error:function(){}})},parseRemoveUser:function(e){var n=$(e).find("RemoveUser").text(),t="";return"SUCCESS"==n.toUpperCase()?t="success":""!=$(e).find("ExceptionText").text()&&(t=$(e).find("ExceptionText").text()),t},getLoginCount:function(e){var n=this,t="service="+this.service+"&version="+this.version+"&request=GetLoginCount";$.ajax({type:"get",url:this.server,data:encodeURI(t),dataType:"xml",async:!0,beforeSend:function(e){},success:function(t,r){var s=n.parseGetLoginCount(t);null!=e&&e(s)},complete:function(e,n){},error:function(){}})},parseGetLoginCount:function(e){var n=$(e).find("LoginCount").text();return n}});
GeoBeans.Control.DragMapControl=GeoBeans.Class(GeoBeans.Control,{onmousedown:null,beginDragHandler:null,dragingHandler:null,endDragHandler:null,initialize:function(e){GeoBeans.Control.prototype.initialize.apply(this,arguments),this.map=e,this.type="DragMapControl";var n=this,a=function(e){if(n.enabled&&"CANVAS"==e.target.tagName.toUpperCase()){e.preventDefault();var a,t,r,o,i=n.map,s=i.saveSnap(),l=0,p=0;i.width,i.height;a=e.layerX,t=e.layerY;var u=i.transformation.toMapPoint(a,t),d=!0;if(null!=n.beginDragHandler){var m=a,v=t;if(null==n.map.transformation)return;var f=n.map.transformation.toMapPoint(m,v),y=new GeoBeans.Event.MouseArgs;y.buttn=null,y.X=m,y.Y=v,y.mapX=f.x,y.mapY=f.y,n.beginDragHandler(y)}var g=function(e){if(e.preventDefault(),d){n.map.closeTooltip(),n.draging=!0,document.body.style.cursor="pointer",l+=e.layerX-a,p+=e.layerY-t,i.drawBackground(),i.putSnap(l,p);var s=i.transformation.toMapPoint(e.layerX,e.layerY);r=u.x-s.x,o=u.y-s.y,i.offset(r,o);var m=i.infoWindow;if(null!=m){var v=i.mapDiv.find(".popover");if(1==v.length){var f=(m.attr("x"),m.attr("y"),i.width),y=i.height,g=m.css("left"),c=m.css("top");g=parseInt(g.slice(0,g.indexOf("px"))),c=parseInt(c.slice(0,c.indexOf("px"))),g+=e.layerX-a,c+=e.layerY-t;var h=v.css("width"),x=v.css("height");h=parseInt(h.slice(0,h.indexOf("px"))),x=parseInt(x.slice(0,x.indexOf("px"))),g-h/2<0||g+h/2>f||c-x<0||c>y?(m.popover("hide"),i.queryLayer.clearFeatures()):(m.css("left",g+"px"),m.css("top",c+"px"),m.popover("hide").popover("show"),v.find(".popover-title").append('<button type="button" class="close">&times;</button>'),v.find(".popover-title").find(".close").click(function(){$(this).parents(".popover").popover("hide")}))}}if(a=e.layerX,t=e.layerY,null!=n.dragingHandler){var D=a,w=t;if(null==n.map.transformation)return;var X=n.map.transformation.toMapPoint(D,w),Y=new GeoBeans.Event.MouseArgs;Y.buttn=null,Y.X=D,Y.Y=w,Y.mapX=X.x,Y.mapY=X.y,n.dragingHandler(Y)}}},c=function(e){e.preventDefault(),s=null,d=!1,n.draging=!1;var a=i.transformation.toMapPoint(e.layerX,e.layerY);if(r=u.x-a.x,o=u.y-a.y,i.draw(),i.cleanupSnap(),document.body.style.cursor="default",i.mapDiv[0].removeEventListener("mousemove",g),i.mapDiv[0].removeEventListener("mouseup",c),null!=n.endDragHandler){var t=e.layerX,l=e.layerY;if(null==n.map.transformation)return;var p=n.map.transformation.toMapPoint(t,l),m=new GeoBeans.Event.MouseArgs;m.buttn=null,m.X=t,m.Y=l,m.mapX=p.x,m.mapY=p.y,n.endDragHandler(m)}};i.mapDiv[0].addEventListener("mousemove",g),i.mapDiv[0].addEventListener("mouseup",c)}};this.onmousedown=a,this.map.mapDiv[0].addEventListener("mousedown",this.onmousedown)},destory:function(){this.map.mapDiv[0].removeEventListener("mousedown",this.onmousedown),GeoBeans.Control.prototype.destory.apply(this,arguments)}});
GeoBeans.Control.FeatureHitControl=GeoBeans.Class(GeoBeans.Control,{map:null,layer:null,onmousemove:null,callback:null,tolerance:10,selection:[],ptsymbol:null,lnsymbol:null,rnsymbol:null,initialize:function(e,o){GeoBeans.Control.prototype.initialize.apply(this,arguments),this.type="FeatureHitControl",this.layer=e,this.map=e.map,this.ptsymbol=this.createPointSymbolizer(),this.lnsymbol=this.createLineSymbolizer(),this.rnsymbol=this.createPolygonSymbolizer(),null!=this.map},destory:function(){this.layer=null,this.enabled(!1),GeoBeans.Control.prototype.destory.apply(this,arguments)},enable:function(e){if(null!=this.map)if(this.enabled=e,this.enabled){var o=null,t=null,n=this;this.onmousemove=function(e){if(null==o)o=e.layerX,t=e.layerY;else{var l=Math.abs(e.layerX-o)+Math.abs(e.layerY-t);if(l>n.tolerance){console.log(l),o=e.layerX,t=e.layerY;var i=n.map.transformation.toMapPoint(e.layerX,e.layerY);n.hit(i.x,i.y,n.callback)}}},this.map.canvas.addEventListener("mousemove",this.onmousemove)}else this.map.canvas.addEventListener("mousemove",this.onmousemove),this.onmousemove=null},hit:function(e,o,t){if(null!=this.layer){var n=this.layer.features;if(null!=n){this.map.renderer,this.map.transformation;this.selection=[],console.log(e+","+o);var l=0,i=null,a=null,s=n.length;for(l=0;l<s;l++)i=n[l],a=i.geometry,null!=a&&a.hit(e,o,this.map.tolerance)&&this.selection.push(i);this.highlight(this.selection),void 0!=t&&t(this.layer,this.selection)}}},highlight:function(e){for(var o=this.map.renderer,t=e.length,n=0;n<t;n++){var l=e[n],i=l.geometry;switch(i.type){case GeoBeans.Geometry.Type.POINT:case GeoBeans.Geometry.Type.MULTIPOINT:o.setSymbolizer(this.ptsymbol),o.drawGeometry(i,this.ptsymbol,this.map.transformation);break;case GeoBeans.Geometry.Type.LINESTRING:case GeoBeans.Geometry.Type.MULTILINESTRING:o.setSymbolizer(this.lnsymbol),o.drawGeometry(i,this.lnsymbol,this.map.transformation);break;case GeoBeans.Geometry.Type.POLYGON:case GeoBeans.Geometry.Type.MULTIPOLYGON:o.setSymbolizer(this.rnsymbol),o.drawGeometry(i,this.rnsymbol,this.map.transformation)}}},createPointSymbolizer:function(){var e;return e=new GeoBeans.Style.PointSymbolizer,e.size=5,e.fillColor="rgba(255,0,0,0.25)",e.outLineWidth=1,e.outLineColor="rgba(255,255,0,0.55)",e.outLineCap=GeoBeans.Style.LineCap.ROUND,e.outLineJoin=GeoBeans.Style.LineJoin.ROUND,e.showOutline=!0,e},createLineSymbolizer:function(){var e;return e=new GeoBeans.Style.LineSymbolizer,e.width=1,e.color="Red",e.lineCap=GeoBeans.Style.LineCap.ROUND,e.lineJoin=GeoBeans.Style.LineJoin.ROUND,e},createPolygonSymbolizer:function(){var e;return e=new GeoBeans.Style.PolygonSymbolizer,e.size=5,e.fillColor="rgba(255,0,0,0.25)",e.outLineWidth=1,e.outLineColor="rgba(255,255,0,0.55)",e.outLineCap=GeoBeans.Style.LineCap.ROUND,e.outLineJoin=GeoBeans.Style.LineJoin.ROUND,e.showOutline=!0,e}});
GeoBeans.Control.MapNavControl=GeoBeans.Class(GeoBeans.Control,{controlDiv:null,initialize:function(a){this.type=GeoBeans.Control.Type.NAV,this.map=a;var o='<div class="map-nav-wrapper">\t<div class="map-nav-pan">\t<div class="map-nav-pan">\t\t<div class="map-nav-button map-nav-pan-N"></div>\t\t<div class="map-nav-button map-nav-pan-W"></div>\t\t<div class="map-nav-button map-nav-pan-E"></div>\t\t<div class="map-nav-button map-nav-pan-S"></div>\t</div>\t<div class="map-nav-zoom">\t\t<div class="map-nav-button map-nav-zoom-in"></div>\t\t<div class="map-nav-button map-nav-zoom-out"></div>\t\t<div class="map-nav-zoom-slider">\t\t\t<div class="map-nav-zoom-slider-top"></div>\t\t\t<div class="map-nav-zoom-slider-bottom"></div>\t\t\t<div class="map-nav-zoom-slider-bar"></div>\t\t</div>\t\t<div class="map-nav-zoom-labels">\t\t\t<div class="map-nav-zoom-label map-nav-zoom-label-street"></div>\t\t\t<div class="map-nav-zoom-label map-nav-zoom-label-city"></div>\t\t\t<div class="map-nav-zoom-label map-nav-zoom-label-province"></div>\t\t\t<div class="map-nav-zoom-label map-nav-zoom-label-country"></div>\t\t</div>\t</div></div>';this.map.mapDiv.append(o),this.controlDiv=$(".map-nav-wrapper"),$(".map-nav-pan-N").mouseover(function(){$(this).parent().css("background-position","0 -44px")}),$(".map-nav-pan-W").mouseover(function(){$(this).parent().css("background-position","0 -176px")}),$(".map-nav-pan-E").mouseover(function(){$(this).parent().css("background-position","0 -88px")}),$(".map-nav-pan-S").mouseover(function(){$(this).parent().css("background-position","0 -132px")}),$(".map-nav-pan div").mouseout(function(){$(this).parent().css("background-position","0 0")});var e=this;$(".map-nav-pan-N").click(function(){var a=e.map.center,o=e.map.transformation.toMapPoint(e.width/2,0);e.map.offset(0,a.y-o.y),e.map.draw()}),$(".map-nav-pan-S").click(function(){var a=e.map.center,o=e.map.transformation.toMapPoint(e.width/2,0);e.map.offset(0,o.y-a.y),e.map.draw()}),$(".map-nav-pan-W").click(function(){var a=e.map.center,o=e.map.transformation.toMapPoint(e.map.width,e.map.height/2);e.map.offset(o.x-a.x,0),e.map.draw()}),$(".map-nav-pan-E").click(function(){var a=e.map.center,o=e.map.transformation.toMapPoint(e.map.width,e.map.height/2);e.map.offset(a.x-o.x,0),e.map.draw()}),$(".map-nav-zoom-in").click(function(){var a=e.map.level+1;null==a||a<1||null==e.map.baseLayer||a>e.map.baseLayer.MAX_ZOOM_LEVEL||a<e.map.baseLayer.MIN_ZOOM_LEVEL||(e.map.saveSnap(),e.map.drawBackground(),e.map.drawBaseLayerSnap(a),e.map.setLevel(a),e.map.draw())}),$(".map-nav-zoom-out").click(function(){var a=e.map.level-1;null==a||a<1||null==e.map.baseLayer||a>e.map.baseLayer.MAX_ZOOM_LEVEL||a<e.map.baseLayer.MIN_ZOOM_LEVEL||(e.map.saveSnap(),e.map.drawBackground(),e.map.drawBaseLayerSnap(a),e.map.setLevel(a),e.map.draw())});var n=function(a){a.preventDefault();var o=a.clientX,n=a.clientY,t=!0,m=function(a){if(a.preventDefault(),t){console.log("brefore Y :"+n),console.log("current Y :"+a.clientY);var m=(a.clientX-o,a.clientY-n);console.log("offsetY Y :"+m);var p=$(".map-nav-zoom-slider-bar").css("top"),s=parseFloat(p.slice(0,p.lastIndexOf("px"))),i=s+m;o=a.clientX,n=a.clientY,console.log("topMove:"+i);var r=$(".map-nav-zoom-slider").height(),v=r-i+10,l=$(".map-nav-zoom-slider").height()/18,c=r-l*(e.map.baseLayer.MAX_ZOOM_LEVEL-1),d=r-l*(e.map.baseLayer.MIN_ZOOM_LEVEL-1);20-Math.floor(i/l);if(i<c){var u=l*(e.map.baseLayer.MAX_ZOOM_LEVEL-1)+10;$(".map-nav-zoom-slider-bar").css("top",c+"px"),$(".map-nav-zoom-slider-bottom").css("top",c+"px"),$(".map-nav-zoom-slider-bottom").css("height",u+"px")}else if(i>d){console.log("topMove > minZoomPosition"+i);var b=l*(e.map.baseLayer.MIN_ZOOM_LEVEL-1)+10;$(".map-nav-zoom-slider-bar").css("top",d+"px"),$(".map-nav-zoom-slider-bottom").css("top",d+"px"),$(".map-nav-zoom-slider-bottom").css("height",b+"px")}else $(".map-nav-zoom-slider-bar").css("top",i+"px"),$(".map-nav-zoom-slider-bottom").css("top",i+"px"),$(".map-nav-zoom-slider-bottom").css("height",v+"px")}},p=function(a){a.preventDefault(),$(".map-nav-zoom-slider-bar")[0].removeEventListener("mousemove",m),$(".map-nav-zoom-slider-bar")[0].removeEventListener("mouseup",p),t=!1;var o=$(".map-nav-zoom-slider-bar").css("top"),n=parseFloat(o.slice(0,o.lastIndexOf("px"))),s=$(".map-nav-zoom-slider").height()/18,i=19-Math.ceil(n/s);mapObj.level!=i&&(e.map.drawBackground(),e.map.setLevel(i),e.map.draw())},s=function(a){a.preventDefault(),$(".map-nav-zoom-slider-bar")[0].removeEventListener("mousemove",m),$(".map-nav-zoom-slider-bar")[0].removeEventListener("mouseup",p),t=!1};$(".map-nav-zoom-slider-bar")[0].addEventListener("mousemove",m),$(".map-nav-zoom-slider-bar")[0].addEventListener("mouseup",p),$(".map-nav-zoom-slider-bar")[0].addEventListener("mouseout",s)};$(".map-nav-zoom-slider-bar")[0].addEventListener("mousedown",n),$(".map-nav-zoom").mouseover(function(){$(".map-nav-zoom-labels").css("display","block")}),$(".map-nav-zoom").mouseout(function(){$(".map-nav-zoom-labels").css("display","none")}),$(".map-nav-zoom-label-street").click(function(){18>e.map.baseLayer.MIN_ZOOM_LEVEL&&18<e.map.baseLayer.MAX_ZOOM_LEVEL&&(e.map.drawBackground(),e.map.setLevel(18),e.map.draw())}),$(".map-nav-zoom-label-city").click(function(){12>e.map.baseLayer.MIN_ZOOM_LEVEL&&12<e.map.baseLayer.MAX_ZOOM_LEVEL&&(e.map.drawBackground(),e.map.setLevel(12),e.map.draw())}),$(".map-nav-zoom-label-province").click(function(){8>e.map.baseLayer.MIN_ZOOM_LEVEL&&8<e.map.baseLayer.MAX_ZOOM_LEVEL&&(e.map.drawBackground(),e.map.setLevel(8),e.map.draw())}),$(".map-nav-zoom-label-country").click(function(){4>e.map.baseLayer.MIN_ZOOM_LEVEL&&4<e.map.baseLayer.MAX_ZOOM_LEVEL&&(e.map.drawBackground(),e.map.setLevel(4),e.map.draw())})},setZoomSlider:function(a){if(!(null==a||a<1||null==this.map.baseLayer||a>this.map.baseLayer.MAX_ZOOM_LEVEL||a<this.map.baseLayer.MIN_ZOOM_LEVEL)){var o=$(".map-nav-zoom-slider").height(),e=o/18,n=e*(a-1);$(".map-nav-zoom-slider-bar").css("top",o-n),$(".map-nav-zoom-slider-bottom").css("height",n+10),$(".map-nav-zoom-slider-bottom").css("top",o-n)}},setEnable:function(a){a?0!=this.controlDiv.length&&this.controlDiv.css("display","block"):0!=this.controlDiv.length&&this.controlDiv.css("display","none")}});
GeoBeans.Control.SrollMapControl=GeoBeans.Class(GeoBeans.Control,{onmousewheel:null,count:0,userHandler:null,initialize:function(e){GeoBeans.Control.prototype.initialize.apply(this,arguments),this.map=e;var a=this;this.type=GeoBeans.Control.Type.SCROLL_MAP;var n=function(a,n){if(a.preventDefault(),null!=e.baseLayer){var r=e.level;a.wheelDelta>0?(r+=n,r>e.baseLayer.MAX_ZOOM_LEVEL&&(r=e.baseLayer.MAX_ZOOM_LEVEL),e.saveSnap(),e.drawBackground(),e.drawBaseLayerSnap(r),e.setLevel(r),e.draw()):(r-=n,r<e.baseLayer.MIN_ZOOM_LEVEL&&(r=e.baseLayer.MIN_ZOOM_LEVEL),e.saveSnap(),e.drawBackground(),e.drawBaseLayerSnap(r),e.setLevel(r),e.draw())}else if(a.wheelDelta>0){var o=1/(1+.2*n);e.saveSnap(),e.drawBackground(),e.drawLayersSnap(o),e.viewer.scale(o),e.transformation.update(),e.draw()}else{var o=1+.2*n;e.saveSnap(),e.drawBackground(),e.drawLayersSnap(o),e.viewer.scale(o),e.transformation.update(),e.draw()}};this.mousewheel=function(r){a.count=a.count+1;var o=a.count;setTimeout(function(){a.count==o&&(n(r,a.count),a.count=0,null!=a.userHandler&&a.userHandler({level:e.level}))},200)},e.mapDiv[0].addEventListener("mousewheel",this.mousewheel)},destory:function(){this.map.mapDiv[0].removeEventListener("mousewheel",this.mousewheel),GeoBeans.Control.prototype.destory.apply(this,arguments)}});
GeoBeans.Control.TrackControl=GeoBeans.Class(GeoBeans.Control,{map:null,onMouseDown:null,onMouseMove:null,onMouseDClick:null,initialize:function(){this.type=GeoBeans.Control.Type.TRACK},destory:function(){this.end()},trackPoint:function(e,n,a){var t=this;this.map.saveSnap(),this.map.enableDrag(!1),this.cleanup();var o=function(o){if(t.drawPoint(o.layerX,o.layerY),null!=e&&void 0!=e){var r=t.map.transformation.toMapPoint(o.layerX,o.layerY);e(r,n,a)}},r=function(e){t.map.restoreSnap(),t.drawPoint(e.layerX,e.layerY)};this.onMouseDown=o,this.onMouseMove=r,this.map.mapDiv[0].addEventListener("mousemove",r),this.map.mapDiv[0].addEventListener("mousedown",o)},trackLine:function(e,n,a,t){var o=this,r=[],i=[],s=!1;this.map.saveSnap(),this.map.enableDrag(!1),this.cleanup();var l=function(l){l.preventDefault();for(var u=!1,v=0;v<r.length;++v){var m=r[v],p=m.x,y=m.y;p==l.layerX&&y==l.layerY&&(u=!0)}var h=function(e){o.map.restoreSnap(),o.drawLine(r,e.layerX,e.layerY),o.drawPoints(r,e.layerX,e.layerY)},c=function(l){if(n.canvas.removeEventListener("dblclick",o.onMouseDClick),o.map.canvas.removeEventListener("mousemove",h),o.map.canvas.removeEventListener("dblclick",c),i.length!=r.length){if(0==i.length&&r.forEach(function(e,n){i.push(e)}),l.preventDefault(),o.map.restoreSnap(),null!=e&&"undefined"!=e&&e(o.buildLineString(r),n,a,t),null==e)return o.buildLineString(r);i=[],r=[],s=!1}};0==u&&r.push({x:l.layerX,y:l.layerY}),s||(console.log("add-mousemove"),o.map.canvas.addEventListener("mousemove",h),o.map.canvas.addEventListener("dblclick",c),s=!0),o.onMouseDClick=c,o.onMouseMove=h};this.map.mapDiv[0].addEventListener("mousedown",l),this.onMouseDown=l},trackPolygon:function(e,n,a,t){var o=this,r=[],i=!1;this.map.saveSnap(),this.map.enableDrag(!1),this.cleanup();var s=function(s){r.push({x:s.layerX,y:s.layerY});var l=function(e){o.map.restoreSnap(),r.length>1?(o.drawPolygon(r,e.layerX,e.layerY),o.drawPoints(r,e.layerX,e.layerY)):(o.drawLine(r,e.layerX,e.layerY),o.drawPoints(r,e.layerX,e.layerY))},u=function(s){o.map.canvas.removeEventListener("mousemove",l),o.map.canvas.removeEventListener("dblclick",u),r.push({x:s.layerX,y:s.layerY}),o.map.restoreSnap(),null!=e&&"undefined"!=e&&r.length>=3&&e(o.buildPolygon(r),n,a,t),r=[],i=!1};i||(console.log("add-mousemove"),o.map.canvas.addEventListener("mousemove",l),o.map.canvas.addEventListener("dblclick",u),i=!0),o.onMouseDClick=u,o.onMouseMove=l};this.map.mapDiv[0].addEventListener("mousedown",s),this.onMouseDown=s},trackCircle:function(e){var n=this,a=null,t=null,o=0;this.map.saveSnap(),this.map.enableDrag(!1),this.cleanup();var r=function(r){r.preventDefault(),a={x:r.layerX,y:r.layerY},n.drawPoints([],r.layerX,r.layerY);var i=function(e){e.preventDefault(),t={x:e.layerX,y:e.layerY},n.map.restoreSnap(),n.drawPoints([],a.x,a.y),o=Math.sqrt((t.x-a.x)*(t.x-a.x)+(t.y-a.y)*(t.y-a.y)),n.drawCircle(a,o)},s=function(o){if(o.preventDefault(),null!=t){n.map.canvas.removeEventListener("mousemove",i),n.map.canvas.removeEventListener("mouseup",s),n.map.restoreSnap(),n.map.enableDrag(!0);var r=n.map.transformation.toMapPoint(a.x,a.y),l=n.map.transformation.toMapPoint(t.x,t.y),u=Math.sqrt((l.x-r.x)*(l.x-r.x)+(l.y-r.y)*(l.y-r.y));if(null!=e&&"undefined"!=e){var v=new GeoBeans.Geometry.Circle(r,u);e(v)}}};n.map.canvas.addEventListener("mousemove",i),n.map.canvas.addEventListener("mouseup",s),n.onMouseMove=i,n.onMouseUp=s};this.map.mapDiv[0].addEventListener("mousedown",r),this.onMouseDown=r},trackRect:function(e,n,a,t){var o=this;this.map.saveSnap(),this.map.enableDrag(!1),this.cleanup();var r=null,i=null,s=function(s){s.preventDefault(),r={x:s.layerX,y:s.layerY},o.drawPoints([],s.layerX,s.layerY);var l=function(e){if(e.preventDefault(),null!=r){i={x:e.layerX,y:e.layerY},o.map.restoreSnap();var n=[];n.push(r),n.push({x:i.x,y:r.y}),n.push(i),n.push({x:r.x,y:i.y}),o.drawPolygon(n,r.x,r.y)}},u=function(s){if(s.preventDefault(),null!=i){var v=r.x-i.x,m=r.y-i.y;if(o.map.canvas.removeEventListener("mousemove",l),o.map.canvas.removeEventListener("mouseup",u),o.map.restoreSnap(),!(Math.abs(v)<1e-4&&Math.abs(m)<1e-4)){var p=o.buildRect(r,i);null!=e&&"undefined"!=e&&e(p,n,a,t),r=null,i=null}}};o.map.canvas.addEventListener("mousemove",l),o.map.canvas.addEventListener("mouseup",u),o.onMouseMove=l,o.onMouseUp=u};this.map.mapDiv[0].addEventListener("mousedown",s),this.onMouseDown=s},trackInfo:function(e,n,a,t){var o=this,r=null,i=null,s=function(s){if("CANVAS"==s.target.tagName.toUpperCase()){r={x:s.layerX,y:s.layerY};var l=function(s){i={x:s.layerX,y:s.layerY};var u=r.x-i.x,v=r.y-i.y;if(Math.abs(u)>1e-4||Math.abs(v)>1e-4)return void o.map.mapDiv[0].removeEventListener("mouseup",l);var m=new GeoBeans.Geometry.Point(r.x,r.y);null!=e&&void 0!=e&&(console.log(r.x,r.y),e(m,n,a,t)),o.map.mapDiv[0].removeEventListener("mouseup",l)};o.map.mapDiv[0].addEventListener("mouseup",l),o.onMouseUp=l}};this.map.mapDiv[0].addEventListener("mousedown",s),this.onMouseDown=s},cleanup:function(){this.map.mapDiv[0].removeEventListener("mousedown",this.onMouseDown),this.map.mapDiv[0].removeEventListener("mousemove",this.onMouseMove),this.map.mapDiv[0].removeEventListener("dblclick",this.onMouseDClick),this.map.mapDiv[0].removeEventListener("mouseup",this.onMouseUp),this.onMouseDown=null,this.onMouseMove=null,this.onMouseDClick=null,this.onMouseUp=null,this.map.restoreSnap()},end:function(){this.cleanup(),this.map.enableDrag(!0)},onMouseDownPoint:function(e){var n=e.layerX,a=e.layerY;this.drawPoint(n,a),this.map.mapDiv[0].saveSnap()},onMouseMovePoint:function(e){this.map.restoreSnap();var n=e.layerX,a=e.layerY;this.drawPoint(n,a)},drawPoint:function(e,n){var a=this.map.renderer.context,t=5;a.save(),a.fillStyle="rgba(255,0,0,0.25)",a.strokeStyle="rgba(0,0,0,0.75)",a.lineWidth=1,a.beginPath(),a.arc(e,n,t,0,2*Math.PI,!1),a.closePath(),a.fill(),a.stroke(),a.restore()},drawPoints:function(e,n,a){var t=this.map.renderer.context;t.save();var o=5;t.fillStyle="rgba(255,0,0,0.25)",t.strokeStyle="rgba(255,0,0,0.25)",t.lineWidth=.5,t.beginPath(),t.arc(n,a,o,0,2*Math.PI,!1),t.closePath(),t.fill(),t.stroke();for(var r=e.length,i=0;i<r;i++)t.beginPath(),t.arc(e[i].x,e[i].y,o,0,2*Math.PI,!1),t.closePath(),t.fill(),t.stroke();t.restore()},drawLine:function(e,n,a){var t=this.map.renderer.context;t.save(),t.strokeStyle="rgba(255,0,0,0.25)",t.lineWidth=3,t.beginPath(),t.moveTo(n,a);for(var o=e.length,r=o-1;r>=0;r--)t.lineTo(e[r].x,e[r].y);t.stroke(),t.restore()},drawPolygon:function(e,n,a){var t=this.map.renderer.context;t.save(),t.fillStyle="rgba(255,255,255,0.25)",t.strokeStyle="rgba(0,0,0,1)",t.lineWidth=.5;var o=e.length;for(t.beginPath(),t.moveTo(n,a),i=0;i<o;i++)t.lineTo(e[i].x,e[i].y);t.closePath(),t.fill(),t.stroke(),t.restore()},drawCircle:function(e,n){var a=this.map.renderer.context;a.save(),a.strokeStyle="rgba(255,0,0,0.25)",a.lineWidth=1,a.beginPath(),a.arc(e.x,e.y,n,0,2*Math.PI,!0),a.strokeStyle="#08c",a.stroke(),a.closePath()},buildLineString:function(e){for(var n=null,a=[],t=e.length,o=0;o<t;o++)n=this.map.transformation.toMapPoint(e[o].x,e[o].y),a.push(n);return new GeoBeans.Geometry.LineString(a)},buildMultiLineString:function(e){},buildPolygon:function(e){for(var n=null,a=[],t=e.length,o=0;o<t;o++)n=this.map.transformation.toMapPoint(e[o].x,e[o].y),a.push(n);a.push(a[0]);var r=new GeoBeans.Geometry.LinearRing(a);return new GeoBeans.Geometry.Polygon([r])},buildRect:function(e,n){e=this.map.transformation.toMapPoint(e.x,e.y),n=this.map.transformation.toMapPoint(n.x,n.y);var a=e.x>n.x?n.x:e.x,t=e.x>n.x?e.x:n.x,o=e.y>n.y?n.y:e.y,r=e.y>n.y?e.y:n.y,i=new GeoBeans.Envelope(a,o,t,r);return i}});
GeoBeans.Control.ZoomControl=GeoBeans.Class(GeoBeans.Control,{mode:null,initialize:function(){this.type=GeoBeans.Control.Type.ZOOM},destory:function(){this.end()},end:function(){this.cleanup(),this.map.enableDrag(!0)},setMode:function(e){this.mode=e},cleanup:function(){this.map.mapDiv[0].removeEventListener("mousedown",this.onMouseDown),this.map.mapDiv[0].removeEventListener("mousemove",this.onMouseMove),this.map.mapDiv[0].removeEventListener("mouseup",this.onMouseUp),this.onMouseDown=null,this.onMouseMove=null,this.onMouseUp=null},trackRect:function(){var e=this;if(null==this.onMouseDown){this.map.enableDrag(!1);var t=null,a=null,o=function(o){o.preventDefault(),e.map.saveSnap(),t={x:o.layerX,y:o.layerY},e.drawPoints([],o.layerX,o.layerY);var n=function(o){if(o.preventDefault(),null!=t){a={x:o.layerX,y:o.layerY},e.map.restoreSnap();var n=[];n.push(t),n.push({x:a.x,y:t.y}),n.push(a),n.push({x:t.x,y:a.y}),e.drawPolygon(n,t.x,t.y)}},i=function(o){if(o.preventDefault(),null!=a){var s=t.x-a.x,r=t.y-a.y;if(e.map.mapDiv[0].removeEventListener("mousemove",n),e.map.mapDiv[0].removeEventListener("mouseup",i),e.map.restoreSnap(),!(Math.abs(s)<1e-4&&Math.abs(r)<1e-4)){var l=e.buildRect(t,a);e.zoomMap(l),t=null,a=null}}};e.map.mapDiv[0].addEventListener("mousemove",n),e.map.mapDiv[0].addEventListener("mouseup",i),e.onMouseMove=n,e.onMouseUp=i};this.map.mapDiv[0].addEventListener("mousedown",o),this.onMouseDown=o}},drawPolygon:function(e,t,a){var o=this.map.renderer.context;o.save(),o.fillStyle="rgba(255,255,255,0.25)",o.strokeStyle="rgba(0,0,0,1)",o.lineWidth=.5;var n=e.length;for(o.beginPath(),o.moveTo(t,a),i=0;i<n;i++)o.lineTo(e[i].x,e[i].y);o.closePath(),o.fill(),o.stroke(),o.restore()},buildRect:function(e,t){e=this.map.transformation.toMapPoint(e.x,e.y),t=this.map.transformation.toMapPoint(t.x,t.y);var a=e.x>t.x?t.x:e.x,o=e.x>t.x?e.x:t.x,n=e.y>t.y?t.y:e.y,i=e.y>t.y?e.y:t.y,s=new GeoBeans.Envelope(a,n,o,i);return s},drawPoints:function(e,t,a){var o=this.map.renderer.context;o.save();var n=5;o.fillStyle="rgba(255,0,0,0.25)",o.strokeStyle="rgba(255,0,0,0.25)",o.lineWidth=.5,o.beginPath(),o.arc(t,a,n,0,2*Math.PI,!1),o.closePath(),o.fill(),o.stroke();for(var i=e.length,s=0;s<i;s++)o.beginPath(),o.arc(e[s].x,e[s].y,n,0,2*Math.PI,!1),o.closePath(),o.fill(),o.stroke();o.restore()},zoomMap:function(e){"in"==this.mode?this.zoomInMap(e):this.zoomOutMap(e)},zoomInMap:function(e){if(null!=this.map.baseLayer){var t=this.map.getLevel(e);this.map.setLevel(t),console.log(t);var a=e.getCenter();this.map.setCenter(a)}else this.map.setViewer(e);this.map.draw()},zoomOutMap:function(e){var t=this.map.viewer,a=t.getWidth()/e.getWidth(),o=t.getHeight()/e.getHeight(),n=a>o?a:o;if(t.scale(n),null!=this.map.baseLayer){var i=this.map.getLevel(t);this.map.drawBackground(),this.map.drawBaseLayerSnap(i),this.map.setLevel(i),console.log(i)}else this.map.drawBackground(),this.map.drawLayersSnap(n),this.map.setViewer(t);this.map.draw()}});
GeoBeans.Control.TrackBufferControl=GeoBeans.Class(GeoBeans.Control.TrackControl,{initialize:function(){this.type=GeoBeans.Control.Type.TRACKBUFFER},destory:function(){this.end()},end:function(){this.cleanup(),this.map.enableDrag(!0)},trackBufferCircle:function(e,n,a){var t=this,o=null,s=null,r=0;this.map.saveSnap(),this.map.enableDrag(!1),this.cleanup();var i=function(i){i.preventDefault(),o={x:i.layerX,y:i.layerY},t.drawPoints([],i.layerX,i.layerY);var l=function(e){e.preventDefault(),s={x:e.layerX,y:e.layerY},t.map.restoreSnap(),t.drawPoints([],o.x,o.y),r=Math.sqrt((s.x-o.x)*(s.x-o.x)+(s.y-o.y)*(s.y-o.y)),t.drawCircle(o,r)},u=function(r){if(r.preventDefault(),null!=s){t.map.canvas.removeEventListener("mousemove",l),t.map.canvas.removeEventListener("mouseup",u),t.map.canvas.removeEventListener("mousedown",t.onMouseDown),t.map.restoreSnap(),t.map.enableDrag(!0);var i=t.map.transformation.toMapPoint(o.x,o.y),v=t.map.transformation.toMapPoint(s.x,s.y),c=Math.sqrt((v.x-i.x)*(v.x-i.x)+(v.y-i.y)*(v.y-i.y));null!=n&&"undefined"!=n&&a(e,c,i,n)}};t.map.canvas.addEventListener("mousemove",l),t.map.canvas.addEventListener("mouseup",u),t.onMouseMove=l,t.onMouseUp=u};this.map.canvas.addEventListener("mousedown",i),this.onMouseDown=i},trackBufferLine:function(e,n,a,t){var o=this,s=[],r=[];this.map.saveSnap(),this.map.enableDrag(!1),this.cleanup();var i=function(i){i.preventDefault();for(var l=!1,u=0;u<s.length;++u){var v=s[u],c=v.x,m=v.y;c==i.layerX&&m==i.layerY&&(l=!0)}0==l&&s.push({x:i.layerX,y:i.layerY});var p=function(e){o.map.restoreSnap(),o.drawLine(s,e.layerX,e.layerY),o.drawPoints(s,e.layerX,e.layerY)},h=function(i){i.preventDefault(),o.map.canvas.removeEventListener("mousemove",p),o.map.canvas.removeEventListener("dblclick",h),o.map.canvas.removeEventListener("click",o.onMouseClick),o.map.enableDrag(!0),r.length!=s.length&&(0==r.length&&s.forEach(function(e,n){r.push(e)}),o.map.restoreSnap(),null!=a&&"undefined"!=a&&t(e,n,o.buildLineString(s),a),r=[],s=[])};o.map.canvas.addEventListener("mousemove",p),o.map.canvas.addEventListener("dblclick",h),o.onMouseMove=p,o.onMouseDBclick=h};this.map.canvas.addEventListener("click",i),this.onMouseClick=i},cleanup:function(){this.map.canvas.removeEventListener("click",this.onMouseClick),this.map.canvas.removeEventListener("mousemove",this.onMouseMove),this.map.canvas.removeEventListener("dblclick",this.onMouseDBclick),this.map.canvas.removeEventListener("mousedown",this.onMouseDown),this.map.canvas.removeEventListener("mouseup",this.onMouseUp),this.onMouseClick=null,this.onMouseMove=null,this.onMouseDBclick=null,this.onMouseDown=null,this.onMouseUp=null}});
GeoBeans.Control.TrackOverlayControl=GeoBeans.Class(GeoBeans.Control.TrackControl,{initialize:function(){this.type=GeoBeans.Control.Type.TRACKOVERLAY},trackMarker:function(e){this.map.overlayLayer.setHitOverlayCallback(e);var a=this;this.map.saveSnap(),this.map.enableDrag(!1),this.cleanup();var n=function(n){if(n.preventDefault(),a.map.canvas.style.cursor="default",a.map.enableDrag(!0),null!=e&&void 0!=e){var o=a.map.transformation.toMapPoint(n.layerX,n.layerY),r=new GeoBeans.Symbolizer.PointSymbolizer;r.icon_url="../images/marker.png",r.icon_offset_x=0,r.icon_offset_y=0;var t=new GeoBeans.Overlay.Marker("maker",o,r);a.map.addOverlay(t),a.map.draw(),e(t)}a.map.canvas.removeEventListener("mousedown",a.onMouseDown),a.map.canvas.style.cursor="default"},o=function(e){e.preventDefault()};this.onMouseDown=n,this.onMouseMove=o,this.map.canvas.addEventListener("mousemove",o),this.map.canvas.addEventListener("mousedown",n)},trackLine:function(e){this.map.overlayLayer.setHitOverlayCallback(e);var a=this,n=[],o=[],r=!1;this.map.saveSnap(),this.map.enableDrag(!1),this.cleanup();var t=function(t){t.preventDefault();for(var l=!1,s=0;s<n.length;++s){var i=n[s],v=i.x,m=i.y;v==t.layerX&&m==t.layerY&&(l=!0)}0==l&&n.push({x:t.layerX,y:t.layerY});var u=function(e){a.map.restoreSnap(),a.drawLine(n,e.layerX,e.layerY),a.drawPoints(n,e.layerX,e.layerY)},p=function(t){if(a.map.enableDrag(!0),a.map.canvas.removeEventListener("mousedown",a.onMouseDown),a.map.canvas.removeEventListener("mousemove",u),a.map.canvas.removeEventListener("dblclick",p),o.length!=n.length){if(0==o.length&&n.forEach(function(e,a){o.push(e)}),t.preventDefault(),a.map.restoreSnap(),null!=e&&"undefined"!=e){var l=a.buildLineString(n),s=new GeoBeans.Symbolizer.LineSymbolizer;s.stroke.color.set(255,0,0,1),s.width=3;var i=new GeoBeans.Overlay.Polyline("polyline",l,s);a.map.addOverlay(i),a.map.draw(),e(i)}if(null==e)return a.buildLineString(n);o=[],n=[],r=!1}};0==l&&n.push({x:t.layerX,y:t.layerY}),r||(console.log("add-mousemove"),a.map.canvas.addEventListener("mousemove",u),a.map.canvas.addEventListener("dblclick",p),r=!0),a.onMouseDClick=p,a.onMouseMove=u};this.map.canvas.addEventListener("mousedown",t),this.onMouseDown=t},trackPolygon:function(e){this.map.overlayLayer.setHitOverlayCallback(e);var a=this,n=[],o=[];this.map.saveSnap(),this.map.enableDrag(!1),this.cleanup();var r=function(r){r.preventDefault();for(var t=!1,l=0;l<n.length;++l){var s=n[l],i=s.x,v=s.y;i==r.layerX&&v==r.layerY&&(t=!0)}0==t&&n.push({x:r.layerX,y:r.layerY});var m=function(e){a.map.restoreSnap(),n.length>1?(a.drawPolygon(n,e.layerX,e.layerY),a.drawPoints(n,e.layerX,e.layerY)):(a.drawLine(n,e.layerX,e.layerY),a.drawPoints(n,e.layerX,e.layerY))},u=function(r){if(r.preventDefault(),a.map.canvas.removeEventListener("mousemove",m),a.map.canvas.removeEventListener("dblclick",u),a.map.canvas.removeEventListener("mousedown",a.onMouseDown),a.map.enableDrag(!0),o.length!=n.length){if(0==o.length&&n.forEach(function(e,a){o.push(e)}),null!=e&&"undefined"!=e&&n.length>=3){var t=new GeoBeans.Symbolizer.PolygonSymbolizer;t.fill.color.set(255,0,0,1),t.stroke.color.set(255,0,0,.2);var l=a.buildPolygon(n),s=new GeoBeans.Overlay.Polygon("polygon",l,t);a.map.addOverlay(s),a.map.draw(),e(s)}o=[],n=[]}};a.map.canvas.addEventListener("mousemove",m),a.map.canvas.addEventListener("dblclick",u),a.onMouseMove=m,a.onMouseDBclick=u};this.map.canvas.addEventListener("mousedown",r),this.onMouseDown=r}});
GeoBeans.Control.TrackControl.TrackTransactionControl=GeoBeans.Class(GeoBeans.Control.TrackControl,{initialize:function(){this.type=GeoBeans.Control.Type.TRACKTRANSACTION},trackPoint:function(e,n,a){var o=this;this.map.saveSnap(),this.map.enableDrag(!1),this.cleanup();var t=function(t){if(o.drawPoint(t.layerX,t.layerY),o.map.enableDrag(!0),null!=e&&void 0!=e){var r=o.map.transformation.toMapPoint(t.layerX,t.layerY);e(r,n,a)}o.map.canvas.removeEventListener("mousemove",o.onMouseMove),o.map.canvas.removeEventListener("mousedown",o.onMouseDown)},r=function(e){o.map.restoreSnap(),o.drawPoint(e.layerX,e.layerY)};this.onMouseDown=t,this.onMouseMove=r,this.map.canvas.addEventListener("mousemove",r),this.map.canvas.addEventListener("mousedown",t)},trackLine:function(e,n,a,o){var t=this,r=[],s=[];this.map.saveSnap(),this.map.enableDrag(!1),this.cleanup();var i=function(i){i.preventDefault();for(var l=!1,v=0;v<r.length;++v){var c=r[v],m=c.x,u=c.y;m==i.layerX&&u==i.layerY&&(l=!0)}0==l&&r.push({x:i.layerX,y:i.layerY}),console.log("mouseclick"),console.log(r);var p=function(e){t.map.restoreSnap(),t.drawLine(r,e.layerX,e.layerY),t.drawPoints(r,e.layerX,e.layerY)},d=function(i){if(i.preventDefault(),t.map.canvas.removeEventListener("mousemove",p),t.map.canvas.removeEventListener("dblclick",d),t.map.canvas.removeEventListener("click",t.onMouseClick),t.map.enableDrag(!0),s.length!=r.length){if(0==s.length&&r.forEach(function(e,n){s.push(e)}),i.preventDefault(),console.log("mousedbclick"),t.map.canvas.removeEventListener("mousemove",p),t.map.canvas.removeEventListener("dblclick",d),null!=e&&"undefined"!=e)if(o){var l=[t.buildLineString(r)],v=new GeoBeans.Geometry.MultiLineString(l);e(v,n,a)}else e(t.buildLineString(r),n,a);s=[],r=[]}};t.map.canvas.addEventListener("mousemove",p),t.map.canvas.addEventListener("dblclick",d),t.onMouseMove=p,t.onMouseDBclick=d};this.map.canvas.addEventListener("click",i),this.onMouseClick=i},trackPolygon:function(e,n,a,o){var t=this,r=[],s=[];this.map.saveSnap(),this.map.enableDrag(!1),this.cleanup();var i=function(i){i.preventDefault();for(var l=!1,v=0;v<r.length;++v){var c=r[v],m=c.x,u=c.y;m==i.layerX&&u==i.layerY&&(l=!0)}0==l&&r.push({x:i.layerX,y:i.layerY});var p=function(e){t.map.restoreSnap(),r.length>1?(t.drawPolygon(r,e.layerX,e.layerY),t.drawPoints(r,e.layerX,e.layerY)):(t.drawLine(r,e.layerX,e.layerY),t.drawPoints(r,e.layerX,e.layerY))},d=function(i){if(i.preventDefault(),t.map.canvas.removeEventListener("mousemove",p),t.map.canvas.removeEventListener("dblclick",d),t.map.canvas.removeEventListener("mousedown",t.onMouseDown),t.map.enableDrag(!0),s.length!=r.length){if(0==s.length&&r.forEach(function(e,n){s.push(e)}),null!=e&&"undefined"!=e&&r.length>=3)if(o){var l=[t.buildPolygon(r)],v=new GeoBeans.Geometry.MultiPolygon(l);e(v,n,a)}else e(t.buildPolygon(r),n,a);s=[],r=[]}};t.map.canvas.addEventListener("mousemove",p),t.map.canvas.addEventListener("dblclick",d),t.onMouseMove=p,t.onMouseDBclick=d};this.map.canvas.addEventListener("mousedown",i),this.onMouseDown=i}});
GeoBeans.DataSet=GeoBeans.Class({dataSource:null,name:null,type:null,geometryType:null,srid:null,thumbnail:null,featureType:null,fields:null,count:null,extent:null,initialize:function(e,t,n,i,u,a,l,s){if(this.dataSource=e,this.name=t,this.type=n,this.geometryType=i,this.srid=u,this.thumbnail=a,this.count=l,this.extent=s,null!=this.dataSource){var r=new GeoBeans.WFSWorkspace("tmp",this.dataSource.server,"1.0.0");this.featureType=new GeoBeans.FeatureType(r,this.name)}},getFields:function(){if(null!=this.fields)return this.fields;var e=this.featureType.getFields(null,this.dataSource.name);return this.fields=e,this.fields},getFieldsWithoutGeom:function(){var e=this.getFields();if(null==e)return null;for(var t=[],n=null,i=null,u=0;u<e.length;++u)n=e[u],null!=n&&(i=n.type,i!=GeoBeans.FieldType.GEOMETRY&&t.push(n.name));return t},getFeatures:function(e,t,n,i){this.featureType.getFeaturesFilterAsync(null,this.dataSource.name,null,e,t,n,null,i)},getPreview:function(e,t){var n=this.dataSource.server+"?service="+this.dataSource.service+"&version="+this.dataSource.version+"&request=GetPreview&sourceName="+this.dataSource.name+"&dataSetName="+this.name+"&width="+e+"&height="+t;return n},getFeatureCount:function(){var e=this.featureType.getCount(null,this.dataSource.name,null);return e}});
GeoBeans.DataSource=GeoBeans.Class({server:null,service:"dbs",version:"1.0.0",name:null,engine:null,constr:null,dataSets:null,initialize:function(e,t,a,n){this.server=e,this.name=t,this.engine=a,this.constr=n,this.dataSets=[]},getDataSets:function(e){var t=this,a="service="+this.service+"&version="+this.version+"&request=GetDataSet&sourceName="+this.name;$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(a,n){t.dataSets=t.parseDataSets(a),void 0!=e&&e(t.dataSets)},complete:function(e,t){},error:function(){}})},getDataSet:function(e,t){if(null!=e&&""!=e){var a=this,n="service="+this.service+"&version="+this.version+"&request=GetDataSet&sourceName="+this.name+"&dataSetName="+e;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var s=a.parseDataSet(e);void 0!=t&&t(s)},complete:function(e,t){},error:function(){}})}},parseDataSets:function(e){var t=this,a=[];return $(e).find("DataSet").each(function(){var e=t.parseDataSet(this);a.push(e)}),a},parseDataSet:function(e){var t=$(e).find("Name").text(),a=$(e).find("Type:first").text(),n=$(e).find("Geometry>Type").text(),s=null;switch(n.toUpperCase()){case"POINT":s=GeoBeans.Geometry.Type.POINT;break;case"LINESTRING":s=GeoBeans.Geometry.Type.LINESTRING;break;case"POLYGON":s=GeoBeans.Geometry.Type.POLYGON;break;case"MULTIPOINT":s=GeoBeans.Geometry.Type.MULTIPOINT;break;case"MULTILINESTRING":s=GeoBeans.Geometry.Type.MULTILINESTRING;break;case"MULTIPOLYGON":s=GeoBeans.Geometry.Type.MULTIPOLYGON}var r=$(e).find("Geometry>SRID").text();""==r&&(r=null);var i=$(e).find("Thumbnail").attr("xlink");""==i&&(i=null);var o=$(e).find("Count").text();null!=o&&(o=parseInt(o));var c=$(e).find("BoundingBox").attr("minx"),u=$(e).find("BoundingBox").attr("miny"),l=$(e).find("BoundingBox").attr("maxx"),f=$(e).find("BoundingBox").attr("maxy"),v=null;null!=c&&null!=u&&null!=l&&null!=f&&(v=new GeoBeans.Envelope(parseFloat(c),parseFloat(u),parseFloat(l),parseFloat(f)));var d=new GeoBeans.DataSet(this,t,a,s,r,i,o,v);return d},removeDataSet:function(e,t){if(null!=e){var a=this,n="service="+this.service+"&version="+this.version+"&request=RemoveDataSet&sourceName="+this.name+"&dataSetName="+e;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var s=a.parseRemoveDataSet(e);void 0!=t&&t(s)},complete:function(e,t){},error:function(){}})}},parseRemoveDataSet:function(e){var t=$(e).find("RemoveDataSet").text();if("success"==t.toLowerCase())return"success";var a=$(e).find("ExceptionText").text();return a},refresh:function(e,t){if(null==e)return void(null!=t&&t("refresh name is null"));var a=this,n="service="+this.service+"&version="+this.version+"&request=Refresh&sourceName="+this.name+"&dataSetName="+e;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var s=a.parseRefreshDataSet(e);void 0!=t&&t(s)},complete:function(e,t){},error:function(){}})},parseRefreshDataSet:function(e){var t=$(e).find("Refresh").text();if("success"==t.toLowerCase())return"success";var a=$(e).find("ExceptionText").text();return a}});
GeoBeans.DBSManager=GeoBeans.Class({server:null,service:"dbs",version:"1.0.0",dataSources:null,sourceName:null,initialize:function(e){this.server=e+"/mgr",this.dataSources=[]},getDataSources:function(e,t){var r=this,n="service="+this.service+"&version="+this.version+"&request=GetDataSource";null!=t&&(n+="&type="+t),$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(t,n){r.dataSources=r.parseDataSources(t),void 0!=e&&e(r.dataSources)},complete:function(e,t){},error:function(){}})},getDataSource:function(e,t){if(null!=e&&""!=e){var r=this,n="service="+this.service+"&version="+this.version+"&request=GetDataSource&name="+e;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var i=r.parseDataSource(e);void 0!=t&&t(i)},complete:function(e,t){},error:function(){}})}},unRegisterDataSource:function(e,t){if(null!=e){var r=this,n="service="+this.service+"&version="+this.version+"&request=UnRegisterDataSource&name="+e;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var i=r.parseUnRegisterDBS(e);void 0!=t&&t(i)},complete:function(e,t){},error:function(){}})}},registerDataSource:function(e,t,r,n,i){if(null==e||null==r||null==t||null==n)return void(null!=i&&i("params is invalid"));var s=this,a="service="+this.service+"&version="+this.version+"&request=RegisterDataSource&name="+e+"&engine="+t+"&uri="+r+"&type="+n;$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var r=s.parseRegisterDBS(e);void 0!=i&&i(r)},complete:function(e,t){},error:function(){}})},tryConnection:function(e,t){if(null!=e&&""!=e){var r=this,n="service="+this.service+"&version="+this.version+"&request=TryConnection&engine=Postgres&uri="+e;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var i=r.parseTryConn(e);void 0!=t&&t(i)},complete:function(e,t){},error:function(){}})}},featureImport:function(e,t,r,n,i,s,a){if(null==e||null==t||null==r)return void a("params is invalid");var o="service=gps&vesion=1.0.0&request=FeatureImport&sourcename="+e+"&typeName="+t+"&shppath="+r+"&shpname="+n;o+=null!=i?"&srid="+i:"&srid=4326",o+=null!=s?"&geom="+s:"&geom=shape";var u=this;$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var r=u.parseFeatureImport(e);null!=a&&a(r)},complete:function(e,t){},error:function(){}})},createTileStore:function(e,t,r,n,i,s,a){if(null==e||null==t||null==r||null==i||null==s)return void(null!=a&&a("params is invalid"));null==n&&(n=new GeoBeans.Envelope((-180),(-90),180,90));var o=this,u="service="+this.service+"&version="+this.version+"&request=CreateTileStore&sourceName="+e+"&storeName="+t+"&type="+r+"&extent="+n.toString()+"&startLevel="+i+"&endLevel="+s;$.ajax({type:"get",url:this.server,data:encodeURI(u),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var r=o.parseCreateTileStore(e);void 0!=a&&a(r)},complete:function(e,t){},error:function(){}})},describeTileStores:function(e,t){if(null==e)return void(null!=t&&t("params is invalid"));var r="service="+this.service+"&version="+this.version+"&request=DescribeTileStore&sourceName="+e;this.sourceName=e;var n=this;$.ajax({type:"get",url:this.server,data:encodeURI(r),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var i=n.parseDescribeTileStores(e);void 0!=t&&t(i)},complete:function(e,t){},error:function(){}})},describeTileStore:function(e,t,r){if(null==e||null==t)return void(null!=r&&r("params is invalid"));var n=this,i="service="+this.service+"&version="+this.version+"&request=DescribeTileStore&sourceName="+e+"&storeName="+t;this.sourceName=e,$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var i=n.parseDescribeTileStore(e);void 0!=r&&r(i)},complete:function(e,t){},error:function(){}})},removeTileStore:function(e,t,r){if(null==e||null==t)return void(null!=r&&r("params is invalid"));var n="service="+this.service+"&version="+this.version+"&request=RemoveTileStore&sourceName="+e+"&storeName="+t,i=this;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=i.parseRemoveTileStore(e);void 0!=r&&r(n)},complete:function(e,t){},error:function(){}})},parseCreateTileStore:function(e){var t=$(e).find("CreateTileStore").text();if("success"==t.toLowerCase())return"success";var r=$(e).find("ExceptionText").text();return r},parseDataSources:function(e){var t=[],r=this;return $(e).find("DataSource").each(function(){var e=r.parseDataSource(this);t.push(e)}),t},parseDataSource:function(e){var t=$(e).find("Name").text(),r=$(e).find("Engine").text(),n=$(e).find("ConnectionString").text(),i=new GeoBeans.DataSource(this.server,t,r,n);return i},parseUnRegisterDBS:function(e){var t=$(e).find("UnRegisterDataSource").text();if("success"==t.toLowerCase())return"success";var r=$(e).find("ExceptionText").text();return r},parseRegisterDBS:function(e){var t=$(e).find("RegisterDataSource").text();if("success"==t.toLowerCase())return"success";var r=$(e).find("ExceptionText").text();return r},parseTryConn:function(e){var t=$(e).find("TryConnection").text();if("success"==t.toLowerCase())return"success";var r=$(e).find("ExceptionText").text();return r},parseFeatureImport:function(e){var t=$(e).find("FeatureImport").text();return"SUCCESS"==t.toUpperCase()?result="success":""!=$(e).find("ExceptionText").text()&&(result=$(e).find("ExceptionText").text()),result},parseDescribeTileStores:function(e){var t=[],r=this;return $(e).find("TileStore").each(function(){var e=r.parseDescribeTileStore(this);t.push(e)}),t},parseDescribeTileStore:function(e){var t=$(e).find("Title").first().text(),r=$(e).find("Format").first().text(),n=$(e).find("SRID").first().text(),i=$(e).find("TileMatrixSetLink>TileMatrixSet").first().text(),s=$(e).find("Level>Start").text();s=parseInt(s);var a=$(e).find("Level>End").text();a=parseInt(a);var o=$(e).find("LowerCorner").text(),u=$(e).find("UpperCorner").text(),c=o.indexOf(" "),l=o.lastIndexOf(" "),v=o.slice(0,c),f=o.slice(l+1,o.length);c=u.indexOf(" "),l=u.lastIndexOf(" ");var d=u.slice(0,c),p=u.slice(l+1,u.length),S=new GeoBeans.Envelope(parseFloat(v),parseFloat(f),parseFloat(d),parseFloat(p)),x=this.sourceName,m=new GeoBeans.TileStore(t,S,r,i,x,s,a,n);return m},parseRemoveTileStore:function(e){var t=$(e).find("RemoveTileStore").text(),r="";return"SUCCESS"==t.toUpperCase()?r="success":""!=$(e).find("ExceptionText").text()&&(r=$(e).find("ExceptionText").text()),r},createDataSet:function(e,t,r,n){if(null==e||null==t||null==r)return void(null!=n&&n("params is invalid"));var i=this.buildCreateDataSetXML(e,t,r);if(null==i)return void(null!=n&&n("params is invalid"));var s=this;$.ajax({type:"post",url:this.server,data:i,contentType:"text/xml",dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var r=s.parseCreateDataSet(e);void 0!=n&&n(r)},complete:function(e,t){},error:function(){}})},buildCreateDataSetXML:function(e,t,r){if(null==e||null==t||null==r)return null;var n='<?xml version="1.0" encoding="UTF-8"?><CreateDataSet \tservice="dbs" \tversion="1.0.0" \tsourceName="'+e+'" \tdataSetName="'+t+'">';if(0!=r.length){n+="<Fields>";for(var i=null,s=null,a=null,o=null,u=0;u<r.length;++u)i=r[u],null!=i&&(o=i.name,s=i.type,a=i.length,n+="<Field><Name>"+o+"</Name><Type>"+s+"</Type>",null!=a&&(n+="<Length>"+a+"</Length>"),n+="</Field>");n+="</Fields>"}return n+="</CreateDataSet>"},parseCreateDataSet:function(e){var t=$(e).find("CreateDataSet").text(),r="";return"SUCCESS"==t.toUpperCase()?r="success":""!=$(e).find("ExceptionText").text()&&(r=$(e).find("ExceptionText").text()),r}});
GeoBeans.GField=GeoBeans.Class({name:null,type:null,length:null,initialize:function(e,t,l){this.name=e,this.type=t,this.length=l}}),GeoBeans.GFieldType={Bool:"bool",Char:"char",Short:"short",Int:"int",Long:"long",Int64:"int64",Float:"float",Double:"double",String:"string",Time:"time",Blob:"blob",Geometry:"geometry"};
GeoBeans.File=GeoBeans.Class({name:null,accessTime:null,lastTime:null,size:null,path:null,parPath:null,initialize:function(i,s,l,a,e,t){this.parPath=i,this.path=s,this.name=l,this.accessTime=a,this.lastTime=e,this.size=t}});
GeoBeans.FileManager=GeoBeans.Class({server:null,service:"ufs",version:"1.0.0",list:null,currentPath:null,initialize:function(e){this.server=e+"/mgr",this.list=[]},getList:function(e,t){if(null==e)return void(null!=t&&t("path is null"));var r=this,n="service="+this.service+"&version="+this.version+"&request=List&path="+e;r.currentPath=e,$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){r.list=r.parseList(e),void 0!=t&&t(r.list.sort(r.sortFile2Folder))},complete:function(e,t){},error:function(){}})},createFolder:function(e,t){if(null==e)return void(null!=t&&t("path is null"));var r=this,n="service="+this.service+"&version="+this.version+"&request=CreateFolder&path="+e;r.currentPath=e,$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var i=r.parseCreateFolder(e);void 0!=t&&t(i)},complete:function(e,t){},error:function(){}})},removeFolder:function(e,t){if(null==e)return void(null!=t&&t("path is null"));var r=this,n="service="+this.service+"&version="+this.version+"&request=RemoveFolder&path="+e;r.currentPath=e,$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var i=r.parseRemoveFolder(e);void 0!=t&&t(i)},complete:function(e,t){},error:function(){}})},removeFile:function(e,t){if(null==e)return void(null!=t&&t("path is null"));var r=this,n="service="+this.service+"&version="+this.version+"&request=RemoveFile&path="+e;r.currentPath=e,$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var i=r.parseRemoveFile(e);void 0!=t&&t(i)},complete:function(e,t){},error:function(){}})},describeCsv:function(e,t){if(null==e)return void(null!=t&&t("path is null"));var r=this,n="service="+this.service+"&version="+this.version+"&request=DescribeCsv&path="+e;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var i=r.parseDescribeCsv(e);void 0!=t&&t(i)},complete:function(e,t){},error:function(){}})},parseList:function(e){var t=this,r=[],n=$(e).find("Files");return n.children().each(function(){if("File"==this.tagName){var e=t.parseFile(this);r.push(e)}else if("Folder"==this.tagName){var n=t.parseFolder(this);r.push(n)}}),r},parseFile:function(e){var t=$(e).attr("name"),r=$(e).attr("access_time"),n=$(e).attr("last_modified_time"),i=$(e).attr("size"),s=null;s="/"==this.currentPath?this.currentPath+t:this.currentPath+"/"+t;var a=new GeoBeans.File(this.currentPath,s,t,r,n,i);return a},parseFolder:function(e){var t=$(e).attr("name"),r=$(e).attr("access_time"),n=$(e).attr("last_modified_time"),i=null;i="/"==this.currentPath?this.currentPath+t:this.currentPath+"/"+t;var s=new GeoBeans.Folder(this.currentPath,i,t,r,n);return s},parseCreateFolder:function(e){var t=$(e).find("CreateFolder").text();if("success"==t.toLowerCase())return"success";var r=$(e).find("ExceptionText").text();return r},parseRemoveFolder:function(e){var t=$(e).find("RemoveFolder").text();if("success"==t.toLowerCase())return"success";var r=$(e).find("ExceptionText").text();return r},parseRemoveFile:function(e){var t=$(e).find("RemoveFile").text();if("success"==t.toLowerCase())return"success";var r=$(e).find("ExceptionText").text();return r},sortFile2Folder:function(e,t){return e instanceof GeoBeans.File&&t instanceof GeoBeans.Folder?1:e instanceof GeoBeans.Folder&&t instanceof GeoBeans.File?-1:e instanceof GeoBeans.File&&t instanceof GeoBeans.File?t-e:e instanceof GeoBeans.Folder&&t instanceof GeoBeans.Folder?t-e:void 0},parseDescribeCsv:function(e){var t=$(e).find("ExceptionText").text();if(null!=t&&""!=t)return t;var r=[];return $(e).find("sequence").find("element").each(function(){var e=$(this).attr("name");r.push(e)}),r}});
GeoBeans.Folder=GeoBeans.Class({name:null,accessTime:null,lastTime:null,path:null,parPath:null,initialize:function(a,l,s,e,i){this.parPath=a,this.path=l,this.name=s,this.accessTime=e,this.lastTime=i}});
GeoBeans.ComparisionFilter=GeoBeans.Class(GeoBeans.Filter,{operator:null,initialize:function(){GeoBeans.Filter.prototype.initialize.apply(this,arguments),this.type=GeoBeans.Filter.Type.FilterComparsion}}),GeoBeans.ComparisionFilter.OperatorType={ComOprEqual:"equal",ComOprNotEqual:"notequal",ComOprLessThan:"lessthan",ComOprGreaterThan:"greaterthan",ComOprLessThanOrEqual:"lessthanorequal",ComOprGreaterThanOrEqual:"greaterthanorequal",ComOprIsLike:"islike",ComOprIsNull:"isnull",ComOprIsBetween:"isbetween"};
GeoBeans.DistanceBufferFilter=GeoBeans.Class(GeoBeans.Class,{propName:null,distance:null,initialize:function(){GeoBeans.SpatialFitler.prototype.initialize.apply(this,arguments),this.operator=GeoBeans.SpatilalFilter.OperatorType.SpOprIntersects}}),GeoBeans.UnitType={Inches:"inches",Points:"points",feet:"feet",yards:"yards",miles:"miles",naticalMiles:"naticalmiles"};
GeoBeans.Expression=GeoBeans.Class({type:null,initialize:function(){},clone:function(){var e=new GeoBeans.Expression;return e.type=this.type,e}}),GeoBeans.Expression.Type={Arithmetic:"arithmetic",PropertyName:"propname",Literal:"literal",Function:"function"};
GeoBeans.FilterReader=GeoBeans.Class({initialize:function(){},read:function(e){var r=null,a=e.children();return 0==a.length?null:r=this.parseFilter(a[0])},parseFilter:function(e){var r=null,a=e.tagName;return a=a.slice(a.lastIndexOf(":")+1,a.length),a=a.toLowerCase(),"bbox"==a?r=this.parseBBox(e):0==a.indexOf("propertyis")?r=this.parseBinaryComparision(a,e):"and"==a||"or"==a?r=this.parseBinaryLogical(a,e):"not"==a?r=this.parseUnaryLogic(e):"gmlobjectid"!=a&&"featureid"!=a||(r=this.parseID(e)),r},parseBBox:function(e){var r=this,a=new GeoBeans.BBoxFilter;return $(e).children().each(function(){var e=this.tagName;if(e=e.slice(e.lastIndexOf(":")+1,e.length),e=e.toLowerCase(),"propertyname"==e){var n=r.parsePropertyName(this);a.propertyName=n}else if("envelope"==e){var t=r.parseEnvelope(this);a.envelope=t}}),a},parseBinaryComparision:function(e,r){var a=new GeoBeans.BinaryComparisionFilter,n=this.parseComparisionOperator(e);if(n==GeoBeans.ComparisionFilter.OperatorType.ComOprIsBetween){var t=this.parseIsBetween(r);return t}a.operator=n;var i=$(r).children();if(null!=i[0]){var o=i[0],s=this.parseExpression(o);null!=s&&(a.expression1=s)}if(null!=i[1]){var l=i[1],p=this.parseExpression(l);null!=p&&(a.expression2=p)}return a},parseIsBetween:function(e){for(var r=new GeoBeans.IsBetweenFilter,a=$(e).children(),n=0;n<a.length;++n){var t=a[n],i=t.tagName;if(i=i.toLowerCase(),"ogc:lowerboundary"==i){var o=$(t).children();if(null!=o[0]){var s=this.parseExpression(o[0]);r.lowerBound=s}}else if("ogc:upperboundary"==i){var l=$(t).children();if(null!=l[0]){var p=this.parseExpression(l[0]);r.upperBound=p}}else{var u=this.parseExpression(t);r.expression=u}}return r},parseBinaryLogical:function(e,r){var a=this,n=new GeoBeans.BinaryLogicFilter;return"and"==e?n.operator=GeoBeans.LogicFilter.OperatorType.LogicOprAnd:"or"==e&&(n.operator=GeoBeans.LogicFilter.OperatorType.LogicOprOr),$(r).children().each(function(){var e=a.parseFilter(this);null!=e&&n.addFilter(e)}),n},parseUnaryLogic:function(e){var r=new GeoBeans.UnaryLogicFilter,a=$(e).children()[0];if(null!=a){var n=this.parseFilter(a);if(null!=n)return r.filter=n,r}return null},parseID:function(e){for(var r=$(e),a=new GeoBeans.IDFilter;0!=r.length;){var n=r.attr("gml:id");if(null==n&&(n=r.attr("gml:fid")),null!=n){var t=n.slice(n.lastIndexOf(".")+1,n.length);a.addID(parseInt(t))}r=r.next()}return a},parseComparisionOperator:function(e){var r=null;switch(e=e.toLowerCase()){case"propertyisequal":r=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;break;case"propertyisnotequal":r=GeoBeans.ComparisionFilter.OperatorType.ComOprNotEqual;break;case"propertyislessthan":r=GeoBeans.ComparisionFilter.OperatorType.ComOprLessThan;break;case"propertyisgreaterthan":r=GeoBeans.ComparisionFilter.OperatorType.ComOprGreaterThan;break;case"propertyislessthanorequalto":r=GeoBeans.ComparisionFilter.OperatorType.ComOprLessThanOrEqual;break;case"propertyisgreaterthanorequalto":r=GeoBeans.ComparisionFilter.OperatorType.ComOprGreaterThanOrEqual;break;case"propertyisislike":r=GeoBeans.ComparisionFilter.OperatorType.ComOprIsLike;break;case"propertyisisnull":r=GeoBeans.ComparisionFilter.OperatorType.ComOprIsNull;break;case"propertyisbetween":r=GeoBeans.ComparisionFilter.OperatorType.ComOprIsBetween;break;default:r=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual}return r},parseExpression:function(e){var r=null,a=e.tagName;return a=a.slice(a.lastIndexOf(":")+1,a.length),a=a.toLowerCase(),"propertyname"==a?r=this.parsePropertyName(e):"literal"==a&&(r=this.parseLiteral(e)),r},parsePropertyName:function(e){var r=$(e).text();if(null!=r){var a=new GeoBeans.PropertyName;return a.name=r,a}return null},parseLiteral:function(e){var r=$(e).text();if(null!=name){var a=new GeoBeans.Literal;return a.value=r,a}return null},parseEnvelope:function(e){var r=null,a=null,n=null,t=null;if($(e).children().each(function(){var e=this.tagName;if(e=e.slice(e.lastIndexOf(":")+1,e.length),e=e.toLowerCase(),"lowercorner"==e){var i=$(this).text(),o=i.indexOf(" "),s=i.lastIndexOf(" ");r=i.slice(0,o),a=i.slice(s+1,i.length)}else if("uppercorner"==e){var i=$(this).text(),o=i.indexOf(" "),s=i.lastIndexOf(" ");n=i.slice(0,o),t=i.slice(s+1,i.length)}}),null!=r&&null!=a&&null!=n&&null!=t){var i=new GeoBeans.Envelope(parseFloat(r),parseFloat(a),parseFloat(n),parseFloat(t));return i}return null}});
GeoBeans.FilterWriter=GeoBeans.Class({initialize:function(){},write:function(e,r){if(null==r)return null;var t=e.createElement("ogc:Filter"),i=this.writeFilter(e,r);return $(t).append(i),t},writeFilter:function(e,r){var t=r.type,i=null;return t==GeoBeans.Filter.Type.FilterID?i=this.writeIDFilter(e,r):t==GeoBeans.Filter.Type.FilterComparsion?i=this.writeComparsionFilter(e,r):t==GeoBeans.Filter.Type.FilterLogic?i=this.writeLogicFilter(e,r):t==GeoBeans.Filter.Type.FilterSpatial&&(i=this.writeSpatialFilter(e,r)),i},writeIDFilter:function(e,r){},writeComparsionFilter:function(e,r){var t=r.operator,i=null;if(t==GeoBeans.ComparisionFilter.OperatorType.ComOprEqual){i=e.createElement("ogc:PropertyIsEqualTo");var n=r.expression1,o=r.expression2,p=this.writeExpression(e,n),a=this.writeExpression(e,o);$(i).append(p),$(i).append(a)}else if(t==GeoBeans.ComparisionFilter.OperatorType.ComOprNotEqual){i=e.createElement("ogc:PropertyIsNotEqual");var n=r.expression1,o=r.expression2,p=this.writeExpression(e,n),a=this.writeExpression(e,o);$(i).append(p),$(i).append(a)}else if(t==GeoBeans.ComparisionFilter.OperatorType.ComOprLessThan){i=e.createElement("ogc:PropertyIsLessThan");var n=r.expression1,o=r.expression2,p=this.writeExpression(e,n),a=this.writeExpression(e,o);$(i).append(p),$(i).append(a)}else if(t==GeoBeans.ComparisionFilter.OperatorType.ComOprGreaterThan){i=e.createElement("ogc:PropertyIsGreaterThan");var n=r.expression1,o=r.expression2,p=this.writeExpression(e,n),a=this.writeExpression(e,o);$(i).append(p),$(i).append(a)}else if(t==GeoBeans.ComparisionFilter.OperatorType.ComOprLessThanOrEqual){i=e.createElement("ogc:PropertyIsLessThanOrEqualTo");var n=r.expression1,o=r.expression2,p=this.writeExpression(e,n),a=this.writeExpression(e,o);$(i).append(p),$(i).append(a)}else if(t==GeoBeans.ComparisionFilter.OperatorType.ComOprGreaterThanOrEqual){i=e.createElement("ogc:PropertyIsGreaterThanOrEqualTo");var n=r.expression1,o=r.expression2,p=this.writeExpression(e,n),a=this.writeExpression(e,o);$(i).append(p),$(i).append(a)}else if(t==GeoBeans.ComparisionFilter.OperatorType.ComOprIsLike){i=e.createElement("ogc:PropertyIsLike"),$(i).attr("escapeChar","!"),$(i).attr("singleChar","#"),$(i).attr("wildCard","*");var s=r.properyName,l=r.literal,c=this.writeExpression(e,s),m=this.writeExpression(e,l);$(i).append(c),$(i).append(m)}else if(t==GeoBeans.ComparisionFilter.OperatorType.ComOprIsNull)i=e.createElement("ogc:PropertyIsIsNull");else if(t==GeoBeans.ComparisionFilter.OperatorType.ComOprIsBetween){i=e.createElement("ogc:PropertyIsBetween");var E=r.expression,x=this.writeExpression(e,E),u=r.lowerBound,w=this.writeExpression(e,u),y=r.upperBound,F=this.writeExpression(e,y),h=e.createElement("ogc:LowerBoundary");$(h).append(w);var B=e.createElement("ogc:UpperBoundary");$(B).append(F),$(i).append(h),$(i).append(B),$(i).append(x)}return i},writeExpression:function(e,r){var t=null,i=r.type;if(i==GeoBeans.Expression.Type.Arithmetic);else if(i==GeoBeans.Expression.Type.PropertyName){t=e.createElement("ogc:PropertyName");var n=r.name;$(t).text(n)}else if(i==GeoBeans.Expression.Type.Literal){t=e.createElement("ogc:Literal");var o=r.value;$(t).text(o)}else i==GeoBeans.Expression.Type.Function;return t},writeLogicFilter:function(e,r){var t=r.operator,i=null;if(t==GeoBeans.LogicFilter.OperatorType.LogicOprAnd)i=e.createElement("ogc:And");else if(t==GeoBeans.LogicFilter.OperatorType.LogicOprOr)i=e.createElement("ogc:Or");else if(t==GeoBeans.LogicFilter.OperatorType.LogicOprNot){i=e.createElement("ogc:Not");var n=r.filter,o=this.writeFilter(e,n);return $(i).append(o),i}for(var p=r.filters,a=0;a<p.length;++a){var n=p[a],o=this.writeFilter(e,n);$(i).append(o)}return i},writeSpatialFilter:function(e,r){var t=r.operator,i=null;return t==GeoBeans.SpatialFilter.OperatorType.SpOprBBox?i=this.writeBBoxFilter(e,r):t==GeoBeans.SpatialFilter.OperatorType.SpOprIntersects&&(i=this.writeSpatialFilterIntersects(e,r)),i},writeBBoxFilter:function(e,r){var t=e.createElement("ogc:BBOX"),i=r.propName,n=this.writeExpression(e,i);$(t).append(n);var o=r.extent,p=this.writeEnvelope(e,o);return $(t).append(p),t},writeEnvelope:function(e,r){var t=r.xmin,i=r.ymin,n=r.xmax,o=r.ymax,p=e.createElement("gml:Envelope"),a=e.createElement("gml:lowerCorner");$(a).text(t+" "+i);var s=e.createElement("gml:upperCorner");return $(s).text(n+" "+o),$(p).append(a),$(p).append(s),p},writeSpatialFilterIntersects:function(e,r){var t=e.createElement("Intersects"),i=r.geometry,n=r.propName,o=new GeoBeans.Geometry.GML.Writer(GeoBeans.Geometry.GML.Version.v_2_0),p=o.write(i),a=e.createElement("PropertyName");return $(a).text(n),$(t).append(a),$(t).append(p),t}});
GeoBeans.IDFilter=GeoBeans.Class(GeoBeans.Filter,{ids:null,initialize:function(){GeoBeans.Filter.prototype.initialize.apply(this,arguments),this.type=GeoBeans.Filter.Type.FilterID,this.ids=[]},addID:function(i){this.ids.push(i)}});
GeoBeans.Literal=GeoBeans.Class(GeoBeans.Expression,{value:null,initialize:function(){GeoBeans.Expression.prototype.initialize.apply(this,arguments),this.type=GeoBeans.Expression.Type.Literal},setValue:function(e){this.value=e},clone:function(){var e=new GeoBeans.Literal;return e.value=this.value,e.type=this.type,e}});
GeoBeans.LogicFilter=GeoBeans.Class(GeoBeans.Filter,{operator:null,initialize:function(){GeoBeans.Filter.prototype.initialize.apply(this,arguments),this.type=GeoBeans.Filter.Type.FilterLogic}}),GeoBeans.LogicFilter.OperatorType={LogicOprAnd:"and",LogicOprOr:"or",LogicOprNot:"not"};
GeoBeans.OrderBy=GeoBeans.Class({fields:null,order:null,initialize:function(){this.fields=[]},destory:function(){this.fields=null},addField:function(e){null!=e&&this.fields.push(e)},getField:function(e){return e<0||e>=this.fields.length?null:this.fields[e]},getFieldCount:function(){return this.fields.length},setOrder:function(e){this.order=e},isAsc:function(){return this.order==GeoBeans.OrderBy.OrderType.OrderAsc}}),GeoBeans.OrderBy.OrderType={OrderAsc:"asc",OrderDesc:"desc"};
GeoBeans.PropertyName=GeoBeans.Class({name:null,initialize:function(){this.type=GeoBeans.Expression.Type.PropertyName},clone:function(){var e=new GeoBeans.PropertyName;return e.name=this.name,e},setName:function(e){this.name=e}});
GeoBeans.SpatialFilter=GeoBeans.Class(GeoBeans.Filter,{operator:null,propName:null,geometry:null,initialize:function(){GeoBeans.Filter.prototype.initialize.apply(this,arguments),this.type=GeoBeans.Filter.Type.FilterSpatial}}),GeoBeans.SpatialFilter.OperatorType={SpOprIntersects:"intersects",SpOprDWithin:"dwithin",SpOprEquals:"equals",SpOprDisjoint:"disjoint",SpOprTouchs:"touchs",SpOprCrosses:"crosses",SpOprByond:"byond",SpOprContains:"contains",SpOprOverlaps:"overlaps",SpOprBBox:"bbox"};
GeoBeans.UnaryLogicFilter=GeoBeans.Class(GeoBeans.LogicFilter,{filter:null,initialize:function(){GeoBeans.LogicFilter.prototype.initialize.apply(this,arguments),this.operator=GeoBeans.LogicFilter.OperatorType.LogicOprNot}});
GeoBeans.BinaryComparisionFilter=GeoBeans.Class(GeoBeans.ComparisionFilter,{expression1:null,expression2:null,initialize:function(){GeoBeans.ComparisionFilter.prototype.initialize.apply(this,arguments)},clone:function(){var e=new GeoBeans.BinaryComparisionFilter;return e.type=this.type,null!=this.expression1&&(e.expression1=this.expression1.clone()),null!=this.expression2&&(e.expression2=this.expression2.clone()),null!=this.operator&&(e.operator=this.operator),e}});
GeoBeans.IsBetweenFilter=GeoBeans.Class(GeoBeans.ComparisionFilter,{expression:null,lowerBound:null,upperBound:null,initialize:function(){GeoBeans.ComparisionFilter.prototype.initialize.apply(this,arguments),this.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprIsBetween},clone:function(){var e=new GeoBeans.IsBetweenFilter;return e.type=this.type,null!=this.expression&&(e.expression=this.expression.clone()),null!=this.lowerBound&&(e.lowerBound=this.lowerBound.clone()),null!=this.upperBound&&(e.upperBound=this.upperBound.clone()),e}});
GeoBeans.IsLikeFilter=GeoBeans.Class(GeoBeans.ComparisionFilter,{properyName:null,literal:null,initialize:function(){GeoBeans.ComparisionFilter.prototype.initialize.apply(this,arguments),this.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprIsLike}});
GeoBeans.IsNullFilter=GeoBeans.Class(GeoBeans.ComparisionFilter,{properyName:null,initialize:function(){GeoBeans.ComparisionFilter.prototype.initialize.apply(this,arguments),this.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprIsNull}});
GeoBeans.BinaryLogicFilter=GeoBeans.Class(GeoBeans.LogicFilter,{filters:null,initialize:function(){GeoBeans.LogicFilter.prototype.initialize.apply(this,arguments),this.filters=[]},addFilter:function(i){this.filters.push(i)}});
GeoBeans.BBoxFilter=GeoBeans.Class(GeoBeans.SpatialFilter,{propName:null,extent:null,initialize:function(){GeoBeans.SpatialFilter.prototype.initialize.apply(this,arguments),this.operator=GeoBeans.SpatialFilter.OperatorType.SpOprBBox},setExtent:function(e,t,i,a){}});
GeoBeans.BinarySpatialFilter=GeoBeans.Class(GeoBeans.SpatialFilter,{propName:null,envelope:null,unitType:null,initialize:function(){GeoBeans.SpatialFitler.prototype.initialize.apply(this,arguments)}});
GeoBeans.Geometry.Circle=GeoBeans.Class(GeoBeans.Geometry,{center:null,radius:null,type:GeoBeans.Geometry.Type.CIRCLE,initialize:function(e,t){this.center=e,this.radius=t},hit:function(e,t){var i=Math.abs(this.center.x-e)+Math.abs(this.center.y-t);return i<=this.radius}});
GeoBeans.Geometry.GeometryCollection=GeoBeans.Class(GeoBeans.Geometry,{components:null,initialize:function(n){this.components=[]},addComponents:function(n){n instanceof Array||(n=[n]);for(var o=0,e=n.length;o<e;o++)this.addComponent(n[o])},addComponent:function(n){this.components.push(n)}});
GeoBeans.Geometry.GML=GeoBeans.Class({initialize:function(e){this.name=e},destory:function(){GeoBeans.Class.prototype.destory.apply(this,arguments)}}),GeoBeans.Geometry.GML.Version={v_2_0:"2.0",v_3_1_1:"3.1.1",v_3_2_1:"3.2.1"},GeoBeans.Geometry.GML.Type={Point:"gml:Point",LineString:"gml:LineString",Polygon:"gml:Polygon",MultiPoint:"gml:MultiPoint",MultiLineString:"gml:MultiLineString",MultiPolygon:"gml:MultiPolygon"},GeoBeans.Geometry.GML.Writer=GeoBeans.Class({version:null,initialize:function(e){this.version=e},destory:function(){GeoBeans.Class.prototype.destory.apply(this,arguments)},write:function(e){if(null==e)return null;var n="",t=e.type;switch(t){case GeoBeans.Geometry.Type.POINT:n=this.writePoint(e);break;case GeoBeans.Geometry.Type.LINESTRING:n=this.writeLineString(e);break;case GeoBeans.Geometry.Type.POLYGON:n=this.writePolygon(e);break;case GeoBeans.Geometry.Type.MULTIPOINT:break;case GeoBeans.Geometry.Type.MULTILINESTRING:n=this.writeMultiLinestring(e);break;case GeoBeans.Geometry.Type.MULTIPOLYGON:n=this.writeMultiPolygon(e)}return n},writePoint:function(e){var n="";return n+=' <gml:Point><gml:coordinates xmlns:gml="http://www.opengis.net/gml" decimal="." cs="," ts=" ">',n+=e.x,n+=",",n+=e.y,n+="</gml:coordinates></gml:Point>"},writeLineString:function(e){var n="",t=e.points;n+="<LineString><coordinates>";for(var r=0;r<t.length;++r){var i=t[r],o=i.x,l=i.y;n+=o,n+=",",n+=l+" "}return n+="</coordinates></LineString>"},writePolygon:function(e){var n="",t=e.rings;n+='<gml:Polygon  xmlns:gml="http://www.opengis.net/gml" >';for(var r=0;r<t.length;++r){n+="<gml:outerBoundaryIs>",n+="<gml:LinearRing>",n+='<gml:coordinates xmlns:gml="http://www.opengis.net/gml" decimal="." cs="," ts=" ">';for(var i=t[r],o=i.points,l=0;l<o.length;++l){var a=o[l],s=a.x,g=a.y;n+=s,n+=",",n+=g+" "}n+="</gml:coordinates>",n+="</gml:LinearRing>",n+="</gml:outerBoundaryIs>"}return n+="</gml:Polygon>"},writeMultiLinestring:function(e){var n="",t=e.lines;n+="<gml:MultiLineString>";for(var r=0;r<t.length;++r){var i=t[r].points;n+="<gml:lineStringMember>",n+="<gml:LineString>",n+='<gml:coordinates xmlns:gml="http://www.opengis.net/gml" decimal="." cs="," ts=" ">';for(var o=0;o<i.length;++o){var l=i[o],a=l.x,s=l.y;n+=a,n+=",",n+=s+" "}n+="</gml:coordinates>",n+="</gml:LineString></gml:lineStringMember>"}return n+="</gml:MultiLineString>"},writeMultiPolygon:function(e){var n="",t=e.polygons;n+="<gml:MultiPolygon>";for(var r=0;r<t.length;++r){var i=t[r],o=i.rings;n+="<gml:polygonMember>",n+="<gml:Polygon>";for(var l=0;l<o.length;++l){n+="<gml:outerBoundaryIs>",n+="<gml:LinearRing>",n+='<gml:coordinates xmlns:gml="http://www.opengis.net/gml" decimal="." cs="," ts=" ">';for(var a=o[l],s=a.points,g=0;g<s.length;++g){var y=s[g],m=y.x,u=y.y;n+=m,n+=",",n+=u+" "}n+="</gml:coordinates>",n+="</gml:LinearRing>",n+="</gml:outerBoundaryIs>"}n+="</gml:Polygon>",n+="</gml:polygonMember>"}return n+="</gml:MultiPolygon>"}}),GeoBeans.Geometry.GML.Reader=GeoBeans.Class({version:null,initialize:function(e){this.version=e},destory:function(){GeoBeans.Class.prototype.destory.apply(this,arguments)},read:function(e){var n=null,t=e.tagName;switch(t){case GeoBeans.Geometry.GML.Type.Point:n=this.readPoint(e);break;case GeoBeans.Geometry.GML.Type.LineString:n=this.readLineString(e);break;case GeoBeans.Geometry.GML.Type.Polygon:n=this.readPolygon(e);break;case GeoBeans.Geometry.GML.Type.MultiPoint:break;case GeoBeans.Geometry.GML.Type.MultiLineString:n=this.readMultiLineString(e);break;case GeoBeans.Geometry.GML.Type.MultiPolygon:n=this.readMultiPolygon(e)}return n},readPoint:function(e){return this.parsePoint($(e).children().first())},readLineString:function(e){var n=this.parsePoints($(e).children().first());return 0==n.length?null:new GeoBeans.Geometry.LineString(n)},readPolygon:function(e){var n=this,t=null,r=new Array,i=new Array;return $(e).find("gml\\:LinearRing").each(function(e,o){i=n.parsePoints($(this).children().first()),t=new GeoBeans.Geometry.LinearRing(i),r.push(t)}),0==r.length?null:new GeoBeans.Geometry.Polygon(r)},readMultiLineString:function(e){var n=this,t=null,r=new Array;return $(e).find("gml\\:LineString").each(function(e,i){t=n.readLineString(this),r.push(t)}),0==r.length?null:new GeoBeans.Geometry.MultiLineString(r)},readMultiPolygon:function(e){var n=this,t=null,r=new Array;return $(e).find("Polygon").each(function(e,i){t=n.readPolygon(this),null!=t&&r.push(t)}),new GeoBeans.Geometry.MultiPolygon(r)},parsePoint:function(e){var n=($(e).attr("ts"),$(e).attr("cs")),t=($(e).attr("dc"),$(e).text()),r=t.split(n),i=new GeoBeans.Geometry.Point(parseFloat(r[0]),parseFloat(r[1]));return i},parsePoints:function(e){for(var n,t,r=$(e).attr("ts"),i=$(e).attr("cs"),o=($(e).attr("dc"),$(e).text()),l=o.split(r),a=l.length,s=new Array,g=0;g<a;g++)t=l[g].split(i),n=new GeoBeans.Geometry.Point(parseFloat(t[0]),parseFloat(t[1])),s.push(n);return s}});
GeoBeans.Geometry.LineString=GeoBeans.Class(GeoBeans.Geometry,{points:null,type:GeoBeans.Geometry.Type.LINESTRING,initialize:function(t){this.points=t,this.extent=this.computeExtent(this.points)},destory:function(){this.points=null},hit:function(t,n,e){if(!this.extent.contain(t,n))return!1;for(var s=this.points.length-1,a=null,i=null,o=0,h=0;h<s;h++)if(a=this.points[h],i=this.points[h+1],o=this.distance2segment(t,n,a.x,a.y,i.x,i.y),o<e)return!0;return!1},distance:function(t,n){for(var e=this.points.length-1,s=null,a=null,i=0,o=0,h=0;h<e;h++)s=this.points[h],a=this.points[h+1],o=this.distance2segment(t,n,s.x,s.y,a.x,a.y),o<i&&(o=i);return i},distance2segment:function(t,n,e,s,a,i){var o=0;if(Math.abs(e-a)<Math.ESPLON){var h=s<i?s:i,r=s>i?s:i;n>h&&n<r?o=Math.abs(t-e):n<h?o=Math.sqrt(Math.pow(t-e,2)+Math.pow(n-h,2)):n>r&&(o=Math.sqrt(Math.pow(t-e,2)+Math.pow(n-r,2)))}else if(Math.abs(s-i)<Math.ESPLON){var p=e<a?e:a,M=e>a?e:a;t>p&&t<M?o=Math.abs(n-s):t<p?o=Math.sqrt(Math.pow(n-s,2)+Math.pow(t-p,2)):n>r&&(o=Math.sqrt(Math.pow(n-s,2)+Math.pow(t-M,2)))}else{var l=-(a-e)/(i-s),u=-1/l,y=s-u*e,f=n-l*t,w=l-u,x=(y-f)/w,c=l*x+f,p=e<a?e:a,M=e>a?e:a;if(x>p&&x<M||c>h&&c<r)o=Math.sqrt(Math.pow(n-c,2)+Math.pow(t-x,2));else{var v=Math.sqrt(Math.pow(s-c,2)+Math.pow(e-x,2)),G=Math.sqrt(Math.pow(i-c,2)+Math.pow(a-x,2));o=v<G?v:G}}return o},computeExtent:function(t){var n=t.length;if(0==n)return null;for(var e=t[0],s=e.x,a=e.y,i=e.x,o=e.y,h=1;h<n;h++)e=t[h],e.x<s&&(s=e.x),e.x>i&&(i=e.x),e.y<a&&(a=e.y),e.y>o&&(o=e.y);return new GeoBeans.Envelope(s,a,i,o)},getCentroid:function(){for(var t,n=0,e=0,s=0,a=0;a<this.points.length;++a)t=this.points[a],n+=t.x,e+=t.y;n/=s,e/=s;var t=new GeoBeans.Geometry.Point(n,e);return t}});
GeoBeans.Geometry.MultiLineString=GeoBeans.Class(GeoBeans.Geometry,{lines:null,type:GeoBeans.Geometry.Type.MULTILINESTRING,initialize:function(e){this.lines=e,this.extent=this.computeExtent()},destory:function(){this.lines=null},hit:function(e,n,t){if(!this.extent.contain(e,n))return!1;for(var i=this.lines.length,r=0;r<i;r++){var s=this.lines[r];if(s.hit(e,n,t))return!0}return!1},computeExtent:function(){var e=null,n=this.lines.length;if(n<1)return null;var t=this.lines[0];e=new GeoBeans.Envelope(t.extent.xmin,t.extent.ymin,t.extent.xmax,t.extent.ymax);for(var i=1;i<n;i++)t=this.lines[i],e.union(t.extent);return e},getCentroid:function(){for(var e=0,n=0,t=0,i=0;i<this.lines.length;++i){var r=this.lines[i],s=r.points;t+=s.length;for(var o=0;o<s.length;++o){var l=s[o];e+=l.x,n+=l.y}}e/=t,n/=t;var l=new GeoBeans.Geometry.Point(e,n);return l}});
GeoBeans.Geometry.MultiPoint=GeoBeans.Class(GeoBeans.Geometry,{points:null,type:GeoBeans.Geometry.Type.MULTIPOINT,initialize:function(t){this.points=t,this.extent=this.computeExtent(this.points)},destory:function(){this.points=null},hit:function(t,e,n){for(var i=this.points.length,o=0;o<i;o++){var s=this.points[o];if(s.hit(t,e,n))return truel}return!1},computeExtent:function(t){var e=t.length;if(0==e)return null;for(var n=t[0],i=n.x,o=n.y,s=n.x,r=n.y,u=1;u<e;u++)n=t[u],n.x<i&&(i=n.x),n.x>s&&(s=n.x),n.y<o&&(o=n.y),n.y>r&&(r=n.y);return new GeoBeans.Envelope(i,o,s,r)}});
GeoBeans.Geometry.MultiPolygon=GeoBeans.Class(GeoBeans.Geometry,{polygons:null,type:GeoBeans.Geometry.Type.MULTIPOLYGON,initialize:function(n){this.polygons=n,this.extent=this.computeExtent()},destory:function(){this.polygons=null},hit:function(n,t,e){if(!this.extent.contain(n,t))return!1;for(var o=null,r=this.polygons.length,i=0;i<r;i++)if(o=this.polygons[i],o.hit(n,t))return!0;return!1},computeExtent:function(){var n=null,t=this.polygons.length;if(t<1)return null;var e=this.polygons[0];n=new GeoBeans.Envelope(e.extent.xmin,e.extent.ymin,e.extent.xmax,e.extent.ymax);for(var o=1;o<t;o++)e=this.polygons[o],n.union(e.extent);return n},getCentroid:function(){for(var n,t,e,o,r=0,i=0,s=0,l=0;l<this.polygons.length;++l){n=this.polygons[l],t=n.rings;for(var a=0;a<t.length;++a){e=t[a],o=e.points,s+=o.length;for(var y=0;y<o.length;++y)h=o[y],r+=h.x,i+=h.y}}r/=s,i/=s;var h=new GeoBeans.Geometry.Point(r,i);return h},toPointsArray:function(){for(var n=[],t=0;t<this.polygons.length;++t){var e=this.polygons[t];if(null!=e){var o=e.toPointsArray();n=n.concat(o)}}return n}});
GeoBeans.Geometry.Point=GeoBeans.Class(GeoBeans.Geometry,{x:null,y:null,type:GeoBeans.Geometry.Type.POINT,initialize:function(e,t){this.x=parseFloat(e),this.y=parseFloat(t),this.extent=new GeoBeans.Envelope(this.x,this.y,this.x,this.y)},hit:function(e,t,n){var s=Math.abs(this.x-e)+Math.abs(this.y-t);return s<n},getCentroid:function(){return new GeoBeans.Geometry.Point(this.x,this.y)}});
GeoBeans.Geometry.Polygon=GeoBeans.Class(GeoBeans.Geometry,{rings:null,type:GeoBeans.Geometry.Type.POLYGON,initialize:function(t){this.rings=t,this.extent=this.computeExtent()},hit:function(t,n,e){if(!this.extent.contain(t,n))return!1;for(var r=0,i=this.rings.length,s=0;s<i;s++)for(var o,a,h=this.rings[s],u=h.points,g=u.length-1,l=0;l<g;l++)o=u[l],a=u[l+1],this.isSegmentShooted(t,n,o,a)&&r++;var f=r%2;return 0!=f},computeExtent:function(){var t=null,n=this.rings.length;if(n<1)return null;var e=this.rings[0];t=new GeoBeans.Envelope(e.extent.xmin,e.extent.ymin,e.extent.xmax,e.extent.ymax);for(var r=1;r<n;r++)e=this.rings[r],t.union(e.extent);return t},getCrossedSegments:function(){},isSegmentShooted:function(t,n,e,r){if(Math.abs(e.y-r.y)<Number.EPSILON){if(Math.abs(n-e.y)<Number.EPSILON)return!1;if(Math.abs(n-r.y)<Number.EPSILON)return!1}else if((n>e.y&&n<r.y||n>r.y&&n<e.y)&&t<e.x&&t<r.x)return!0;return!1},getCentroid:function(){for(var t=0,n=0,e=0,r=0;r<this.rings.length;++r){var i=this.rings[r];if(null!=i){var s=i.points;e+=s.length;for(var o=0;o<s.length;++o){var a=s[o];t+=a.x,n+=a.y}}}t/=e,n/=e;var a=new GeoBeans.Geometry.Point(t,n);return a},toPointsArray:function(){for(var t=[],n=0;n<this.rings.length;++n){var e=this.rings[n];if(null!=e)for(var r=e.points,i=0;i<r.length;++i){var s=r[i],o=s.x,a=s.y;t.push(o),t.push(a)}}return t}});
GeoBeans.Geometry.LinearRing=GeoBeans.Class(GeoBeans.Geometry.LineString,{points:null,initialize:function(e){GeoBeans.Geometry.LineString.prototype.initialize.apply(this,arguments)},destory:function(){GeoBeans.Geometry.LineString.prototype.destory.apply(this,arguments)},numPoints:function(){return this.points.length}});
GeoBeans.GPSManager=GeoBeans.Class({server:null,service:"gps",version:"1.0.0",initialize:function(e){this.server=e+"/mgr"},getCapabilities:function(e){var t=this,n="service="+this.service+"&version="+this.version+"&request=GetCapabilities";$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(n,r){var u=t.parseGetCapabilities(n);null!=e&&e(u)},complete:function(e,t){},error:function(){}})},parseGetCapabilities:function(e){var t=[];return $(e).find("OperationsSet").each(function(){var e=$(this),n=e.attr("type"),r=e.attr("description"),u={type:n,description:r},s=[];e.find("ows\\:Operation").each(function(){var e=$(this).find("Name").first().text(),t=$(this).find("Alias").first().text(),n={name:e,alias:t};s.push(n)}),u.operList=s,t.push(u)}),t},clusterKmean:function(e,t,n,r,u,s){if(null==e||null==t||null==n||null==r||null==u)return void(null!=s&&s("params is invalid"));var i=this,a="service="+this.service+"&version="+this.version+"&request=KMean&inputSourceName="+e+"&inputTypeName="+t+"&outputSourceName="+n+"&outputTypeName="+r+"&clusters="+u;$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=i.parseClusterKmean(e);null!=s&&s(n)},complete:function(e,t){},error:function(){}})},parseClusterKmean:function(e){var t=$(e).find("KMean").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},featureProject:function(e,t,n,r,u,s){if(null==e||null==t||null==n||null==r)return void(null!=s&&s("params is invalid"));var i=this,a="service=gps&vesion=1.0.0&request=FeatureProject&inputSourceName="+e+"&inputTypeName="+t+"&outputSourceName="+n+"&outputTypeName="+r+"&outputSrid="+u,i=this;$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=i.parseFeatureProject(e);null!=s&&s(n)},complete:function(e,t){},error:function(){}})},parseFeatureProject:function(e){var t=$(e).find("FeatureProject").text();return"SUCCESS"==t.toUpperCase()?result="success":""!=$(e).find("ExceptionText").text()&&(result=$(e).find("ExceptionText").text()),result},featureImport:function(e,t,n,r,u,s,i){if(null==e||null==t||null==n)return void(null!=i&&i("params is invalid"));var a="service=gps&vesion=1.0.0&request=FeatureImport&sourcename="+e+"&typeName="+t+"&shppath="+n+"&shpname="+r;a+=null!=u?"&srid="+u:"&srid=4326",a+=null!=s?"&geom="+s:"&geom=shape";var o=this;$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=o.parseFeatureImport(e);null!=i&&i(n)},complete:function(e,t){},error:function(){}})},parseFeatureImport:function(e){var t=$(e).find("FeatureImport").text();return"SUCCESS"==t.toUpperCase()?result="success":""!=$(e).find("ExceptionText").text()&&(result=$(e).find("ExceptionText").text()),result},getSpatialReferenceList:function(e,t,n){var r=this,u="service="+this.service+"&version="+this.version+"&request=GetSpatialReference";null!=e&&(u+="&count="+e),null!=t&&(u+="&offset="+t),$.ajax({type:"get",url:this.server,data:encodeURI(u),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var u=r.parseSpatialReferences(e);null!=n&&n(u)},complete:function(e,t){},error:function(){}})},parseSpatialReferences:function(e){var t=[],n=this;return $(e).find("SpatialReference").each(function(){var e=n.parseSpatialReference(this);t.push(e)}),t},parseSpatialReference:function(e){var t=$(e).find("srid").text(),n=$(e).find("srtext").text(),r=$(e).find("proj4").text(),u=null;return null!=t&&(u=new GeoBeans.SpatialReference(t,n,r)),u},getSpatialReferenceBySrid:function(e,t){if(null==e)return void(null!=t&&t("srid is null"));var n=this,r="service="+this.service+"&version="+this.version+"&request=GetSpatialReference&srid="+e;$.ajax({type:"get",url:this.server,data:encodeURI(r),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var u=n.parseSpatialReferences(e);null!=t&&t(u)},complete:function(e,t){},error:function(){}})},getSpatialReferenceCount:function(e){var t=this,n="service="+this.service+"&version="+this.version+"&request=GetSpatialReferenceCount";$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(n,r){var u=t.parseGetSpatialReferenceCount(n);null!=e&&e(u)},complete:function(e,t){},error:function(){}})},parseGetSpatialReferenceCount:function(e){var t=$(e).find("Count").text();return t=parseInt(t)},rasterReverse:function(e,t,n,r,u,s,i){if(null==e||null==t||null==r||null==s)return void(null!=i&&i("params is invalid"));var a=this,o="service="+this.service+"&version="+this.version+"&request=RasterReverse&inputSourceName="+e+"&inputRasterName="+t+"&outputSourceName="+r+"&outPutRasterName="+u;null!=n&&(o+="&inputPath="+n),null!=s&&(o+="&outputPath="+s),$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.parseRasterReverse(e);null!=i&&i(n)},complete:function(e,t){},error:function(){}})},parseRasterReverse:function(e){var t=$(e).find("RasterReverse").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},rasterGraylize:function(e,t,n,r,u,s,i){if(null==e||null==t||null==r||null==s)return void(null!=i&&i("params is invalid"));var a=this,o="service="+this.service+"&version="+this.version+"&request=RasterGraylize&inputSourceName="+e+"&inputRasterName="+t+"&outputSourceName="+r+"&outPutRasterName="+u;null!=n&&(o+="&inputPath="+n),null!=s&&(o+="&outputPath="+s),$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.parseRasterGraylize(e);null!=i&&i(n)},complete:function(e,t){},error:function(){}})},parseRasterGraylize:function(e){var t=$(e).find("RasterGraylize").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},rasterSmooth:function(e,t,n,r,u,s,i,a){if(null==e||null==t||null==r||null==u||null==i)return void(null!=a&&a("params is invalid"));var o=this,l="service="+this.service+"&version="+this.version+"&request=RasterSmooth&inputSourceName="+e+"&inputRasterName="+t+"&operator="+r+"&outputSourceName="+u+"&outPutRasterName="+s;null!=n&&(l+="&inputPath="+n),null!=i&&(l+="&outputPath="+i),$.ajax({type:"get",url:this.server,data:encodeURI(l),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=o.parseRasterSmooth(e);null!=a&&a(n)},complete:function(e,t){},error:function(e,t,n){a(n)}})},parseRasterSmooth:function(e){var t=$(e).find("RasterSmooth").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},rasterStretch:function(e,t,n,r,u,s,i){if(null==e||null==t||null==r||null==s)return void(null!=i&&i("params is invalid"));var a=this,o="service="+this.service+"&version="+this.version+"&request=RasterStretch&inputSourceName="+e+"&inputRasterName="+t+"&outputSourceName="+r+"&outPutRasterName="+u;null!=n&&(o+="&inputPath="+n),null!=s&&(o+="&outputPath="+s),$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.parseRasterStretch(e);null!=i&&i(n)},complete:function(e,t){},error:function(){}})},parseRasterStretch:function(e){var t=$(e).find("RasterStretch").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},rasterSubtract:function(e,t,n,r,u,s,i,a,o,l){if(null==e||null==t||null==r||null==u||null==i||null==a)return void(null!=l&&l("params is invalid"));var c=this,p="service="+this.service+"&version="+this.version+"&request=RasterSubtract&inputSourceName_1="+e+"&inputRasterName_1="+t;null!=n&&(p+="&inputPath_1="+n),p+="&inputSourceName_2="+r+"&inputRasterName_2="+u,null!=s&&(p+="&inputPath_2="+s),p+="&outputSourceName="+i+"&outPutRasterName="+a,null!=o&&(p+="&outputPath="+o),$.ajax({type:"get",url:this.server,data:encodeURI(p),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=c.parseRasterSubtract(e);null!=l&&l(n)},complete:function(e,t){},error:function(){}})},parseRasterSubtract:function(e){var t=$(e).find("RasterSubtract").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},rasterPixelBlend:function(e,t,n,r,u,s,i,a,o,l){if(null==e||null==t||null==r||null==u||null==i||null==a)return void(null!=l&&l("params is invalid"));var c=this,p="service="+this.service+"&version="+this.version+"&request=RasterPixelBlend&inputSourceName_1="+e+"&inputRasterName_1="+t;null!=n&&(p+="&inputPath_1="+n),p+="&inputSourceName_2="+r+"&inputRasterName_2="+u,null!=s&&(p+="&inputPath_2="+s),p+="&outputSourceName="+i+"&outPutRasterName="+a,null!=o&&(p+="&outputPath="+o),$.ajax({type:"get",url:this.server,data:encodeURI(p),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=c.parseRasterPixelBlend(e);null!=l&&l(n)},complete:function(e,t){},error:function(){}})},parseRasterPixelBlend:function(e){var t=$(e).find("RasterPixelBlend").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},rasterEdgeDetect:function(e,t,n,r,u,s,i){if(null==e||null==t||null==r||null==s)return void(null!=i&&i("params is invalid"));var a=this,o="service="+this.service+"&version="+this.version+"&request=RasterEdgeDetect&inputSourceName="+e+"&inputRasterName="+t+"&outputSourceName="+r+"&outPutRasterName="+u;null!=n&&(o+="&inputPath="+n),null!=s&&(o+="&outputPath="+s),$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.parseRasterEdgeDetect(e);null!=i&&i(n)},complete:function(e,t){},error:function(){}})},parseRasterEdgeDetect:function(e){var t=$(e).find("RasterEdgeDetect").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},rasterExtractByRectangle:function(e,t,n,r,u,s,i,a){if(null==e||null==t||null==r||null==s||null==i)return void(null!=a&&a("params is invalid"));var o=this,l=i.toString(),c="service="+this.service+"&version="+this.version+"&request=RasterExtractByRectangle&inputSourceName="+e+"&inputRasterName="+t+"&outputSourceName="+r+"&outPutRasterName="+u+"&extent="+l;null!=n&&(c+="&inputPath="+n),null!=s&&(c+="&outputPath="+s),$.ajax({type:"get",url:this.server,data:encodeURI(c),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=o.parseRasterExtractByRectangle(e);null!=a&&a(n)},complete:function(e,t){},error:function(){}})},parseRasterExtractByRectangle:function(e){var t=$(e).find("RasterExtractByRectangle").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},rasterSepiaTone:function(e,t,n,r,u,s,i){if(null==e||null==t||null==r||null==s)return void(null!=i&&i("params is invalid"));var a=this,o="service="+this.service+"&version="+this.version+"&request=RasterSepiaTone&inputSourceName="+e+"&inputRasterName="+t+"&outputSourceName="+r+"&outPutRasterName="+u;null!=n&&(o+="&inputPath="+n),null!=s&&(o+="&outputPath="+s),$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.parseRasterSepiaTone(e);null!=i&&i(n)},complete:function(e,t){},error:function(){}})},parseRasterSepiaTone:function(e){var t=$(e).find("RasterSepiaTone").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},getArea:function(e,t,n,r,u){if(null==e||null==t||null==n||null==r)return void(null!=u&&u("params is invalid"));var s=this,i="service="+this.service+"&version="+this.version+"&request=GetArea&inputSourceName="+e+"&inputTypeName="+t+"&outputSourceName="+n+"&outputTypeName="+r;$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=s.praseGetArea(e);null!=u&&u(n)},complete:function(e,t){},error:function(){}})},praseGetArea:function(e){var t=$(e).find("GetArea").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},getLength:function(e,t,n,r,u){if(null==e||null==e||null==n||null==r)return void(null!=u&&u("params is invalid"));var s=this,i="service="+this.service+"&version="+this.version+"&request=GetLength&inputSourceName="+e+"&inputTypeName="+t+"&outputSourceName="+n+"&outputTypeName="+r;$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=s.praseGetLength(e);null!=u&&u(n)},complete:function(e,t){},error:function(){}})},praseGetLength:function(e){var t=$(e).find("GetLength").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},getBuffer:function(e,t,n,r,u,s,i){if(null==e||null==t||null==u||null==s)return void(null!=i&&i("params is invalid"));var a=this,o="service="+this.service+"&version="+this.version+"&request=Buffer&inputSourceName="+e+"&inputTypeName="+t+"&outputSourceName="+u+"&outputTypeName="+s;null!=n&&(o+="&distance="+n),null!=r&&(o+="&distanceField="+r),$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.praseGetBuffer(e);null!=i&&i(n)},complete:function(e,t){},error:function(){}})},praseGetBuffer:function(e){var t=$(e).find("Buffer").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},getCentroid:function(e,t,n,r,u){if(null==e||null==e||null==n||null==r)return void(null!=u&&u("params is invalid"));var s=this,i="service="+this.service+"&version="+this.version+"&request=Centroid&inputSourceName="+e+"&inputTypeName="+t+"&outputSourceName="+n+"&outputTypeName="+r;$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=s.praseGetCentroid(e);null!=u&&u(n)},complete:function(e,t){},error:function(){}})},praseGetCentroid:function(e){var t=$(e).find("Centroid").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},convexHull:function(e,t,n,r,u){if(null==e||null==e||null==n||null==r)return void(null!=u&&u("params is invalid"));var s=this,i="service="+this.service+"&version="+this.version+"&request=ConvexHull&inputSourceName="+e+"&inputTypeName="+t+"&outputSourceName="+n+"&outputTypeName="+r;$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=s.praseConvexHull(e);null!=u&&u(n)},complete:function(e,t){},error:function(){}})},praseConvexHull:function(e){var t=$(e).find("ConvexHull").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},buildPyramid:function(e,t,n,r,u,s){if(null==e||null==t||null==n||null==r||null==u)return void(null!=s&&s("params is invalid"));var i=this,a="service="+this.service+"&version="+this.version+"&request=BuildPyramid&mapName="+e+"&sourceName="+t+"&tileStore="+n+"&start="+r+"&end="+u;$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=i.praseBuildPyramid(e);null!=s&&s(n)},complete:function(e,t){},error:function(e,t,n){s(n)}})},praseBuildPyramid:function(e){var t=$(e).find("BuildPyramid").text();return"SUCCESS"==t.toUpperCase()?result="success":""!=$(e).find("ExceptionText").text()&&(result=$(e).find("ExceptionText").text()),result},updateTile:function(e,t,n,r,u,s,i){if(null==e||null==t||null==n||null==r||null==u||null==s)return void(null!=i&&i("params is invalid"));var a=this,o="service="+this.service+"&version="+this.version+"&request=updateTile&mapName="+e+"&sourceName="+t+"&tileStore="+n+"&level="+r+"&row="+u+"&col="+s;$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.parseUpdateTile(e);null!=i&&i(n)},complete:function(e,t){},error:function(){}})},parseUpdateTile:function(e){var t=$(e).find("UpdateTile").text();return"SUCCESS"==t.toUpperCase()?result="success":""!=$(e).find("ExceptionText").text()&&(result=$(e).find("ExceptionText").text()),result},rasterHisEqual:function(e,t,n,r,u,s,i){if(null==e||null==t||null==r||null==s)return void(null!=i&&i("params is invalid"));var a=this,o="service="+this.service+"&version="+this.version+"&request=RasterHistogramEqualization&inputSourceName="+e+"&inputRasterName="+t+"&outputSourceName="+r+"&outPutRasterName="+u;null!=n&&(o+="&inputPath="+n),null!=s&&(o+="&outputPath="+s),$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.parseRasterHisEqual(e);null!=i&&i(n)},complete:function(e,t){},error:function(){}})},parseRasterHisEqual:function(e){var t=$(e).find("RasterHistogramEqualization").text();return"SUCCESS"==t.toUpperCase()?result="success":""!=$(e).find("ExceptionText").text()&&(result=$(e).find("ExceptionText").text()),result},demSlope:function(e,t,n,r,u,s,i){if(null==e||null==t||null==r||null==s)return void(null!=i&&i("params is invalid"));var a=this,o="service="+this.service+"&version="+this.version+"&request=DemSlope&inputSourceName="+e+"&inputRasterName="+t+"&outputSourceName="+r+"&outPutRasterName="+u;null!=n&&(o+="&inputPath="+n),null!=s&&(o+="&outputPath="+s),$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.parseDemSlope(e);null!=i&&i(n)},complete:function(e,t){},error:function(){}})},parseDemSlope:function(e){var t=$(e).find("DemSlope").text();return"SUCCESS"==t.toUpperCase()?result="success":""!=$(e).find("ExceptionText").text()&&(result=$(e).find("ExceptionText").text()),result},demAspect:function(e,t,n,r,u,s,i){if(null==e||null==t||null==r||null==s)return void(null!=i&&i("params is invalid"));var a=this,o="service="+this.service+"&version="+this.version+"&request=DemAspect&inputSourceName="+e+"&inputRasterName="+t+"&outputSourceName="+r+"&outPutRasterName="+u;null!=n&&(o+="&inputPath="+n),null!=s&&(o+="&outputPath="+s),$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.parseDemAspect(e);null!=i&&i(n)},complete:function(e,t){},error:function(){}})},parseDemAspect:function(e){var t=$(e).find("DemAspect").text();return"SUCCESS"==t.toUpperCase()?result="success":""!=$(e).find("ExceptionText").text()&&(result=$(e).find("ExceptionText").text()),result},demStretch:function(e,t,n,r,u,s,i){if(null==e||null==t||null==r||null==u)return void(null!=i&&i("params is invalid"));var a=this,o="service="+this.service+"&version="+this.version+"&request=DemStretch&inputSourceName="+e+"&inputRasterName="+t+"&outputSourceName="+r+"&outPutRasterName="+u;null!=n&&(o+="&inputPath="+n),null!=s&&(o+="&outputPath="+s),$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.parseDemStretch(e);null!=i&&i(n)},complete:function(e,t){},error:function(){}})},parseDemStretch:function(e){var t=$(e).find("DemStretch").text();return"SUCCESS"==t.toUpperCase()?result="success":""!=$(e).find("ExceptionText").text()&&(result=$(e).find("ExceptionText").text()),result},demHillshade:function(e,t,n,r,u,s,i,a,o,l){if(null==e||null==t||null==r||null==u||null==i||null==a||null==o)return void(null!=l&&l("params is invalid"));var c=this,p="service="+this.service+"&version="+this.version+"&request=DemHillshade&inputSourceName="+e+"&inputRasterName="+t+"&outputSourceName="+r+"&outPutRasterName="+u+"&Azimuth="+i+"&zenith="+a+"&zfactor="+o;null!=n&&(p+="&inputPath="+n),null!=s&&(p+="&outputPath="+s),$.ajax({type:"get",url:this.server,data:encodeURI(p),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=c.parseDemHillshade(e);null!=l&&l(n)},complete:function(e,t){},error:function(){}})},parseDemHillshade:function(e){var t=$(e).find("DemHillshade").text();return"SUCCESS"==t.toUpperCase()?result="success":""!=$(e).find("ExceptionText").text()&&(result=$(e).find("ExceptionText").text()),result},delaunay:function(e,t,n,r,u,s){if(null==e||null==t||null==r||null==u)return void(null!=s&&s("params is invalid"));var i=this,a="service="+this.service+"&version="+this.version+"&request=Delaunay&inputSourceName="+e+"&inputTypeName="+t+"&outputSourceName="+r+"&outputTypeName="+u;null!=n&&(a+="&inputZField="+n),$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=i.praseDelaunay(e);null!=s&&s(n)},complete:function(e,t){},error:function(){}})},praseDelaunay:function(e){var t=$(e).find("Delaunay").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},rasterThreshold:function(e,t,n,r,u,s,i){if(null==e||null==t||null==r||null==s)return void(null!=i&&i("params is invalid"));var a=this,o="service="+this.service+"&version="+this.version+"&request=rasterThreshold&inputSourceName="+e+"&inputRasterName="+t+"&outputSourceName="+r+"&outPutRasterName="+u;null!=n&&(o+="&inputPath="+n),null!=s&&(o+="&outputPath="+s),$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.parseRasterThreshold(e);null!=i&&i(n)},complete:function(e,t){},error:function(){}})},parseRasterThreshold:function(e){var t=$(e).find("RasterThreshold").text();return"SUCCESS"==t.toUpperCase()?result="success":""!=$(e).find("ExceptionText").text()&&(result=$(e).find("ExceptionText").text()),result},lineToPoints:function(e,t,n,r,u){if(null==e||null==t||null==n||null==r)return void(null!=u&&u("params is invalid"));var s=this,i="service="+this.service+"&version="+this.version+"&request=LineToPoints&inputSourceName="+e+"&inputTypeName="+t+"&outputSourceName="+n+"&outputTypeName="+r;$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=s.praseLineToPoints(e);null!=u&&u(n)},complete:function(e,t){},error:function(){}})},praseLineToPoints:function(e){var t=$(e).find("LineToPoints").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},multiPointToPoints:function(e,t,n,r,u){if(null==e||null==t||null==n||null==r)return void(null!=u&&u("params is invalid"));var s=this,i="service="+this.service+"&version="+this.version+"&request=MultiPointToPoints&inputSourceName="+e+"&inputTypeName="+t+"&outputSourceName="+n+"&outputTypeName="+r;$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=s.praseMultiPointToPoints(e);null!=u&&u(n)},complete:function(e,t){},error:function(){}})},praseMultiPointToPoints:function(e){var t=$(e).find("MultiPointToPoints").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},polygonToPoints:function(e,t,n,r,u){if(null==e||null==t||null==n||null==r)return void(null!=u&&u("params is invalid"));var s=this,i="service="+this.service+"&version="+this.version+"&request=PolygonToPoints&inputSourceName="+e+"&inputTypeName="+t+"&outputSourceName="+n+"&outputTypeName="+r;$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=s.prasePolygonToPoints(e);null!=u&&u(n)},complete:function(e,t){},error:function(){}})},prasePolygonToPoints:function(e){var t=$(e).find("PolygonToPoints").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},polygonToLine:function(e,t,n,r,u){if(null==e||null==t||null==n||null==r)return void(null!=u&&u("params is invalid"));var s=this,i="service="+this.service+"&version="+this.version+"&request=PolygonToLine&inputSourceName="+e+"&inputTypeName="+t+"&outputSourceName="+n+"&outputTypeName="+r;$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=s.prasePolygonToLine(e);null!=u&&u(n)},complete:function(e,t){},error:function(){}})},prasePolygonToLine:function(e){var t=$(e).find("PolygonToLine").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},generateRandomPoints:function(e,t,n,r,u,s){if(null==e||null==t||null==n||null==r||null==u)return void(null!=s&&s("params is invalid"));var i=this,a="service="+this.service+"&version="+this.version+"&request=GenerateRandomPoints&sourceName="+e+"&typeName="+t+"&extent="+n.toString()+"&srid="+r+"&count="+u;$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=i.praseGenerateRandomPoints(e);null!=s&&s(n)},complete:function(e,t){},error:function(){}})},praseGenerateRandomPoints:function(e){var t=$(e).find("GenerateRandomPoints").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},generateRandomPointsInPolygon:function(e,t,n,r,u,s){if(null==e||null==t||null==n||null==r||null==u)return void(null!=s&&s("params is invalid"));var i=this,a="service="+this.service+"&version="+this.version+"&request=GenerateRandomPointsInPolygon&inputSourceName="+e+"&inputTypeName="+t+"&outputSourceName="+n+"&outputTypeName="+r+"&count="+u;$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=i.praseGenerateRandomPointsInPolygon(e);null!=s&&s(n)},complete:function(e,t){},error:function(){}})},praseGenerateRandomPointsInPolygon:function(e){var t=$(e).find("GenerateRandomPointsInPolygon").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n},getJob:function(e,t,n,r){if(null==e)return void(null!=r&&r("state is null"));var u=this,s="service="+this.service+"&version="+this.version+"&request=GetJob&state="+e;null!=t&&(s+="&maxJobs="+t),null!=n&&(s+="&offset="+n),$.ajax({type:"get",url:this.server,data:encodeURI(s),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=u.praseGetJob(e);null!=r&&r(n)},complete:function(e,t){},error:function(){}})},praseGetJob:function(e){var t=[],n=this;return $(e).find("Job").each(function(){var e=n.parseJob(this);null!=e&&t.push(e)}),t},parseJob:function(e){var t=$(e).find("UUID").text();if(null==t)return null;var n=$(e).find("Operation").text(),r=$(e).find("Params").text(),u=$(e).find("Client").text(),s=$(e).find("Server").text(),i=$(e).find("StartTime").text(),a=$(e).find("EndTime").text(),o=new GeoBeans.Job(t,n,r,u,s,i,a,status);return o},csvImport:function(e,t,n,r,u,s){if(null==e||null==t||null==n||null==r)return void(null!=s&&s("params is valid"));var i=this,a="service="+this.service+"&version="+this.version+"&request=CsvImport&sourceName="+e+"&typeName="+t+"&csvPath="+n+"&csvName="+r;null!=u&&(a+="&srid="+u),$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=i.praseCsvImport(e);null!=s&&s(n)},complete:function(e,t){},error:function(){}})},praseCsvImport:function(e){var t=$(e).find("CsvImport").text();if("success"==t.toLowerCase())return"success";var n=$(e).find("ExceptionText").text();return n}});
GeoBeans.Job=GeoBeans.Class({uuid:null,oper:null,params:null,client:null,server:null,startTime:null,endTime:null,status:null,initialize:function(s,e,i,n,t,l,u,a){this.uuid=s,this.oper=e,this.params=i,this.client=n,this.server=t,this.startTime=l,this.endTime=u,this.status=a}}),GeoBeans.Job.Status={CANCELED:"Canceled",RUNNING:"Running",FINISHED:"Finished"};
GeoBeans.SpatialReference=GeoBeans.Class({srid:null,srtext:null,proj:null,initialize:function(e,i,s){this.srid=e,this.srtext=i,this.proj=s}});
GeoBeans.PointLabel=GeoBeans.Class(GeoBeans.Label,{pos:null,extent:null,initialize:function(){this.pos=new GeoBeans.Geometry.Point(0,0)},computePosition:function(t,e){var i=this.geometry.getCentroid(),s=e.toScreenPoint(i.x,i.y);this.pos.x=s.x,this.pos.y=s.y;var n=this.textSymbolizer.font.size;this.extent=t.getTextExtent(this.text,parseInt(n)),this.pos.x+=this.textSymbolizer.displaceX,this.pos.y+=this.textSymbolizer.displaceY,this.pos.x-=this.extent.getWidth()*this.textSymbolizer.anchorX,this.pos.y+=this.extent.getHeight()*this.textSymbolizer.anchorY,this.extent.offset(this.pos.x,this.pos.y)},adjustPosition:function(t,e){var i=0,s=0;null!=this.extent&&(this.extent.xmin<0?i=-this.extent.xmin:this.extent.xmax>t&&(i=t-this.extent.xmax-2),this.extent.ymin<0?s=-this.extent.ymin:this.extent.ymax>e&&(s=e-this.extent-2),this.extent.offset(i,s),this.pos+=i,this.pos+=s)},isCollision:function(t){if(null==t)return!1;t.extent;return this.extent.intersects(oterhExtent)}});
GeoBeans.Layer.DBLayer=GeoBeans.Class(GeoBeans.Layer,{id:null,dbName:null,typeName:null,queryable:null,type:null,format:"image/png",transparent:"true",image:null,updateFlag:!1,initialize:function(e,a,t,i,s,r){GeoBeans.Layer.prototype.initialize.apply(this,arguments),this.id=a,this.dbName=t,this.typeName=i,this.queryable=s,this.visible=r,this.image=new Image},cleanup:function(){},setMap:function(){GeoBeans.Layer.prototype.setMap.apply(this,arguments)},load:function(){var e=this.map.canvas.width,a=this.map.canvas.height,t=this.map.viewer,i=t.xmin.toFixed(6)+","+t.ymin.toFixed(6)+","+t.xmax.toFixed(6)+","+t.ymax.toFixed(6),s="",r="",l=this.name;if(null!=this.styleName&&(r=this.styleName),null!=l&&this.visible){var n=this.map.mapWorkspace.version;s=this.map.server+"?service=WMS&version="+n+"&request=GetMap&layers="+l+"&styles="+r+"&bbox="+i+"&width="+e+"&height="+a+"&srs="+this.srid+"&format="+this.format+"&transparent="+this.transparent+"&mapName="+this.map.name}if(this.renderer.clearRect(0,0,e,a),this.updateFlag){var h=new Date;this.image.src=s+"&t="+h.getTime(),this.updateFlag=!1}else this.image.src=s;var m=this.heatMapLayer;if(null!=m&&m.load(),this.image.complete){this.updateFlag=!1,this.flag=GeoBeans.Layer.Flag.LOADED,this.renderer.drawImage(this.image,0,0,e,a);var o=this.image.src.lastIndexOf("&t=");o!=-1&&(this.image.src=this.image.src.slice(0,o))}else{var p=this;p.flag=GeoBeans.Layer.Flag.READY,this.image.onload=function(){p.flag!=GeoBeans.Layer.Flag.LOADED&&(p.flag=GeoBeans.Layer.Flag.LOADED,p.renderer.drawImage(p.image,0,0,e,a),p.map.drawLayersAll())},this.image.onerror=function(){p.flag=GeoBeans.Layer.Flag.LOADED,p.map.drawLayersAll()}}},update:function(){this.updateFlag=!0}}),GeoBeans.Layer.DBLayer.Type={Raster:"raster",Feature:"feature"};
GeoBeans.Layer.FeatureDBLayer=GeoBeans.Class(GeoBeans.Layer.DBLayer,{styleName:null,geomType:null,featureLayer:null,initialize:function(e,t,a,r,l,n,i){GeoBeans.Layer.DBLayer.prototype.initialize.apply(this,arguments),void 0!=i&&(this.styleName=i),this.type=GeoBeans.Layer.DBLayer.Type.Feature},setMap:function(e){GeoBeans.Layer.prototype.setMap.apply(this,arguments);var t=new GeoBeans.Layer.FeatureLayer("tmp");t.setMap(e),this.featureLayer=t,this.featureLayer.renderer.context.globalCompositeOperation="lighter"},setStyle:function(e){null!=e&&(this.style=e,this.styleName=e.name)},getFeatureType:function(){if(null!=this.featureType)return this.featureType;if(null!=this.map){var e=new GeoBeans.WFSWorkspace("tmp",this.map.server,"1.0.0");return this.featureType=new GeoBeans.FeatureType(e,this.name),null==this.featureType.fields&&(this.featureType.fields=this.featureType.getFields(this.map.name,null)),this.featureType}return null},getFeatureBBoxGet:function(e,t,a){var r=this.getFeatureType(),l=null;return null!=r&&(l=r.getFeatureBBoxGet(this.map.name,null,e,t,a)),l},getFeautureBBoxGetOutput:function(e,t,a){var r=null,l=this.getFeatureType();return null!=l&&(r=l.getFeatureBBoxGetOutput(this.map.name,null,e,t,a)),r},getFeatureCount:function(e,t){var a=this.getFeatureType();if(null!=a){var r=a.getCount(this.map.name,null,e);if(null==t)return r;t(this,r)}else{if(null==t)return 0;t(0)}},getFields:function(){var e=this.getFeatureType(),t=null;return null!=e&&(t=e.getFields(this.map.name,null)),t},getHeatMapLayer:function(){return this.heatMapLayer},addHeatMap:function(e,t,a){if(null!=e||null!=t){var r=this.getFeatureType(),l=r.getFieldIndex(e);if(!(l<0&&null==t)){if(l<0&&null!=t)return this.heatMapLayer=new GeoBeans.Layer.HeatMapLayer(this.name+"-heatMap",a),this.heatMapLayer.setMap(this.map),void this.heatMapLayer.setLayer(this,null,t);this.heatMapLayer=new GeoBeans.Layer.HeatMapLayer(this.name+"-heatMap",a),this.heatMapLayer.setMap(this.map),this.heatMapLayer.setLayer(this,e,null)}}},removeHeatMap:function(){null!=this.heatMapLayer&&(this.heatMapLayer.destory(),this.heatMapLayer=null)},setHeatMapVisible:function(e){null!=this.heatMapLayer&&(this.heatMapLayer.visible=e)},getFeaturesWithin:function(e){var t=null,a=this.getFeatureType();return null!=a&&(t=a.getFeaturesWithin(this.map.name,null,e)),t},getFeatureFilter:function(e,t,a,r){var l=this.getFeatureType();return null!=l&&(features=l.getFeaturesFilter(this.map.name,null,e,t,a,r)),features},getFeatureFilterCount:function(e){var t=0,a=this.getFeatureType();return null!=a&&(t=a.getFeatureFilterCount(this.map.name,null,e)),t},getFeatureFilterCountAsync:function(e,t){var a=this.getFeatureType();null!=a?a.getFeatureFilterCountAsync(this.map.name,null,e,this,t):null!=t&&t(0)},getFeatureFilterOutput:function(e,t,a){var r=null,l=this.getFeatureType();return null!=l&&(r=l.getFeatureFilterOutput(this.map.name,null,e,t,a)),r},getFeatures:function(e,t,a){var r=this.getFeatureType();return null==r?void(null!=a&&a(null)):void r.getFeaturesFilterAsync2(this.map.name,null,null,null,null,e,null,t,a)},loadLocal:function(){var e=this.map.viewer;if(null!=e&&null!=this.viewer&&e.equal(this.viewer)&&null!=this.features&&null!=this.style&&this.flag==GeoBeans.Layer.Flag.LOADED)return this.renderer.clearRect(),void this.renderer.drawImage(this.featureLayer.canvas,0,0,this.map.width,this.map.height);if(null==this.xhr&&(this.features=[],this.viewer=new GeoBeans.Envelope(e.xmin,e.ymin,e.xmax,e.ymax),null==this.featureType&&(this.featureType=this.getFeatureType()),null!=this.featureType)){var t=this;t.flag=GeoBeans.Layer.Flag.READY;var a=new GeoBeans.BBoxFilter;a.extent=this.viewer,a.propName=this.featureType.geomFieldName;var r=[this.featureType.geomFieldName],l=this.featureType.getFeaturesFilterAsync2(this.map.name,null,a,null,null,r,null,this,this.getFeatures_callback);this.xhr=l}},getFeatures_callback:function(e,t){null!=e&&null!=t&&(e.setTransformation(e.map.transformation),e.features=t,e.featureLayer.features=t,e.renderer.clearRect(),e.featureLayer.renderer.clearRect(),e.getStyle())},drawLayer:function(){this.xhr=null;var e=this.style,t=this.features;if(null!=e&&null!=t&&(rules=e.rules,0!=rules.length)){for(var a=(new Date,0);a<rules.length;a++){var r=rules[a],t=this.featureLayer.selectFeaturesByFilter(r.filter);null!=r.symbolizer&&(null!=r.symbolizer.icon_url||this.featureLayer.drawFeatures(t,r.symbolizer)),null!=r.textSymbolizer&&this.featureLayer.labelFeatures(t,r.textSymbolizer)}this.renderer.drawImage(this.featureLayer.canvas,0,0,this.map.width,this.map.height),this.flag=GeoBeans.Layer.Flag.LOADED,this.map.drawLayersAll()}},getStyle:function(){if(null!=this.style)return void this.drawLayer();if(null==this.styleName||""==this.styleName){this.featureLayer.featureType=this.getFeatureType();var e=this.featureLayer.getDefaultStyle();return null!=e?(this.style=e,void this.drawLayer()):void(this.flag=GeoBeans.Layer.Flag.ERROR)}var t=this.map.server;t=t.replace("/mgr","");var a=new GeoBeans.StyleManager(t);a.getStyleXML(this.styleName,this.getStyle_callback,this)},getStyle_callback:function(e,t){null!=e&&null!=t&&(t.style=e,t.drawLayer())}});
GeoBeans.Layer.FeatureLayer=GeoBeans.Class(GeoBeans.Layer,{features:null,style:null,geometryType:null,featureType:null,enableHit:!1,selection:null,unselection:null,hitControl:null,hitEvent:null,hitTooltipEvent:null,hitCanvas:null,hitRenderer:null,bufferCanvas:null,bufferRenderer:null,bufferFeatures:null,bufferSymbolizer:null,bufferTracker:null,initialize:function(e){GeoBeans.Layer.prototype.initialize.apply(this,arguments),this.featureType=null,this.features=[],this.selection=[],this.unselection=[]},destory:function(){this.features=null,this.style=null,this.renderer=null,this.geometryType=null,this.featureType=null,GeoBeans.Layer.prototype.destroy.apply(this,arguments)},addFeature:function(e){null!=e&&this.features.push(e)},addFeatures:function(e){if(null!=e&&e instanceof Array)for(var t=0,r=e.length;t<r;t++){var a=e[t];this.features.push(a)}},getFeature:function(e){return e<0?null:e>=this.features.length?null:this.features[e]},getFeatureByID:function(e){if(null==this.features)return null;for(var t=null,r=0;r<this.features.length;++r)if(t=this.features[r],null!=t&&t.fid==e)return t;return null},setStyle:function(e){this.style=e},count:function(){return this.features.length},draw:function(){var e=this.style;if(null!=e&&(rules=e.rules,0!=rules.length))for(var t=0;t<rules.length;t++){var r=rules[t],a=this.selectFeatures(r.filter);this.drawFeatures(a,r.symbolizer)}},drawLayer:function(){var e=this.style;if(null==e){if(e=this.getDefaultStyle(),null==e)return;this.style=e}if(rules=e.rules,0!=rules.length)for(var t=0;t<rules.length;t++){var r=rules[t],a=this.selectFeaturesByFilter(r.filter);null!=r.symbolizer&&(null!=r.symbolizer.symbol?this.renderer.drawIcons(a,r.symbolizer,this.map.transformation):this.drawFeatures(a,r.symbolizer)),null!=r.textSymbolizer&&this.labelFeatures(a,r.textSymbolizer)}},getGeomType:function(){var e=this.featureType;if(null==e)return null;var t=e.geomFieldName;if(null==t)return null;var r=e.getFieldIndex(t);if(null==r)return null;var a=e.fields[r];if(null==a)return null;var n=a.geomType;return n},getDefaultStyle:function(){var e=this.getGeomType(),t=null;switch(e){case GeoBeans.Geometry.Type.POINT:case GeoBeans.Geometry.Type.MULTIPOINT:t=new GeoBeans.Style.FeatureStyle("default",GeoBeans.Style.FeatureStyle.GeomType.Point);var r=new GeoBeans.Rule,a=new GeoBeans.Symbolizer.PointSymbolizer;r.symbolizer=a,t.addRule(r);break;case GeoBeans.Geometry.Type.LINESTRING:case GeoBeans.Geometry.Type.MULTILINESTRING:t=new GeoBeans.Style.FeatureStyle("default",GeoBeans.Style.FeatureStyle.GeomType.LineString);var r=new GeoBeans.Rule,a=new GeoBeans.Symbolizer.LineSymbolizer;r.symbolizer=a,t.addRule(r);break;case GeoBeans.Geometry.Type.POLYGON:case GeoBeans.Geometry.Type.MULTIPOLYGON:t=new GeoBeans.Style.FeatureStyle("default",GeoBeans.Style.FeatureStyle.GeomType.Polygon);var r=new GeoBeans.Rule,a=new GeoBeans.Symbolizer.PolygonSymbolizer;r.symbolizer=a,t.addRule(r)}return t},drawFeatures:function(e,t){if(0!=e.length){this.renderer.save(),this.renderer.setSymbolizer(t);for(var r=0,a=e.length;r<a;r++)feature=e[r],null!=t&&"undefined"!=t&&this.renderer.draw(feature,t,this.map.transformation);this.renderer.restore()}},labelFeatures:function(e,t){var r=e.length;if(0!=r){this.renderer.save(),this.renderer.setSymbolizer(t);var a=e[0],n=null,s=t.labelText;if(null==s||0==s.length){var i=t.labelProp;if(null!=i)var l=a.featureType.getFieldIndex(i)}else n=s;for(var u=null,o=null,h=null,f=0,r=e.length;f<r;f++)a=e[f],o=a.geometry,null!=o&&(h=new GeoBeans.PointLabel,h.geometry=o,h.textSymbolizer=t,u=null==n?a.values[l]:n,h.text=u,h.computePosition(this.renderer,this.map.transformation),this.renderer.drawLabel(h));this.renderer.restore()}},drawFeature:function(e,t){for(var r=this.selectRules(e),a=r.length,n=0;n<a;n++){var s=r[n];if(null!=t&&"undefined"!=t||(t=s.symbolizer),this.map.renderer.save(),this.map.renderer.setSymbolizer(t),t instanceof GeoBeans.Symbolizer.TextSymbolizer){var i=e.featureType.getFieldIndex(t.field);this.map.renderer.label(e.geometry,e.values[i],t,this.map.transformation)}else this.map.renderer.draw(e,t,this.map.transformation);this.map.renderer.restore()}r=null},clearFeature:function(e){switch(e.geometry.type){case GeoBeans.Geometry.Type.POINT:case GeoBeans.Geometry.Type.MULTIPOINT:var t=this.getSymbolizer(e);this.map.renderer.clear(e.geometry,this.map.bgColor,t.size,this.map.transformation);break;default:this.map.renderer.clear(e.geometry,this.map.bgColor,0,this.map.transformation)}},selectFeatures:function(e){if(null==e)return this.features;var t=e.type;if(t==GeoBeans.Filter.Type.FilterComparsion){var r=null,a=null,n=e.expression1;null!=n&&(n.type==GeoBeans.Expression.Type.PropertyName?r=n.name:n.type==GeoBeans.Expression.Type.Literal&&(a=n.value));var s=e.expression2;null!=s&&(s.type==GeoBeans.Expression.Type.PropertyName?r=s.name:s.type==GeoBeans.Expression.Type.Literal&&(a=s.value))}if(null==r||null==a)return this.features;var i=[],l=this.featureType.getFieldIndex(r);if(l>=0)for(var u=null,o=this.features.length,h=0;h<o;++h)u=this.features[h],fvalue=u.values[l],fvalue==a&&i.push(u);return i},selectFeaturesByFilter:function(e){if(null==e)return this.features;var t=e.type,r=this.features;switch(t){case GeoBeans.Filter.Type.FilterID:r=this.selectFeaturesByIDFilter(e);break;case GeoBeans.Filter.Type.FilterComparsion:r=this.selectFeaturesByComparsion(e);break;case GeoBeans.Filter.Type.FilterLogic:break;case GeoBeans.Filter.Type.FilterSpatial:}return r},selectFeaturesByIDFilter:function(e){if(null==e)return this.features;var t=e.ids;if(null==t)return this.features;for(var r=[],a=0;a<this.features.length;++a){var n=this.features[a],s=n.fid;t.indexOf(s)!=-1&&r.push(n)}return r},selectFeaturesByComparsion:function(e){if(null==e)return this.features;var t=e.operator;if(t==GeoBeans.ComparisionFilter.OperatorType.ComOprEqual){var r=null,a=null,n=e.expression1;null!=n&&(n.type==GeoBeans.Expression.Type.PropertyName?r=n.name:n.type==GeoBeans.Expression.Type.Literal&&(a=n.value));var s=e.expression2;if(null!=s&&(s.type==GeoBeans.Expression.Type.PropertyName?r=s.name:s.type==GeoBeans.Expression.Type.Literal&&(a=s.value)),null==r||null==a)return this.features;var i=[],l=this.featureType.getFieldIndex(r);if(l>=0)for(var u=null,o=this.features.length,h=0;h<o;++h)u=this.features[h],fvalue=u.values[l],fvalue==a&&i.push(u);return i}return this.features},selectRules:function(e){var t=[];if(null!=this.style)for(var r=this.style.rules.length,a=0;a<r;a++){var n=this.style.rules[a];if(null!=n.filter){var s=n.filter.field,i=null,l=this.featureType.getFieldIndex(s);i=e.values[l],i==n.filter.value&&t.push(n)}else t.push(n)}return t},getSymbolizer:function(e){for(var t=this.selectRules(e),r=t.length,a=0;a<r;a++){var n=t[a],s=n.symbolizer;if(!(s instanceof GeoBeans.Style.TextSymbolizer))return s}return null},setHitControl:function(e){null!=e&&"undefined"!=e&&(this.hitControl=null,this.hitControl=e)},init:function(){},enableHit:function(e){this.enableHit=e},hit:function(e,t,r){if(null!=this.features){this.map.renderer,this.map.transformation;this.selection=[];var a=0,n=null,s=null,i=this.features.length;for(a=0;a<i;a++)n=this.features[a],s=n.geometry,null!=s&&s.hit(e,t,this.map.tolerance)&&this.selection.push(n);if(this.hitRenderer.clearRect(0,0,this.hitCanvas.height,this.hitCanvas.width),this.map.drawLayersAll(),void 0!=r){var l=new GeoBeans.Geometry.Point(e,t);r(this,this.selection,l)}}},registerHitEvent:function(e){var t=this.map,r=this,a=null,n=null,s=10;this.hitCanvas=document.createElement("canvas"),this.hitCanvas.width=this.canvas.width,this.hitCanvas.height=this.canvas.height,this.hitRenderer=new GeoBeans.Renderer(this.hitCanvas),this.hitEvent=function(i){if(null==a)a=i.layerX,n=i.layerY;else{var l=Math.abs(i.layerX-a)+Math.abs(i.layerY-n);if(l>s){a=i.layerX,n=i.layerY;var u=t.transformation.toMapPoint(i.layerX,i.layerY);r.hit(u.x,u.y,e)}}},t.mapDiv[0].addEventListener("mousemove",this.hitEvent),this.events.addEvent("mousemove",this.hitEvent)},unRegisterHitEvent:function(){this.map.mapDiv[0].removeEventListener("mousemove",this.hitEvent),this.hitRenderer.clearRect(0,0,this.hitCanvas.height,this.hitCanvas.width),this.map.drawLayersAll(),this.hitEvent=null},drawHitFeature:function(e,t){for(var r=this.selectRules(e),a=r.length,n=0;n<a;n++){var s=r[n];if(null!=t&&"undefined"!=t||(t=s.symbolizer),this.hitRenderer.save(),this.hitRenderer.setSymbolizer(t),t instanceof GeoBeans.Symbolizer.TextSymbolizer){var i=e.featureType.getFieldIndex(t.field);this.hitRenderer.label(e.geometry,e.values[i],t,this.map.transformation)}else this.hitRenderer.draw(e,t,this.map.transformation);this.hitRenderer.restore()}r=null,this.map.drawHitLayer()},cleanup:function(){this.enableHit=!1,this.map.canvas.removeEventListener("mousemove",this.hitEvent),this.map.canvas.removeEventListener("mousemove",this.hitTooltipEvent)},registerHitTooltipEvent:function(e){var t=this.map,r=this,a=null,n=null,s=10;this.hitTooltipEvent=function(t){if(null==a)a=t.layerX,n=t.layerY;else{var i=Math.abs(t.layerX-a)+Math.abs(t.layerY-n);i>s&&(a=t.layerX,n=t.layerY,r.hitTooltip(t.layerX,t.layerY,e))}},t.canvas.addEventListener("mousemove",this.hitTooltipEvent)},unregisterHitTooltipEvent:function(){this.map.canvas.removeEventListener("mousemove",this.hitTooltipEvent),this.hitTooltipEvent=null},hitTooltip:function(e,t,r){if(null!=this.features&&null!=r){var a=this.map,n=a.transformation.toMapPoint(e,t),s=n.x,i=n.y,l=(this.map.renderer,this.map.transformation,0),u=null,o=null,h=this.features.length;for(l=0;l<h;l++)if(u=this.features[l],o=u.geometry,null!=o&&o.hit(s,i,this.map.tolerance))return void r(this,e,t,u);r(this,e,t,null)}},getBufferTracker:function(){if(null==this.bufferTracker){var e=new GeoBeans.Control.TrackBufferControl,t=this.map.controls.find(e.type);t==-1?(this.bufferTracker=e,this.map.controls.add(this.bufferTracker)):this.bufferTracker=this.map.controls.get(t)}return this.bufferTracker},queryByBufferLine:function(e,t){var r=this.getBufferTracker();r.trackBufferLine(this,e,t,this.callbackQueryByBufferTrack)},queryByBufferCircle:function(e){var t=this.getBufferTracker();t.trackBufferCircle(this,e,this.callbackQueryByBufferTrack)},callbackQueryByBufferTrack:function(e,t,r,a){if(!(null==r||t<0)){var n=e.featureType;if(null!=n){var s=e.workspace;null!=s&&s.queryByBuffer(t,r,n,a)}}},drawBufferFeatures:function(e,t){this.bufferFeatures=e,this.bufferSymbolizer=t,this.drawBufferFeaturesCanvas(),this.map.drawLayersAll()},clearBufferFeatures:function(){this.bufferFeatures=null,this.drawBufferFeaturesCanvas(),this.map.drawLayersAll()},drawBufferFeaturesCanvas:function(){if(null==this.bufferCanvas&&(this.bufferCanvas=document.createElement("canvas"),this.bufferCanvas.width=this.canvas.width,this.bufferCanvas.height=this.canvas.height,this.bufferRenderer=new GeoBeans.Renderer(this.bufferCanvas)),this.bufferRenderer.clearRect(0,0,this.bufferCanvas.width,this.bufferCanvas.height),null!=this.bufferFeatures&&0!=this.bufferFeatures.length){this.bufferRenderer.save(),this.bufferRenderer.setSymbolizer(this.bufferSymbolizer);for(var e=0,t=this.bufferFeatures.length;e<t;e++)feature=this.bufferFeatures[e],null!=this.bufferSymbolizer&&"undefined"!=this.bufferSymbolizer&&this.bufferRenderer.draw(feature,this.bufferSymbolizer,this.map.transformation);this.bufferRenderer.restore()}},beginTransaction:function(e){var t=this.featureType.getFieldIndex(this.featureType.geomFieldName),r=this.featureType.fields[t],a=r.geomType,n=this.getTransactionTracker();switch(a){case GeoBeans.Geometry.Type.POINT:n.trackPoint(this.transactionCallback,e,this);break;case GeoBeans.Geometry.Type.LINESTRING:n.trackLine(this.transactionCallback,e,this,!1);break;case GeoBeans.Geometry.Type.MULTILINESTRING:n.trackLine(this.transactionCallback,e,this,!0);break;case GeoBeans.Geometry.Type.POLYGON:n.trackPolygon(this.transactionCallback,e,this,!1);break;case GeoBeans.Geometry.Type.MULTIPOLYGON:n.trackPolygon(this.transactionCallback,e,this,!0)}},transactionCallback:function(e,t,r){t(e,r)},transaction:function(e,t,r){this.workspace.transaction(this.featureType,e,t,r)},getTransactionTracker:function(){var e=null,t=this.map.controls.find(GeoBeans.Control.Type.TRACKTRANSACTION);return t==-1?(e=new GeoBeans.Control.TrackControl.TrackTransactionControl,this.map.controls.add(e)):e=this.map.controls.get(t),e},CLASS_NAME:"GeoBeans.Layer.FeatureLayer"});
GeoBeans.Layer.ChartLayer=GeoBeans.Class(GeoBeans.Layer.FeatureLayer,{baseLayerName:null,baseLayerField:null,dbName:null,tableName:null,tableField:null,chartFields:null,chartFeatureType:null,type:null,chartFeatures:null,initialize:function(e,t,a,i,r,n,s){GeoBeans.Layer.FeatureLayer.prototype.initialize.apply(this,arguments),this.baseLayerName=t,this.baseLayerField=a,this.dbName=i,this.tableName=r,this.tableField=n,this.chartFields=s},destroy:function(){this.cleanup()},cleanup:function(){this.removeLegend(),this.name=null,this.baseLayerName=null,this.baseLayerField=null,this.dbName=null,this.tableName=null,this.tableField=null,this.chartFields=null,this.map._removeLegend(this.legendIndex)},setFeatureType:function(e){this.featureType=e},setFeatures:function(e){this.features=e},setMap:function(e){GeoBeans.Layer.prototype.setMap.apply(this,arguments);var t=this.getChartFeatures();null!=t&&(this.chartFeatures=t);var a=this.getBaseLayerExtent();null!=a&&(this.extent=a)},getBaseLayerExtent:function(){var e=this.map.getLayer(this.baseLayerName);if(null!=e){var t=e.getExtent();return t}return null},getChartFeatures:function(){if(null==this.baseLayerName||null==this.baseLayerField||null==this.dbName||null==this.tableName||null==this.tableField)return null;var e=this.map.getLayer(this.baseLayerName);if(null==e)return null;var t=new GeoBeans.WFSWorkspace("tmp",this.map.server,"1.0.0"),a=new GeoBeans.FeatureType(t,this.tableName);this.chartFeatureType=a;var i=(a.getFields(null,this.dbName),a.getFeaturesFilter(null,this.dbName,null,null,null,[this.tableField].concat(this.chartFields))),r=a.getFieldIndex(this.tableField);if(r==-1)return null;var n=e.getFeatureType(),s=n.geomFieldName,l=null;l=this.type==GeoBeans.Layer.ChartLayer.Type.BAR||this.type==GeoBeans.Layer.ChartLayer.Type.PIE||this.type==GeoBeans.Layer.ChartLayer.Type.SYMBOL||this.type==GeoBeans.Layer.ChartLayer.Type.RING?[this.baseLayerField,s]:[this.baseLayerField];var h=n.getFeaturesFilter(this.map.name,null,null,null,null,l),u=(e.getFields(),n.getFieldIndex(this.baseLayerField));if(u==-1)return null;var d=this.getValidChartFeatures(i,r,h,u);return d},getValidChartFeatures:function(e,t,a,i){if(null==e||null==t||null==a||null==i)return null;for(var r=[],n=0;n<e.length;++n){var s=e[n];if(null!=s){var l=s.values;if(null!=l){var h=l[t];if(null!=h)for(var u=0;u<a.length;++u){var d=a[u];if(null!=d){var y=d.values;if(null!=y){var o=y[i];if(null!=o&&o==h){s.geometry=d.geometry,s.gid=d.fid,r.push(s);break}}}}}}}return r},setBaseLayer:function(e){this.baseLayerName=e,this.chartFeatures=this.getChartFeatures()},getBaseLayer:function(){return this.baseLayerName},setBaseLayerField:function(e){this.baseLayerField=e,this.chartFeatures=this.getChartFeatures()},getBaseLayerField:function(){return this.baseLayerField},setDbName:function(e){this.dbName=e,this.chartFeatures=this.getChartFeatures()},getDbName:function(){return this.dbName},setTableName:function(e){this.tableName=e,this.chartFeatures=this.getChartFeatures()},getTableName:function(){return this.tableName},setTableField:function(e){this.tableField=e,this.chartFeatures=this.getChartFeatures()},getTableField:function(){return this.tableField},setChartFields:function(e){this.chartFields=e,this.chartFeatures=this.getChartFeatures()},getChartFields:function(){return this.chartFields},setChartOption:function(e){this.chartOption=e},getChartOption:function(){return this.chartOption},addLegend:function(){},showLegend:function(){this.map.mapDiv.find(".chart-legend#"+this.name).css("display","block")},hideLegend:function(){this.map.mapDiv.find(".chart-legend#"+this.name).css("display","none")},removeLegend:function(){this.map.mapDiv.find(".chart-legend#"+this.name).remove()},setName:function(e){this.removeLegend(),this.name=e,this.addLegend()}}),GeoBeans.Layer.ChartLayer.Type={RANGE:"range",BAR:"bar",PIE:"pie",AQI:"aqi",AQITIMELINE:"aqi_timeline",SYMBOL:"symbol",RANGESYMBOL:"rangesymbol",RING:"ring"};
GeoBeans.Layer.GroupLayer=GeoBeans.Class(GeoBeans.Layer,{layers:null,server:null,image:null,format:"image/png",version:"1.1.0",srs:"EPSG:4326",transparent:"true",updateFlag:!1,initialize:function(e,a,s){GeoBeans.Layer.prototype.initialize.apply(this,arguments),this.server=e,this.name=a,this.layers=[],void 0!=s&&(this.format=s),this.image=new Image},addLayer:function(e){null!=e&&this.layers.push(e)},insertLayer:function(e){null!=e&&this.layers.unshift(e)},removeLayer:function(e){for(var a=null,s=0;s<this.layers.length;++s)if(a=this.layers[s],a==e)return this.layers.splice(s,1),void e.cleanup()},getLayers:function(){return this.layers},loadTotal:function(){if(null==this.map||null==this.map.canvas)return void(this.flag=GeoBeans.Layer.Flag.LOADED);for(var e,a=this.map.canvas.width,s=this.map.canvas.height,r=this.map.viewer,i=r.xmin.toFixed(6)+","+r.ymin.toFixed(6)+","+r.xmax.toFixed(6)+","+r.ymax.toFixed(6),t="",l="",n=0;n<this.layers.length;++n){var h=this.layers[n],o=h.name,g=h.styleName,h=this.layers[n];if(null!=o&&h.visible&&!h.drawLocal){null!=g&&(t+=g),l+=o,n<this.layers.length-1&&(t+=",",l+=",");var u=h.heatMapLayer;null!=u&&u.visible&&u.load()}}if(e=this.server+"?service=WMS&version="+this.version+"&request=GetMap&layers="+l+"&styles="+t+"&bbox="+i+"&width="+a+"&height="+s+"&srs="+this.srs+"&format="+this.format+"&transparent="+this.transparent+"&mapName="+this.map.name,this.renderer.clearRect(0,0,a,s),""==l)return void(this.flag=GeoBeans.Layer.Flag.LOADED);if(this.image.src==e&&this.flag==GeoBeans.Layer.Flag.ERROR)return void console.log("ERROR");if(this.updateFlag){var y=new Date;this.image.src=e+"&t="+y.getTime(),this.updateFlag=!1}else this.image.src=e;if(this.image.complete){this.updateFlag=!1,this.flag=GeoBeans.Layer.Flag.LOADED,this.renderer.drawImage(this.image,0,0,a,s);var f=this.image.src.lastIndexOf("&t=");f!=-1&&(this.image.src=this.image.src.slice(0,f))}else{var m=this;m.flag=GeoBeans.Layer.Flag.READY,this.image.onload=function(){m.flag!=GeoBeans.Layer.Flag.LOADED&&(m.flag=GeoBeans.Layer.Flag.LOADED,m.renderer.drawImage(m.image,0,0,a,s),m.map.drawLayersAll())},this.image.onerror=function(){m.flag=GeoBeans.Layer.Flag.ERROR,m.map.drawLayersAll()}}},load:function(){this.flag=GeoBeans.Layer.Flag.READY;for(var e=null,a=0;a<this.layers.length;++a)e=this.layers[a],null!=e&&e.visible&&(this.map.drawLocalFlag&&e instanceof GeoBeans.Layer.FeatureDBLayer?e.loadLocal():e.load());for(var s=null,a=0;a<this.layers.length;++a)if(e=this.layers[a],null!=e&&e.visible&&(s=e.flag,s!=GeoBeans.Layer.Flag.LOADED))return;var r=null;this.renderer.clearRect(0,0,this.canvas.width,this.canvas.height);for(var a=this.layers.length-1;a>=0;--a)e=this.layers[a],null!=e&&e.visible&&(r=e.canvas,null!=r&&e.flag==GeoBeans.Layer.Flag.LOADED&&this.renderer.drawImage(r,0,0,r.width,r.height));this.flag=GeoBeans.Layer.Flag.LOADED},update:function(){this.updateFlag=!0},hasLayer:function(e){if(null==e)return!1;for(var a=null,s=0;s<this.layers.length;++s)if(a=this.layers[s],null!=a&&a.name==e)return!0;return!1}});
GeoBeans.Layer.HeatMapLayer=GeoBeans.Class(GeoBeans.Layer,{name:null,container:null,data:null,layer:null,field:null,uniqueValue:null,heatmapInstance:null,div:null,config:null,initialize:function(e,a){this.name=e,this.config=a},setMap:function(e){if(null!=e){this.map=e,this.div=document.createElement("div"),this.div.className="heatmap";var a=e.canvas,n=a.height,i=a.width;this.div.style.cssText="height:"+n+"px;width:"+i+"px;";var t=null,l=null;null!=this.config&&(null!=this.config.gradient&&(t=this.config.gradient),l=null!=this.config.radius?this.config.radius:30),this.heatmapInstance=h337.create({container:this.div,gradient:t,radius:l})}},destory:function(){this.name=null,this.layer=null,this.field=null,this.heatmapInstance=null},setLayer:function(e,a,n){null!=e&&(null==a&&null==n||(this.layer=e,this.field=a,this.uniqueValue=n))},getField:function(){return this.field},getUniqueValue:function(){return this.uniqueValue},load:function(){var e=this.layer.featureType;if(null==e)return void(this.flag=GeoBeans.Layer.Flag.LOADED);var a=e.getFieldIndex(this.field);if(a<0&&null==this.uniqueValue)return void(this.flag=GeoBeans.Layer.Flag.LOADED);var n,i,t=null,l=null,u=[],s=null,r=this.layer.map.transformation,h=this.map.getViewer();if(null==h)return void(this.flag=GeoBeans.Layer.Flag.LOADED);var o=this.layer.getFeatureBBoxGet(h);if(null==o)return void(this.flag=GeoBeans.Layer.Flag.LOADED);for(var d=0;d<o.length;++d){var f=o[d],c=f.geometry;c instanceof GeoBeans.Geometry.Point&&(s=r.toScreenPoint(c.x,c.y)),a<0&&null!=this.uniqueValue?(n=this.uniqueValue,l=n,t=n):a>=0&&(n=f.values[a],0==d&&(t=n,l=n),t=Math.max(n,t),l=Math.min(n,l)),i={x:s.x,y:s.y,value:n},u.push(i)}var g={max:t,min:l,data:u};this.heatmapInstance.setData(g),this.canvas=this.div.children[0],this.flag=GeoBeans.Layer.Flag.LOADED}});
GeoBeans.Layer.MapLayer=GeoBeans.Class(GeoBeans.Layer,{style_name:null,style:null,geomType:null,fields:null,initialize:function(e){GeoBeans.Layer.prototype.initialize.apply(this,arguments)},destory:function(){this.style_name=null,GeoBeans.Layer.prototype.destory.apply(this,arguments)},draw:function(){},setStyle:function(e){}});
GeoBeans.Layer.OverlayLayer=GeoBeans.Class(GeoBeans.Layer.FeatureLayer,{overlays:null,hitOverlay:null,hitOverlayCallback:null,editCanvas:null,editRenderer:null,editEvent:null,editOverlay:null,initialize:function(e){GeoBeans.Layer.prototype.initialize.apply(this,arguments),this.overlays=[]},addOverlay:function(e){null!=e&&(e.setLayer(this),this.overlays.push(e))},addOverlays:function(e){for(var t=0;t<e.length;++t){var i=e[t];this.addOverlay(i)}},removeOverlay:function(e){for(var t=this.overlays.length,i=t-1;i>=0;i--){this.overlays[i];i==e&&this.overlays.splice(i,1)}},removeOverlays:function(e){for(var t=0;t<e.length;++t){var i=e[t];this.overlays.splice(i,1)}},clearOverlays:function(){for(var e=this.overlays.length;e>0;)this.overlays.splice(e-1,1),e=this.overlays.length;null!=this.editRenderer&&this.editRenderer.clearRect(),null!=this.hitRenderer&&this.hitRenderer.clearRect()},load:function(){this.renderer.clearRect(),null!=this.hitRenderer&&this.hitRenderer.clearRect(),null!=this.editRenderer&&this.editRenderer.clearRect();for(var e=0;e<this.overlays.length;++e){var t=this.overlays[e];t.draw()}},draw:function(){var e=this.getLoadFlag();e==GeoBeans.Layer.Flag.LOADED&&this.map.drawLayersAll()},getLoadFlag:function(){for(var e=0;e<this.overlays.length;++e){var t=this.overlays[e],i=t.loadFlag;if(i!=GeoBeans.Overlay.Flag.LOADED)return GeoBeans.Layer.Flag.READY}return GeoBeans.Layer.Flag.LOADED},setHitOverlayCallback:function(e){this.hitOverlayCallback=e},onOverlayHit:function(e,t){var i=t.length;if(i>=1){var a=t[i-1];if(a.isEdit)return e.hitRenderer.clearRect(),void e.map.drawLayersAll();var r=e.getHitOverlaySymbolizer(a);e.drawHitOverlay(a,r),null!=e.hitOverlay&&(e.hitOverlay.isHit=!1),e.hitOverlay=a,a.isHit=!0,null!=e.hitOverlayCallback&&e.hitOverlayCallback(a)}else null!=e.editOverlay&&(e.editOverlay.isHit=!1),null!=e.hitOverlayCallback&&e.hitOverlayCallback(null),null!=e.hitOverlay&&(e.hitOverlay.isHit=!1)},getHitOverlaySymbolizer:function(e){var t=e.type,i=null;switch(t){case GeoBeans.Overlay.Type.MARKER:i=new GeoBeans.Symbolizer.PointSymbolizer,i.icon_url="../images/marker-hit.png",i.icon_offset_x=0,i.icon_offset_y=0;break;case GeoBeans.Overlay.Type.PLOYLINE:i=new GeoBeans.Symbolizer.LineSymbolizer,i.stroke.color.set(255,0,0,1),i.stroke.width=4;break;case GeoBeans.Overlay.Type.POLYGON:i=new GeoBeans.Symbolizer.PolygonSymbolizer,i.fill.color.set(255,255,255,1),i.stroke.color.set(255,0,0,1)}return i},drawHitOverlay:function(e,t){this.hitRenderer.clearRect(),this.hitRenderer.setSymbolizer(t);var i=this.hitRenderer.drawOverlay(e,t,this.map.transformation);i&&this.map.renderer.drawImage(this.hitCanvas,0,0,this.hitCanvas.width,this.hitCanvas.height)},registerHitEvent:function(){this.hitCanvas=document.createElement("canvas"),this.hitCanvas.width=this.canvas.width,this.hitCanvas.height=this.canvas.height,this.hitRenderer=new GeoBeans.Renderer(this.hitCanvas);var e=this,t=null,i=null,a=10,r=e.map;this.hitEvent=function(n){if(null==t)t=n.layerX,i=n.layerY;else{var l=Math.abs(n.layerX-t)+Math.abs(n.layerY-i);if(l>a){t=n.layerX,i=n.layerY;var s=r.transformation.toMapPoint(n.layerX,n.layerY);e.hit(s.x,s.y)}}},r.canvas.addEventListener("mousemove",this.hitEvent),this.registerEditEvent()},unregisterHitEvent:function(){var e=this.map;e.canvas.removeEventListener("mousemove",this.hitEvent),this.unregisterEditEvent(),this.editOverlay=null,this.editRenderer.clearRect(),this.hitRenderer.clearRect(),this.map.drawLayersAll()},hit:function(e,t){if(null!=this.overlays){this.map.renderer,this.map.transformation;this.selection=[];var i=0,a=null,r=null,n=this.overlays.length;for(i=0;i<n;i++)a=this.overlays[i],r=a.geometry,null!=r&&r.hit(e,t,this.map.tolerance)&&this.selection.push(a);this.hitRenderer.clearRect(),this.map.drawLayersAll(),void 0!=this.onOverlayHit&&this.onOverlayHit(this,this.selection)}},registerEditEvent:function(){null==this.editCanvas&&(this.editCanvas=document.createElement("canvas"),this.editCanvas.width=this.canvas.width,this.editCanvas.height=this.canvas.height,this.editRenderer=new GeoBeans.Renderer(this.editCanvas));var e=this.map,t=this;this.editEvent=function(i){var a=t.hitOverlay;if(null!=a){null!=t.editOverlay&&(t.editOverlay.isEdit=!1);var r=e.transformation.toMapPoint(i.layerX,i.layerY),n=a.geometry;if(n.hit(r.x,r.y,e.tolerance)){t.editOverlay=a;var l=t.getEditOverlaySymbolizer(a);t.drawEditOverlay(a,l),a.isEdit=!0,null!=t.hitOverlayCallback&&t.hitOverlayCallback(a)}}},this.map.canvas.addEventListener("click",this.editEvent)},unregisterEditEvent:function(){this.map.canvas.removeEventListener("click",this.editEvent)},getEditOverlaySymbolizer:function(e){var t=e.type,i=null;switch(t){case GeoBeans.Overlay.Type.MARKER:i=new GeoBeans.Symbolizer.PointSymbolizer,i.icon_url="../images/marker-edit.png",i.icon_offset_x=0,i.icon_offset_y=0;break;case GeoBeans.Overlay.Type.PLOYLINE:i=new GeoBeans.Symbolizer.LineSymbolizer,i.stroke.color.set(255,0,0,1),i.stroke.width=6;break;case GeoBeans.Overlay.Type.POLYGON:i=new GeoBeans.Symbolizer.PolygonSymbolizer,i.fill.color.set(255,0,0,1),i.stroke.color.set(255,0,0,1),i.stroke.width=8}return i},drawEditOverlay:function(e,t){this.editRenderer.clearRect(),this.editRenderer.setSymbolizer(t);var i=this.editRenderer.drawOverlay(e,t,this.map.transformation);i&&this.map.renderer.drawImage(this.editCanvas,0,0,this.editCanvas.width,this.editCanvas.height)},getOverlayIndex:function(e){if(null==e)return-1;for(var t=0;t<this.overlays.length;++t)if(e==this.overlays[t])return t;return-1},removeOverlayObj:function(e){var t=this.getOverlayIndex(e);this.removeOverlay(t)},registerInfoWindowEvent:function(){var e=this,t=null,i=null,a=10;this.hitInfoWindowEvent=function(r){if(null==t)t=r.layerX,i=r.layerY;else{var n=Math.abs(r.layerX-t)+Math.abs(r.layerY-i);if(n>a){t=r.layerX,i=r.layerY;var l=e.map.transformation.toMapPoint(r.layerX,r.layerY);e.hitInfoWindow(l.x,l.y)}}},this.map.canvas.addEventListener("mousemove",this.hitInfoWindowEvent)},hitInfoWindow:function(e,t){if(null!=this.overlays){var i=(this.map.renderer,this.map.transformation,[]),a=0,r=null,n=null,l=this.overlays.length;for(a=0;a<l;a++)r=this.overlays[a],n=r.geometry,null!=n&&n instanceof GeoBeans.Geometry.Point&&n.hit(e,t,this.map.tolerance)&&i.push(r);if(i.length>=1){var r=i[i.length-1],s=r.geometry,o=r.infoWindow;null!=s&&null!=o&&this.map.openInfoWindow(o,s)}else this.map.closeInfoWindow()}},unRegisterInfoWindowEvent:function(){this.map.canvas.removeEventListener("mousemove",this.hitInfoWindowEvent),this.hitInfoWindowEvent=null}});
GeoBeans.Layer.PanoramaLayer=GeoBeans.Class(GeoBeans.Layer.FeatureLayer,{overlays:null,initialize:function(e){GeoBeans.Layer.prototype.initialize.apply(this,arguments),this.overlays=[]},addMarker:function(e,a,t,i){if(null!=e&&null!=a&&null!=t){null==i&&(i="images/360.png");var n=new GeoBeans.Symbolizer.PointSymbolizer;n.icon_url=i,n.icon_offset_x=0,n.icon_offset_y=0;var l=new GeoBeans.Overlay.Marker(a,e,n);l.setLayer(this),l.htmlPath=t,this.overlays.push(l),null==this.clickEvent&&this.registerClickEvent()}},removeMarker:function(e){for(var a=null,t=0;t<this.overlays.length;++t)a=this.overlays[t],a.name==e&&this.overlays.splice(t,1);0==this.overlays.length&&this.unRegisterClickEvent(),this.map.infoWindow.attr("data-original-title")==e&&this.map.closeInfoWindow()},clearMarkers:function(){for(var e=this.overlays.length;e>0;)this.overlays.splice(e-1,1),e=this.overlays.length;this.renderer.clearRect(),this.unRegisterClickEvent(),this.map.closeInfoWindow()},load:function(){this.renderer.clearRect();for(var e=0;e<this.overlays.length;++e){var a=this.overlays[e];a.draw()}},draw:function(){var e=this.getLoadFlag();e==GeoBeans.Layer.Flag.LOADED&&this.map.drawLayersAll()},getLoadFlag:function(){for(var e=0;e<this.overlays.length;++e){var a=this.overlays[e],t=a.loadFlag;if(t!=GeoBeans.Overlay.Flag.LOADED)return GeoBeans.Layer.Flag.READY}return GeoBeans.Layer.Flag.LOADED},registerClickEvent:function(){var e=this.map,a=this;this.clickEvent=function(t){var i=e.transformation.toMapPoint(t.layerX,t.layerY);a.hit(i.x,i.y,a.hitOverlayCallback)},e.canvas.addEventListener("click",this.clickEvent)},unRegisterClickEvent:function(){var e=this.map;e.canvas.removeEventListener("click",this.clickEvent),this.clickEvent=null},hit:function(e,a,t){var i=[],n=0,l=null,r=null,s=this.overlays.length;for(n=0;n<s;n++)l=this.overlays[n],r=l.geometry,null!=r&&r.hit(e,a,this.map.tolerance)&&i.push(l);t(this,i)},hitOverlayCallback:function(e,a){if(null!=a&&0!=a.length){var t=a[0];if(null!=t){var i={title:t.name},n=t.htmlPath,l=t.geometry;if(null!=n&&null!=l){var r="<div style='width:400px;height:300px;'><iframe src='"+n+"' style='width:100%;height:100%' frameborder='no'></iframe></div>",s=new GeoBeans.InfoWindow(r,i);mapObj.openInfoWindow(s,l)}}}}});
GeoBeans.Layer.FeatureLayer.QueryLayer=GeoBeans.Class(GeoBeans.Layer.FeatureLayer,{layer:null,blinkFeature:null,blinkFeatureIndex:-1,timer:null,initialize:function(e){GeoBeans.Layer.prototype.initialize.apply(this,arguments)},setLayer:function(e){null!=e&&(this.layer=e,this.style=this.getStyle(e.geomType))},setFeatures:function(e){this.features=e,this.blinkFeatureIndex=null,this.blinkFeature=null,clearInterval(this.timer)},clearFeatures:function(){this.features=null,this.layer=null,this.style=null,this.blinkFeatureIndex=null,this.blinkFeature=null,this.map.draw()},load:function(){if(this.flag=GeoBeans.Layer.Flag.LOADED,this.renderer.clearRect(),null!=this.style&&null!=this.features&&null!=this.layer){var e=this.style.rules;if(null!=e&&0!=e.length)for(var l=0;l<e.length;++l){var t=e[l],r=this.selectFeatures(t.filter);null!=t.symbolizer&&(null!=t.symbolizer.icon_url?this.renderer.drawIcons(r,t.symbolizer,this.map.transformation):this.drawFeatures(r,t.symbolizer)),null!=t.textSymbolizer&&this.labelFeatures(r,t.textSymbolizer)}}},getStyle:function(e){if(null==e)return null;e=e.toUpperCase();var l=null;switch(e){case"POINT":case"MULTIPOINT":l=new GeoBeans.Style.FeatureStyle("query",GeoBeans.Style.FeatureStyle.GeomType.Point);var t=new GeoBeans.Rule,r=new GeoBeans.Symbolizer.PointSymbolizer;r.fill.color.set(255,0,0,1),r.stroke.color.set(252,240,244,.9),t.symbolizer=r,l.addRule(t);break;case"LINESTRING":case"MULTILINESTRING":l=new GeoBeans.Style.FeatureStyle("default",GeoBeans.Style.FeatureStyle.GeomType.LineString);var t=new GeoBeans.Rule,r=new GeoBeans.Symbolizer.LineSymbolizer;r.stroke.color.set(255,0,0,1),r.stroke.width=4,t.symbolizer=r,l.addRule(t);break;case"POLYGON":case"MULTIPOLYGON":l=new GeoBeans.Style.FeatureStyle("default",GeoBeans.Style.FeatureStyle.GeomType.Polygon);var t=new GeoBeans.Rule,r=new GeoBeans.Symbolizer.PolygonSymbolizer;r.fill.color.set(255,0,0,1),r.stroke.color.set(252,240,244,.9),t.symbolizer=r,l.addRule(t)}return l},setFeatureBlink:function(e,l){if(null!=e&&null!=l){null!=this.blinkFeature&&(clearInterval(this.timer),this.features.indexOf(this.blinkFeature)==-1&&(this.features.splice(this.blinkFeatureIndex,0,this.blinkFeature),this.map.drawLayersAll())),this.blinkFeature=e;var t=this,r=this.features.indexOf(e);if(this.blinkFeatureIndex=r,r!=-1){var a=!1,s=setInterval(function(){return 0==l||null==t.features?void clearInterval(s):void(a?(t.features.splice(r,0,e),t.map.drawLayersAll(),a=!1,l--):(t.features.splice(r,1),t.map.drawLayersAll(),a=!0))},500);this.timer=s}}}});
GeoBeans.Layer.RasterDBLayer=GeoBeans.Class(GeoBeans.Layer.DBLayer,{rasterPath:null,type:null,initialize:function(e,a,t,r,s,i,y){GeoBeans.Layer.DBLayer.prototype.initialize.apply(this,arguments),void 0!=y&&(this.rasterPath=y),this.type=GeoBeans.Layer.DBLayer.Type.Raster}});
GeoBeans.TileState={LOADED:1,LOADING:2},GeoBeans.Tile=GeoBeans.Class({map:null,image:null,url:null,row:null,col:null,level:null,layer:null,state:null,initialize:function(e,i,l,t,a,s){this.map=e,this.url=i,this.row=t,this.col=a,this.level=s,this.layer=l},loading:function(e,i,l,t){if(null==this.image&&(this.image=new Image,this.image.src=this.url),this.image.complete&&0!=this.image.height&&0!=this.width)return this.state=GeoBeans.TileState.LOADED,void i(this,e,l,t);var a=this;this.image.onload=function(){a.layer.flag!=GeoBeans.Layer.Flag.LOADED&&(a.state=GeoBeans.TileState.LOADED,i(a,e,l,t))}},draw:function(e,i,l,l){this.map.level==this.level&&(this.layer.renderer.context.clearRect(e,i,l,l),this.layer.visible&&this.layer.renderer.drawImage(this.image,e,i,l,l))}});
GeoBeans.TileCache=GeoBeans.Class({cache:null,initialize:function(){this.cache=[]},destory:function(){this.cache=null},putTile:function(e){var i=e.url,n=this.getTile(i);return null==n&&void this.cache.push(e)},getTile:function(e){for(var i=null,n=this.cache.length,l=0;l<n;l++)if(i=this.cache[l],i.url==e)return i;return null}});
GeoBeans.TileLayerState={LOADING:0,LOADED:1,ERROR:2},GeoBeans.Layer.TileLayer=GeoBeans.Class(GeoBeans.Layer,{IMG_WIDTH:null,IMG_HEIGHT:null,MIN_ZOOM_LEVEL:null,MAX_ZOOM_LEVEL:null,RESOLUTIONS:null,server:null,scale:null,cache:null,state:null,tiles:null,initialize:function(e,t){GeoBeans.Layer.prototype.initialize.apply(this,arguments),this.url=t,this.cache=new GeoBeans.TileCache,this.tiles=[]},destroy:function(){this.server=null,this.scale=null,this.cache=null,GeoBeans.Layer.prototype.destroy.apply(this,arguments)},setName:function(){this.name=name},getValidView:function(){var e=this.map.viewer,t=Math.max(e.xmin,this.FULL_EXTENT.xmin),l=Math.max(e.ymin,this.FULL_EXTENT.ymin),i=Math.min(e.xmax,this.FULL_EXTENT.xmax),n=Math.min(e.ymax,this.FULL_EXTENT.ymax);return new GeoBeans.Envelope(t,l,i,n)},updateScale:function(){this.map,this.FULL_EXTENT},draw:null,drawCache:null,preDraw:null,loadingTiles:null,getTileID:null,computeTileBound:null,getResolution:function(e){return e<=0||e>=this.RESOLUTIONS.length?-1:this.RESOLUTIONS[e-1]},getLevel:function(e){for(var t=this.MAX_ZOOM_LEVEL,l=this.MIN_ZOOM_LEVEL,i=0;i<this.RESOLUTIONS.length;++i){var n=this.RESOLUTIONS[i];if(e>=n)return i<l?l:i>t?t:i}return t},init:function(){var e=this.map;this.level=this.map.level,this.resolution=this.getResolution(this.level),e.setResolution(this.resolution),e.updateMapExtent()}}),GeoBeans.Layer.TileLayer.Type={QS:"QuadServer",WMTS:"wmts"};
GeoBeans.Layer.WFSLayer=GeoBeans.Class(GeoBeans.Layer.FeatureLayer,{style:null,server:null,url:null,typeName:null,format:"GML2",version:"1.0.0",srs:"EPSG:4326",features:null,maxFeatures:50,filter:null,workspace:null,viewer:null,initialize:function(e,a,t,r){GeoBeans.Layer.FeatureLayer.prototype.initialize.apply(this,arguments),this.name=e,this.server=a,this.typeName=t,this.format=r,this.image=new Image,this.workspace=new GeoBeans.WFSWorkspace(this.name,this.server,this.version)},destory:function(){this.server=null,this.name=null,this.server=null,this.typeName=null,this.format=null,this.featureType=null,this.workspace=null,GeoBeans.Layer.FeatureLayer.prototype.destory.apply(this,arguments)},load:function(){var e=this.map.viewer;if(null!=e&&null!=this.viewer&&e.equal(this.viewer)&&null!=this.features)return this.flag=GeoBeans.Layer.Flag.LOADED,this.drawLayerSnap(),this.renderer.clearRect(),this.drawLayer(),void this.drawBufferFeaturesCanvas();if(this.viewer=new GeoBeans.Envelope(e.xmin,e.ymin,e.xmax,e.ymax),null==this.featureType&&(this.featureType=this.workspace.getFeatureType(this.typeName)),null!=this.featureType){var a=this;a.flag=GeoBeans.Layer.Flag.READY,this.featureType.getFeaturesBBox(function(e,t){a.setTransformation(a.map.transformation),a.features=t,a.drawLayerSnap(),a.renderer.clearRect(),a.drawLayer(),a.drawBufferFeaturesCanvas(),a.map.drawLayersAll(),a.flag=GeoBeans.Layer.Flag.LOADED},this.viewer,this.filter)}},draw:function(){if(null!=this.features)return this.drawLayerSnap(),this.renderer.clearRect(),this.drawLayer(),void this.map.renderer.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height);if(null==this.featureType&&(this.featureType=this.workspace.getFeatureType(this.typeName)),null!=this.featureType){var e=this;this.featureType.getFeatures(function(a,t){e.setTransformation(e.map.transformation),e.features=t,e.drawLayerSnap(),e.renderer.clearRect(),e.drawLayer(),e.map.renderer.drawImage(e.canvas,0,0,e.canvas.width,e.canvas.height)})}},setFilter:function(e){this.filter=e,this.features=null},getFeatureType:function(){if(null==this.featureType&&(this.featureType=this.workspace.getFeatureType(this.typeName)),null!=this.featureType)return this.featureType},CLASS_NAME:"GeoBeans.Layer.WFSLayer"});
GeoBeans.Layer.WMSLayer=GeoBeans.Class(GeoBeans.Layer,{server:null,url:null,image:null,layers:[],mapLayers:[],styles:[],format:"image/png",version:"1.1.0",srs:"EPSG:4326",transparent:"true",workspace:null,updateFlag:!1,initialize:function(e,s,t,a,r){GeoBeans.Layer.prototype.initialize.apply(this,arguments),this.workspace=new GeoBeans.WMSWorkspace(e,s,"1.3.0"),this.name=e,this.server=s,this.layers=t,this.mapLayers=[];for(var i=0;i<this.layers.length;++i){var n=this.layers[i],l=this.workspace.getMapLayer(n);this.mapLayers.push(l)}void 0!=a&&(this.styles=a),void 0!=r&&(this.format=r),this.image=new Image;var h=this.workspace.extent;this.extent=h},destory:function(){this.server=null,this.name=null,this.server=null,this.layers=null,this.styles=null,this.format=null,this.image=null,this.mapLayers=null,GeoBeans.Layer.prototype.destory.apply(this,arguments)},load:function(){for(var e,s=this.map.canvas.width,t=this.map.canvas.height,a=this.map.viewer,r=a.xmin+","+a.ymin+","+a.xmax+","+a.ymax,i="",n="",l=0;l<this.mapLayers.length;++l){var h=this.mapLayers[l];if(null!=h){var o=h.name,m=h.style_name;null!=m&&h.visible&&(i+=m,n+=o),l<this.mapLayers.length-1&&(""!=i&&","!=i.substr(i.length-1,1)&&(i+=","),""!=n&&","!=n.substr(n.length-1,1)&&(n+=","))}}if(","==i.substr(i.length-1,1)&&(i=i.substr(0,i.length-1)),","==n.substr(n.length-1,1)&&(n=n.substr(0,n.length-1)),e=this.server+"service=WMS&version="+this.version+"&request=GetMap&layers="+n+"&styles="+i+"&bbox="+r+"&width="+s+"&height="+t+"&srs="+this.srs+"&format="+this.format+"&transparent="+this.transparent,this.renderer.clearRect(0,0,s,t),""==n)return void(this.flag=GeoBeans.Layer.Flag.LOADED);if(this.updateFlag){var p=new Date;this.image.src=e+"&t="+p.getTime(),this.updateFlag=!1}else this.image.src=e;if(this.image.complete){this.updateFlag=!1,this.flag=GeoBeans.Layer.Flag.LOADED,this.renderer.drawImage(this.image,0,0,s,t);var y=this.image.src.lastIndexOf("&t=");y!=-1&&(this.image.src=this.image.src.slice(0,y))}else{var g=this;g.flag=GeoBeans.Layer.Flag.READY,this.image.onload=function(){g.flag!=GeoBeans.Layer.Flag.LOADED&&(g.flag=GeoBeans.Layer.Flag.LOADED,g.renderer.drawImage(g.image,0,0,s,t),g.map.drawLayersAll())}}},draw:function(){var e,s=this.map.canvas.width,t=this.map.canvas.height,a=this.map.viewer,r=a.xmin+","+a.ymin+","+a.xmax+","+a.ymax;e=this.server+"&service=WMS&version="+this.version+"&request=GetMap&layers="+this.layers+"&styles="+this.styles+"&bbox="+r+"&width="+s+"&height="+t+"&srs="+this.srs+"&format="+this.format+"&transparent="+this.transparent,this.image.src=e;var i=this.map.renderer;if(this.image.complete)i.drawImage(this.image,0,0,s,t);else{var n=this;this.image.onload=function(){i.drawImage(n.image,0,0,s,t)}}},getMapLayer:function(e){for(var s,t,a=0;a<this.mapLayers.length;++a)if(s=this.mapLayers[a],t=s.name,t==e)return s;return null},update:function(){this.updateFlag=!0},setMapLayerStyle:function(e,s,t){if(null!=e&&null!=s){var a=this,r=e.name,i="service=wms&version=1.0.0&request=SetStyle&&layer="+r+"&style="+s;$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!1,beforeSend:function(e){},success:function(r,i){var n=a.parseSetMapLayerStyle(r);"success"==n&&(e.style_name=s),void 0!=t&&t(n)},complete:function(e,s){},error:function(){}})}},parseSetMapLayerStyle:function(e){var s="",t=$(e).find("SetStyle").text();return"SUCCESS"==t.toUpperCase()?s="success":""!=$(e).find("ExceptionText").text()&&(s=$(e).find("ExceptionText").text()),s}});
GeoBeans.Layer.ClusterLayer=GeoBeans.Class(GeoBeans.Layer.FeatureLayer,{sourceLayer:null,distance:28,clusters:null,symbolizer:null,initialize:function(e,t,r){GeoBeans.Layer.FeatureLayer.prototype.initialize.apply(this,arguments),this.features=null,this.sourceLayer=t,this.sourceLayer.visible=!1,this.symbolizer=r},setName:function(e){this.name=e},setMap:function(e){this.map=e,this.canvas=this.sourceLayer.canvas,this.renderer=this.sourceLayer.renderer},setLayer:function(e){null!=e&&(this.sourceLayer.visible=!0,this.sourceLayer=e,this.sourceLayer.visible=!1,this.features=null)},setSymbolizer:function(e){this.symbolizer=e},load:function(){if(null==this.features)this.flag=GeoBeans.Layer.Flag.READY,this.getFeatures();else{var e=this.map.viewer;if(null!=e&&null!=this.viewer&&this.flag==GeoBeans.Layer.Flag.LOADED&&e.equal(this.viewer))return;this.viewer=new GeoBeans.Envelope(e.xmin,e.ymin,e.xmax,e.ymax),this.renderer.clearRect(),this.cluster(),this.flag=GeoBeans.Layer.Flag.LOADED}},getFeatures:function(){var e=this.sourceLayer.getFeatureType(),t=e.geomFieldName,r=[t];this.sourceLayer.getFeatures(r,this,this.getFeatures_callback)},getFeatures_callback:function(e,t){e.flag=GeoBeans.Layer.Flag.LOADED,e.features=t,e.map.drawLayersAll()},cluster:function(){if(null!=this.features){for(var e=(new Date,null),t=null,r=null,s=!1,a=[],l=0;l<this.features.length;++l)if(e=this.features[l],null!=e&&(t=e.geometry,null!=t&&this.viewer.contain(t.x,t.y))){s=!1;for(var n=0;n<a.length;++n)if(r=a[n],this.shouldCluster(r,t)){this.addToCluster(r,e),s=!0;break}s||a.push(this.createCluster(e))}this.drawClusters(a)}},createCluster:function(e){var t={features:[]};t.features.push(e);var r=e.geometry;return t.geometry=r,t},shouldCluster:function(e,t){var r=e.geometry,s=this.map.transformation.toScreenPoint(r.x,r.y),a=this.map.transformation.toScreenPoint(t.x,t.y),l=Math.sqrt(Math.pow(s.x-a.x,2)+Math.pow(s.y-a.y,2));return l<this.distance},addToCluster:function(e,t){e.features.push(t)},drawClusters:function(e){for(var t=null,r=null,s=0;s<e.length;++s)if(t=e[s],null!=t){r=t.geometry;var a=this.getClusterCenter(t);a=r;var l=(new GeoBeans.Geometry.Circle(a,2),null);l=null==this.symbolizer?new GeoBeans.Symbolizer.PolygonSymbolizer:this.symbolizer,this.renderer.setSymbolizer(l);var n=this.renderer.context;n.beginPath();var i=14,o=this.map.transformation.toScreenPoint(a.x,a.y);n.arc(o.x,o.y,i,0,2*Math.PI,!0),null!=l.fill&&n.fill(),null!=l.stroke&&n.stroke(),n.closePath();var u=new GeoBeans.Symbolizer.TextSymbolizer,h=new GeoBeans.Color;h.setByHex("#ffffff",1),u.fill.color=h,this.renderer.setSymbolizer(u);var y=t.features.length,f=n.measureText(y).width;null!=l.fill&&n.fillText(y,o.x-f/2,o.y+4)}},getClusterCenter:function(e){for(var t=e.features,r=null,s=null,a=0,l=0,n=0;n<t.length;++n)r=t[n],null!=r&&(s=r.geometry,null!=s&&(a+=s.x,l+=s.y));return new GeoBeans.Geometry.Point(a/t.length,l/t.length)}});
GeoBeans.Layer.ImageLayer=GeoBeans.Class(GeoBeans.Layer,{images:null,initialize:function(a){GeoBeans.Layer.prototype.initialize.apply(this,arguments),this.images=[]},addImage:function(a,e){if(null!=a&&null!=e){var i=new Image;i.src=a;var t={image:i,extent:e,flag:!1};this.images.push(t)}},load:function(){var a=this.map.canvas.width,e=this.map.canvas.height;this.renderer.clearRect(0,0,a,e);for(var i=null,t=null,n=null,r=0;r<this.images.length;++r)if(t=this.images[r],null!=t){i=t.image,n=t.extent;var s=this.map.transformation.toScreenPoint(n.xmin,n.ymax),l=this.map.transformation.toScreenPoint(n.xmax,n.ymin),h=l.x-s.x,g=l.y-s.y;if(i.complete){var o=i.width,m=i.height;this.renderer.drawImageParms(i,0,0,o,m,s.x,s.y,h,g),t.flag=!0}else{var f=this;i.onload=function(){t.flag=!0;var a=this.width,e=this.height;f.renderer.drawImageParms(i,0,0,a,e,s.x,s.y,h,g),f.map.drawLayersAll()}}}for(var r=0;r<this.images.length;++r)if(t=this.images[r],!t.flag)return void(this.flag=GeoBeans.Layer.Flag.READY);this.flag=GeoBeans.Layer.Flag.LOADED},getLoadFlag:function(){return this.flag}});
GeoBeans.Layer.RippleLayer=GeoBeans.Class(GeoBeans.Layer,{featureType:null,dbName:null,typeName:null,option:null,xhr:null,beginTime:null,filter:null,defaultOption:{radius:10,scale:2.5,period:4,lineNumber:3,type:"stroke",color:"#FFFF00",alpha:1,showEffect:!0},initialize:function(e,t,i,l,n){GeoBeans.Layer.prototype.initialize.apply(this,arguments),this.dbName=t,this.typeName=i,this.option=l;var a=this._getOption(l);this.option=a,this.filter=n},destroy:function(){GeoBeans.Layer.prototype.destroy.apply(this,arguments),this.option=null,this.dbName=null,this.typeName=null,this.beginTime=null,this.xhr=null,this.features=null;var e=this.map.hitRippleLayers.indexOf(this);e!=-1&&this.map.hitRippleLayers.splice(e,1)},_getOption:function(e){if(null==e)return this.defaultOption;var t=e.radius;null==t&&(t=this.defaultOption.radius);var i=e.scale;null==i&&(i=this.defaultOption.scale);var l=e.period;null==l&&(l=this.defaultOption.period);var n=e.lineNumber;null==n&&(n=this.defaultOption.lineNumber);var a=e.type;null==a&&(a=this.defaultOption.type);var r=e.color;null==r&&(r=this.defaultOption.color);var s=e.alpha;null==s&&(s=this.defaultOption.alpha);var u=e.field,o=e.radiusField,h=e.colorField,p=e.showEffect;return null==p&&(p=!0),{radius:t,scale:i,period:l,lineNumber:n,type:a,color:r,alpha:s,field:u,showEffect:p,radiusField:o,colorField:h}},setMap:function(e){e.beginAnimate(),this.map=e,this.canvas=this.map.animateCanvas,this.renderer=this.map.animateRenderer},load:function(){null==this.features&&null==this.xhr&&this.getFeatures(),this.flag=GeoBeans.Layer.Flag.LOADED},getFeatures:function(){var e=this.getFeatureType();if(null!=e){this.featureType=e;var t=[this.featureType.geomFieldName],i=this.option.radiusField;null!=i&&$.inArray(i,t)==-1&&t.push(i);var l=this.option.colorField;null!=l&&$.inArray(l,t)==-1&&t.push(l),this.get_time=new Date,this.xhr=this.featureType.getFeaturesFilterAsync2(null,this.dbName,this.filter,null,null,t,null,this,this.getFeatures_callback)}},getJson:function(){var e=[],t=this.getFeatureType(),i=this,l=new Date;$.getJSON("hospital.json",function(n){for(var a=null,r=null,s=null,u=null,o=null,h=null,p=null,f=0;f<n.length;++f)a=n[f],r=a.id,s=a.x,u=a.y,o=new GeoBeans.Geometry.Point(s,u),p=[],p.push(r),p.push(null),p.push(o),h=new GeoBeans.Feature(t,r,o,p),e.push(h);i.features=e,console.log(new Date-l),i.draw()})},getFeatures_callback:function(e,t){null!=e&&null!=t&&$.isArray(t)&&(e.xhr=null,e.features=t,e.draw())},getFeatureType:function(){if(null!=this.featureType)return this.featureType;if(null!=this.map){var e=new GeoBeans.WFSWorkspace("tmp",this.map.server,"1.0.0");return this.featureType=new GeoBeans.FeatureType(e,this.typeName),null==this.featureType.fields&&(this.featureType.fields=this.featureType.getFields(null,this.dbName)),this.featureType}return null},unregisterHitEvent:function(){this.content=null},hit:function(e,t){if(null!=this.features&&this.visible){var i=(this.map.renderer,this.map.transformation,[]),l=0,n=null,a=null,r=this.features.length;for(l=0;l<r;l++)n=this.features[l],a=n.geometry,null!=a&&a.hit(e,t,this.map.tolerance)&&i.push(n);if(i.length>0){var n=i[i.length-1],s=(new GeoBeans.Geometry.Point(e,t),this.getContent(n,this.content));return s}return null}},getFeaturesByHitContent:function(e){if(null!=e){var t=this.getHitFields(e);if(0!=t.length){var i=this.getFeatureType();if(null!=i){var l=this.featureType.geomFieldName;$.inArray(l,t)==-1&&t.push(l),null!=this.option.field&&$.inArray(this.option.field,t)==-1&&t.push(this.option.field);var n=1e6;this.featureType.getFeaturesFilterAsync2(null,this.dbName,this.filter,n,null,t,null,this,this.getFeaturesHit_callback)}}}},getFeaturesHit_callback:function(e,t){null!=e&&null!=t&&(e.features=t)},getHitFields:function(e){for(var t=[];e.indexOf("{")!=-1;){var i=e.indexOf("{"),l=e.indexOf("}"),n=e.slice(i+1,l);$.inArray(n,t)==-1&&t.push(n),e=e.slice(l+1,e.length)}return t},getContent:function(e,t){if(null==e||null==t)return"";var i=this.getHitFields(t);if(null==i)return"";var l=e.values;if(null==l)return"";var n=this.getFeatureType();if(null==n)return"";for(var a=null,r=null,s=null,u=0;u<i.length;++u)a=i[u],r=n.getFieldIndex(a),r!=-1&&(s=l[r],null!=s&&(t=t.replace("{"+a+"}",s)));return t},setHitContent:function(e){e!=this.content&&(this.content=e,this.getFeaturesByHitContent(e))},draw:function(e){this.visible&&null!=this.option&&this.drawRipple(e)},drawRipple:function(e){new Date;if(null!=this.features&&null!=this.option){var t=this.map.viewer,i=this.getViewerFeatures(t,this.features),l=this.option.radiusField,n=this.option.colorField,a=this.option.scale,r=this.option.period,s=this.option.type,u=this.option.lineNumber,o=this.option.showEffect,h=this.option.alpha,p=this.option.radius,f=this.option.color,c=0;null==this.beginTime?this.beginTime=e:(c=e-this.beginTime,c>1e3*r&&(c=0,this.beginTime=e));for(var d=this.getFeatureType(),y=d.getFieldIndex(l),g=d.getFieldIndex(n),m=this.renderer.context,v=null,F=null,b=null,T=null,w=null,x=null,B=null,G=null,N=null,O=null,P=0;P<i.length;++P)if(v=i[P],null!=v&&(w=v.geometry,w instanceof GeoBeans.Geometry.Point&&(F=v.values,null!=F))){var A=null;"function"==typeof p?(b=F[y],A=p(b)):A=p;var C=null;"function"==typeof f?(T=F[g],C=f(T,this)):C=f;var H=new GeoBeans.Color;if(H.setByHex(C,h),m.fillStyle=H.getRgba(),x=this.map.transformation.toScreenPoint(w.x,w.y),m.beginPath(),m.arc(x.x,x.y,A,0,2*Math.PI),m.fill(),o){B=A*a,G=(B-A)/(1e3*r),N=G*c,O=(B-A)/u;for(var L=0;L<u;++L){var R=A+O*L;R+=N,R>B&&(R=R-B+A);var k=h*(1-(R-A)/(B-A)),_=new GeoBeans.Color;_.setByHex(C,k),"stroke"==s?(m.strokeStyle=_.getRgba(),m.beginPath(),m.arc(x.x,x.y,R,0,2*Math.PI),m.stroke(),m.closePath()):"fill"==s&&(m.fillStyle=_.getRgba(),m.beginPath(),m.arc(x.x,x.y,R,0,2*Math.PI),m.fill(),m.closePath())}}}var D=this.map.controls.find(GeoBeans.Control.Type.DRAG_MAP),S=this.map.controls.get(D),$=this.map.controls.find(GeoBeans.Control.Type.SCROLL_MAP),E=this.map.controls.get($);!S.draging&&0==E.count}},getViewerFeatures:function(e,t){new Date;if(null==e||null==t)return[];for(var i=[],l=null,n=null,a=0;a<t.length;++a)l=t[a],null!=l&&(n=l.geometry,null!=n&&e.contain(n.x,n.y)&&i.push(l));return i}});
GeoBeans.Layer.AirLineLayer=GeoBeans.Class(GeoBeans.Layer,{dbName:null,typeName:null,symbolizer:null,pointSymbolizer:null,option:null,featureType:null,initialize:function(e,t,r,a,l,i){GeoBeans.Layer.prototype.initialize.apply(this,arguments),this.dbName=t,this.typeName=r,this.symbolizer=a,this.pointSymbolizer=l,this.option=i},load:function(){var e=this.map.viewer;return null!=e&&null!=this.viewer&&e.equal(this.viewer)&&null!=this.features?void(this.flag=GeoBeans.Layer.Flag.LOADED):(this.viewer=new GeoBeans.Envelope(e.xmin,e.ymin,e.xmax,e.ymax),this.flag=GeoBeans.Layer.Flag.READY,this.renderer.clearRect(),void this.getFeatures())},getFeatures:function(){if(null!=this.features)return void this.drawLayer();var e=this.getFeatureType();if(null==e)return void(this.flag=GeoBeans.Layer.Flag.ERROR);var t=[this.featureType.geomFieldName];this.featureType.getFeaturesFilterAsync2(null,this.dbName,null,null,null,t,null,this,this.getFeatures_callback)},getFeatureType:function(){if(null!=this.featureType)return this.featureType;if(null!=this.map){var e=new GeoBeans.WFSWorkspace("tmp",this.map.server,"1.0.0");return this.featureType=new GeoBeans.FeatureType(e,this.typeName),null==this.featureType.fields&&(this.featureType.fields=this.featureType.getFields(null,this.dbName)),this.featureType}return null},getFeatures_callback:function(e,t){null!=e&&null!=t&&(e.features=t,e.drawLayer())},drawLayer:function(){var e=this.renderer,t=this.filterFeatures(),r=this.pointSymbolizer;e.setSymbolizer(r);for(var a=0;a<t.length;++a){var l=t[a];if(null!=l){var i=l.geometry;e.drawGeometry(i,r,this.map.transformation)}}e.setSymbolizer(this.symbolizer);for(var n=this.option.curveness,s=null,u=null,o=null,y=null,h=null,a=0;a<t.length;++a)if(s=t[a],null!=s&&(u=s.geometry,null!=u))for(var f=a+1;f<t.length;++f)f<=a||(o=t[f],null!=o&&(y=o.geometry,null!=y&&(h=this.getBezierControlPoint(u,y,n),e.drawBezierLine(u,y,h,mapObj.transformation))));this.flag=GeoBeans.Layer.Flag.LOADED,this.map.drawLayersAll()},getBezierControlPoint:function(e,t,r){if(null==e||null==t)return null;var a=new GeoBeans.Geometry.Point(e.x/2+t.x/2,e.y/2+t.y/2),l=Math.sqrt((e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y)),i=(e.x-t.x)/(e.y-t.y),n=Math.atan(i);n=Math.PI/2-n;var s=l*r,u=Math.sin(n)*s,o=Math.cos(n)*s,y=a.x+u,h=a.y-o,f=new GeoBeans.Geometry.Point(y,h);return f},filterFeatures:function(){for(var e=[],t=this.features,r=0;r<t.length;++r)r%60==0&&e.push(t[r]);return e}});
GeoBeans.Layer.AQIChartLayer=GeoBeans.Class(GeoBeans.Layer.ChartLayer,{chartField:null,labelField:null,timeField:null,timePoint:null,styleMgr:null,featuresAll:null,tipInfos:null,flagField:null,changeLegend:!0,colorMap:null,isTimeline:!1,initialize:function(e,t,i,a,n,l,r,s,o){this.name=e,this.dbName=t,this.tableName=i,this.chartField=a,this.labelField=n,this.flagField=l,this.timeField=r,this.timePoint=s,this.chartOption=o,this.type=GeoBeans.Layer.ChartLayer.Type.AQI},setChartOption:function(e){this.chartOption=e,this.features=null,this.changeLegend=!0;var t=this.chartOption.colorMapID,i=this.styleMgr.getColorMapByID(t);this.colorMap=i},getChartField:function(){return this.chartField},setChartField:function(e){this.chartField=e,this.features=null,this.changeLegend=!0},getFlagField:function(){return this.flagField},getTimeField:function(){return this.timeField},getTimePoint:function(){return this.timePoint},setTimePoint:function(e){this.timePoint=e,this.features=null},getLableField:function(){return this.labelField},setMap:function(e,t){GeoBeans.Layer.prototype.setMap.apply(this,arguments);var i=new GeoBeans.WFSWorkspace("tmp",this.map.server,"1.0.0"),a=new GeoBeans.FeatureType(i,this.tableName);this.featureType=a;var n=(a.getFields(null,this.dbName),this.map.server.slice(0,this.map.server.lastIndexOf("/mgr")));this.styleMgr=new GeoBeans.StyleManager(n);var l=this.chartOption.colorMapID,r=this.styleMgr.getColorMapByID(l);this.colorMap=r,null!=t&&(this.isTimeline=t),t||e._addLegend(this)},load:function(){var e=this.map.viewer;if(null==this.minMaxValue){var t=this.getMinMaxValue();if(null==t)return;this.minMaxValue=t}return this.drawLegend(),null!=e&&null!=this.viewer&&e.equal(this.viewer)&&null!=this.features?void(this.flag=GeoBeans.Layer.Flag.LOADED):(this.viewer=new GeoBeans.Envelope(e.xmin,e.ymin,e.xmax,e.ymax),this.getFeatures(),void(this.flag=GeoBeans.Layer.Flag.READY))},drawLegend:function(){if(!this.isTimeline){if(this.changeLegend)this.removeLegend(),this.addLegend(),this.changeLegend=!1;else{var e=this.map.mapDiv.find(".chart-legend#"+this.name),t=parseInt(e.attr("lindex"));t!=this.legendIndex&&(this.removeLegend(),this.addLegend())}return this.visible?void this.showLegend():void this.hideLegend()}},getFeatures:function(){var e=new GeoBeans.BinaryLogicFilter;e.operator=GeoBeans.LogicFilter.OperatorType.LogicOprAnd;var t=new GeoBeans.BinaryComparisionFilter;t.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var i=new GeoBeans.PropertyName;i.setName(this.timeField);var a=new GeoBeans.Literal;a.setValue(this.timePoint),t.expression1=i,t.expression2=a,e.addFilter(t);var n=this.featureType.geomFieldName,l=this.map.viewer,r=new GeoBeans.BBoxFilter;r.extent=l,i=new GeoBeans.PropertyName,i.setName(n),r.propName=i,e.addFilter(r),this.featureType.getFeaturesFilterAsync2(null,this.dbName,e,null,null,[this.chartField,n,this.labelField,this.flagField],null,this,this.getFeatures_callback)},getFeatures:function(){if(null!=this.features)return void this.draw();var e=new GeoBeans.BinaryComparisionFilter;e.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var t=new GeoBeans.PropertyName;t.setName(this.timeField);var i=new GeoBeans.Literal;i.setValue(this.timePoint),e.expression1=t,e.expression2=i;var a=this.featureType.geomFieldName;this.featureType.getFeaturesFilterAsync2(null,this.dbName,e,null,null,[this.chartField,a,this.labelField,this.flagField],null,this,this.getFeatures_callback)},getFeatures_callback:function(e,t){null!=e&&null!=t&&(e.features=t,e.draw())},draw:function(){this.style=this.getStyle(),this.flag=GeoBeans.Layer.Flag.READY,this.setTransformation(this.map.transformation),this.drawLayerSnap(),this.renderer.clearRect(),this.drawAQIChart(),this.drawLegend(),this.flag=GeoBeans.Layer.Flag.LOADED,this.map.drawLayersAll()},drawAQIChart:function(){var e=this.chartOption.type;"point"==e?(this.renderer.context.globalCompositeOperation="lighter",this.drawByValue()):"tip"==e&&(this.renderer.context.globalCompositeOperation="source-over",this.showTips(),this.drawLayer())},showTips:function(){if(null!=this.features&&null!=this.chartOption&&null!=this.colorMap&&null!=this.minMaxValue){this.tipInfos=[];for(var e=new GeoBeans.ColorRangeMap(this.colorMap.startColor,this.colorMap.endColor,this.minMaxValue.min,this.minMaxValue.max),t=this.featureType.getFieldIndex(this.chartField),i=this.featureType.getFieldIndex(this.labelField),a=this.featureType.getFieldIndex(this.flagField),n=null,l=null,r=null,s=0;s<this.features.length;++s)if(l=this.features[s],null!=l&&(r=l.geometry,null!=r)){var o=l.values;if(null!=o){n=o[t],n=parseFloat(n);var h=e.getValue(n),u=new GeoBeans.Rule,d=new GeoBeans.Symbolizer.PolygonSymbolizer,m=new GeoBeans.Fill;m.color=h,d.fill=m;var p=new GeoBeans.Stroke;p.color=h,p.width=.5,d.stroke=p,u.symbolizer=d;var c=new GeoBeans.Symbolizer.TextSymbolizer;c.labelText=n;var f=new GeoBeans.Font;f.family="宋体",f.style="normal",f.weight="normal",f.size="12",c.font=f;var v=new GeoBeans.Color;v.setByHex("#ffffff",1);var m=new GeoBeans.Fill;m.color=v,c.fill=m,u.textSymbolizer=c;var y=o[i],g=new GeoBeans.Rule,w=new GeoBeans.Symbolizer.PolygonSymbolizer,m=new GeoBeans.Fill;v=new GeoBeans.Color,v.setByHex("#ffffff",1),m.color=v,w.fill=m;var p=new GeoBeans.Stroke;p.color=h,p.width=.5,w.stroke=p,g.symbolizer=w;var c=new GeoBeans.Symbolizer.TextSymbolizer;c.labelText=y;var f=new GeoBeans.Font;f.family="宋体",f.style="normal",f.weight="normal",f.size="12",c.font=f;var v=new GeoBeans.Color;v.setByHex("#000000",1);var m=new GeoBeans.Fill;m.color=v,c.fill=m,g.textSymbolizer=c;var F=o[a],x=this.renderer.drawTip(r,this.map.transformation,u,g),B={flag:F,viewer:x,name:y};this.tipInfos.push(B)}}}},getMinMaxValue:function(){var e=this.chartField,t=0,i=500;switch(e){case"aqi":t=0,i=500;break;case"co":t=0,i=90;break;case"co_24h":t=0,i=90;break;case"no2":t=0,i=100;break;case"no2_24h":t=0,i=100;break;case"o3":t=0,i=200;break;case"o3_24h":t=0,i=200;break;case"o3_8h":t=0,i=200;break;case"o3_8h_24h":t=0,i=200;break;case"pm10":t=0,i=500;break;case"pm10_24":t=0,i=500;break;case"pm2_5":t=0,i=300;break;case"pm_2_5_24h":t=0,i=300;break;case"so2":t=0,i=500;break;case"so2_24h":t=0,i=500;break;default:t=0,i=500}return{min:t,max:i}},getStyle:function(){var e=new GeoBeans.Style.FeatureStyle("default",GeoBeans.Style.FeatureStyle.GeomType.Point),t=new GeoBeans.Rule,i=new GeoBeans.Symbolizer.PointSymbolizer,a=new GeoBeans.Color;return a.setByHex("#A4C3F2",1),i.fill.color=a,a=new GeoBeans.Color,a.setByHex("#808000",.1),i.stroke.color=a,i.size=1,t.symbolizer=i,e.addRule(t),e},addLegend:function(){if(null!=this.minMaxValue&&null!=this.minMaxValue.min&&null!=this.minMaxValue.max){var e=0;if(0==this.legendIndex)e=10;else{var t=this.legendIndex-1,i=this.map.mapDiv.find(".chart-legend[lindex='"+t+"']");if(0!=i.length){var a=i.css("left"),n=i.css("width");a=parseInt(a.replace("px","")),n=parseInt(n.replace("px","")),e=a+n+5}}var l="",l="<div class='chart-legend chart-legend-aqi' id='"+this.name+"' style='left:"+e+"px' lindex='"+this.legendIndex+"'>";l+="<div class='chart-legend-title'><h5>"+this.chartField+"</h5></div>",l+="<div class='chart-legend-canvas'>\t<canvas width='20' height='200'></canvas></div><div class='chart-legend-value'><div class='chart-legend-max'>"+this.minMaxValue.max+"</div><div class='chart-legend-min'>"+this.minMaxValue.min+"</div></div>",l+="</div>",this.map.mapDiv.append(l);var r=this.map.mapDiv.find("#"+this.name+" .chart-legend-canvas canvas"),s=r[0].getContext("2d"),o=new Image;o.src=this.colorMap.url,o.onload=function(){var e=r.width()/2,t=r.height()/2,i=o.width,a=o.height;s.clearRect(0,0,i,a),s.translate(e,t),s.rotate(270*Math.PI/180),s.drawImage(o,-i/2,-a/2,i,a),s.rotate(-270*Math.PI/180),s.translate(-e,-t)}}},registerHitEvent:function(e,t){var i=this,a=null,n=null,l=3;this.hitEvent=function(r){if(null==a){a=r.layerX,n=r.layerY;var s=new GeoBeans.Geometry.Point(a,n),o=i.map.transformation.toMapPoint(s.x,s.y),h=i.getTipInfo(s);if(null!=h){var u={title:h.name},d=new GeoBeans.InfoWindow(e,u);i.map.openInfoWindow(d,o),null!=t&&t(h.flag,h.name,i)}}else{var m=Math.abs(r.layerX-a)+Math.abs(r.layerY-n);if(m>l){a=r.layerX,n=r.layerY;var s=new GeoBeans.Geometry.Point(a,n),o=i.map.transformation.toMapPoint(s.x,s.y),h=i.getTipInfo(s);if(null!=h){var u={title:h.name},d=new GeoBeans.InfoWindow(e,u);i.map.openInfoWindow(d,o),null!=t&&t(h.flag,h.name,i)}}}};var r=null,s=null;this.moveEvent=function(e){if(null==r)r=e.layerX,s=e.layerY;else{var t=Math.abs(e.layerX-r)+Math.abs(e.layerY-s);if(t>l){r=e.layerX,s=e.layerY;var a=new GeoBeans.Geometry.Point(r,s),n=(i.map.transformation.toMapPoint(a.x,a.y),i.getTipInfo(a));null!=n?document.body.style.cursor="pointer":document.body.style.cursor="default"}}},this.map.mapDiv[0].addEventListener("click",this.hitEvent),this.map.mapDiv[0].addEventListener("mousemove",this.moveEvent)},unRegisterHitEvent:function(){this.map.mapDiv[0].removeEventListener("click",this.hitEvent),this.map.mapDiv[0].removeEventListener("mousemove",this.moveEvent),this.hitEvent=null,this.moveEvent=null},setVisiable:function(e){GeoBeans.Layer.prototype.setVisiable.apply(this,arguments),this.visible?null!=this.hitEvent&&(this.map.mapDiv[0].addEventListener("click",this.hitEvent),this.map.mapDiv[0].addEventListener("mousemove",this.moveEvent)):null!=this.hitEvent&&(this.map.mapDiv[0].removeEventListener("click",this.hitEvent),this.map.mapDiv[0].removeEventListener("mousemove",this.moveEvent))},getTipInfo:function(e){for(var t=null,i=null,a=null,n=null,l=this.chartOption.type,r=this.tipInfos.length;r>=0;r--)if(t=this.tipInfos[r],null!=t)if("point"==l){a=t.center,n=t.radius;var s=Math.sqrt((a.x-e.x)*(a.x-e.x)+(a.y-e.y)*(a.y-e.y));if(s<n)return t}else if("tip"==l&&(i=t.viewer,i.contain(e.x,e.y)))return t;return null},drawByValue:function(){if(null!=this.features&&null!=this.chartOption&&null!=this.colorMap&&null!=this.minMaxValue){var e=this.featureType.getFieldIndex(this.chartField),t=this.featureType.getFieldIndex(this.labelField),i=this.featureType.getFieldIndex(this.flagField),a=.8,n=this.features,l=null,r=null,s=null,o=null,h=null,u=null,d=null;this.renderer.save(),this.tipInfos=[];for(var m=0;m<n.length;++m)if(r=n[m],null!=r&&(l=r.geometry,null!=l&&(s=r.values,null!=s))){o=s[e],o=parseFloat(o),h=o/10,u=this.colorFunctionByColorMap(o),d=new GeoBeans.Color,d.setByHex(u,a),this.renderer.context.fillStyle=d.getRgba(),spt=this.map.transformation.toScreenPoint(l.x,l.y),this.renderer.context.beginPath(),this.renderer.context.arc(spt.x,spt.y,h,0,2*Math.PI),this.renderer.context.fill(),this.renderer.context.closePath();var p=s[i],c=s[t],f={flag:p,center:spt,radius:h,name:c};this.tipInfos.push(f)}this.renderer.restore()}},colorFunctionByColorMap:function(e){var t=this.minMaxValue,i=t.min,a=t.max,n=(this.colorMap,this.colorMap.startColor),l=this.colorMap.endColor;if(e<i)return n;if(e>a)return l;var r=new GeoBeans.Color;r.setByHex(n,1);var s=r.getHsl(),o=new GeoBeans.Color;o.setByHex(l,1);var h=o.getHsl(),u=s.h+(e-i)*(h.h-s.h)/(a-i),d=s.s+(e-i)*(h.s-s.s)/(a-i),m=s.l+(e-i)*(h.l-s.l)/(a-i),p=new GeoBeans.Color;return p.setByHsl(u,d,m),p.getHex()}});
GeoBeans.Layer.AQITimelineLayer=GeoBeans.Class(GeoBeans.Layer.ChartLayer,{chartField:null,labelField:null,timePoints:null,styleMgr:null,flagField:null,timeField:null,chartLayers:null,interval:null,currentLayerID:null,timeline:null,initialize:function(e,t,i,a,n,s,h,l,r,d){this.name=e,this.dbName=t,this.tableName=i,this.chartField=a,this.labelField=n,this.flagField=s,this.timeField=h,this.timePoints=l,this.interval=r,this.chartOption=d,this.chartLayers=[],this.type=GeoBeans.Layer.ChartLayer.Type.AQITIMELINE},setMap:function(e){GeoBeans.Layer.prototype.setMap.apply(this,arguments);for(var t=null,i=0;i<this.timePoints.length;++i)if(t=this.timePoints[i],null!=t){var a=new GeoBeans.Layer.AQIChartLayer("aqi-timline",this.dbName,this.tableName,this.chartField,this.labelField,this.flagField,this.timeField,t,this.chartOption);a.setMap(this.map,!0),this.chartLayers.push(a)}this.currentLayerID=0,this.timeline=new GeoBeans.TimeLineBar(this),e._addLegend(this),this.chartLayers.length>0&&(this.colorMap=this.chartLayers[0].colorMap)},cleanup:function(){GeoBeans.Layer.ChartLayer.prototype.cleanup.apply(this,arguments),this.timeline.cleanup();for(var e=0;e<this.chartLayers.length;++e)this.chartLayers[e].cleanup()},load:function(){if(null==this.minMaxValue&&(this.minMaxValue=this.getMinMaxValue()),this.drawLegend(),null==this.chartLayers)return void(this.flag=GeoBeans.Layer.Flag.LOADED);this.setTransformation(this.map.transformation),this.drawLayerSnap(),this.renderer.clearRect();var e=this.chartLayers,t=e[this.currentLayerID];if(null!=t){t.load();var i=t.canvas;null!=i&&t.flag==GeoBeans.Layer.Flag.LOADED&&this.renderer.drawImage(i,0,0,i.width,i.height)}this.flag=GeoBeans.Layer.Flag.LOADED},drawLegend:function(){if(0!=this.chartLayers.length){var e=this.chartLayers[0];if(e.changeLegend)this.removeLegend(),this.addLegend(),e.changeLegend=!1;else{var t=this.map.mapDiv.find(".chart-legend#"+this.name),i=parseInt(t.attr("lindex"));i!=this.legendIndex&&(this.removeLegend(),this.addLegend())}return this.visible?void this.showLegend():void this.hideLegend()}},getChartField:function(){return this.chartField},getTimePoints:function(){return this.timePoints},setTimePoints:function(e){this.timePoints=e;for(var t=0;t<this.chartLayers.length;++t){var i=this.chartLayers[t];null!=i&&i.cleanup()}this.chartLayers=[];for(var t=0;t<this.timePoints.length;++t)if(timePoint=this.timePoints[t],null!=timePoint){var i=new GeoBeans.Layer.AQIChartLayer(this.name,this.dbName,this.tableName,this.chartField,this.labelField,this.flagField,this.timeField,timePoint,this.chartOption);i.setMap(this.map),this.chartLayers.push(i)}this.currentLayerID=0,this.timeline.cleanup(),this.timeline=new GeoBeans.TimeLineBar(this)},setChartOption:function(e){this.chartOption=e;for(var t=null,i=0;i<this.chartLayers.length;++i)t=this.chartLayers[i],null!=t&&(t.features=null,t.changeLegend=!0,t.setChartOption(e))},setChartField:function(e){this.chartField=e;for(var t=0;t<this.chartLayers.length;++t)layer=this.chartLayers[t],null!=layer&&(layer.features=null,layer.changeLegend=!0,layer.setChartField(e))},getInterval:function(){return this.interval},setInterval:function(e){this.interval=e,this.timeline.cleanup(),this.timeline=new GeoBeans.TimeLineBar(this)},setVisiable:function(e){GeoBeans.Layer.prototype.setVisiable.apply(this,arguments),this.visible?this.timeline.show():this.timeline.hide()},getMinMaxValue:function(){return this.chartLayers.length>0?this.chartLayers[0].getMinMaxValue():null},addLegend:function(){if(null!=this.minMaxValue&&null!=this.minMaxValue.min&&null!=this.minMaxValue.max){var e=0;if(0==this.legendIndex)e=10;else{var t=this.legendIndex-1,i=this.map.mapDiv.find(".chart-legend[lindex='"+t+"']");if(0!=i.length){var a=i.css("left"),n=i.css("width");a=parseInt(a.replace("px","")),n=parseInt(n.replace("px","")),e=a+n+5}}var s="",s="<div class='chart-legend chart-legend-aqi' id='"+this.name+"' style='left:"+e+"px' lindex='"+this.legendIndex+"'>";s+="<div class='chart-legend-title'><h5>"+this.chartField+"</h5></div>",s+="<div class='chart-legend-canvas'>\t<canvas width='20' height='200'></canvas></div><div class='chart-legend-value'><div class='chart-legend-max'>"+this.minMaxValue.max+"</div><div class='chart-legend-min'>"+this.minMaxValue.min+"</div></div>",s+="</div>",this.map.mapDiv.append(s);var h=this.map.mapDiv.find("#"+this.name+" .chart-legend-canvas canvas"),l=h[0].getContext("2d"),r=new Image;r.src=this.colorMap.url,r.onload=function(){var e=h.width()/2,t=h.height()/2,i=r.width,a=r.height;l.clearRect(0,0,i,a),l.translate(e,t),l.rotate(270*Math.PI/180),l.drawImage(r,-i/2,-a/2,i,a),l.rotate(-270*Math.PI/180),l.translate(-e,-t)}}}});
GeoBeans.Layer.BarChartLayer=GeoBeans.Class(GeoBeans.Layer.ChartLayer,{minMax:null,chartOption:null,initialize:function(t,e,a,i,n,s,r,l){GeoBeans.Layer.ChartLayer.prototype.initialize.apply(this,arguments),this.chartOption=l,this.type=GeoBeans.Layer.ChartLayer.Type.BAR},setMap:function(t){GeoBeans.Layer.ChartLayer.prototype.setMap.apply(this,arguments),t._addLegend(this)},load:function(){this.visible?(this.removeLegend(),this.addLegend(),this.showLegend()):(this.removeLegend(),this.hideLegend()),this.minMax=this.getMinMaxValue();var t=this;this.flag=GeoBeans.Layer.Flag.READY,t.setTransformation(t.map.transformation),t.drawLayerSnap(),t.renderer.clearRect(),this.drawLayer(),t.flag=GeoBeans.Layer.Flag.LOADED},drawLayer:function(){if(null!=this.chartFeatures){var t=null,e=null,a=null,i=null,n=null;this.renderer.save(),this.renderer.setGlobalAlpha(this.chartOption.opacity);for(var s=0;s<this.chartFeatures.length;++s)if(t=this.chartFeatures[s],null!=t&&(geometry=t.geometry,null!=geometry&&geometry.type==GeoBeans.Geometry.Type.POINT&&(e=t.values,null!=e))){var r=[],l=null,h=null,o=document.createElement("canvas"),p=o.getContext("2d");p.font="12px Arial, Verdana, sans-seri";for(var d=this.chartFields.length,c=0;c<d;++c)if(i=this.chartFields[c],null!=i){var u=this.chartFeatureType.getFieldIndex(i);if(u!=-1){a=parseFloat(e[u]);var m=new Object;m.name=i,m.type="bar",m.data=[a];var y=p.measureText(e[u]).width;h=null==h?y:h>y?h:y,m.itemStyle={normal:{label:{show:this.chartOption.showLabel,position:"top"}}},r.push(m),l=null==l?a:a>l?a:l}}var g=10,x=10;h>this.chartOption.width&&(g=h-this.chartOption.width/d/2,x=h-this.chartOption.width/d/2);var v={top:26,bottom:12,left:g,right:x};n={grid:{x:v.left+"px",y:v.top+"px",x2:v.right+"px",y2:v.bottom+"px",width:this.chartOption.width+"px",borderWidth:0},xAxis:[{type:"category",data:[""],splitLine:{show:this.chartOption.x_splitLine},axisLabel:{show:!1},axisTick:{show:!1},axisLine:{show:this.chartOption.x_axisLine}}],yAxis:[{min:this.minMax.min,max:l,splitLine:{show:this.chartOption.y_splitLine},axisLabel:{show:!1},axisTick:{show:!1},axisLine:{show:this.chartOption.y_axisLine}}],color:this.chartOption.colors,series:r,animation:!1,calculable:!1};var f=this.chartOption.height,L=this.chartOption.width,w=parseFloat(v.top)+parseFloat(v.bottom),O=l/this.minMax.max*f+w,F=v.left+v.right,b=L+F,B="bar_chart_"+this.name+s,G="<div class='chart-div' style='height: "+O+"px; width:"+b+"px' id='"+B+"'></div>";this.map.mapDiv.append(G);var I=echarts.init(document.getElementById(B));I.setOption(n);var M=$("#"+B).find("canvas").first(),T=M.width(),_=M.height(),A=geometry.x,C=geometry.y,D=this.map.transformation.toScreenPoint(A,C),E=D.x-T/2+this.chartOption.offsetX,k=D.y-O+v.bottom-this.chartOption.offsetY;this.renderer.drawImage(M[0],E,k,T,_),I.dispose()}var R="bar_chart_"+this.name;$("*[id*='"+R+"']").remove(),this.renderer.restore()}},getMinMaxValue:function(){for(var t=null,e=null,a=null,i=null,n=null,s=null,r=null,l=0;l<this.chartFields.length;++l)if(a=this.chartFields[l],null!=a&&(r=this.chartFeatureType.getFieldIndex(a),r!=-1)){for(var h=null,o=null,p=0;p<this.chartFeatures.length;++p)i=this.chartFeatures[p],null!=i&&(n=i.values,null!=n&&(s=parseFloat(n[r]),h=null==h?s:s>h?s:h,o=null==o?s:s<o?s:o));t=null==t?h:h>t?h:t,e=null==e?o:o<e?o:e}return{min:e,max:t}},addLegend:function(){if(null!=this.chartOption){var t=0;if(0==this.legendIndex)t=10;else{var e=this.legendIndex-1,a=this.map.mapDiv.find(".chart-legend[lindex='"+e+"']");if(0!=a.length){var i=a.css("left"),n=a.css("width");i=parseInt(i.replace("px","")),n=parseInt(n.replace("px","")),t=i+n+5}}var s="<div class='chart-legend' id='"+this.name+"' style='left:"+t+"px' lindex='"+this.legendIndex+"'>";s+="<div class='chart-legend-title'><h5>"+this.name+"</h5></div>";for(var r=null,l=null,h=this.chartOption.colors,o=0;o<this.chartFields.length;++o)r=this.chartFields[o],null!=r&&(l=h[o],s+="<div>\t<span class='chart-legend-symbol' style='background-color:"+l+"'></span>\t<span class='chart-legend-label'>"+r+"</span></div>");s+="</div>",this.map.mapDiv.append(s)}}});
GeoBeans.Layer.PieChartLayer=GeoBeans.Class(GeoBeans.Layer.ChartLayer,{chartOption:null,initialize:function(t,e,a,i,r,s,n,h){GeoBeans.Layer.ChartLayer.prototype.initialize.apply(this,arguments),this.chartOption=h,this.type=GeoBeans.Layer.ChartLayer.Type.PIE},setMap:function(t){GeoBeans.Layer.ChartLayer.prototype.setMap.apply(this,arguments),t._addLegend(this)},setChartOption:function(t){this.chartOption=t,this.chartFeatures=this.getChartFeatures()},getChartOption:function(){return this.chartOption},load:function(){this.removeLegend(),this.addLegend(),this.visible?this.showLegend():this.hideLegend(),this.flag=GeoBeans.Layer.Flag.READY,this.setTransformation(this.map.transformation),this.drawLayerSnap(),this.renderer.clearRect(),this.drawLayer(),this.flag=GeoBeans.Layer.Flag.LOADED},drawLayer:function(){if(null!=this.chartFeatures){var t=null,e=null,a=null,i=null,r=null,s=80,n=[],h=0,l=0,o=!1,p=1;null!=this.chartOption&&(null!=this.chartOption.radius&&(s=this.chartOption.radius),null!=this.chartOption.colors&&(n=this.chartOption.colors),null!=this.chartOption.offsetX&&(h=this.chartOption.offsetX),null!=this.chartOption.offsetY&&(l=this.chartOption.offsetY),null!=this.chartOption.showLabel&&(o=this.chartOption.showLabel),null!=this.chartOption.opacity&&(p=this.chartOption.opacity)),this.renderer.save(),this.renderer.setGlobalAlpha(p);for(var c=0;c<this.chartFeatures.length;++c)if(t=this.chartFeatures[c],null!=t&&(geometry=t.geometry,null!=geometry&&geometry.type==GeoBeans.Geometry.Type.POINT&&(e=t.values,null!=e))){var d=[],u=document.createElement("canvas"),y=u.getContext("2d");y.font="12px Arial, Verdana, sans-seri";for(var g=null,f=0;f<this.chartFields.length;++f)if(i=this.chartFields[f],null!=i){var v=this.chartFeatureType.getFieldIndex(i);if(v!=-1){a=e[v];var m=new Object;m.name=a,m.value=[parseFloat(a)],d.push(m);var O=y.measureText(a).width;g=null==g?O:g>O?g:O}}var r={series:[{type:"pie",radius:this.chartOption.radius+"px",center:["50%","50%"],data:d,itemStyle:{normal:{label:{show:this.chartOption.showLabel,position:"outer"},labelLine:{show:this.chartOption.showLabel,length:0}}}}],animation:!1,calculable:!1,color:n},L=2*this.chartOption.radius+2*g+52,x=2*this.chartOption.radius+40,w="pie_chart_"+this.name+c,F="<div class='chart-div' style='height: "+x+"px; width:"+L+"px' id='"+w+"'></div>";this.map.mapDiv.append(F);var b=echarts.init(document.getElementById(w));b.setOption(r);var G=$("#"+w).find("canvas").first(),B=G.width(),C=G.height(),I=geometry.x,D=geometry.y,T=this.map.transformation.toScreenPoint(I,D),E=T.x-L/2+h,_=T.y-x/2-l;this.renderer.drawImage(G[0],E,_,B,C),b.dispose()}var A="pie_chart_"+this.name;$("*[id*='"+A+"']").remove(),this.renderer.restore()}},addLegend:function(){if(null!=this.chartOption){var t=0;if(0==this.legendIndex)t=10;else{var e=this.legendIndex-1,a=this.map.mapDiv.find(".chart-legend[lindex='"+e+"']");if(null!=a){var i=a.css("left"),r=a.css("width");i=parseInt(i.replace("px","")),r=parseInt(r.replace("px","")),t=i+r+5}}var s="<div class='chart-legend' id='"+this.name+"' style='left:"+t+"px' lindex='"+this.legendIndex+"'>";s+="<div class='chart-legend-title'><h5>"+this.name+"</h5></div>";for(var n=null,h=null,l=this.chartOption.colors,o=0;o<this.chartFields.length;++o)n=this.chartFields[o],null!=n&&(h=l[o],s+="<div>\t<span class='chart-legend-symbol' style='background-color:"+h+"'></span>\t<span class='chart-legend-label'>"+n+"</span></div>");s+="</div>",this.map.mapDiv.append(s)}}});
GeoBeans.Layer.RangeChartLayer=GeoBeans.Class(GeoBeans.Layer.ChartLayer,{chartOption:null,style:null,styleMgr:null,colors:null,minMaxValue:null,labelLayerName:null,labelLayerField:null,changeLegend:!0,initialize:function(e,t,a,l,i,n,r,s,h,o){GeoBeans.Layer.ChartLayer.prototype.initialize.apply(this,arguments),this.chartOption=s,this.type=GeoBeans.Layer.ChartLayer.Type.RANGE,this.labelLayerName=h,this.labelLayerField=o},cleanup:function(){GeoBeans.Layer.ChartLayer.prototype.cleanup.apply(this,arguments),this.unRegisterHitEvent()},setVisiable:function(e){GeoBeans.Layer.prototype.setVisiable.apply(this,arguments),this.visible?null==this.hitEvent&&this.registerHitEvent(this.onFeatureHit):null!=this.hitEvent&&this.unRegisterHitEvent()},setChartOption:function(e){GeoBeans.Layer.ChartLayer.prototype.setChartOption.apply(this,arguments),this.style=this.getStyle(),this.changeLegend=!0,this.flag=GeoBeans.Layer.Flag.READY},setChartFields:function(e){this.chartFields=e,this.changeLegend=!0},setMap:function(e){GeoBeans.Layer.prototype.setMap.apply(this,arguments),this.getFeatures();var t=this.map.server.slice(0,this.map.server.lastIndexOf("/mgr"));this.styleMgr=new GeoBeans.StyleManager(t),this.registerHitEvent(this.onFeatureHit),e._addLegend(this)},onFeatureHit:function(e,t,a){if(console.log(t.length),"pointer"==document.body.style.cursor)return void e.map.closeInfoWindow();if(0==t.length)e.map.closeInfoWindow();else{var l=t[0],i=l.chartValue,n=e.featureType;if(null==n)return;var r=l.values;if(null==r)return;var s=n.getFieldIndex(e.baseLayerField),h=r[s];null==i&&(i="空");var o="<div>"+i+"</div>",u={title:h,width:100,height:40},d=new GeoBeans.InfoWindow(o,u);e.map.openInfoWindow(d,a)}},getChartFeatureValue:function(e){for(var t=this.chartFields[0],a=this.chartFeatureType.getFieldIndex(t),l=this.tableField,i=this.chartFeatureType.getFieldIndex(l),n=null,r=0;r<this.chartFeatures.length;++r)if(n=this.chartFeatures[r],null!=n){var s=n.gid;if(s==e){var h=n.values;if(null!=h){var o=h[a],u=h[i];return{value:o,table:u}}}}return""},load:function(){var e=this.map.viewer;if(null!=e&&null!=this.viewer&&e.equal(this.viewer)&&null!=this.features&&this.flag==GeoBeans.Layer.Flag.LOADED)return void this.drawLegend();this.viewer=new GeoBeans.Envelope(e.xmin,e.ymin,e.xmax,e.ymax),null==this.style&&(this.style=this.getStyle());var t=this;t.flag=GeoBeans.Layer.Flag.READY,t.setTransformation(t.map.transformation),t.drawLayerSnap(),t.drawLegend(),t.renderer.clearRect();new Date;t.drawLayer(),t.flag=GeoBeans.Layer.Flag.LOADED},drawLegend:function(){this.changeLegend?(this.removeLegend(),this.addLegend(),this.changeLegend=!1):this.decideDrawLegend()},decideDrawLegend:function(){var e=this.map.mapDiv.find(".chart-legend#"+this.name),t=parseInt(e.attr("lindex"));t!=this.legendIndex&&(this.removeLegend(),this.addLegend())},addLegend:function(){if(null!=this.minMaxValue&&null!=this.minMaxValue.min&&null!=this.minMaxValue.max){var e="",t=(this.map.mapDiv.find(".chart-legend"),0);if(0==this.legendIndex)t=10;else{var a=this.legendIndex-1,l=this.map.mapDiv.find(".chart-legend[lindex='"+a+"']"),i=l.css("left"),n=l.css("width");i=parseInt(i.replace("px","")),n=parseInt(n.replace("px","")),t=i+n+5}var e="<div class='chart-legend chart-legend-range' id='"+this.name+"' style='left:"+t+"px' lindex='"+this.legendIndex+"'>";e+="<div class='chart-legend-title'><h5>"+this.chartFields[0]+"</h5></div>",e+="<div class='chart-legend-canvas'>\t<canvas width='20' height='200'></canvas></div><div class='chart-legend-value'><div class='chart-legend-max'>"+this.minMaxValue.max+"</div><div class='chart-legend-min'>"+this.minMaxValue.min+"</div></div>",e+="</div>",this.map.mapDiv.append(e);var r=this.map.mapDiv.find("#"+this.name+" .chart-legend-canvas canvas"),s=r[0].getContext("2d"),h=new Image;h.src=this.colorMap.url,h.onload=function(){var e=r.width()/2,t=r.height()/2,a=h.width,l=h.height;s.clearRect(0,0,a,l),s.translate(e,t),s.rotate(270*Math.PI/180),s.drawImage(h,-a/2,-l/2,a,l),s.rotate(-270*Math.PI/180),s.translate(-e,-t)}}},getChartStyle:function(){if(null==this.chartFeatures||null==this.chartOption)return null;var e=this.getMinMaxValue();if(null==e)return null;this.minMaxValue=e;var t=this.chartFeatures.length,a=this.chartOption.colorMapID,l=this.styleMgr.getColorMapByID(a);this.colorMap=l;for(var i=new GeoBeans.ColorRangeMap(this.colorMap.startColor,this.colorMap.endColor,e.min,e.max),n=this.chartFields[0],r=this.chartFeatureType.getFieldIndex(n),s=this.tableField,h=this.chartFeatureType.getFieldIndex(s),o=new GeoBeans.Style.FeatureStyle("chart",GeoBeans.Style.FeatureStyle.GeomType.Polygon),u=[],d=null,c=0;c<t;++c)if(d=this.chartFeatures[c],null!=d){var p=d.values;if(null!=p){var y=p[r];if(y=parseFloat(y),null!=y){var g=p[h],v=i.getValue(y),f=new GeoBeans.Symbolizer.PolygonSymbolizer;null!=this.chartOption.opacity?v.setOpacity(this.chartOption.opacity):v.setOpacity(1),f.fill.color=v,v=new GeoBeans.Color,null!=this.chartOption.border&&v.setByHex(this.chartOption.border,1),null!=this.chartOption.borderOpacity?v.setOpacity(this.chartOption.borderOpacity):v.setOpacity(1),f.stroke.color=v;var m=new GeoBeans.IDFilter;m.addID(d.gid);var v=new GeoBeans.Color,F=new GeoBeans.Fill;F.color=v;var L=new GeoBeans.Rule;L.filter=m,L.name=g,L.symbolizer=f,u.push(L)}}}return o.rules=u,o},getLabelLayer:function(){var e=this.map.getLayer(this.labelLayerName);if(null==e)return null;var t=e.featureType,a=t.geomFieldName,l=[this.labelLayerField,a],i=t.getFeaturesFilter(this.map.name,null,null,null,null,l),n=t.getFieldIndex(this.labelLayerField),r=null,s=this.chartFeatureType.getFieldIndex(this.tableField),h=this.chartFeatureType.getFieldIndex(this.chartFields[0]),o=new GeoBeans.Layer.FeatureLayer("label");o.features=[];for(var u=new GeoBeans.Style.FeatureStyle("label",GeoBeans.Style.FeatureStyle.GeomType.Point),d=[],c=0;c<i.length;++c)if(r=i[c],null!=r){var p=r.values;if(null!=p)for(var y=p[n],g=0;g<this.chartFeatures.length;++g){var v=this.chartFeatures[g];if(null!=v){var f=v.values;if(null!=f){var m=f[s];if(m==y){o.addFeature(r);var F=f[h],L=new GeoBeans.Rule,w=new GeoBeans.Symbolizer.TextSymbolizer;w.labelText=F;var B=new GeoBeans.Font;B.family="SimSun",B.style="normal",B.weight="normal",B.size="18",w.font=B;var x=new GeoBeans.Color;x.setByHex("#f500c0",1);var b=new GeoBeans.Fill;b.color=x,w.fill=b,w.stroke=null;var G=new GeoBeans.IDFilter;G.addID(r.fid),L.textSymbolizer=w,L.filter=G,d.push(L)}}}}}return u.rules=d,o.style=u,o},getFeatures:function(){if(null!=this.baseLayerName&&null!=this.baseLayerField&&null!=this.dbName&&null!=this.tableName&&null!=this.tableField){var e=this.map.getLayer(this.baseLayerName);if(null!=e){var t=new GeoBeans.WFSWorkspace("tmp",this.map.server,"1.0.0"),a=new GeoBeans.FeatureType(t,this.tableName);this.chartFeatureType=a;var l=(a.getFields(null,this.dbName),a.getFeaturesFilter(null,this.dbName,null,null,null,[this.tableField].concat(this.chartFields))),i=a.getFieldIndex(this.tableField);if(i!=-1){var n=a.getFieldIndex(this.chartFields[0]),r=e.getFeatureType(),s=r.geomFieldName,h=[this.baseLayerField,s],o=r.getFeaturesFilter(this.map.name,null,null,null,null,h),u=(e.getFields(),r.getFieldIndex(this.baseLayerField));if(u!=-1){for(var d=0;d<o.length;++d){var c=o[d];if(null!=c){var p=c.values;if(null!=p)for(var y=p[u],g=0;g<l.length;++g){var v=l[g];if(null!=v){var f=v.values;if(null!=f){var m=f[i];if(y==m){var F=f[n];c.chartValue=F}}}}}}this.features=o,this.featureType=r}}}}},getStyle:function(){if(null==this.features||null==this.chartOption)return null;var e=this.getMinMaxValue();if(null==e)return null;this.minMaxValue=e;var t=this.features.length,a=this.chartOption.colorMapID,l=this.styleMgr.getColorMapByID(a);this.colorMap=l;for(var i=new GeoBeans.ColorRangeMap(this.colorMap.startColor,this.colorMap.endColor,e.min,e.max),n=new GeoBeans.Style.FeatureStyle("chart",GeoBeans.Style.FeatureStyle.GeomType.Polygon),r=[],s=0;s<t;++s){var h=this.features[s];if(null!=h){var o=h.chartValue,u=new GeoBeans.Symbolizer.PolygonSymbolizer,d=null;null==o?(d=new GeoBeans.Color,d.setByHex("#ffffff",1)):(o=parseFloat(o),d=i.getValue(o)),null!=this.chartOption.opacity?d.setOpacity(this.chartOption.opacity):d.setOpacity(1),u.fill.color=d,d=new GeoBeans.Color,null!=this.chartOption.border&&d.setByHex(this.chartOption.border,1),null!=this.chartOption.borderOpacity?d.setOpacity(this.chartOption.borderOpacity):d.setOpacity(1),u.stroke.color=d,u.stroke.width=.6;var c=new GeoBeans.IDFilter;c.addID(h.fid);var d=new GeoBeans.Color,p=new GeoBeans.Fill;p.color=d;var y=new GeoBeans.Rule;y.filter=c,y.name=o,y.symbolizer=u,r.push(y)}}return n.rules=r,n},getMinMaxValue:function(){if(null==this.features)return null;for(var e=null,t=null,a=null,l=0;l<this.features.length;++l)if(a=this.features[l],null!=a){var i=a.chartValue;null!=i&&(i=parseFloat(i),e=null==e?i:i<e?i:e,t=null==t?i:i>t?i:t)}return{min:e,max:t}}});
GeoBeans.Layer.RangeSymbolChartLayer=GeoBeans.Class(GeoBeans.Layer.ChartLayer,{rangeBaseLayerName:null,rangeBaseLayerField:null,rangeChartField:null,rangeOption:null,symbolBaseLayerName:null,symbolBaseLayerField:null,symbolChartField:null,symbolOption:null,style:null,maxSymbolRadius:30,levelMap:null,legendPadding:4,initialize:function(e,l,a,t,i,n,s,r,h,o,d,u){GeoBeans.Layer.prototype.initialize.apply(this,arguments),this.name=e,this.rangeBaseLayerName=l,this.rangeBaseLayerField=a,this.rangeChartField=t,this.symbolBaseLayerName=i,this.symbolBaseLayerField=n,this.symbolChartField=s,this.dbName=r,this.tableName=h,this.tableField=o,this.chartFields=[this.rangeChartField,this.symbolChartField],this.rangeOption=d,this.symbolOption=u,this.type=GeoBeans.Layer.ChartLayer.Type.RANGESYMBOL},cleanup:function(){this.rangeBaseLayerName=null,this.rangeBaseLayerField=null,this.rangeChartField=null,this.rangeOption=null,this.symbolBaseLayerName=null,this.symbolBaseLayerField=null,this.symbolChartField=null,this.symbolOption=null,this.style=null,this.maxSymbolRadius=null,this.levelMap=null,this.legendPadding=null,GeoBeans.Layer.ChartLayer.prototype.cleanup.apply(this,arguments),this.unRegisterHitEvent()},setMap:function(e){GeoBeans.Layer.prototype.setMap.apply(this,arguments),this.getFeatures();var l=this.map.server.slice(0,this.map.server.lastIndexOf("/mgr"));this.styleMgr=new GeoBeans.StyleManager(l),this.registerHitEvent(this.onFeatureHit),e._addLegend(this)},setVisiable:function(e){GeoBeans.Layer.prototype.setVisiable.apply(this,arguments),this.visible?null==this.hitEvent&&this.registerHitEvent(this.onFeatureHit):null!=this.hitEvent&&this.unRegisterHitEvent()},load:function(){var e=this.map.viewer;return null!=e&&null!=this.viewer&&e.equal(this.viewer)&&null!=this.features&&this.flag==GeoBeans.Layer.Flag.LOADED?void this.decideDrawLegend():(this.viewer=new GeoBeans.Envelope(e.xmin,e.ymin,e.xmax,e.ymax),this.renderer.clearRect(),this.drawRangChart(),this.drawSymbolChart(),this.flag==GeoBeans.Layer.Flag.READY?this.drawLegend():this.decideDrawLegend(),void(this.flag=GeoBeans.Layer.Flag.LOADED))},decideDrawLegend:function(){var e=this.map.mapDiv.find(".chart-legend#"+this.name),l=parseInt(e.attr("lindex"));l!=this.legendIndex&&(this.removeLegend(),this.drawLegend())},drawLegend:function(){null!=this.minMax&&null!=this.rangeOption&&null!=this.symbolOption&&(console.log("draw legend"),this.removeLegend(),this.drawRangeLegend(),this.drawSymbolLegend(),this.resizeLegend())},getFeatures:function(){if(null!=this.rangeBaseLayerName&&null!=this.rangeBaseLayerField&&null!=this.symbolBaseLayerName&&null!=this.symbolBaseLayerField&&null!=this.dbName&&null!=this.tableName&&null!=this.tableField){var e=new GeoBeans.WFSWorkspace("tmp",this.map.server,"1.0.0"),l=new GeoBeans.FeatureType(e,this.tableName);l.getFields(null,this.dbName);var a=l.getFieldIndex(this.tableField);if(a!=-1){var t=l.getFeaturesFilter(null,this.dbName,null,null,null,[this.tableField].concat(this.chartFields)),i=this.map.getLayer(this.rangeBaseLayerName),n=i.getFeatureType(),s=n.getFieldIndex(this.rangeBaseLayerField);if(s!=-1){var r=n.geomFieldName,h=[this.rangeBaseLayerField,r],o=n.getFeaturesFilter(this.map.name,null,null,null,null,h),d=this.map.getLayer(this.symbolBaseLayerName),u=d.getFeatureType(),m=u.getFieldIndex(this.symbolBaseLayerField);if(m!=-1){for(var y=u.geomFieldName,h=[this.symbolBaseLayerField,y],g=u.getFeaturesFilter(this.map.name,null,null,null,null,h),p=l.getFieldIndex(this.rangeChartField),c=l.getFieldIndex(this.symbolChartField),v=null,f=null,b=null,L=null,F=null,B=null,x=null,w=null,G=null,O=null,S=null,M=null,C=null,R=null,D=null,I=0;I<o.length;++I)if(v=o[I],null!=v&&(f=v.values,null!=f)){x=f[s];for(var z=0;z<g.length;++z)if(b=g[z],null!=b&&(L=b.values,null!=L&&(w=L[m],x==w))){v.symbolGeomtry=b.geometry;for(var N=0;N<t.length;++N)if(F=t[N],null!=F&&(B=F.values,null!=B&&(G=B[a],G==x))){O=B[p],S=B[c],O=parseFloat(O),S=parseFloat(S),v.rValue=O,v.sValue=S,M=null==M?O:M<O?M:O,null==C?C=O:(C=C>O?C:O,rmax=O),R=null==R?S:R<S?R:S,D=null==D?S:D>S?D:S;break}break}v.tValue=x}this.features=o,this.minMax={range:{min:M,max:C},symbol:{min:R,max:D}}}}}}},drawRangChart:function(){this.style=this.getRangeStyle(),null!=this.style&&this.drawLayer()},getRangeStyle:function(){if(null==this.features||null==this.rangeOption||null==this.minMax)return null;var e=this.features.length,l=this.rangeOption.colorMapID,a=this.styleMgr.getColorMapByID(l);this.colorMap=a;for(var t=this.minMax.range,i=new GeoBeans.ColorRangeMap(this.colorMap.startColor,this.colorMap.endColor,t.min,t.max),n=new GeoBeans.Style.FeatureStyle("chart",GeoBeans.Style.FeatureStyle.GeomType.Polygon),s=[],r=0;r<e;++r){var h=this.features[r];if(null!=h){var o=h.rValue,d=new GeoBeans.Symbolizer.PolygonSymbolizer,u=null;null==o?(u=new GeoBeans.Color,u.setByHex("#ffffff",1)):(o=parseFloat(o),u=i.getValue(o)),null!=this.rangeOption.opacity?u.setOpacity(this.rangeOption.opacity):u.setOpacity(1),d.fill.color=u,u=new GeoBeans.Color,null!=this.rangeOption.border&&u.setByHex(this.rangeOption.border,1),null!=this.rangeOption.borderOpacity?u.setOpacity(this.rangeOption.borderOpacity):u.setOpacity(1),d.stroke.color=u;var m=new GeoBeans.IDFilter;m.addID(h.fid);var u=new GeoBeans.Color,y=new GeoBeans.Fill;y.color=u;var g=new GeoBeans.Rule;g.filter=m,g.name=o,g.symbolizer=d,s.push(g)}}return n.rules=s,n},drawSymbolChart:function(){if(null!=this.minMax&&null!=this.symbolOption&&null!=this.features){var e=this.symbolOption.byLevel;e?this.drawSymbolLayerByLevel():this.drawSymbolLayerByValue()}},drawSymbolLayerByLevel:function(){if(null!=this.features&&null!=this.minMax&&null!=this.symbolOption){var e=this.symbolOption.level,l=this.minMax.symbol,a=l.min,t=l.max,i=this.symbolOption.maxsize,n=this.getSymbolizer();this.renderer.setSymbolizer(n);var s=null,r=null,h=null,o=null,d=this.getLevelMap(i,e,a,t);this.levelMap=d;for(var u=0;u<this.features.length;++u)feature=this.features[u],null!=feature&&(s=feature.sValue,r=feature.symbolGeomtry,h=this.getRadiusByLevelMap(parseFloat(s),d),o=new GeoBeans.Geometry.Circle(r,h),feature.circle=o,this.renderer.drawGeometry(o,n,this.map.transformation))}},getLevelMap:function(e,l,a,t){if(null!=e&&null!=l&&null!=a&&null!=t){for(var i=(t-a)/l,n=[],s=0;s<l;++s){var r=a+s*i,h=a+(s+1)*i,o=Math.pow(1.2,s+1-l)*e,d={min:r,max:h,radius:o};n.push(d)}return n}},drawSymbolLayerByValue:function(){if(null!=this.minMax&&null!=this.features&&null!=this.symbolOption){var e=this.minMax.symbol,l=(e.min,e.max),a=this.getSymbolizer();this.renderer.setSymbolizer(a);for(var t=null,i=null,n=null,s=null,r=null,h=0;h<this.features.length;++h)t=this.features[h],null!=t&&(i=t.sValue,null!=i&&(n=t.symbolGeomtry,s=parseFloat(i)/l*this.symbolOption.maxsize,r=new GeoBeans.Geometry.Circle(n,s),t.circle=r,this.renderer.drawGeometry(r,a,this.map.transformation)))}},getSymbolizer:function(){var e=new GeoBeans.Symbolizer.PolygonSymbolizer,l=this.symbolOption.color;null!=l&&e.fill.color.setByHex(l,1);var a=this.symbolOption.opacity;null!=a?e.fill.color.setOpacity(a):e.fill.color.setOpacity(1);var t=this.symbolOption.border;null!=t&&e.stroke.color.setByHex(t,1);var i=this.symbolOption.borderOpacity;return null!=i?e.stroke.color.setOpacity(i):e.stroke.color.setOpacity(1),e},getRadiusByLevelMap:function(e,l){if(null==e||null==l)return null;for(var a=null,t=null,i=null,n=0;n<l.length;++n)if(a=l[n],null!=a){if(t=a.min,i=a.max,0==n&&e==t)return a.radius;if(t<e&&i>=e)return a.radius}return null},onFeatureHit:function(e,l,a){if("pointer"==document.body.style.cursor)return void e.map.closeInfoWindow();if(0==l.length)e.map.closeInfoWindow();else{var t=l[0];if(null==t)return;var i=t.tValue,n=t.rValue,s=t.sValue,r=e.rangeChartField,h=e.symbolChartField,o="<div><div>"+r+" : "+(null==n?"":n)+"</div><div>"+h+" : "+(null==s?"":s)+"</div></div>",d={title:i,width:100,height:40},u=new GeoBeans.InfoWindow(o,d);e.map.openInfoWindow(u,a)}},drawRangeLegend:function(){if(null!=this.minMax&&null!=this.rangeOption){var e="",l=(this.map.mapDiv.find(".chart-legend"),0);if(0==this.legendIndex)l=10;else{var a=this.legendIndex-1,t=this.map.mapDiv.find(".chart-legend[lindex='"+a+"']"),i=t.css("left"),n=t.css("width");i=parseInt(i.replace("px","")),n=parseInt(n.replace("px","")),l=i+n+5}var e="<div class='chart-legend chart-legend-range-symbol' id='"+this.name+"' style='left:"+l+"px' lindex='"+this.legendIndex+"'>";e+="<div class='chart-legend-item chart-legend-rs-range'><div class='chart-legend-title'><h5>"+this.rangeChartField+"</h5></div>",e+="<div class='chart-legend-canvas'>\t<canvas width='20' height='200'></canvas></div><div class='chart-legend-value'><div class='chart-legend-label'>"+this.minMax.range.max+"</div><div class='chart-legend-label' style='padding-top:180px'>"+this.minMax.range.min+"</div></div></div>",e+="</div>",this.map.mapDiv.append(e);var s=this.map.mapDiv.find("#"+this.name+" .chart-legend-canvas canvas"),r=s[0].getContext("2d"),h=new Image;h.src=this.colorMap.url,h.onload=function(){var e=s.width()/2,l=s.height()/2,a=h.width,t=h.height;r.clearRect(0,0,a,t),r.translate(e,l),r.rotate(270*Math.PI/180),r.drawImage(h,-a/2,-t/2,a,t),r.rotate(-270*Math.PI/180),r.translate(-e,-l)}}},drawSymbolLegend:function(){if(null==this.symbolOption)return"";var e=this.symbolOption.byLevel;return e?this.drawSymbolLegendByLevel():this.drawSymbolLegendByValue()},drawSymbolLegendByLevel:function(){if(null!=this.symbolOption){var e=this.symbolOption.maxsize,l=(this.symbolOption.level,2*this.maxSymbolRadius+4),a=this.getLegendCanvasHeightByLevel(this.levelMap,this.maxSymbolRadius,e);if(null!=a){var t="<div class='chart-legend-item chart-legend-rs-symbol'>";t+="<div class='chart-legend-title'<h5>"+this.symbolChartField+"</h5></div>",t+="<div class='chart-legend-canvas'><canvas width='"+l+"' height='"+a+"'></canvas></div>",t+="<div class='chart-legend-value' style='font-size:12px;ling-height:12px'></div>",t+="</div>",this.map.mapDiv.find("#"+this.name).prepend(t);var i=this.map.mapDiv.find("#"+this.name+" .chart-legend-rs-symbol .chart-legend-title").height(),n=i+a+20;this.map.mapDiv.find("#"+this.name+" .chart-legend-rs-symbol").css("height",n+"px");var s="",r=this.map.mapDiv.find("#"+this.name+" .chart-legend-rs-symbol canvas"),h=new GeoBeans.Renderer(r[0]),o=this.getSymbolizer();h.setSymbolizer(o);for(var d=h.context,u=0,m=null,y=null,g=null,p=null,c=null,v=null,f=0,b=null,L=0;L<this.levelMap.length;++L)if(m=this.levelMap[L],null!=m){p=m.min,c=m.max,p=p.toFixed(2),c=c.toFixed(2),v=p+"~"+c,y=m.radius,g=y/e*this.maxSymbolRadius,u+=g,0==L&&(u+=1),null==b&&(b=-8.495),f=u-b-16.99,b=u,s+="<div class='chart-legend-label' style='padding-top:"+f+"px'>"+v+"</div>",u=Math.ceil(u);var F=new GeoBeans.Geometry.Point(this.maxSymbolRadius+2,u);u+=g+this.legendPadding,u=Math.ceil(u),d.beginPath(),d.arc(F.x,F.y,g,0,2*Math.PI,!0),null!=o.fill&&d.fill(),null!=o.stroke&&d.stroke(),d.closePath()}this.map.mapDiv.find("#"+this.name+" .chart-legend-rs-symbol .chart-legend-value").html(s)}}},getLegendCanvasHeightByLevel:function(e,l,a){if(null==e||null==l||null==a)return null;for(var t=0,i=null,n=null,s=e.length-1;s>=0;--s)if(i=e[s],null!=i){n=i.radius;var r=n/a*l;t+=2*r+this.legendPadding}return t+=4,t=Math.ceil(t)},drawSymbolLegendByValue:function(){if(null!=this.symbolOption){var e=this.minMax.symbol,l=e.min,a=e.max,t=(this.symbolOption.maxsize,l/a*this.maxSymbolRadius),i=t;t<8.5&&(i=8.5);var n=2*this.maxSymbolRadius+4,s=2*(this.maxSymbolRadius+i)+this.legendPadding+4,r=this.map.mapDiv.find(".chart-legend"),h=0;if(r.length>0){var o=r.last(),d=o.css("left"),u=o.css("width");d=parseInt(d.replace("px","")),u=parseInt(u.replace("px","")),h=d+u+5}else h=10;var m="<div class='chart-legend-item chart-legend-rs-symbol'>";m+="<div class='chart-legend-title'><h5>"+this.symbolChartField+"</h5></div>",m+="<div class='chart-legend-canvas'><canvas width='"+n+"' height='"+s+"'></canvas></div>",m+="<div class='chart-legend-value' style='font-size:12px;ling-height:12px'></div>",m+="</div>",this.map.mapDiv.find("#"+this.name).prepend(m);var y=this.map.mapDiv.find("#"+this.name+" .chart-legend-rs-symbol .chart-legend-title").height(),g=y+s+20;this.map.mapDiv.find("#"+this.name+" .chart-legend-rs-symbol").css("height",g+"px");var p=this.map.mapDiv.find("#"+this.name+" .chart-legend-rs-symbol canvas"),c=new GeoBeans.Renderer(p[0]),v=this.getSymbolizer();c.setSymbolizer(v);var f=c.context,b=new GeoBeans.Geometry.Point(this.maxSymbolRadius+2,i);f.beginPath(),f.arc(b.x,b.y,t,0,2*Math.PI,!0),null!=v.fill&&f.fill(),null!=v.stroke&&f.stroke(),f.closePath(),f.beginPath();var L=this.maxSymbolRadius+2*i+this.legendPadding,F=new GeoBeans.Geometry.Point(this.maxSymbolRadius+2,L);f.arc(F.x,F.y,this.maxSymbolRadius,0,2*Math.PI,!0),null!=v.fill&&f.fill(),null!=v.stroke&&f.stroke(),f.closePath();var B="",x=i-8.5,w=F.y-b.y-16.99;console.log(x),console.log(w),B+="<div class='chart-legend-label' style='padding-top:"+x+"px'>"+l+"</div>",B+="<div class='chart-legend-label' style='padding-top:"+w+"px'>"+a+"</div>",this.map.mapDiv.find("#"+this.name+" .chart-legend-rs-symbol .chart-legend-value").html(B)}},resizeLegend:function(){var e=this.map.mapDiv.find(".chart-legend-rs-range .chart-legend-value"),l=e.width(),a=this.map.mapDiv.find(".chart-legend#"+this.name).width();if(l+40<a){var t=a-l-30,i=t/2;e.css("margin-right",i+"px"),this.map.mapDiv.find(".chart-legend-rs-range .chart-legend-canvas").css("margin-left",i+"px")}},setRangeBaseLayer:function(e){null!=e&&e!=this.rangeBaseLayerName&&(this.rangeBaseLayerName=e,this.getFeatures(),this.flag=GeoBeans.Layer.Flag.READY)},setRangeBaseLayerField:function(e){null!=e&&e!=this.rangeBaseLayerField&&(this.rangeBaseLayerField=e,this.getFeatures(),this.flag=GeoBeans.Layer.Flag.READY)},setSymbolBaseLayer:function(e){null!=e&&e!=this.symbolBaseLayerName&&(this.symbolBaseLayerName=e,this.getFeatures(),this.flag=GeoBeans.Layer.Flag.READY)},setSymbolBaseLayerField:function(e){null!=e&&e!=this.symbolBaseLayerField&&(this.symbolBaseLayerField=e,this.getFeatures(),this.flag=GeoBeans.Layer.Flag.READY)},setRangeChartField:function(e){null!=e&&e!=this.rangeChartField&&(this.rangeChartField=e,this.getFeatures(),this.flag=GeoBeans.Layer.Flag.READY)},setSymbolChartField:function(e){null!=e&&e!=this.symbolChartField&&(this.symbolChartField=e,this.getFeatures(),this.flag=GeoBeans.Layer.Flag.READY)},setRangeChartOption:function(e){null!=e&&(this.rangeOption=e,this.flag=GeoBeans.Layer.Flag.READY)},setSymbolChartOption:function(e){null!=e&&(this.symbolOption=e,this.flag=GeoBeans.Layer.Flag.READY)}});
GeoBeans.Layer.RingChartLayer=GeoBeans.Class(GeoBeans.Layer.ChartLayer,{chartOption:null,initialize:function(t,e,a,r,l,i,n,s){GeoBeans.Layer.ChartLayer.prototype.initialize.apply(this,arguments),this.type=GeoBeans.Layer.ChartLayer.Type.RING,this.chartOption=s},setMap:function(t){GeoBeans.Layer.ChartLayer.prototype.setMap.apply(this,arguments)},load:function(){this.flag=GeoBeans.Layer.Flag.LOADED,null==this.features&&(this.features=this.chartFeatures),this.renderer.clearRect(),this.drawLayer()},getMinMaxValue:function(){if(null==this.chartFeatures)return null;for(var t=null,e=(this.chartFields[0],this.chartFeatureType),a=e.getFieldIndex(this.chartFields[0]),r=null,l=null,i=null,n=null,s=0;s<this.chartFeatures.length;++s)t=this.chartFeatures[s],null!=t&&(r=t.values,null!=r&&(n=r[a],null!=n&&(n=parseFloat(n),l=null==l?n:n<l?n:l,i=null==i?n:n>i?n:i)));return{min:l,max:i}},drawLayer:function(){var t=this.getMinMaxValue();this.minMax=t;for(var e=(t.min,t.max),a=(this.chartFields[0],this.chartFeatureType),r=a.getFieldIndex(this.chartFields),l=null,i=null,n=null,s=null,h=null,u=null,o=null,o=this.chartOption.color,c=this.chartOption.opacityInner,p=this.chartOption.opacityOuter,y=0;y<this.chartFeatures.length;++y)l=this.chartFeatures[y],null!=l&&(i=l.values,null!=i&&(n=i[r],null!=n&&(s=l.geometry,h=parseFloat(n)/e*this.chartOption.maxsize,u=h+this.chartOption.outerRadius,this.renderer.drawRing(s,h,u,o,c,p,this.map.transformation))))}});
GeoBeans.Layer.SymbolChartLayer=GeoBeans.Class(GeoBeans.Layer.ChartLayer,{chartOption:null,levelMap:null,legendPadding:4,maxSymbolRadius:30,minMax:null,initialize:function(e,t,l,i,a,n,s,r){GeoBeans.Layer.ChartLayer.prototype.initialize.apply(this,arguments),this.type=GeoBeans.Layer.ChartLayer.Type.SYMBOL,this.chartOption=r,this.features=null},setMap:function(e){GeoBeans.Layer.ChartLayer.prototype.setMap.apply(this,arguments),this.registerHitEvent(this.onFeatureHit),e._addLegend(this)},cleanup:function(){GeoBeans.Layer.ChartLayer.prototype.cleanup.apply(this,arguments),this.unRegisterHitEvent(),this.chartOption=null,this.levelMap=null,this.minMax=null},load:function(){null==this.features&&(this.features=this.chartFeatures),this.renderer.clearRect(),this.drawLayer(),this.removeLegend(),this.addLegend(),this.visible?this.showLegend():this.hideLegend(),this.flag=GeoBeans.Layer.Flag.LOADED},getSymbolizer:function(){var e=new GeoBeans.Symbolizer.PolygonSymbolizer,t=this.chartOption.color;null!=t&&e.fill.color.setByHex(t,1);var l=this.chartOption.opacity;null!=l?e.fill.color.setOpacity(l):e.fill.color.setOpacity(1);var i=this.chartOption.border;null!=i&&e.stroke.color.setByHex(i,1);var a=this.chartOption.borderOpacity;return null!=a?e.stroke.color.setOpacity(a):e.stroke.color.setOpacity(1),e},drawLayer:function(){if(null!=this.chartOption){var e=this.chartOption.byLevel;e?this.drawLayerByLevel():this.drawLayerByValue()}},drawLayerByLevel:function(){if(null!=this.chartOption){var e=this.chartOption.level,t=this.getMinMaxValue();this.minMax=t;var l=t.min,i=t.max,a=this.chartOption.maxsize,n=(this.chartFields[0],this.chartFeatureType),s=n.getFieldIndex(this.chartFields),r=this.getSymbolizer();this.renderer.setSymbolizer(r);var h=null,d=null,o=null,u=null,c=null,p=null,v=this.getLevelMap(a,e,l,i);this.levelMap=v;for(var m=0;m<this.chartFeatures.length;++m)h=this.chartFeatures[m],null!=h&&(d=h.values,null!=d&&(o=d[s],null!=o&&(u=h.geometry,c=this.getRadiusByLevelMap(parseFloat(o),v),p=new GeoBeans.Geometry.Circle(u,c),h.circle=p,this.renderer.drawGeometry(p,r,this.map.transformation))))}},drawLayerByValue:function(){var e=this.getMinMaxValue();this.minMax=e;var t=(e.min,e.max),l=(this.chartFields[0],this.chartFeatureType),i=l.getFieldIndex(this.chartFields),a=this.getSymbolizer();this.renderer.setSymbolizer(a);for(var n=null,s=null,r=null,h=null,d=null,o=null,u=0;u<this.chartFeatures.length;++u)n=this.chartFeatures[u],null!=n&&(s=n.values,null!=s&&(r=s[i],null!=r&&(h=n.geometry,d=parseFloat(r)/t*this.chartOption.maxsize,o=new GeoBeans.Geometry.Circle(h,d),n.circle=o,this.renderer.drawGeometry(o,a,this.map.transformation))))},getMinMaxValue:function(){if(null==this.chartFeatures)return null;for(var e=null,t=(this.chartFields[0],this.chartFeatureType),l=t.getFieldIndex(this.chartFields[0]),i=null,a=null,n=null,s=null,r=0;r<this.chartFeatures.length;++r)e=this.chartFeatures[r],null!=e&&(i=e.values,null!=i&&(s=i[l],null!=s&&(s=parseFloat(s),a=null==a?s:s<a?s:a,n=null==n?s:s>n?s:n)));return{min:a,max:n}},getLevelMap:function(e,t,l,i){if(null!=e&&null!=t&&null!=l&&null!=i){for(var a=(i-l)/t,n=[],s=0;s<t;++s){var r=l+s*a,h=l+(s+1)*a,d=Math.pow(1.2,s+1-t)*e,o={min:r,max:h,radius:d};n.push(o)}return n}},getRadiusByLevelMap:function(e,t){if(null==e||null==t)return null;for(var l=null,i=null,a=null,n=0;n<t.length;++n)if(l=t[n],null!=l){if(i=l.min,a=l.max,0==n&&e==i)return l.radius;if(i<e&&a>=e)return l.radius}return null},addLegend:function(){if(null!=this.chartOption){var e=this.chartOption.byLevel;e?this.addLegendByLevel():this.addLegendByValue()}},addLegendByLevel:function(){if(null!=this.chartOption){var e=this.chartOption.maxsize,t=(this.chartOption.level,2*this.maxSymbolRadius+4),l=this.getLegendCanvasHeightByLevel(this.levelMap,this.maxSymbolRadius,e);if(null!=l){var i=(this.map.mapDiv.find(".chart-legend"),0);if(0==this.legendIndex)i=10;else{var a=this.legendIndex-1,n=this.map.mapDiv.find(".chart-legend[lindex='"+a+"']"),s=n.css("left"),r=n.css("width");s=parseInt(s.replace("px","")),r=parseInt(r.replace("px","")),i=s+r+5}var h="<div class='chart-legend chart-symbol-legend' id='"+this.name+"' style='left:"+i+"px' lindex='"+this.legendIndex+"'>";h+="<div class='chart-legend-title'<h5>"+this.name+"</h5></div>",h+="<div class='chart-legend-canvas'><canvas width='"+t+"' height='"+l+"'></canvas></div>",h+="<div class='chart-legend-value' style='font-size:12px;ling-height:12px'></div>",h+="</div>",this.map.mapDiv.append(h);var d="",o=this.map.mapDiv.find("#"+this.name+" canvas"),u=new GeoBeans.Renderer(o[0]),c=this.getSymbolizer();u.setSymbolizer(c);for(var p=u.context,v=0,m=null,y=null,g=null,f=null,x=null,L=null,b=0,F=null,B=0;B<this.levelMap.length;++B)if(m=this.levelMap[B],null!=m){f=m.min,x=m.max,f=f.toFixed(2),x=x.toFixed(2),L=f+"~"+x,y=m.radius,g=y/e*this.maxSymbolRadius,v+=g,v=Math.ceil(v),null==F&&(F=-8.495),b=v-F-16.99,F=v,d+="<div class='chart-legend-label' style='padding-top:"+b+"px'>"+L+"</div>";var w=new GeoBeans.Geometry.Point(this.maxSymbolRadius+2,v);v+=g+this.legendPadding,v=Math.ceil(v),p.beginPath(),p.arc(w.x,w.y,g,0,2*Math.PI,!0),null!=c.fill&&p.fill(),null!=c.stroke&&p.stroke(),p.closePath()}this.map.mapDiv.find("#"+this.name+".chart-legend .chart-legend-value").html(d)}}},getLegendCanvasHeightByLevel:function(e,t,l){if(null==e||null==t||null==l)return null;for(var i=0,a=null,n=null,s=e.length-1;s>=0;--s)if(a=e[s],null!=a){n=a.radius;var r=n/l*t;i+=2*r+this.legendPadding}return i+=4,i=Math.ceil(i)},addLegendByValue:function(){if(null!=this.chartOption){var e=this.minMax;if(null!=e){var t=e.min,l=e.max,i=(this.chartOption.maxsize,t/l*this.maxSymbolRadius);i<0&&(i=this.maxSymbolRadius/10);var a=i;i<8.5&&(a=8.5);var n=2*this.maxSymbolRadius+4,s=2*(this.maxSymbolRadius+a)+this.legendPadding+4,r=(this.map.mapDiv.find(".chart-legend"),0);if(0==this.legendIndex)r=10;else{var h=this.legendIndex-1,d=this.map.mapDiv.find(".chart-legend[lindex='"+h+"']"),o=d.css("left"),u=d.css("width");o=parseInt(o.replace("px","")),u=parseInt(u.replace("px","")),r=o+u+5}var c="<div class='chart-legend chart-symbol-legend' id='"+this.name+"' style='left:"+r+"px' lindex='"+this.legendIndex+"'>";c+="<div class='chart-legend-title'><h5>"+this.name+"</h5></div>",c+="<div class='chart-legend-canvas'><canvas width='"+n+"' height='"+s+"'></canvas></div>",c+="<div class='chart-legend-value' style='font-size:12px;ling-height:12px'></div>",c+="</div>",this.map.mapDiv.append(c);var p=this.map.mapDiv.find("#"+this.name+" canvas"),v=new GeoBeans.Renderer(p[0]),m=this.getSymbolizer();v.setSymbolizer(m);var y=v.context,g=new GeoBeans.Geometry.Point(this.maxSymbolRadius+2,a);y.beginPath(),y.arc(g.x,g.y,i,0,2*Math.PI,!0),null!=m.fill&&y.fill(),null!=m.stroke&&y.stroke(),y.closePath(),y.beginPath();var f=this.maxSymbolRadius+2*a+this.legendPadding,x=new GeoBeans.Geometry.Point(this.maxSymbolRadius+2,f);y.arc(x.x,x.y,this.maxSymbolRadius,0,2*Math.PI,!0),null!=m.fill&&y.fill(),null!=m.stroke&&y.stroke(),y.closePath();var L="",b=a-8.5,F=x.y-g.y-16.99;console.log(b),console.log(F),L+="<div class='chart-legend-label' style='padding-top:"+b+"px'>"+t+"</div>",L+="<div class='chart-legend-label' style='padding-top:"+F+"px'>"+l+"</div>",this.map.mapDiv.find("#"+this.name+".chart-legend .chart-legend-value").html(L)}}},onFeatureHit:function(e,t,l){if(console.log(t.length),"pointer"==document.body.style.cursor)return void e.map.closeInfoWindow();if(0==t.length)e.map.closeInfoWindow();else{var i=t[0],a=(i.chartValue,e.chartFeatureType);if(null==a)return;var n=i.values;if(null==n)return;var s=a.getFieldIndex(e.chartFields[0]),r=n[s],h=a.getFieldIndex(e.tableField),d=n[h],o="<div>"+r+"</div>",u={title:d,width:100,height:40},c=new GeoBeans.InfoWindow(o,u),p=i.circle.center;e.map.openInfoWindow(c,p)}},hit:function(e,t,l){if(null!=this.chartFeatures){this.map.renderer,this.map.transformation;this.selection=[];var i=0,a=null,n=null,s=this.features.length;for(i=0;i<s;i++)a=this.features[i],n=a.circle,null!=n&&n.hit(e,t,this.map.tolerance)&&this.selection.push(a);if(this.hitRenderer.clearRect(0,0,this.hitCanvas.height,this.hitCanvas.width),this.map.drawLayersAll(),void 0!=l){var r=new GeoBeans.Geometry.Point(e,t);l(this,this.selection,r)}}}});
GeoBeans.Layer.AMapLayer=GeoBeans.Class(GeoBeans.Layer.TileLayer,{AMP_URL:"/appmaptile?lang=zh_cn&size=1&scale=1&style=8",IMG_WIDTH:256,IMG_HEIGHT:256,MIN_ZOOM_LEVEL:1,MAX_ZOOM_LEVEL:18,FULL_EXTENT:{xmin:-20037508.3427892,ymin:-20037508.3427892,xmax:20037508.3427892,ymax:20037508.3427892},RESOLUTIONS:[78271.51696402031,39135.75848201016,19567.87924100508,9783.939620502539,4891.96981025127,2445.984905125635,1222.992452562817,611.4962262814087,305.7481131407043,152.8740565703522,76.43702828517608,38.21851414258804,19.10925707129402,9.554628535647009,4.777314267823505,2.388657133911752,1.194328566955876,.5971642834779382],resolution:null,rows:null,cols:null,offset_x:0,offset_y:0,lrow:0,urow:0,lcol:0,rcol:0,initialize:function(t,i){GeoBeans.Layer.TileLayer.prototype.initialize.apply(this,arguments)},destory:function(){GeoBeans.Layer.TileLayer.prototype.destroy.apply(this,arguments)},computeTileBound:function(){var t=this.map,i=(t.level,t.resolution),e=i*this.IMG_WIDTH,a=this.getValidView(),l=Math.floor((a.xmin-this.FULL_EXTENT.xmin)/e),s=Math.ceil((a.xmax-this.FULL_EXTENT.xmin)/e),r=Math.floor((this.FULL_EXTENT.ymax-a.ymax)/e),o=Math.ceil((this.FULL_EXTENT.ymax-a.ymin)/e);return{rmin:r,rmax:o,cmin:l,cmax:s}},updateTileCache:function(t){var i,e,a,l,s=t.rmin,r=t.rmax,o=t.cmin,n=t.cmax,h=null,c=this.map.level;for(a=s;a<r;a++)for(l=o;l<n;l++)i="x="+l+"&y="+a+"&z="+c,e=this.AMP_URL+"&"+i,null==this.cache.getTile(e)&&(h=new GeoBeans.Tile(this.map,e,this,l,a,c,0,0),this.cache.putTile(h))},draw:function(){var t=this.computeTileBound();this.updateTileCache(t);var i=t.rmin,e=t.rmax,a=t.cmin,l=t.cmax,s=this.map.transformation.toScreenPoint(this.FULL_EXTENT.xmin,this.FULL_EXTENT.ymax);s.x=Math.floor(s.x+.5),s.y=Math.floor(s.y+.5);var r,o,n,h,c,m=this.IMG_WIDTH*this.scale,T=this.map.level;for(o=s.y+i*m,n=i;n<e;n++){for(r=s.x+a*m,h=a;h<l;h++)tid=this.getTileID(n,h,T),turl=this.AMP_URL+"&"+tid,c=this.cache.getTile(turl),null!=c&&c.draw(r,o,m,m),r+=m;o+=m}},drawCache:function(){var t=this.computeTileBound(),i=t.rmin,e=t.rmax,a=t.cmin,l=t.cmax,s=this.map.transformation.toScreenPoint(this.FULL_EXTENT.xmin,this.FULL_EXTENT.ymax);s.x=Math.floor(s.x+.5),s.y=Math.floor(s.y+.5);var r,o,n,h,c,m=this.IMG_WIDTH*this.scale,T=this.map.level;for(o=s.y+i*m,n=i;n<e;n++){for(r=s.x+a*m,h=a;h<l;h++)tid=this.getTileID(n,h,T),turl=this.AMP_URL+"&"+tid,c=this.cache.getTile(turl),null!=c&&c.draw(r,o,m,m),r+=m;o+=m}},preDraw:function(){var t=this.computeTileBound();this.updateTileCache(t);var i=t.rmin,e=t.rmax,a=t.cmin,l=t.cmax,s=this.map.transformation.toScreenPoint(this.FULL_EXTENT.xmin,this.FULL_EXTENT.ymax);s.x=Math.floor(s.x+.5),s.y=Math.floor(s.y+.5);var r,o,n,h,c,m=this.IMG_WIDTH*this.scale,T=this.map.level;for(o=s.y+i*m,n=i;n<e;n++){for(r=s.x+a*m,h=a;h<l;h++){tid=this.getTileID(n,h,T),turl=this.AMP_URL+"&"+tid,c=this.cache.getTile(turl);var f=new Object;f.tile=c,f.img_size=m,f.x=r,f.y=o,this.tiles.push(f),r+=m}o+=m}},loadingTiles:function(t){for(var i=0;i<this.tiles.length;++i){var e=this.tiles[i].tile;if(null!=e)if(e.state!=GeoBeans.TileState.LOADED)e.loading(t,this.loadTileCallback,this.tiles,i),this.state=GeoBeans.TileLayerState.LOADING;else if(e.state==GeoBeans.TileState.LOADED){var a=this.tiles[i],l=a.img_size,s=a.x,r=a.y;e.draw(s,r,l,l)}}for(var i=0;i<this.tiles.length;++i){var o=this.tiles[i];if(o.tile.state!=GeoBeans.TileState.LOADED)return}t(this.map)},loadTileCallback:function(t,i,e,a){var l=e[a],s=l.img_size,r=l.x,o=l.y;t.draw(r,o,s,s);for(var n=0;n<e.length;++n){var h=e[n];if(h.tile.state!=GeoBeans.TileState.LOADED)return}i(t.map)},getRows:function(){},getCols:function(){},computeExtent:function(){},computeCenterTileOffset:function(){var t=this.map.center,i=(t.x-this.ORIGIN.x,t.y-this.ORIGIN.y,Math.floor((t.x-this.ORIGIN.x)/this.resolution)),e=Math.floor((t.y-this.ORIGIN.y)/this.resolution);offset_x=i,offset_y=e},getTileID:function(t,i,e){return"x="+i+"&y="+t+"&z="+e},isCached:function(t){for(var i in this.tileCache){var e=this.tileCache[i];if(e.url==t)return!0}return!1}});
GeoBeans.Layer.BaiduLayer=GeoBeans.Class(GeoBeans.Layer.TileLayer,{ORIGIN:{x:0,y:0},IMG_WIDTH:256,IMG_HEIGHT:256,MIN_ZOOM_LEVEL:1,MAX_ZOOM_LEVEL:19,RESOLUTIONS:[131072,65536,32768,16384,8192,4096,2048,1024,512,256,128,64,32,16,8,4,2,1,.5],initialize:function(e){GeoBeans.Layer.TileLayerLayer.prototype.initialize.apply(this,arguments)},destory:function(){GeoBeans.Layer.TileLayerLayer.prototype.destroy.apply(this,arguments)}});

GeoBeans.Layer.QSLayer=GeoBeans.Class(GeoBeans.Layer.TileLayer,{AMP_URL:"/QuadServer/maprequest?services=world_image",IMG_WIDTH:256,IMG_HEIGHT:256,MIN_ZOOM_LEVEL:2,MAX_ZOOM_LEVEL:17,FULL_EXTENT:{xmin:-256,ymin:-256,xmax:256,ymax:256},RESOLUTIONS:[1,.5,.25,.125,.0625,.03125,.015625,.0078125,.00390625,.001953125,976563e-9,488281e-9,244141e-9,12207e-8,6103515625e-14,30517578125e-15,152587890625e-16,762939453125e-17,3814697265625e-18,19073486328125e-19],resolution:null,rows:null,cols:null,offset_x:0,offset_y:0,lrow:0,urow:0,lcol:0,rcol:0,initialize:function(e,t){GeoBeans.Layer.TileLayer.prototype.initialize.apply(this,arguments),this.type=GeoBeans.Layer.TileLayer.Type.QS},destroy:function(){GeoBeans.Layer.TileLayer.prototype.destroy.apply(this,arguments)},updateTileCache:function(e){var t,i,a,l,s=e.rmin,o=e.rmax,r=e.cmin,n=e.cmax,h=null,m=this.map.level;for(a=s;a<o;a++)for(l=r;l<n;l++)t=this.getTileID(a,l,m),i=this.url+"&"+t,null==this.cache.getTile(i)&&(h=new GeoBeans.Tile(this.map,i,this,a,l,m,0,0),this.cache.putTile(h))},preDraw:function(){var e=this.computeTileBound();this.updateTileCache(e);var t=e.rmin,i=e.rmax,a=e.cmin,l=e.cmax,s=this.map.transformation.toScreenPoint(this.FULL_EXTENT.xmin,this.FULL_EXTENT.ymin);s.x=Math.floor(s.x+.5),s.y=Math.floor(s.y+.5);var o,r,n,h,m,c=this.IMG_WIDTH*this.scale;this.map.transformation.toMapPoint(s.x,s.y);this.tiles=[];var u=this.map.level;for(r=s.y-(t+1)*c,n=t;n<i;n++){for(o=s.x+a*c,h=a;h<l;h++){tid=this.getTileID(n,h,u),turl=this.url+"&"+tid,m=this.cache.getTile(turl);var T=new Object;T.tile=m,T.img_size=c,T.x=o,T.y=r,this.tiles.push(T),o+=c}r-=c}},loadingTiles:function(e){for(var t=0;t<this.tiles.length;++t){var i=this.tiles[t].tile;if(null!=i)if(i.state!=GeoBeans.TileState.LOADED)i.loading(e,this.loadTileCallback,this.tiles,t),this.state=GeoBeans.TileLayerState.LOADING;else if(i.state==GeoBeans.TileState.LOADED){var a=this.tiles[t],l=a.img_size,s=a.x,o=a.y;i.draw(s,o,l,l)}}},loadTileCallback:function(e,t,i,a){var l=i[a],s=l.img_size,o=l.x,r=l.y;e.draw(o,r,s,s)},draw:function(){for(var e=0;e<this.tilesLoaded.length;++e){var t=this.tilesLoaded[e],i=t.tile,a=t.img_size,l=t.x,s=t.y;null!=i&&i.draw(l,s,a,a)}},drawCache:function(){var e=this.computeTileBound(),t=e.rmin,i=e.rmax,a=e.cmin,l=e.cmax,s=this.map.transformation.toScreenPoint(this.FULL_EXTENT.xmin,this.FULL_EXTENT.ymin);s.x=Math.floor(s.x+.5),s.y=Math.floor(s.y+.5);var o,r,n,h,m,c=this.IMG_WIDTH*this.scale,u=this.map.level;for(r=s.y-(t+1)*c,n=t;n<i;n++){for(o=s.x+a*c,h=a;h<l;h++)tid=this.getTileID(n,h,u),turl=this.url+"&"+tid,m=this.cache.getTile(turl),null!=m&&m.draw(o,r,c,c),o+=c;r-=c}},getRows:function(){},getCols:function(){},computeExtent:function(){},computeCenterTileOffset:function(){var e=this.map.center,t=(e.x-this.ORIGIN.x,e.y-this.ORIGIN.y,Math.floor((e.x-this.ORIGIN.x)/this.resolution)),i=Math.floor((e.y-this.ORIGIN.y)/this.resolution);offset_x=t,offset_y=i},getTileID:function(e,t,i){return"col="+t+"&row="+e+"&level="+i},computeTileBound:function(){var e=this.map,t=(e.level,e.resolution),i=t*this.IMG_WIDTH,a=this.getValidView(),l=Math.floor((a.xmin-this.FULL_EXTENT.xmin)/i),s=Math.ceil((a.xmax-this.FULL_EXTENT.xmin)/i),o=Math.floor((a.ymin-this.FULL_EXTENT.ymin)/i),r=Math.ceil((a.ymax-this.FULL_EXTENT.ymin)/i);return{rmin:o-1,rmax:r+1,cmin:l-1,cmax:s+1}}});
GeoBeans.Layer.WMTSLayer=GeoBeans.Class(GeoBeans.Layer.TileLayer,{name:null,type:null,extent:null,format:null,tms:null,sourceName:null,IMG_WIDTH:180,IMG_HEIGHT:180,MIN_ZOOM_LEVEL:1,MAX_ZOOM_LEVEL:10,RESOLUTIONS:[1,.5,.25,.125,.0625,.03125,.015625,.0078125,.00390625,.001953125,976563e-9,488281e-9,244141e-9,12207e-8,6103515625e-14,30517578125e-15,152587890625e-16,762939453125e-17,3814697265625e-18,19073486328125e-19],initialize:function(t,e,i,a,s,l,n){GeoBeans.Layer.TileLayer.prototype.initialize.apply(this,arguments),this.typeName=i,this.extent=a,this.tms=s,this.format=l,this.FULL_EXTENT={xmin:-180,ymin:-90,xmax:180,ymax:90},this.scale=1,this.sourceName=n,this.type=GeoBeans.Layer.TileLayer.Type.WMTS},setExtent:function(t){this.extent=t},getExtent:function(){return this.extent},setFormat:function(t){this.format=t},getFormat:function(){return this.format},setTMS:function(t){this.tms=t},getTMS:function(){return this.tms},load:function(){this.preDraw(),this.loadingTiles(this.map.drawBaseLayerCallback)},preDraw:function(){this.renderer.clearRect();var t=this.computeTileBound();this.updateTileCache(t);var e=t.rmin,i=t.rmax,a=t.cmin,s=t.cmax,l=this.map.transformation.toScreenPoint(this.FULL_EXTENT.xmin,this.FULL_EXTENT.ymax);l.x=Math.floor(l.x+.5),l.y=Math.floor(l.y+.5);var n,r,h,o,m,T=this.IMG_WIDTH*this.scale;this.map.transformation.toMapPoint(l.x,l.y);this.tiles=[];var u=this.map.level;for(r=l.y-e*T,r=l.y+e*T,h=e;h<=i;h++){for(n=l.x+a*T,o=a;o<=s;o++){tid=this.getTileID(h,o,u),turl=this.url+tid,m=this.cache.getTile(turl);var L=new Object;L.tile=m,L.img_size=T,L.x=n,L.y=r,this.tiles.push(L),n+=T}r+=T}},computeTileBound:function(){var t=this.map,e=(t.level,t.resolution),i=e*this.IMG_WIDTH,a=this.getValidView(),s=Math.floor((a.xmin-this.FULL_EXTENT.xmin)/i),l=Math.ceil((a.xmax-this.FULL_EXTENT.xmin)/i),n=Math.floor((this.FULL_EXTENT.ymax-a.ymax)/i),r=Math.ceil((this.FULL_EXTENT.ymax-a.ymin)/i);return{rmin:n,rmax:r-1,cmin:s,cmax:l-1}},updateTileCache:function(t){var e,i,a,s,l=t.rmin,n=t.rmax,r=t.cmin,h=t.cmax,o=null,m=this.map.level;for(a=l;a<=n;a++)for(s=r;s<=h;s++)e=this.getTileID(a,s,m),i=this.url+e,null==this.cache.getTile(i)&&(o=new GeoBeans.Tile(this.map,i,this,a,s,m,0,0),this.cache.putTile(o))},getTileID:function(t,e,i){var a="?SERVICE=dbs&REQUEST=GetTile&VERSION=1.0.0&LAYER="+this.typeName+"&STYLE=Default&FORMAT="+this.format+"&TILEMATRIXSET="+this.tms+"&TILEMATRIX="+this.tms+":"+i+"&TILEROW="+t+"&TILECOL="+e+"&sourceName="+this.sourceName;return a},getUrl:function(){return"typeName:"+this.typeName+";format:"+this.format+";tms:"+this.tms+";extent:"+this.extent.toString()+";sourceName:"+this.sourceName+";url:"+this.url+";startLevel:"+this.MIN_ZOOM_LEVEL+";endLevel:"+this.MAX_ZOOM_LEVEL},loadingTiles:function(t){for(var e=0;e<this.tiles.length;++e){var i=this.tiles[e].tile;if(null!=i)if(i.state!=GeoBeans.TileState.LOADED)i.loading(t,this.loadTileCallback,this.tiles,e),this.state=GeoBeans.TileLayerState.LOADING,this.flag=GeoBeans.Layer.Flag.READY;else if(i.state==GeoBeans.TileState.LOADED){var a=this.tiles[e],s=a.img_size,l=a.x,n=a.y;i.draw(l,n,s,s)}}for(var e=0;e<this.tiles.length;++e){var r=this.tiles[e];if(r.tile.state!=GeoBeans.TileState.LOADED)return}this.flag=GeoBeans.Layer.Flag.LOADED,t(this.map)},loadTileCallback:function(t,e,i,a){var s=i[a],l=s.img_size,n=s.x,r=s.y;t.draw(n,r,l,l);for(var h=0;h<i.length;++h){var o=i[h];if(o.tile.state!=GeoBeans.TileState.LOADED)return}t.layer.flag=GeoBeans.Layer.Flag.LOADED,e(t.map)}});
GeoBeans.Overlay.Circle=GeoBeans.Class(GeoBeans.Overlay,{type:GeoBeans.Overlay.Type.CIRCLE});
GeoBeans.Overlay.Marker=GeoBeans.Class(GeoBeans.Overlay,{image:null,type:GeoBeans.Overlay.Type.MARKER,infoWindow:null,initialize:function(e,i,a,n){GeoBeans.Overlay.prototype.initialize.apply(this,arguments),this.infoWindow=n}});
GeoBeans.Overlay.Polygon=GeoBeans.Class(GeoBeans.Overlay,{type:GeoBeans.Overlay.Type.POLYGON});
GeoBeans.Overlay.Polyline=GeoBeans.Class(GeoBeans.Overlay,{type:GeoBeans.Overlay.Type.PLOYLINE});
GeoBeans.PoiManager=GeoBeans.Class({server:null,service:"poi",version:"1.0.0",initialize:function(e){this.server="/poi/"+e+"/mgr"},getPoi:function(e,n,t,i,s){if(null==e)return void(null!=s&&s("keyword is null"));var r=this,o="service="+this.service+"&version="+this.version+"&request=GetPoi";if($.isArray(e)){for(var a="",l=0;l<e.length;++l)a+=e[l],l<e.length-1&&(a+=",");o+="&name="+a}else o+="&name="+e;null!=n&&(o+="&limit="+n),null!=t&&(o+="&offset="+t),null!=i&&i instanceof GeoBeans.Envelope&&(o+="&extent="+i.toString()),$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var t=r.parsGetPoi(e);null!=s&&s(t)},complete:function(e,n){},error:function(){}})},parsGetPoi:function(e){var n=[];return $(e).find("Pois>Poi").each(function(){var e=$(this).find("name").text(),t=$(this).find("lon").text(),i=$(this).find("lat").text(),s=$(this).find("address").text(),r=$(this).find("type").text(),o={name:e,x:t,y:i,address:s,type:r};n.push(o)}),n}});
GeoBeans.Raster=GeoBeans.Class({name:null,format:null,bands:null,width:null,height:null,extent:null,initialize:function(t,i,n,s,e,l,h){this.name=t,this.format=i,this.bands=n,this.srid=s,this.width=e,this.height=l,this.extent=h}});
GeoBeans.RasterDBManager=GeoBeans.Class({server:null,service:"rds",version:"1.0.0",currentPath:null,initialize:function(e){this.server=e+"/mgr"},getList:function(e,r,t){if(null==e||null==r)return void(null!=t&&t("invalid params"));var n=this,s="service="+this.service+"&version="+this.version+"&request=List&path="+r+"&sourceName="+e;n.currentPath=r,$.ajax({type:"get",url:this.server,data:encodeURI(s),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var s=n.parseList(e);void 0!=t&&t(s)},complete:function(e,r){},error:function(){}})},parseList:function(e){var r=this,t=[],n=$(e).find("Files");return n.children().each(function(){if("File"==this.tagName){var e=r.parseFile(this);t.push(e)}else if("Folder"==this.tagName){var n=r.parseFolder(this);t.push(n)}}),t},parseFile:function(e){var r=$(e).attr("name"),t=$(e).attr("access_time"),n=$(e).attr("last_modified_time"),s=$(e).attr("size"),a=null;a="/"==this.currentPath?this.currentPath+r:this.currentPath+"/"+r;var i=new GeoBeans.File(this.currentPath,a,r,t,n,s);return i},parseFolder:function(e){var r=$(e).attr("name"),t=$(e).attr("access_time"),n=$(e).attr("last_modified_time"),s=null;s="/"==this.currentPath?this.currentPath+r:this.currentPath+"/"+r;var a=new GeoBeans.Folder(this.currentPath,s,r,t,n);return a},addRaster:function(e,r,t,n,s){if(null==e||null==r||null==t||null==n)return void(null!=s&&s("invalid params"));var a=this,i="service="+this.service+"&version="+this.version+"&request=AddRaster&sourceName="+e+"&rasterName="+r+"&rasterPath="+t+"&filePath="+n;$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var t=a.parseAddRaster(e);void 0!=s&&s(t)},complete:function(e,r){},error:function(){}})},parseAddRaster:function(e){var r=$(e).find("AddRaster").text();if("success"==r.toLowerCase())return"success";var t=$(e).find("ExceptionText").text();return t},removeRaster:function(e,r,t,n){if(null==e||null==r||null==t)return void(null!=n&&n("invalid params"));var s=this,a="service="+this.service+"&version="+this.version+"&request=RemoveRaster&sourceName="+e+"&rasterName="+r+"&path="+t;$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var t=s.parseRemoveRaster(e);void 0!=n&&n(t)},complete:function(e,r){},error:function(){}})},parseRemoveRaster:function(e){var r=$(e).find("RemoveRaster").text();if("success"==r.toLowerCase())return"success";var t=$(e).find("ExceptionText").text();return t},getRaster:function(e,r,t,n){if(null==e||null==r||null==t)return void(null!=n&&n("invalid params"));var s="service="+this.service+"&version="+this.version+"&request=GetRaster&sourceName="+e+"&rasterName="+r+"&Path="+t;$.ajax({type:"get",url:this.server,data:encodeURI(s),async:!0,beforeSend:function(e){},success:function(e,r){null!=n&&n(e)},complete:function(e,r){},error:function(e){}})},getRasterUrl:function(e,r,t){if(null==e||null==r||null==t)return null;var n=this.server+"?service="+this.service+"&version="+this.version+"&request=GetRaster&sourceName="+e+"&rasterName="+r+"&Path="+t;return n},describeRaster:function(e,r,t,n){if(null==e||null==r||null==t)return void(null!=n&&n("invalid params"));var s=this,a="service="+this.service+"&version="+this.version+"&request=DescribeRaster&sourceName="+e+"&rasterName="+r+"&Path="+t;$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var t=s.parseDescribeRaster(e);null!=n&&n(t)},complete:function(e,r){},error:function(){}})},parseDescribeRaster:function(e){var r=$(e).find("Raster>Name").text(),t=$(e).find("Raster>Format").text(),n=$(e).find("Raster>Bands").text(),s=$(e).find("Raster>SRID").text(),a=$(e).find("Raster>Width").text(),i=$(e).find("Raster>Height").text(),u=null,l=null,o=null,c=null,v=$(e).find("Raster>Boundingbox>LowerLeft").text();if(null!=v){var d=v.split(" ");u=parseFloat(d[0]),l=parseFloat(d[1])}var f=$(e).find("Raster>Boundingbox>UpperRight").text();if(null!=f){var d=f.split(" ");o=parseFloat(d[0]),c=parseFloat(d[1])}var h=null;null!=u&&null!=l&&null!=o&&null!=c&&(h=new GeoBeans.Envelope(u,l,o,c));var m=null;return null!=r&&(m=new GeoBeans.Raster(r,t,n,s,a,i,h)),m},createFolder:function(e,r,t){if(null==r||null==e)return void(null!=t&&t("params is invalid"));var n=this,s="service="+this.service+"&version="+this.version+"&request=CreateFolder&sourceName="+e+"&path="+r;n.currentPath=r,$.ajax({type:"get",url:this.server,data:encodeURI(s),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var s=n.parseCreateFolder(e);void 0!=t&&t(s)},complete:function(e,r){},error:function(){}})},parseCreateFolder:function(e){var r=$(e).find("CreateFolder").text();if("success"==r.toLowerCase())return"success";var t=$(e).find("ExceptionText").text();return t},removeFolder:function(e,r,t){if(null==r||null==e)return void(null!=t&&t("params is invalid"));var n=this,s="service="+this.service+"&version="+this.version+"&request=RemoveFolder&sourceName="+e+"&path="+r;n.currentPath=r,$.ajax({type:"get",url:this.server,data:encodeURI(s),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var s=n.parseRemoveFolder(e);void 0!=t&&t(s)},complete:function(e,r){},error:function(){}})},parseRemoveFolder:function(e){var r=$(e).find("RemoveFolder").text();if("success"==r.toLowerCase())return"success";var t=$(e).find("ExceptionText").text();return t},getThumbnails:function(e,r,t){if(null==r||null==e)return void(null!=t&&t("params is invalid"));var n=this,s="service="+this.service+"&version="+this.version+"&request=GetThumbnail&sourceName="+e+"&path="+r;n.currentPath=r,$.ajax({type:"get",url:this.server,data:encodeURI(s),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var s=n.parseGetThumbnails(e);void 0!=t&&t(s)},complete:function(e,r){},error:function(){}})},parseGetThumbnails:function(e){if(null==e)return null;var r=[],t=this;return $(e).find("Rasters>Raster").each(function(){var e=t.parseGetThumbnail(this);null!=e&&r.push(e)}),r},getThumbnail:function(e,r,t,n){if(null==r||null==e)return void(null!=n&&n("params is invalid"));var s=this,a="service="+this.service+"&version="+this.version+"&request=GetThumbnail&sourceName="+e+"&path="+r+"&rasterName="+t;s.currentPath=r,$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var t=s.parseGetThumbnail(e);void 0!=n&&n(t)},complete:function(e,r){},error:function(){}})},parseGetThumbnail:function(e){if(null==e)return null;var r=$(e).find("Name").text(),t=$(e).find("Thumbnail").attr("xlink");return{name:r,thumb:t}}});
GeoBeans.ColorMap=GeoBeans.Class({id:null,startColor:null,endColor:null,initialize:function(l,o,i,n){this.id=l,this.startColor=o,this.endColor=i,this.url=n}});
GeoBeans.Style.FeatureStyle=GeoBeans.Class(GeoBeans.Style,{name:null,rules:null,geomType:null,styleClass:null,field:null,initialize:function(e,l){this.name=e,this.geomType=l,this.type=GeoBeans.Style.Type.FeatureType,this.rules=[]},addRule:function(e){this.rules.push(e)},removeRule:function(e){this.rules.splice(e,1)},clone:function(){for(var e=new GeoBeans.Style.FeatureStyle(this.name,this.geomType),l=0;l<this.rules.length;++l){var t=this.rules[l].clone();e.addRule(t)}return e.styleClass=this.styleClass,e}}),GeoBeans.Style.FeatureStyle.GeomType={Point:"Point",LineString:"LineString",Polygon:"Polygon"},GeoBeans.Style.FeatureStyle.StyleClass={SINGLE:"single",UNIQUE:"unique",QUANTITIES:"quantities",CUSTOM:"custom",DOTDENSITY:"DotDensity"};
GeoBeans.Fill=GeoBeans.Class({color:null,initialize:function(){this.color=new GeoBeans.Color},getRgba:function(){return this.color.getRgba()},getOpacity:function(){return this.color.getOpacity()},getRgb:function(){return this.color.getRgb()},clone:function(){var o=new GeoBeans.Fill;return null!=this.color&&(o.color=this.color.clone()),o}});
GeoBeans.Font=GeoBeans.Class({family:null,style:null,weight:null,size:null,initialize:function(){this.family="Times New Roman",this.style=GeoBeans.Font.StyleType.Normal,this.weight=GeoBeans.Font.WeightType.Normal,this.size=12},clone:function(){var e=new GeoBeans.Font;return e.family=this.family,e.style=this.style,e.weight=this.weight,e.size=this.size,e}}),GeoBeans.Font.StyleType={Normal:"normal",Italic:"italic",Oblique:"oblique"},GeoBeans.Font.WeightType={Normal:"normal",Bold:"bold"};
GeoBeans.Symbolizer.LineSymbolizer=GeoBeans.Class(GeoBeans.Symbolizer,{stroke:null,fill:null,symbol:null,initialize:function(){GeoBeans.Symbolizer.prototype.initialize.apply(this,arguments),this.type=GeoBeans.Symbolizer.Type.Line,this.stroke=new GeoBeans.Stroke,this.fill=new GeoBeans.Fill},clone:function(){var l=new GeoBeans.Symbolizer.LineSymbolizer;return null!=this.stroke?l.stroke=this.stroke.clone():l.stroke=null,null!=this.fill?l.fill=this.fill.clone():l.fill=null,null!=this.symbol&&(l.symbol=this.symbol.clone()),l}});
GeoBeans.Symbolizer.PointSymbolizer=GeoBeans.Class(GeoBeans.Symbolizer,{size:null,fill:null,stroke:null,icon_url:null,icon_offset_x:null,icon_offset_y:null,symbol:null,initialize:function(){GeoBeans.Symbolizer.prototype.initialize.apply(this,arguments),this.type=GeoBeans.Symbolizer.Type.Point,this.fill=new GeoBeans.Fill,this.stroke=new GeoBeans.Stroke,this.size=3},clone:function(){var l=new GeoBeans.Symbolizer.PointSymbolizer;return null!=this.fill?l.fill=this.fill.clone():l.fill=null,null!=this.stroke?l.stroke=this.stroke.clone():l.stroke=null,l.size=this.size,null!=this.symbol?l.symbol=this.symbol.clone():l.symbol=null,l}});
GeoBeans.Symbolizer.PolygonSymbolizer=GeoBeans.Class(GeoBeans.Symbolizer,{fill:null,stroke:null,geomName:null,symbol:null,initialize:function(){GeoBeans.Symbolizer.prototype.initialize.apply(this,arguments),this.type=GeoBeans.Symbolizer.Type.Polygon,this.fill=new GeoBeans.Fill,this.stroke=new GeoBeans.Stroke},clone:function(){var l=new GeoBeans.Symbolizer.PolygonSymbolizer;return null!=this.fill?l.fill=this.fill.clone():l.fill=null,null!=this.stroke?l.stroke=this.stroke.clone():l.stroke=null,null!=this.symbol?l.symbol=this.symbol.clone():l.symbol=null,l.geomName=this.geomName,l}});
GeoBeans.Rule=GeoBeans.Class({name:null,symbolizer:null,textSymbolizer:null,filter:null,minScale:null,maxScale:null,initialize:function(){},clone:function(){var l=new GeoBeans.Rule;return l.name=this.name,null!=this.symbolizer&&(l.symbolizer=this.symbolizer.clone()),null!=this.textSymbolizer&&(l.textSymbolizer=this.textSymbolizer.clone()),null!=this.filter&&(l.filter=this.filter.clone()),l.minScale=this.minScale,l.maxScale=this.maxScale,l}});
GeoBeans.Stroke=GeoBeans.Class({color:null,width:null,lineCap:null,lineJoin:null,dashOffset:null,initialize:function(){this.color=new GeoBeans.Color,this.width=2,this.lineCap=GeoBeans.Stroke.LineCapType.RoundCap,this.lineJoin=GeoBeans.Stroke.LineJoinType.RoundJoin},getRgba:function(){return this.color.getRgba()},getRgb:function(){return this.color.getRgb()},getOpacity:function(){return this.color.getOpacity()},clone:function(){var e=new GeoBeans.Stroke;return null!=this.color&&(e.color=this.color.clone()),e.width=this.width,e.lineCap=this.lineCap,e.lineJoin=this.lineJoin,e.dashOffset=this.dashOffset,e}}),GeoBeans.Stroke.LineCapType={ButtCap:"butt",SquareCap:"square",RoundCap:"round",LineCapMax:"max"},GeoBeans.Stroke.LineJoinType={MiterJoin:"miter",MiterRevertJoin:"miterRevert",RoundJoin:"round",BevelJoin:"bevel",LineJoinMax:"max"};
GeoBeans.StyleManager=GeoBeans.Class({name:"",server:null,styles:null,colorMaps:null,service:"ims",version:"1.0.0",reader:null,writer:null,initialize:function(e){this.server=e+"/mgr",this.styles=[],this.colorMaps=[],this.reader=new GeoBeans.StyleReader,this.writer=new GeoBeans.StyleWriter},getStyles:function(){var e=this,t="service="+this.service+"&version="+this.version+"&request=GetStyle";return $.ajax({type:"get",url:this.server,data:encodeURI(t),dataType:"xml",async:!1,beforeSend:function(e){},success:function(t,r){e.styles=e.parseStyles(t)},complete:function(e,t){},error:function(){}}),this.styles},getStyle:function(e){if(null==this.styles)return null;for(var t=0;t<this.styles.length;++t){var r=this.styles[t];if(r.name==e)return r}return null},getStyleXML:function(e,t,r){if(null!=e){var n=this,s="service="+this.service+"&version="+this.version+"&request=GetStyle&name="+e;$.ajax({type:"get",url:this.server,data:encodeURI(s),dataType:"xml",async:!0,beforeSend:function(e){},success:function(s,o){var i=n.parseStyleXML(s);if(null==i&&null!=t)return void t(null,r);var a=n.getStyle(e);if(null==a)return void(void 0!=t&&t(i,r));var l=i.rules;a.rules=[];for(var c=0;c<l.length;++c)a.addRule(l[c]);a.styleClass=i.styleClass,void 0!=t&&t(a,r)},complete:function(e,t){},error:function(){}})}},getStyleByType:function(e){if(null==this.styles)return null;for(var t=new Array,r=0;r<this.styles.length;++r){var n=this.styles[r],s=n.geomType;s==e&&t.push(n)}return t},addStyle:function(e,t,r,n){var s=this,o="service="+this.service+"&version="+this.version+"&request=AddStyle&name="+t+"&type="+r+"&style="+e;$.ajax({type:"POST",url:this.server,data:encodeURI(o),contentType:"application/x-www-form-urlencoded",dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var r=s.parseAddStyleXml(e);s.getStyles(),void 0!=n&&n(r)},complete:function(e,t){},error:function(){}})},updateStyle:function(e,t,r){var n=this,s="service="+this.service+"&version="+this.version+"&request=UpdateStyle&name="+t+"&style="+e;$.ajax({type:"POST",url:this.server,data:encodeURI(s),contentType:"application/x-www-form-urlencoded",dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var s=n.parseUpdateStyleXml(e);n.getStyles(),void 0!=r&&r(s)},complete:function(e,t){},error:function(){}})},removeStyle:function(e,t){if(null!=e){var r=this,n="service="+this.service+"&version="+this.version+"&request=removeStyle&name="+e;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var s=r.parseRemoveStyleXml(e);r.getStyles(),void 0!=t&&t(s)},complete:function(e,t){},error:function(){}})}},getColorMaps:function(e){if(null==e){var t=this.getColorMapsSyn();return t}this.getColorMapsAsync(e)},getColorMapsAsync:function(e){var t=this,r="service="+this.service+"&version="+this.version+"&request=GetColorMap";$.ajax({type:"get",url:this.server,data:encodeURI(r),dataType:"xml",async:!0,beforeSend:function(e){},success:function(r,n){t.colorMaps=t.parseColorMaps(r),void 0!=e&&e(t.colorMaps)},complete:function(e,t){},error:function(){}})},getColorMapsSyn:function(){var e=this,t="service="+this.service+"&version="+this.version+"&request=GetColorMap";return $.ajax({type:"get",url:this.server,data:encodeURI(t),dataType:"xml",async:!1,beforeSend:function(e){},success:function(t,r){e.colorMaps=e.parseColorMaps(t)},complete:function(e,t){},error:function(){}}),e.colorMaps},getColorMapByID:function(e,t){if(null==t){var r=this.getColorMapByIDSyn(e);return r}this.getColorMapByIDAsync(e,t)},getColorMapByIDAsync:function(e,t){var r=this,n="service="+this.service+"&version="+this.version+"&request=GetColorMap&id="+e;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){r.colorMap=r.parseColorMapID(e),void 0!=t&&t(r.colorMap)},complete:function(e,t){},error:function(){}})},getColorMapByIDSyn:function(e){var t=this,r="service="+this.service+"&version="+this.version+"&request=GetColorMap&id="+e;return this.colorMapID=e,$.ajax({type:"get",url:this.server,data:encodeURI(r),dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,r){t.colorMap=t.parseColorMapID(e)},complete:function(e,t){},error:function(){}}),t.colorMap},getColorMap:function(e,t,r){if(null==r){var n=this.getColorMapSyn(e,t);return n}this.getColorMapAsync(e,t,r)},getColorMapSyn:function(e,t){var r=this,n="service="+this.service+"&version="+this.version+"&request=GetColorMap&id="+e+"&count="+t;return $.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,t){var n=r.parseColorMap(e);r.colors=n},complete:function(e,t){},error:function(){}}),r.colors},getColorMapAsync:function(e,t,r){var n=this,s="service="+this.service+"&version="+this.version+"&request=GetColorMap&id="+e+"&count="+t;$.ajax({type:"get",url:this.server,data:encodeURI(s),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var s=n.parseColorMap(e);void 0!=r&&r(s)},complete:function(e,t){},error:function(){}})},getColorMapNew:function(e,t,r){if(this.getColorMap_count=t,null==r){var n=this.getColorMapNewSyn(e,t);return n}this.getColorMapNewAsync(e,t,r)},getColorMapNewAsync:function(e,t,r){var n=this,s="service="+this.service+"&version="+this.version+"&request=GetColorMap&id="+e;$.ajax({type:"get",url:this.server,data:encodeURI(s),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var s=n.parseColorMapID(e),o=n.getColorMapList(s.startColor,s.endColor,null,n.getColorMap_count);r(o)},complete:function(e,t){},error:function(){}})},getColorMapNewSyn:function(e,t){},getColorMapList:function(e,t,r,n){if(null==e||null==t||null==n)return null;var s=[],o=new GeoBeans.Color;o.setByHex(e,1);var i=o.getHsl(),a=new GeoBeans.Color;a.setByHex(t,1);var l=a.getHsl();if(null==r)for(var c=0;c<n;++c){var u=i.h+c*(l.h-i.h)/(n-1),p=i.s+c*(l.s-i.s)/(n-1),f=i.l+c*(l.l-i.l)/(n-1),v=new GeoBeans.Color;v.setByHsl(u,p,f),s.push(v.getHex())}else{var y=new GeoBeans.Color;y.setByHex(r,1);var d=y.getHsl();if(n/2!=0)for(var r=Math.round(n/2)-1,c=0;c<n;++c)if(c<r){var u=i.h+c*(d.h-i.h)/(n-1),p=i.s+c*(d.s-i.s)/(n-1),f=i.l+c*(d.l-i.l)/(n-1),v=new GeoBeans.Color;v.setByHsl(u,p,f),s.push(v.getHex())}else if(c==r)s.push(y.getHex());else if(c>r){var u=d.h+c*(l.h-d.h)/(n-1),p=d.s+c*(l.s-d.s)/(n-1),f=d.l+c*(l.l-d.l)/(n-1),v=new GeoBeans.Color;v.setByHsl(u,p,f),s.push(v.getHex())}}return s},getSymbols:function(e,t){if(null==e)return void(null!=t&&t("params is invalid"));var r=this,n="service="+this.service+"&version="+this.version+"&request=GetSymbol&type="+e;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,n){var s=r.parseGetSymbol(e);void 0!=t&&t(s)},complete:function(e,t){},error:function(){}})},getSymbol:function(e,t){var r=this,n="service="+this.service+"&version="+this.version+"&request=GetSymbol&type="+e+"&name="+t;$.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,t){var n=r.parseGetSymbol(e);void 0!=callback&&callback(n)},complete:function(e,t){},error:function(){}})},getSymbolIcon:function(e,t){var r=this.server+"?service="+this.service+"&version="+this.version+"&request=GetSymbolIcon&type="+e+"&name="+t;return r},parseStyles:function(e){var t=this,r=new Array;return $(e).find("Style").each(function(){var e=$(this).attr("name"),n=$(this).attr("type"),s=t.readStyleType(n),o=new GeoBeans.Style.FeatureStyle(e,s);r.push(o)}),r},readStyleType:function(e){var t=null;switch(e=e.toLowerCase()){case"point":t=GeoBeans.Style.FeatureStyle.GeomType.Point;break;case"linestring":t=GeoBeans.Style.FeatureStyle.GeomType.LineString;break;case"polygon":t=GeoBeans.Style.FeatureStyle.GeomType.Polygon}return t},parseAddStyleXml:function(e){var t="",r=$(e).find("AddStyle").text();return"SUCCESS"==r.toUpperCase()?t="success":""!=$(e).find("ExceptionText").text()&&(t=$(e).find("ExceptionText").text()),t},parseUpdateStyleXml:function(e){var t="",r=$(e).find("UpdateStyle").text();return"SUCCESS"==r.toUpperCase()?t="success":""!=$(e).find("ExceptionText").text()&&(t=$(e).find("ExceptionText").text()),t},parseRemoveStyleXml:function(e){var t="",r=$(e).find("RemoveStyle").text();return"SUCCESS"==r.toUpperCase()?t="success":""!=$(e).find("ExceptionText").text()&&(t=$(e).find("ExceptionText").text()),t},parseStyleXML:function(e){var t=this.reader.read(e);return t},parseColorMaps:function(e){var t=[];return $(e).find("ColorMap").each(function(){var e=$(this).attr("id"),r=$(this).find("Start:first").text(),n=$(this).find("End:first").text(),s=$(this).find("OnlineResource").attr("xlink:href"),o=new GeoBeans.ColorMap(e,r,n,s);t.push(o)}),t},parseColorMapID:function(e){var t=this.colorMapID,r=$(e).find("Start:first").text(),n=$(e).find("End:first").text(),s=$(e).find("OnlineResource").attr("xlink:href"),o=new GeoBeans.ColorMap(t,r,n,s);return o},parseColorMap:function(e){var t=[];return $(e).find("Color").each(function(){var e=$(this).text();t.push(e)}),t},parseGetSymbol:function(e){var t=[],r=this;return $(e).find("Symbol").each(function(){var e=r.parseSymbol(this);null!=e&&t.push(e)}),t},parseSymbol:function(e){var t=$(e).find("Name").text(),r=$(e).find("Icon").attr("xlink:href"),n=null;return null==t&&null==r||(n=new GeoBeans.Symbol(t,r)),n}});
GeoBeans.StyleReader=GeoBeans.Class({filterReader:null,initialize:function(){this.filterReader=new GeoBeans.FilterReader},read:function(e){var t=null,l=$(e),r=l.find("sld\\:StyledLayerDescriptor");if(1!=r.length)return null;var i=r.children()[0].tagName;i=i.slice(i.lastIndexOf(":")+1,i.length);return"UserLayer"==i?t=this.parseUserLayer(r.children()):"NamedLayer"==i&&(t=this.parseNamedLayer(r.children())),t},parseUserLayer:function(e){var t=e.find("sld\\:UserStyle");if(1!=t.length)return null;var l=this.parseUserStyle(e);return l},parseUserStyle:function(e){var t=e.find("Name:first").text(),l=e.find("sld\\:FeatureTypeStyle");if(1!=l.length)return null;var r=this.parseFeatureTypeXML(e),i=e.find("sld\\:StyleClass").text();null!=i&&(r.styleClass=i);var a=e.find("sld\\:StyleField").text();return null!=a&&(r.field=a),r.name=t,r},parseFeatureTypeXML:function(e){var t=new GeoBeans.Style.FeatureStyle,l=this;return e.find("sld\\:Rule").each(function(){var e=l.parseRule($(this));t.addRule(e)}),t},parseRule:function(e){var t=this,l=new GeoBeans.Rule;e.children().each(function(){var e=this.tagName;if(e=e.slice(e.lastIndexOf(":")+1,e.length),"Name"==e)l.name=$(this).text();else if("PointSymbolizer"==e){var r=t.parsePointSymbolizer($(this));l.symbolizer=r}else if("LineSymbolizer"==e){var i=t.parseLineSymbolizer($(this));l.symbolizer=i}else if("PolygonSymbolizer"==e){var a=t.parsePolygonSymbolizer($(this));l.symbolizer=a}else if("TextSymbolizer"==e){var n=t.parseTextSymbolizer($(this));l.textSymbolizer=n}else if("MinScaleDenominator"==e){var s=$(this).text();l.minScale=s}else if("MaxScaleDenominator"==e){var o=$(this).text();l.maxScale=o}else if("Filter"==e){var f=t.filterReader.read($(this));l.filter=f}});e.find("sld\\:Name:first").text(),e.find("sld\\:Title:first").text();return l},parsePointSymbolizer:function(e){var t=this,l=new GeoBeans.Symbolizer.PointSymbolizer;return l.stroke=null,l.fill=null,e.children().each(function(){var e=this.tagName;e=e.slice(e.lastIndexOf(":")+1,e.length),"Graphic"==e&&t.parseGraphic($(this),l)}),l},parseLineSymbolizer:function(e){var t=this,l=new GeoBeans.Symbolizer.LineSymbolizer;return l.fill=null,l.stroke=null,e.children().each(function(){var e=this.tagName;if(e=e.slice(e.lastIndexOf(":")+1,e.length),"Stroke"==e){var r=t.parseStroke($(this));l.stroke=r}else if("Geometry"==e);else if("WellKnownName"==e){var i=t.parseSymbol($(this));l.symbol=i}else if("Fill"==e){var a=t.parseFill($(this));l.fill=a}}),l},parsePolygonSymbolizer:function(e){var t=this,l=new GeoBeans.Symbolizer.PolygonSymbolizer;return l.stroke=null,l.fill=null,e.children().each(function(){var e=this.tagName;if(e=e.slice(e.lastIndexOf(":")+1,e.length),"Fill"==e){var r=t.parseFill($(this));l.fill=r}else if("Stroke"==e){var i=t.parseStroke($(this));l.stroke=i}else if("Geometry"==e){var a=t.parseGeometry($(this));l.geomName=a}else if("WellKnownName"==e){var n=t.parseSymbol($(this));l.symbol=n}}),l},parseGraphic:function(e,t){var l=this;e.children().each(function(){var e=this.tagName;if(e=e.slice(e.lastIndexOf(":")+1,e.length),"Size"==e){var r=parseFloat($(this).text());t.size=r}else"Mark"==e&&l.parseMark($(this),t)})},parseMark:function(e,t){var l=this;e.children().each(function(){var e=this.tagName;if(e=e.slice(e.lastIndexOf(":")+1,e.length),"WellKnownName"==e){var r=l.parseSymbol($(this));t.symbol=r}if("Fill"==e){var i=l.parseFill($(this));t.fill=i}else if("Stroke"==e){var a=l.parseStroke($(this));t.stroke=a}})},parseSize:function(e,t){e.children().each(function(){var e=this.tagName;if(e=e.slice(e.lastIndexOf(":")+1,e.length),"Literal"==e){var l=$(this).text();t.size=parseFloat(l)}})},parseStroke:function(e){var t=new GeoBeans.Stroke,l=null,r=null,i=null;e.children().each(function(){var e=$(this).attr("name");"stroke"==e?l=$(this).text():"stroke-opacity"==e?r=$(this).text():"stroke-width"==e&&(i=parseFloat($(this).text()))});var a=new GeoBeans.Color;return a.setByHex(l,r),t.color=a,t.width=i,t},parseFill:function(e){var t=new GeoBeans.Fill,l=null,r=null;e.children().each(function(){var e=$(this).attr("name");"sld\\:fill"==e?l=$(this).text():"sld\\:fill-opacity"==e&&(r=$(this).text())});var i=new GeoBeans.Color;return i.setByHex(l,r),t.color=i,t},parseSymbol:function(e){var t=e.text();if(null!=t||""!=t){var l=new GeoBeans.Symbol(t,null);return l}return null},parseNamedLayer:function(e){return null},parseTextSymbolizer:function(e){var t=this,l=new GeoBeans.Symbolizer.TextSymbolizer;return l.fill=null,l.stroke=null,e.children().each(function(){var e=this.tagName;if(e=e.slice(e.lastIndexOf(":")+1,e.length),"Label"==e)t.parseLabel($(this),l);else if("Font"==e){var r=t.parseFont($(this));l.font=r}else if("LabelPlacement"==e);else if("Fill"==e){var i=t.parseFill($(this));l.fill=i}else if("Stroke"==e){var a=t.parseStroke($(this));l.stroke=a}}),l},parseLabel:function(e,t){var l=$(e).find("ogc\\:PropertyName");if(1==l.length){var r=l.text();t.labelProp=r}else{var i=e.text();t.labelText=i}},parseFont:function(e){var t=new GeoBeans.Font;return e.children().each(function(){var e=$(this).attr("name");if("font-family"==e){var l=$(this).text();t.family=l}else if("font-size"==e){var r=parseFloat($(this).text());t.size=r}else if("font-style"==e){var i=$(this).text();"normal"==i?t.style=GeoBeans.Font.StyleType.Normal:"italic"==i?t.style=GeoBeans.Font.StyleType.Italic:"oblique"==i&&(t.style=GeoBeans.Font.StyleType.Oblique)}else if("font-weight"==e){var a=$(this).text();"normal"==a?t.weight=GeoBeans.Font.WeightType.Normal:"bold"==a&&(t.weight=GeoBeans.Font.WeightType.Bold)}}),t},parseGeometry:function(e){var t=$(e).find("sld\\:PropertyName");if(1==t.length){var l=t.text();return l}return null}});
GeoBeans.StyleWriter=GeoBeans.Class({filterWriter:null,initialize:function(){this.filterWriter=new GeoBeans.FilterWriter},write:function(e){if(null==e)return null;var t=null;if(e.type==GeoBeans.Style.Type.FeatureType?t=this.writeFeature(e):e.type==GeoBeans.Style.Type.RasterType&&(t=this.writeRaster(e)),null!=t){var r=(new XMLSerializer).serializeToString(t);return r}return null},writeFeature:function(e){var t=$.parseXML('<?xml version="1.0" encoding="UTF-8"?><sld:StyledLayerDescriptor xmlns="http://www.opengis.net/sld" xmlns:sld="http://www.opengis.net/sld" xmlns:ogc="http://www.opengis.net/ogc" xmlns:gml="http://www.opengis.net/gml" version="1.0.0"/>'),r=t.createElement("sld:UserLayer"),l=t.createElement("sld:LayerFeatureConstraints"),a=t.createElement("sld:FeatureTypeConstraint");$(l).append(a),$(r).append(l);var n=this.writeUserStyle(t,e);return $(r).append(n),$("sld\\:StyledLayerDescriptor",t).append(r),t},writeRaster:function(e){return null},writeUserStyle:function(e,t){var r=e.createElement("sld:UserStyle"),l=t.name,a=e.createElement("sld:Name");$(a).text(l),$(r).append(a);var n=this.writeFeatureType(e,t);$(r).append(n);var i=t.styleClass;if(null!=i){var s=e.createElement("sld:StyleClass");if($(s).text(i),$(r).append(s),i==GeoBeans.Style.FeatureStyle.StyleClass.DOTDENSITY){var p=t.field;if(null!=p){var o=e.createElement("sld:StyleField");$(o).text(p),$(r).append(o)}}}return r},writeFeatureType:function(e,t){for(var r=e.createElement("sld:FeatureTypeStyle"),l=t.rules,a=0;a<l.length;++a){var n=l[a];if(null!=n){var i=this.writeRule(e,n);$(r).append(i)}}return r},writeRule:function(e,t){var r=e.createElement("sld:Rule"),l=t.name;if(null!=l){var a=e.createElement("sld:Name");$(a).text(l),$(r).append(a)}var n=t.filter;if(null!=n){var i=this.filterWriter.write(e,n);$(r).append(i)}var s=t.symbolizer;if(null!=s){var p=s.type;if(p==GeoBeans.Symbolizer.Type.Point){var o=this.writePointSymbolizer(e,s);$(r).append(o)}else if(p==GeoBeans.Symbolizer.Type.Line){var m=this.writeLineSymbolizer(e,s);$(r).append(m)}else if(p==GeoBeans.Symbolizer.Type.Polygon){var d=this.writePolygonSymbolizer(e,s);$(r).append(d)}}var u=t.textSymbolizer;if(null!=u){var v=this.writeTextSymbolizer(e,u);$(r).append(v)}return r},writePointSymbolizer:function(e,t){var r=e.createElement("sld:PointSymbolizer"),l=e.createElement("sld:Graphic"),a=e.createElement("sld:Mark"),n=t.symbol;if(null!=n){var i=this.writeSymbol(e,n);$(a).append(i)}var s=t.fill;if(null!=s){var p=this.writeFill(e,s);$(a).append(p)}var o=t.stroke;if(null!=o){var m=this.writeStroke(e,o);$(a).append(m)}$(l).append(a);var d=t.size,u=e.createElement("sld:Size");return $(u).text(d),$(l).append(u),$(r).append(l),r},writeLineSymbolizer:function(e,t){var r=e.createElement("sld:LineSymbolizer"),l=t.symbol;if(null!=l){var a=this.writeSymbol(e,l);$(r).append(a)}var n=t.stroke;if(null!=n){var i=this.writeStroke(e,n);$(r).append(i)}var s=t.fill;if(null!=s){var p=this.writeFill(e,s);$(r).append(p)}return r},writePolygonSymbolizer:function(e,t){var r=e.createElement("sld:PolygonSymbolizer"),l=t.geomName;if(null!=l){var a=this.writeGeom(e,l);$(r).append(a)}var n=t.symbol;if(null!=n){var i=this.writeSymbol(e,n);$(r).append(i)}var s=t.fill;if(null!=s){var p=this.writeFill(e,s);$(r).append(p)}var o=t.stroke;if(null!=o){var m=this.writeStroke(e,o);$(r).append(m)}return r},writeFill:function(e,t){var r=e.createElement("sld:Fill"),l=t.color,a=l.getHex(),n=e.createElement("sld:CssParameter");$(n).attr("name","fill").text(a),$(r).append(n);var i=e.createElement("sld:CssParameter"),s=l.getOpacity();return $(i).attr("name","fill-opacity").text(s),$(r).append(i),r},writeStroke:function(e,t){var r=e.createElement("sld:Stroke"),l=t.color,a=l.getHex(),n=e.createElement("sld:CssParameter");$(n).attr("name","stroke").text(a),$(r).append(n);var i=l.getOpacity(),s=e.createElement("sld:CssParameter");$(s).attr("name","stroke-opacity").text(i),$(r).append(s);var p=t.width,o=e.createElement("sld:CssParameter");return $(o).attr("name","stroke-width").text(p),$(r).append(o),r},writeSize:function(e,t){var r=e.createElement("sld:Size"),l=e.createElement("ogc:Literal");return $(l).text(t),$(r).append(l),r},writeGeom:function(e,t){var r=e.createElement("sld:Geometry"),l=e.createElement("ogc:PropertyName");return $(l).text(t),$(r).append(l),r},writeTextSymbolizer:function(e,t){var r=e.createElement("sld:TextSymbolizer"),l=t.labelText;if(null!=l){var a=e.createElement("sld:Label");$(a).text(l),$(r).append(a)}var n=t.labelProp;if(null!=n){var i=e.createElement("sld:Label"),s=e.createElement("ogc:PropertyName");$(s).text(n),$(i).append(s),$(r).append(i)}var p=t.font;if(null!=p){var o=this.writeFont(e,p);$(r).append(o)}var m=t.fill;if(null!=m){var d=this.writeFill(e,m);$(r).append(d)}var u=t.stroke;if(null!=u){var v=this.writeStroke(e,u);$(r).append(v)}return r},writeFont:function(e,t){var r=e.createElement("sld:Font"),l=t.family;if(null!=l){var a=e.createElement("sld:CssParameter");$(a).attr("name","font-family").text(l),$(r).append(a)}var n=t.size;if(null!=n){var i=e.createElement("sld:CssParameter");$(i).attr("name","font-size").text(n),$(r).append(i)}var s=t.style;if(null!=s){var p=e.createElement("sld:CssParameter");$(p).attr("name","font-style").text(s),$(r).append(p)}var o=t.weight;if(null!=o){var m=e.createElement("sld:CssParameter");$(m).attr("name","font-weight").text(o),$(r).append(m)}return r},writeSymbol:function(e,t){if(null==t)return null;var r=e.createElement("sld:WellKnownName");return $(r).text(t.name),r}});
GeoBeans.Symbol=GeoBeans.Class({name:null,icon:null,initialize:function(n,i){this.name=n,this.icon=i},clone:function(){var n=new GeoBeans.Symbol;return null!=this.name&&(n.name=this.name),null!=this.icon&&(n.icon=this.icon),n}});
GeoBeans.Symbolizer.TextSymbolizer=GeoBeans.Class(GeoBeans.Symbolizer,{fill:null,stroke:null,rotation:null,rotationProp:null,font:null,labelText:null,labelProp:null,anchorX:0,anchorY:0,displaceX:0,displaceY:0,initialize:function(){GeoBeans.Symbolizer.prototype.initialize.apply(this,arguments),this.type=GeoBeans.Symbolizer.Type.Text,this.fill=new GeoBeans.Fill,this.stroke=new GeoBeans.Stroke,this.font=new GeoBeans.Font,this.anchorX=0,this.anchorY=0,this.displaceX=0,this.displaceY=0},clone:function(){var l=new GeoBeans.Symbolizer.TextSymbolizer;return null!=this.fill?l.fill=this.fill.clone():l.fill=null,null!=this.stroke?l.stroke=this.stroke.clone():l.stroke=null,l.rotation=this.rotation,l.rotationProp=this.rotationProp,null!=this.font?l.font=this.font.clone():l.font=null,l.labelText=this.labelText,l.labelProp=this.labelProp,l}});
GeoBeans.SubManager=GeoBeans.Class({server:null,service:"ims",version:"1.0.0",poinames:null,aqiCitys:null,aqiLayer:null,aqiSourceName:null,aqiTimeField:null,aqiCityField:null,aqiUptimeLayer:null,aqiUptimeField:null,aqiDowntimeField:null,aqiFeatureType:null,time:null,subInt:null,timeTick:600,user_callback:null,poiFeatures:null,aqiFeatures:null,initialize:function(e){this.server=e+"/mgr",this.time=new Date,null!=this.poinames&&null!=this.aqiCitys||this.getSubscription(this.getSubscription_callback)},setSubParams:function(e,t,i,a,r,n,s,l){this.aqiSourceName=e,this.aqiLayer=t,this.aqiTimeField=i,this.aqiCityField=a,this.aqiUptimeLayer=r,this.aqiUptimeField=n,this.aqiDowntimeField=s,this.user_callback=l;var o=new GeoBeans.WFSWorkspace("tmp",this.server,"1.0.0");this.aqiFeatureType=new GeoBeans.FeatureType(o,this.aqiLayer),this.aqiUptimeFeatureType=new GeoBeans.FeatureType(o,this.aqiUptimeLayer)},getSubscription:function(e){var t=this,i="service="+this.service+"&version="+this.version+"&request=GetSubscription";$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!0,beforeSend:function(e){},success:function(i,a){var r=t.parseGetSubscription(i);null!=e&&e(t,r)},complete:function(e,t){},error:function(){}})},parseGetSubscription:function(e){var t=$(e).find("ExceptionText");if(0!=t.length)return t.text();var i=new Object;return $(e).find("Theme").each(function(){var e=$(this).attr("name"),t=[],a=[];"poi"==e?$(this).find("Keyword").each(function(){var e=$(this).text();a.push(e)}):"aqi"==e&&$(this).find("Keyword").each(function(){var e=$(this).text();t.push(e)}),i.poi=a,i.aqi=t}),i},getSubscription_callback:function(e,t){if(null!=e&&null!=t){var i=t.poi,a=t.aqi;e.poinames=i,e.aqiCitys=a,e.beginSubscribe()}},beginSubscribe:function(){if(null==this.subInt&&null!=this.aqiFeatureType){var e=this;this.subInt=setInterval(function(){e.getSubscription(e.subscribe_callback)},1e3*this.timeTick)}},subscribe_callback:function(e,t){if(null!=e&&null!=t){var i=t.poi,a=t.aqi;e.poinames=i,e.aqiCitys=a,null!=a&&0!=a.length&&e.getDownloadTime(e.time,e.getDownloadTime_callback);var r=e.dateAdd(e.time,"second",e.timeTick);e.time=r}},getDownloadTime:function(e,t){if(null!=e&&null!=this.aqiUptimeFeatureType){var i=this.dateAdd(e,"minute",-1),a=new GeoBeans.BinaryComparisionFilter;a.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprGreaterThan;var r=new GeoBeans.PropertyName;r.setName(this.aqiDowntimeField);var n=new GeoBeans.Literal,s=this.getTimeFormat(i);n.setValue(s),a.expression1=r,a.expression2=n,this.aqiUptimeFeatureType.fields=this.aqiUptimeFeatureType.getFields(null,this.aqiSourceName);var l=this.aqiUptimeFeatureType.buildGetFeatureFilterXML(null,this.aqiSourceName,a,null,null,null),o=this.server,u=this;$.ajax({type:"post",url:o,data:l,contentType:"text/xml",dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,i){var a=u.aqiUptimeFeatureType.parseFeatures(e);void 0!=t&&t(u,a)},complete:function(e,t){},error:function(e,t,i){console.log("textStatus:"+t),console.log("error:"+i)}})}},getDownloadTime_callback:function(e,t){if(null!=e&&null!=t&&0!=t.length){for(var i=[],a=(e.aqiUptimeFeatureType.getFields(),e.aqiUptimeFeatureType.getFieldIndex(e.aqiUptimeField)),r=null,n=null,s=null,l=0;l<t.length;++l)n=t[l],null!=n&&(r=n.values,s=r[a],null!=s&&i.push(s));e.getAqisByUptime(e.aqiCitys,i,e.getAqisByUptime_callback)}},getAqisByUptime:function(e,t,i){if(null!=e&&null!=t&&$.isArray(e)&&$.isArray(t)){var a=new GeoBeans.BinaryLogicFilter;a.operator=GeoBeans.LogicFilter.OperatorType.LogicOprOr;for(var r=null,n=0;n<e.length;++n){r=e[n];var s=new GeoBeans.BinaryComparisionFilter;s.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var l=new GeoBeans.PropertyName;l.setName(this.aqiCityField);var o=new GeoBeans.Literal;o.setValue(r),s.expression1=l,s.expression2=o,a.addFilter(s)}var u=null,c=new GeoBeans.BinaryLogicFilter;c.operator=GeoBeans.LogicFilter.OperatorType.LogicOprOr;for(var n=0;n<t.length;++n){u=t[n];var p=new GeoBeans.BinaryComparisionFilter;p.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var l=new GeoBeans.PropertyName;l.setName(this.aqiTimeField);var o=new GeoBeans.Literal;o.setValue(u),p.expression1=l,p.expression2=o,c.addFilter(p)}var h=new GeoBeans.BinaryLogicFilter;h.operator=GeoBeans.LogicFilter.OperatorType.LogicOprAnd,h.addFilter(a),h.addFilter(c),this.aqiFeatureType.fields=this.aqiFeatureType.getFields(null,this.aqiSourceName);var m=this.aqiFeatureType.buildGetFeatureFilterXML(null,this.aqiSourceName,h,200,null,null),d=this.server,F=this;$.ajax({type:"post",url:d,data:m,contentType:"text/xml",dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var a=F.aqiFeatureType.parseFeatures(e);if(void 0!=i){var r=F.time;i(F,r,"aqi",a)}},complete:function(e,t){},error:function(e,t,i){console.log("textStatus:"+t),console.log("error:"+i)}})}},getAqisByUptime_callback:function(e,t,i,a){var r=e.dateAdd(t,"second",-e.timeTick);"aqi"==i?e.aqiFeatures=a:"poi"==i&&(e.poiFeatures=a),null!=e.user_callback&&(e.poiFeatures=[],e.user_callback(r,e.poiFeatures,e.aqiFeatures))},getSubFeatures:function(e){null!=this.poinames&&null!=this.aqiCitys&&null!=this.aqiFeatureType&&(this.aqiFeatures=null,this.poiFeatures=null,this.getPois(this.poinames,e,this.getSubFeatures_callback),this.getAqis(this.aqiCitys,e,this.getSubFeatures_callback))},getPois:function(e,t,i){this.poiFeatures=[]},getAqis:function(e,t,i){if(null!=e){0==e.length&&(this.aqiFeatures=[]);var a=new GeoBeans.BinaryComparisionFilter;a.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprGreaterThan;var r=new GeoBeans.PropertyName;r.setName(this.aqiTimeField);var n=new GeoBeans.Literal,s=this.getTimeFormat(t);n.setValue(s),a.expression1=r,a.expression2=n;var l=new GeoBeans.BinaryLogicFilter;l.operator=GeoBeans.LogicFilter.OperatorType.LogicOprOr;for(var o=null,u=0;u<e.length;++u){o=e[u];var c=new GeoBeans.BinaryComparisionFilter;c.operator=GeoBeans.ComparisionFilter.OperatorType.ComOprEqual;var r=new GeoBeans.PropertyName;r.setName(this.aqiCityField);var n=new GeoBeans.Literal;n.setValue(o),c.expression1=r,c.expression2=n,l.addFilter(c)}var p=new GeoBeans.BinaryLogicFilter;p.operator=GeoBeans.LogicFilter.OperatorType.LogicOprAnd,p.addFilter(a),p.addFilter(l),this.aqiFeatureType.fields=this.aqiFeatureType.getFields(null,this.aqiSourceName);var h=this.aqiFeatureType.buildGetFeatureFilterXML(null,this.aqiSourceName,p,200,null,null),m=this.server,d=this;$.ajax({type:"post",url:m,data:h,contentType:"text/xml",dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,a){var r=d.aqiFeatureType.parseFeatures(e);void 0!=i&&i(d,t,"aqi",r)},complete:function(e,t){},error:function(e,t,i){console.log("textStatus:"+t),console.log("error:"+i)}})}},getSubFeatures_callback:function(e,t,i,a){null!=e&&null!=i&&null!=a&&("aqi"==i?e.aqiFeatures=a:"poi"==i&&(e.poiFeatures=a),null!=e.user_callback&&e.user_callback(t,e.poiFeatures,e.aqiFeatures))},dateAdd:function(e,t,i){var a=new Date(e);switch(t.toLowerCase()){case"year":a.setFullYear(a.getFullYear()+i);break;case"quarter":a.setMonth(a.getMonth()+3*i);break;case"month":a.setMonth(a.getMonth()+i);break;case"week":a.setDate(a.getDate()+7*i);break;case"day":a.setDate(a.getDate()+i);break;case"hour":a.setTime(a.getTime()+36e5*i);break;case"minute":a.setTime(a.getTime()+6e4*i);break;case"second":a.setTime(a.getTime()+1e3*i);break;default:a=void 0}return a},getTimeFormat:function(e){if(null==e)return null;var t=this.dateFormat(e,"yyyy-MM-dd hh:mm:ss");return t},dateFormat:function(e,t){var i={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length)));for(var a in i)new RegExp("("+a+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?i[a]:("00"+i[a]).substr((""+i[a]).length)));return t},subscribe:function(e,t,i){if(null==e||null==t||!$.isArray(t))return void(null!=i&&i("params is invalid"));for(var a="",r=0;r<t.length;++r){var n=t[r];null!=n&&(a+=n,r+1<t.length&&(a+=","))}var s="service="+this.service+"&version="+this.version+"&request=subscribe&theme="+e+"&keywords="+a,l=this;$.ajax({type:"get",url:this.server,data:encodeURI(s),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var a=l.parseSubscribe(e);null!=i&&i(a),"SUCCESS"==a&&l.getSubscription(l.getSubscription_callback)},complete:function(e,t){},error:function(){}})},parseSubscribe:function(e){var t=$(e).find("Subscribe").text();if("success"==t.toLowerCase())return"SUCCESS";var i=$(e).find("ExceptionText");return 0!=i.length?i.text():void 0},endSubSribe:function(){null!=this.subInt&&clearInterval(this.subInt),this.subInt=null},Unsubscribe:function(e,t,i){if(null==e||null==t)return void(null!=i&&i("params is invalid"));var a="service="+this.service+"&version="+this.version+"&request=Unsubscribe&theme="+e+"&keywords="+t,r=this;$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var a=r.parseUnsubscribe(e);null!=i&&i(a),"SUCCESS"==a&&r.getSubscription(r.getSubscription_callback)},complete:function(e,t){},error:function(){}})},parseUnsubscribe:function(e){var t=$(e).find("Unsubscribe").text();if("success"==t.toLowerCase())return"SUCCESS";var i=$(e).find("ExceptionText");return 0!=i.length?i.text():void 0}});
GeoBeans.TileDBManager=GeoBeans.Class({name:null,userServer:null,server:null,service:"wmts",version:"1.0.0",initialize:function(e){this.userServer=e},setName:function(e){null!=e&&(this.name=e,this.server=this.userServer+"/"+this.name+"/wmts")},getCapabilities:function(){var e=this,t="service="+this.service+"&version="+this.version+"&request=GetCapabilities";return $.ajax({type:"get",url:this.server,data:encodeURI(t),dataType:"xml",async:!1,beforeSend:function(e){},success:function(t,r){e.layers=e.parseGetCapabilities(t)},complete:function(e,t){},error:function(){}}),e.layers},parseGetCapabilities:function(e){var t=[],r=this;return $(e).find("Layer").each(function(){var e=r.parseLayer(this);t.push(e)}),t},parseLayer:function(e){var t=$(e).find("Identifier:first").text(),r=$(e).find("Format:first").text(),i=$(e).find("TileMatrixSetLink>TileMatrixSet").text(),s=$(e).find("LowerCorner").text(),n=$(e).find("UpperCorner").text(),a=s.indexOf(" "),l=s.lastIndexOf(" "),o=s.slice(0,a),f=s.slice(l+1,s.length);a=n.indexOf(" "),l=n.lastIndexOf(" ");var u=n.slice(0,a),c=n.slice(l+1,n.length),p=new GeoBeans.Envelope(parseFloat(o),parseFloat(f),parseFloat(u),parseFloat(c)),v=new GeoBeans.Layer.WMTSLayer(t,this.server,t,p,i,r);return v}});
GeoBeans.TileStore=GeoBeans.Class({name:null,extent:null,format:null,tms:null,sourceName:null,startLevel:null,endLevel:null,srid:null,initialize:function(e,l,t,s,n,i,a,u){this.name=e,this.extent=l,this.format=t,this.tms=s,this.sourceName=n,this.startLevel=i,this.endLevel=a,this.srid=u}});
GeoBeans.WFSWorkspace=GeoBeans.Class(GeoBeans.Workspace,{server:null,service:"wfs",version:"1.0.0",featureTypes:null,xmlns:null,xmlnsWorkspace:null,workspaceName:null,initialize:function(e,t,n){GeoBeans.Workspace.prototype.initialize.apply(this,arguments),this.server=t,this.version=n,this.featureTypes=null;var s=t.lastIndexOf("/"),r=t.substr(0,s),a=r.lastIndexOf("/");this.workspaceName=r.substr(a+1,r.length)},destory:function(){this.server=null,this.version=null,this.featureTypes=null,GeoBeans.Workspace.prototype.destory.apply(this,arguments)},getFeatureTypes:function(e){if(null!=this.featureTypes)return this.featureTypes;var t=this,n="service="+this.service+"&version="+this.version+"&request=getCapabilities";return $.ajax({type:"get",url:this.server,data:encodeURI(n),dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,n){t.featureTypes=t.parseFeatureTypes(e),t.xmlns=$(e).children("WFS_Capabilities").attr("xmlns");var s="xmlns:"+t.workspaceName;t.xmlnsWorkspace=$(e).children("WFS_Capabilities").attr(s)},complete:function(e,t){},error:function(){}}),this.featureTypes},getFeatureType:function(e){for(var t=this.getFeatureTypes(),n=t.length,s=0;s<n;s++){var r=t[s];if(r.name==e)return r}return null},parseFeatureTypes:function(e){var t=null,n=new Array,s=this;return $(e).find("FeatureType").each(function(){t=s.parseFeatureType(this),n.push(t)}),n},parseFeatureType:function(e){var t=$(e).children("Name:first").text(),n=$(e).children("Title:first").text(),s=$(e).children("Keywords:first").text(),r=$(e).children("SRS:first").text(),a=$(e).children("LatLongBoundingBox:first"),i=parseFloat($(a).attr("minx")),o=parseFloat($(a).attr("maxx")),l=parseFloat($(a).attr("miny")),u=parseFloat($(a).attr("maxy")),c=new GeoBeans.Envelope(i,l,o,u),p=new GeoBeans.FeatureType(this);return p.setName(t),p.setTitle(n),p.setKeywords(s),p.setSrs(r),p.setExtent(c),p},queryByBuffer:function(e,t,n,s){if(!(null==e||e<0||null==t||null==n)){var r=n.geomFieldName,a=new GeoBeans.Geometry.GML.Writer(GeoBeans.Geometry.GML.Version.v_2_0),i=(a.write(t),n.name),o=this.buildBufferXML(i,r,t,e);$.ajax({type:"post",url:this.server,contentType:"text/xml",data:o,dataType:"xml",async:!1,beforeSend:function(e){},success:function(e,t){var r=n.parseFeatures(e);s(r)},complete:function(e,t){},error:function(){}})}},buildBufferXML:function(e,t,n,s){var r="",a=this.workspaceName,i='xmlns:wfs="http://www.opengis.net/wfs"',o="xmlns:"+a+'="'+this.xmlnsWorkspace+'"',l='xmlns:gml="http://www.opengis.net/gml"',u='xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"',c='xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.0.0/WFS-basic.xsd"',p=new GeoBeans.Geometry.GML.Writer(GeoBeans.Geometry.GML.Version.v_2_0),f=p.write(n);return r+='<wfs:GetFeature service="WFS" version="1.0.0"  '+i+" "+o+" "+l+" "+u+" "+c+'><wfs:Query typeName="'+e+'"><Filter><DWithin><PropertyName>'+t+"</PropertyName>"+f+"<Distance>"+s+"</Distance></DWithin></Filter></wfs:Query></wfs:GetFeature>"},transaction:function(e,t,n,s){var r=this.server,a=this.buildTransactionXML(e,t,n);$.ajax({type:"post",url:r,data:a,dataType:"xml",contentType:"text/xml",async:!1,beforeSend:function(e){},success:function(e,t){var n=$(e),r=n.find("SUCCESS");if(0!=r.length){var a=n.find("InsertResult");if(0!=a.length){var i=a.find("FeatureId").attr("fid");return i=i.substr(i.lastIndexOf(".")+1,i.length),s(i),that.features=null,void that.map.draw()}}var o=n.find("ServiceExceptionReport");if(0!=o.length){var l=n.find("ServiceException").text();return void s(l)}},complete:function(e,t){},error:function(){}})},buildTransactionXML:function(e,t,n){if(null!=e&&null!=t&&null!=n){for(var s="",r=e.name,a=this.workspaceName,i='xmlns:wfs="http://www.opengis.net/wfs"',o="xmlns:"+a+'="'+this.xmlnsWorkspace+'"',l='xmlns:gml="http://www.opengis.net/gml"',u='xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"',c='xsi:schemaLocation="http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.0.0/WFS-basic.xsd"',p="",f=0;f<n.length;++f){var m=n[f],h=m.field,w=m.value;e.getFieldIndex(h)!=-1&&(p+="<"+a+":"+h+">",p+=w,p+="</"+a+":"+h+">")}var v=new GeoBeans.Geometry.GML.Writer(GeoBeans.Geometry.GML.Version.v_2_0),d=v.write(t),x="";return x+="<"+a+":"+e.geomFieldName+">",x+=d,x+="</"+a+":"+e.geomFieldName+">",s+='<wfs:Transaction service="WFS" version="1.0.0"  '+i+" "+o+" "+l+" "+u+" "+c+">",s+="<wfs:Insert>",s+="<"+a+":"+r+">",s+=p,s+=x,s+="</"+a+":"+r+">",s+="</wfs:Insert>",s+="</wfs:Transaction>"}},getValue:function(e,t,n,s,r){if(null!=e&&null!=t&&null!=s){null==r&&(r="asc");var a=this,i="service="+this.service+"&version="+this.version+"&request=GetValue&typeName="+e+"&field="+t+"&type=unique&order="+r;null!=n&&(i+="&mapName="+n),$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=a.parseValues(e);s(n)},complete:function(e,t){},error:function(){}})}},parseValues:function(e){var t=[];return $(e).find("wfs\\:Value").each(function(){var e=$(this).text();t.push(e)}),t},getMinMaxValue:function(e,t,n,s){if(null!=e&&null!=t&&null!=s){var r=this,a="service="+this.service+"&version="+this.version+"&request=GetValue&typeName="+e+"&field="+t+"&type=minmax";null!=n&&(a+="&mapName="+n),$.ajax({type:"get",url:this.server,data:encodeURI(a),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var n=r.pareseMinMaxValue(e);s(n)},complete:function(e,t){},error:function(){}})}},pareseMinMaxValue:function(e){var t=$(e).find("wfs\\:Min").text(),n=$(e).find("wfs\\:Max").text(),s=new Object;return s.min=parseFloat(t),s.max=parseFloat(n),s}});
GeoBeans.WMSWorkspace=GeoBeans.Class(GeoBeans.Workspace,{server:null,service:"wms",version:"1.3.0",layers:null,extent:null,format:"image/png",srs:"EPSG:4326",transparent:"true",initialize:function(e,t,s){GeoBeans.Workspace.prototype.initialize.apply(this,arguments),this.server=t,this.version=s,this.layers=null,this.extent=null},destory:function(){this.server=null,this.version=null,this.layers=null,this.extent=null,GeoBeans.Workspace.prototype.destory.apply(this,arguments)},getLayers:function(e){return void 0==e?this.getLayers_sync():void this.getLayers_aync(e)},getLayers_sync:function(){var e=this,t="service="+this.service+"&version="+this.version+"&request=getCapabilities";return $.ajax({type:"get",url:this.server,data:encodeURI(t),dataType:"xml",async:!1,beforeSend:function(e){},success:function(t,s){e.parseCapabilities(t)},complete:function(e,t){},error:function(){}}),this.layers},getLayers_aync:function(e){var t=this,s="service="+this.service+"&version="+this.version+"&request=getCapabilities";$.ajax({type:"get",url:this.server,data:encodeURI(s),dataType:"xml",async:!0,beforeSend:function(e){},success:function(s,r){t.parseCapabilities(s),e(t.layers)},complete:function(e,t){},error:function(t,s){null!=e&&e(s)}})},getMap:function(e,t,s,r,a,n){var i=this,o=this.getMapURL(e,t,s,r,a,n);$.ajax({type:"get",url:this.server,data:encodeURI(o),dataType:"xmllayers, styles, width, height, format",async:!0,beforeSend:function(e){},success:function(e,t){i.parseCapabilities(e),callback(i.layers)},complete:function(e,t){},error:function(){}})},parseCapabilities:function(e){this.extent=this.parseExent($(e).find("Layer>BoundingBox").first()),this.layers=this.parseLayers($(e).find("Layer>Layer"))},parseExent:function(e){if(void 0==e)return null;var t=parseFloat($(e).attr("minx")),s=parseFloat($(e).attr("miny")),r=parseFloat($(e).attr("maxx")),a=parseFloat($(e).attr("maxy"));return new GeoBeans.Envelope(t,s,r,a)},parseLayers:function(e){var t=this,s=[];return $(e).each(function(){var e=t.parseLayer(this);null!=e&&s.push(e)}),s},parseLayer:function(e){var t=$(e).find("Name").first().text(),s=$(e).find("CRS").first().text(),r=this.parseExent($(e).find("BoundingBox").first()),a=$(e).find("Style>Name").first().text(),n=$(e).find("GeometryType").first().text(),i=this.getGeomType(n),o=new GeoBeans.Layer.MapLayer(t);return o.srs=s,o.extent=r,o.style_name=a,o.geomType=i,o},getGeomType:function(e){var t=null;switch(e.toUpperCase()){case"POINT":t=GeoBeans.Geometry.Type.POINT;break;case"LINESTRING":t=GeoBeans.Geometry.Type.LINESTRING;break;case"POLYGON":t=GeoBeans.Geometry.Type.POLYGON;break;case"MULTIPOINT":t=GeoBeans.Geometry.Type.MULTIPOINT;break;case"MULTILINESTRING":t=GeoBeans.Geometry.Type.MULTILINESTRING;break;case"MULTIPOLYGON":t=GeoBeans.Geometry.Type.MULTIPOLYGON}return t},getMapURL:function(e,t,s,r,a,n){var i=t.xmin+","+t.ymin+","+t.xmax+","+t.ymax,o="service=wms";return o+="&version="+this.version,o+="&request=getMap",o+="&layers="+this.layers,o+="&width="+s,o+="&height="+r,o+="&format="+a,o+="&bbox="+i,o+=null==n?"&styles=":"&styles="+n},getMapLayer:function(e){if(null==this.layers&&(this.layers=this.getLayers_sync()),null!=this.layers){for(var t=0;t<this.layers.length;++t){var s=this.layers[t];if(s.name==e)return s}return null}}});
GeoBeans.WMTSWorkspace=GeoBeans.Class(GeoBeans.Workspace,{name:null,server:null,layers:null,initialize:function(e,r){this.name=e,this.server=r},getLayer:function(e,r){for(var n=this.getLayers(),t=null,a=0;a<n.length;++a)if(t=n[a],t.typeName==e)return t.setName(r),t;return null},getLayers:function(){if(null!=this.server){var e=this;return $.ajax({type:"get",url:this.server,dataType:"xml",async:!1,beforeSend:function(e){},success:function(r,n){e.layers=e.parseLayers(r)},complete:function(e,r){},error:function(){}}),e.layers}},parseLayers:function(e){var r=[],n=this;return $(e).find("Layer").each(function(){var e=n.parseLayer(this);r.push(e)}),r},parseLayer:function(e){var r=$(e).find("Identifier:first").text(),n=$(e).find("Format:first").text(),t=$(e).find("TileMatrixSetLink>TileMatrixSet").text(),a=$(e).find("LowerCorner").text(),s=$(e).find("UpperCorner").text(),i=a.indexOf(" "),l=a.lastIndexOf(" "),o=a.slice(0,i),f=a.slice(l+1,a.length);i=s.indexOf(" "),l=s.lastIndexOf(" ");var u=s.slice(0,i),c=s.slice(l+1,s.length),p=new GeoBeans.Envelope(parseFloat(o),parseFloat(f),parseFloat(u),parseFloat(c)),y=new GeoBeans.Layer.WMTSLayer(r,this.server,r,p,t,n);return y}});
GeoBeans.Service=GeoBeans.Class({name:null,mapName:null,url:null,layers:null,srid:null,extent:null,thumb:null,state:null,operations:null,initialize:function(l,t,e,s,n,i,a,r,u){this.name=l,this.mapName=t,this.url=e,this.layers=s,this.srid=n,this.extent=i,this.thumb=a,this.state=r,this.operations=u},getWMSLayers:function(){if(!$.isArray(this.layers))return null;for(var l=null,t=[],e=0;e<this.layers.length;++e)l=this.layers[e],null!=l&&t.push(l.name);return t}});
GeoBeans.ServiceManager=GeoBeans.Class({service:"ims",version:"1.0.0",server:null,services:null,initialize:function(e){this.server=e+"/mgr"},describeServices:function(e){var t=this,i="service="+this.service+"&version="+this.version+"&request=DescribeService";$.ajax({type:"get",url:this.server,data:encodeURI(i),dataType:"xml",async:!0,beforeSend:function(e){},success:function(i,r){t.services=t.parseServices(i),void 0!=e&&e(t.services)},complete:function(e,t){},error:function(){}})},describeService:function(e,t){if(null!=e){var i=this,r="service="+this.service+"&version="+this.version+"&request=DescribeService&name="+e;$.ajax({type:"get",url:this.server,data:encodeURI(r),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var n=i.parseService(e);void 0!=t&&t(n)},complete:function(e,t){},error:function(){}})}},createService:function(e,t,i,r){if(null==e||null==t||null==i)return void(null!=r&&r("params is null"));var n=this,s="service="+this.service+"&version="+this.version+"&request=createService&name="+e+"&mapName="+t+"&uri="+i;$.ajax({type:"get",url:this.server,data:encodeURI(s),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,t){var i=n.parseCreateService(e);void 0!=r&&r(i)},complete:function(e,t){},error:function(){}})},removeService:function(e,t){if(null==e)return void(null!=t&&t("name is null"));var i=this,r="service="+this.service+"&version="+this.version+"&request=RemoveService&name="+e;$.ajax({type:"get",url:this.server,data:encodeURI(r),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var n=i.parseRemoveService(e);void 0!=t&&t(n)},complete:function(e,t){},error:function(){}})},startService:function(e,t){if(null==e)return void(null!=t&&t("name is null"));var i=this,r="service="+this.service+"&version="+this.version+"&request=StartService&name="+e;$.ajax({type:"get",url:this.server,data:encodeURI(r),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var n=i.parseStartService(e);void 0!=t&&t(n)},complete:function(e,t){},error:function(){}})},stopService:function(e,t){if(null==e)return void(null!=t&&t("name is null"));var i=this,r="service="+this.service+"&version="+this.version+"&request=StopService&name="+e;$.ajax({type:"get",url:this.server,data:encodeURI(r),dataType:"xml",async:!0,beforeSend:function(e){},success:function(e,r){var n=i.parseStopService(e);void 0!=t&&t(n)},complete:function(e,t){},error:function(){}})},parseServices:function(e){if(null==e)return null;var t=$(e).find("ExceptionText").text();if(""!=t)return console.log(t),null;var i=[],r=this;return $(e).find("Service").each(function(){var e=r.parseService(this);null!=e&&i.push(e)}),i},parseService:function(e){if(null==e)return null;var t=$(e).find("ExceptionText").text();if(""!=t)return console.log(t),null;var i=$(e).find("Name").first().text(),r=$(e).find("Map").first().text(),n=$(e).find("BoundingBox"),s=this.parseBoundingBox(n),c=$(e).find("SRID").first().text(),a=$(e).find("State").first().text(),o=$(e).find("Thumbnail").text(),u=[];$(e).find("Operations>Operation").each(function(){var e=$(this).text();u.push(e)});var v=[],l=this;$(e).find("Layers>Layer").each(function(){var e=($(this).attr("queryable"),$(this).attr("visible")),t=$(this).attr("id"),i=$(this).find("Name").text(),r=$(this).find("CRS").text(),n=$(this).find("Type").text(),s=$(this).find("BoundingBox"),c=l.parseBoundingBox(s),a={name:i,id:t,srid:r,visible:e,type:n,extent:c};v.push(a)});var f=new GeoBeans.Service(i,r,null,v,c,s,o,a,u);return f},parseBoundingBox:function(e){if(null==e)return null;var t=parseFloat($(e).attr("minx")),i=parseFloat($(e).attr("miny")),r=parseFloat($(e).attr("maxx")),n=parseFloat($(e).attr("maxy"));return $.isNumeric(t)&&$.isNumeric(r)&&$.isNumeric(i)&&$.isNumeric(n)?new GeoBeans.Envelope(t,i,r,n):null},parseRemoveService:function(e){var t="",i=$(e).find("RemoveService").text();return"SUCCESS"==i.toUpperCase()?t="success":""!=$(e).find("ExceptionText").text()&&(t=$(e).find("ExceptionText").text()),t},parseCreateService:function(e){var t="",i=$(e).find("CreateService").text();return"SUCCESS"==i.toUpperCase()?t="success":""!=$(e).find("ExceptionText").text()&&(t=$(e).find("ExceptionText").text()),t},parseStartService:function(e){var t="",i=$(e).find("StartService").text();return"SUCCESS"==i.toUpperCase()?t="success":""!=$(e).find("ExceptionText").text()&&(t=$(e).find("ExceptionText").text()),t},parseStopService:function(e){var t="",i=$(e).find("StopService").text();return"SUCCESS"==i.toUpperCase()?t="success":""!=$(e).find("ExceptionText").text()&&(t=$(e).find("ExceptionText").text()),t}});